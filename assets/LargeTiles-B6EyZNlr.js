import{j as e,r as g,S as y,B as t,n as m,x as k,as as b,am as A,z as V,D as H,M as q,k as _,h as K,i as Q,q as U,ad as X}from"./routes-C-BkZgtt.js";import{a as Y}from"./ArrowDropDownRounded-_f5Pg-S1.js";import{u as G,n as M,s as j,c as C,a as N,t as J,m as Z,b as ee,l as O}from"./main-n2768nU4.js";import{T as w,a as te,b as S}from"./TileText-Cjclz5ce.js";import{S as I}from"./Skeleton-GnPJ5GGB.js";import{M as T}from"./MenuItem-DhQOCWG4.js";import{C as se}from"./Chip-B_B3n0JL.js";import{A as re}from"./ArrowOutwardRounded-BFqHlfLA.js";import{a as oe,b as ne,i as ae,M as ie,T as le,B as ce,g as de}from"./style-CH36U_6d.js";import{u as P}from"./url-QUAxP1Wn.js";import{b as pe}from"./formatters-C9bWSe0O.js";import{F as xe,S as he}from"./Switch-GKi725FL.js";import"./RefreshRounded-84LV6aIo.js";import"./SQLiteClient-NtSnAHyF.js";import"./DataExplorationRounded-BwPftMe4.js";import"./NotificationsRounded-bpE9RUC-.js";import"./fuse-D0PIhOkW.js";import"./useMutation-DItdicL4.js";import"./dayjs.min-DmibwfIS.js";import"./SearchRounded-DZA1yzSm.js";import"./DarkModeRounded-Ck9mItf0.js";import"./Tooltip-Bnxvlrw1.js";import"./DownloadRounded-BKvMQwDC.js";import"./DatasetRounded-BfKRSmty.js";import"./with-selector-CAkLlU_z.js";import"./SwitchBase-CwzMzgKA.js";function B(r){if(!r)return;const d=r.match(/^([a-z]+)(?:\.(\w+))?$/);if(d){const[,n,a]=d,x=["--mui-palette",n];return a&&x.push(a),`var(${x.join("-")})`}return r}const E=({color1:r="white",color2:d="transparent",angle:n=45,stripeWidth:a=10,backgroundSize:x,zIndex:i=0,className:o="",style:s={}})=>{const p=B(r),h=B(d),u=x??a*2,l=`repeating-linear-gradient(
    ${n}deg,
    ${p},
    ${p} ${a}px,
    ${h} ${a}px,
    ${h} ${u}px
  )`;return e.jsx("div",{className:o,style:{position:"absolute",inset:0,zIndex:i,background:l,pointerEvents:"none",...s}})},ue=({value:r,onClick:d})=>{const[n,a]=g.useState(null),x=s=>a(p=>p?null:s.currentTarget),i=()=>a(null),o=s=>()=>{d(s),i()};return e.jsxs(t,{sx:{display:"flex",gap:j,justifyContent:"space-between",alignItems:"center",p:j},children:[e.jsx(m,{variant:"h5",component:"h3",children:"紀錄數"}),e.jsxs(V,{sx:{"&:hover":{bgcolor:"action.hover"},p:1,pr:0,borderRadius:1},onClick:x,children:[e.jsxs(m,{sx:{color:"text.secondary"},children:["前 ",r," 筆"]}),e.jsx(Y,{sx:{color:"text.secondary"}})]}),e.jsx(H,{anchorEl:n,anchorOrigin:{horizontal:"center",vertical:"bottom"},transformOrigin:{horizontal:"center",vertical:"top"},open:!!n,onClose:i,children:e.jsxs(q,{dense:!0,children:[e.jsx(T,{onClick:o(3),selected:r===3,children:"前 3 筆"}),e.jsx(T,{onClick:o(5),selected:r===5,children:"前 5 筆"}),e.jsx(T,{onClick:o(7),selected:r===7,children:"前 7 筆"})]})})]})},me=(r,d)=>{if(r===null)return{dataArray:[...Array(d)].map((l,c)=>({label:"載入中"+c,records:0,percentage:0,loading:!0,noData:!1})),averageAmount:0,averagePercentages:0};const n=Object.entries(r).sort(([,l],[,c])=>c-l).slice(0,d),a=n.map(([l])=>l),x=n.map(([,l])=>l),i=1.75,o=Object.values(x).reduce((l,c)=>l+c,0),s=Math.round(o/d),p=Math.round(s/o*100*i),h=x.map(l=>Math.round(l/o*100*i)),u=a.map((l,c)=>({label:l,records:x[c],percentage:h[c],loading:!1,noData:!1}));if(u.length<d){const l=[...Array(d-u.length)].map(()=>({label:"",records:0,percentage:0,loading:!1,noData:!0}));return{dataArray:[...u,...l],averageAmount:s,averagePercentages:p}}return{dataArray:u,averageAmount:s,averagePercentages:p}},je=()=>{const[r,d]=g.useState(5),{data:n,isFetching:a}=G({types:["table","view"]}),{dataArray:x,averageAmount:i,averagePercentages:o}=me(a?null:n??null,r);return e.jsxs(y,{sx:{aspectRatio:{xs:"2/1",ml:"2/1.2"},borderTop:"1px solid",borderColor:"divider"},children:[e.jsx(ue,{value:r,onClick:d}),e.jsxs(t,{sx:{position:"relative",flex:1,display:"flex",gap:j,p:j,py:M,justifyContent:"space-around",alignItems:"stretch"},children:[x.map(({label:s,records:p,percentage:h,loading:u,noData:l},c)=>e.jsx(w,{title:u||l?null:e.jsxs(t,{children:[e.jsx(m,{variant:"subtitle2",children:s}),e.jsxs(m,{children:[p," 筆紀錄"]})]}),children:e.jsxs(t,{sx:{position:"relative",flex:1,borderRadius:2,overflow:"clip",transition:"all 0.2s ease-in-out","&:hover":{bgcolor:"action.hover","& .bar-content":{opacity:1}}},children:[e.jsx(E,{color1:"divider",color2:"#fff0",angle:-20,stripeWidth:5}),e.jsx(t,{sx:{position:"absolute",inset:`${u||l?100:Math.max(0,100-h)}% 0 0 0`,borderRadius:2,overflow:"hidden",bgcolor:"background.paper",transition:C},children:e.jsx(t,{className:"bar-content",sx:{position:"absolute",inset:0,bgcolor:"primary.main",opacity:c===0?.9:.65,transition:"all 0.2s ease-in-out"}})})]})},c)),e.jsx(t,{sx:{position:"absolute",inset:`0 0 ${a?0:o}% 0`,borderBottom:"4px dashed",borderColor:"divider",pointerEvents:"none",mx:j,scale:"1.02 1",transition:C,"&:before":{content:`"平均 ${a?0:i} 筆"`,position:"absolute",right:0,bottom:0,fontSize:"1rem",color:"text.secondary",opacity:.75}}}),a&&e.jsx(t,{sx:{position:"absolute",inset:0,display:"grid",placeItems:"center",pointerEvents:"none"},children:e.jsx(k,{})})]}),e.jsx(t,{sx:{display:"flex",gap:j,p:j,justifyContent:"space-around",alignItems:"center"},children:x.map(({label:s,loading:p,noData:h},u)=>p?e.jsx(I,{variant:"rounded",animation:"wave",children:e.jsx(m,{variant:"body1",component:"p",sx:{flex:1,textAlign:"center"},children:"載入中"})},u):h?e.jsx(m,{variant:"body1",component:"p",sx:{flex:1,color:"text.secondary",...b,textAlign:"center"},children:"---"},u):e.jsx(w,{title:e.jsx(m,{children:s}),children:e.jsx(m,{variant:"body1",component:"p",sx:{flex:1,color:"text.secondary",...A,...b,textAlign:"center"},children:s})},u))})]})},ge=_([e.jsx("path",{d:"M3 6c-.55 0-1 .45-1 1v13c0 1.1.9 2 2 2h13c.55 0 1-.45 1-1s-.45-1-1-1H4V7c0-.55-.45-1-1-1"},"0"),e.jsx("path",{d:"M20 2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2m-3.54 12.01-.63-1.82H12.2l-.65 1.82c-.1.29-.38.48-.68.48-.51 0-.86-.51-.68-.98l2.73-7.27c.16-.44.6-.74 1.08-.74s.92.3 1.09.75l2.73 7.27c.18.47-.17.98-.68.98-.31 0-.58-.19-.68-.49"},"1"),e.jsx("path",{d:"m13.96 7.17-1.31 3.72h2.69l-1.3-3.72z"},"2")]),D=({children:r,loading:d,...n})=>d?e.jsx(I,{variant:"rounded",animation:"wave",...n,children:r}):r,fe=()=>{const{data:r,isFetching:d}=N({types:["table","view"]}),n=g.useMemo(()=>{if(!r||d)return null;const o={};let s=0;r.forEach(({columns:l})=>{l.forEach(({type:c})=>{o[c]=(o[c]||0)+1,s+=1})});const p=[],h=new Set;let u=0;for(const[l,c]of Object.entries(o).sort((f,v)=>v[1]-f[1])){const f=c/s;p.length<3||f>=.1?p.push([l,c]):(u+=c,h.add(l))}if(u>0){const l=Array.from(h).slice(0,5),c=l.join(", ")+(l.length>5?", ...":"");p.push([`其他 (${c})`,u])}return p.map(([l,c])=>({type:l,count:c,percentage:c/s}))},[r,d]),a=n===null,x=!a&&n.length<3,i=!a&&!x;return e.jsxs(y,{sx:{aspectRatio:{xs:"2/1",ml:"2/1.2"},borderTop:"1px solid",borderColor:"divider",position:"relative"},children:[e.jsxs(t,{sx:{display:"flex",gap:j,justifyContent:"space-between",alignItems:"flex-start",p:j},children:[e.jsxs(y,{sx:{gap:1},children:[e.jsx(te,{children:"最常使用的型別"}),e.jsx(D,{loading:a,children:e.jsx(S,{variant:"h4",sx:{textTransform:"uppercase"},children:a?"載入中":x?"N/A":n[0].type})})]}),e.jsx(ge,{sx:{...J,mt:.5}})]}),e.jsxs(t,{sx:{flex:1,position:"relative"},children:[e.jsxs(t,{sx:{position:"absolute",inset:"auto 0 0 0",p:1.5,borderRadius:9,overflow:"clip"},children:[e.jsx(E,{color1:"divider",color2:"#fff0",angle:-35,stripeWidth:4}),i&&e.jsx(t,{sx:{position:"absolute",inset:0,display:"flex",alignItems:"stretch",zIndex:1},children:n.map(({type:o,count:s,percentage:p},h)=>e.jsx(w,{title:e.jsxs(S,{variant:"body1",sx:{textTransform:"uppercase"},children:[o," 型別使用了 ",s," 次"]}),children:e.jsx(t,{sx:{width:p,"&:hover":{bgcolor:"divider"},opacity:.9,transition:"all 0.2s ease-in-out"}})},h))})]}),e.jsx(t,{sx:{position:"absolute",inset:"auto 0 0 0",my:1.5,display:"grid",placeItems:"center"},children:e.jsx(t,{sx:{position:"absolute",width:1,display:"flex",alignItems:"center",scale:i?"1 1":"0 1",opacity:i?1:0,transition:C},children:i&&n.map(({percentage:o},s)=>e.jsx(t,{sx:{width:o,px:.5,pl:s===0?1:.5,pr:s===n.length-1?1:.5},children:e.jsx(t,{sx:{py:.5,borderRadius:9,bgcolor:"primary.main",filter:`hue-rotate(-${s*30+10}deg)`}})},s))})}),e.jsx(t,{sx:{position:"absolute",inset:0,display:"flex",transformOrigin:"left",scale:i?"1 1":"1 0",transition:C},children:i&&n.map(({type:o,percentage:s},p)=>e.jsx(t,{sx:{width:s,height:1,position:"relative"},children:e.jsx(t,{sx:{position:"absolute",inset:0,ml:p===0?1:0,mb:3,borderLeft:4,borderColor:"divider"},children:e.jsxs(t,{sx:{position:"absolute",inset:"0 auto auto 0"},children:[e.jsx(m,{variant:"body2",sx:{textTransform:"uppercase",color:"text.secondary",ml:1,...b},children:o}),e.jsxs(S,{sx:{textTransform:"uppercase",opacity:.8,ml:1},children:[Math.round(s*100),"%"]})]})})},p))}),a&&e.jsx(t,{sx:{position:"absolute",inset:0,display:"grid",placeItems:"center",pointerEvents:"none"},children:e.jsx(k,{})}),x&&e.jsx(t,{sx:{position:"absolute",inset:0,display:"grid",placeItems:"center",pointerEvents:"none"},children:e.jsx(se,{sx:{p:3,borderRadius:99},label:e.jsx(m,{variant:"h6",component:"p",sx:{color:"text.secondary"},children:"資料不足"})})})]}),e.jsx(t,{sx:{display:"flex",gap:Z,p:j,alignItems:"center",justifyContent:"space-around",width:"fit-content",minWidth:.5},children:i?n.map(({type:o},s)=>e.jsxs(t,{sx:{display:"flex",gap:1,alignItems:"center"},children:[e.jsx(t,{sx:{borderRadius:99,width:"1rem",height:"1rem",bgcolor:"primary.main",filter:`hue-rotate(-${s*30+10}deg)`}}),e.jsx(m,{variant:"body1",component:"p",sx:{color:"text.secondary",textTransform:"uppercase",...b},children:o})]},s)):[...Array(3)].map((o,s)=>e.jsxs(t,{sx:{display:"flex",gap:1,alignItems:"center"},children:[e.jsx(t,{sx:{borderRadius:99,width:"1rem",height:"1rem",bgcolor:"primary.main",filter:`hue-rotate(-${s*30+10}deg)`}}),e.jsx(D,{loading:!0,children:e.jsx(m,{variant:"body1",component:"p",children:"載入中"})})]},s))})]})},be={tableNode:le};function ye({nodes:r,edges:d,isFetching:n}){const{mode:a}=K(),[x,i]=g.useState(r),[o,s]=g.useState(d),[p,h]=g.useState(!1);g.useEffect(()=>{if(p)return;let c,f=0;const v=F=>{if(F-f<200){c=requestAnimationFrame(v);return}if(f=F,!x.every(R=>{var $,z;return(($=R.measured)==null?void 0:$.width)&&((z=R.measured)==null?void 0:z.height)})){c=requestAnimationFrame(v);return}const{nodes:W,edges:L}=de(x,o,"horizontal");i(W),s(L),h(!0)};return c=requestAnimationFrame(v),()=>cancelAnimationFrame(c)},[x,o,p]),g.useEffect(()=>{n||(i(r),s(d),h(!1))},[r,d,n]);const u=g.useCallback(c=>i(f=>oe(c,f)),[i]),l=g.useCallback(c=>s(f=>ne(c,f)),[s]);return e.jsxs(e.Fragment,{children:[e.jsx(t,{sx:{position:"absolute",inset:0,display:"grid",placeItems:"center",bgcolor:"action.hover"},children:e.jsx(k,{})}),e.jsx(ae,{nodes:x,nodeTypes:be,edges:o,onNodesChange:u,onEdgesChange:l,deleteKeyCode:null,colorMode:a,defaultViewport:{x:10,y:10,zoom:.7},defaultEdgeOptions:{type:"smoothstep",animated:!0,selectable:!1,style:{strokeWidth:2,stroke:"#b1b1b7"},markerEnd:{type:ie.Arrow,width:20,height:20}},style:{position:"relative",opacity:!p||n?0:1,transition:!p||n?void 0:"opacity 0.5s ease",background:"var(--mui-palette-background-paper)"},nodesDraggable:!1,nodesConnectable:!1,nodesFocusable:!1,panOnDrag:!1,panOnScroll:!1,zoomOnPinch:!1,zoomOnDoubleClick:!1,zoomOnScroll:!1,children:e.jsx(ce,{bgColor:"var(--mui-palette-action-hover)"})})]})}const ve=g.memo(ye),Ce=()=>{const{updatePath:r}=P(),d=()=>r(U.datahub_schema),{nodes:n,edges:a,isFetching:x}=ee(),i=g.useMemo(()=>n.map(o=>({id:o.tableName,type:"tableNode",data:o,position:{x:0,y:0}})),[n]);return e.jsxs(y,{sx:{aspectRatio:{xs:"2/1",ml:"2/1.2"},borderTop:"1px solid",borderColor:"divider"},children:[e.jsxs(t,{sx:{display:"flex",gap:j,alignItems:"flex-end",p:j},children:[e.jsx(m,{variant:"h5",component:"h3",sx:{textWrap:"noWrap"},children:"資料表關聯圖"}),e.jsx(m,{variant:"body1",sx:{opacity:.8,...b},children:"透過視覺化的節點與連線，探索資料表彼此的結構與關聯。"})]}),e.jsx(t,{sx:{flex:1,width:1,position:"relative"},children:e.jsx(t,{sx:{position:"absolute",inset:0,p:j,pt:M},children:e.jsxs(t,{sx:{position:"relative",width:1,height:1,borderRadius:3,border:3,borderColor:"divider",borderStyle:"dashed"},children:[e.jsxs(t,{sx:{position:"absolute",inset:0,display:"grid",placeItems:"center"},children:[e.jsx(t,{sx:{position:"absolute",inset:0,zIndex:1}}),e.jsx(ve,{nodes:i,edges:a,isFetching:x})]}),e.jsx(t,{sx:{position:"absolute",inset:"auto 0 0 auto",color:"secondary.dark",translate:"1rem 50%",zIndex:2},children:e.jsx(Q,{color:"inherit",size:"large",variant:"outlined",onClick:d,endIcon:e.jsx(re,{}),sx:{"&:hover":{scale:"1.02"},scale:"1.001",transition:"all 0.2s ease-in-out",bgcolor:"background.paper"},children:"查看完整關聯圖"})})]})})})]})},we=1.375,Ie=({field:r,count:d,percentage:n,loading:a,noData:x,index:i})=>{const{updateSearchParams:o}=P(),s=()=>o({search:"true",searchQuery:r,searchTopic:"column"},{skipTransition:!0});return e.jsxs(e.Fragment,{children:[e.jsx(t,{children:a?e.jsx(I,{variant:"rounded",animation:"wave",children:e.jsx(m,{variant:"body1",sx:{...b,...A,width:"6rem"},children:"載入中"})}):x?e.jsx(m,{variant:"body1",sx:{...b,width:"6rem"},children:"---"}):e.jsx(w,{title:e.jsx(m,{children:r}),children:e.jsx(m,{variant:"body1",sx:{...b,...A,width:"6rem"},onClick:s,children:r})})}),e.jsx(w,{title:a||x?null:e.jsxs(t,{children:[e.jsx(m,{variant:"subtitle2",children:r}),e.jsxs(m,{children:["所有欄位名稱中的 ",`${Math.round(n*100)}%`]})]}),children:e.jsxs(t,{onClick:s,sx:{width:1,height:"1rem",borderRadius:99,position:"relative",overflow:"clip",display:"flex",alignItems:"center","&:hover":{bgcolor:"action.hover","& .bar-content":{opacity:1}},transition:"all 0.2s ease-in-out"},children:[e.jsx(E,{color1:"divider",color2:"#fff0",angle:-35,stripeWidth:5}),e.jsx(t,{sx:{position:"absolute",width:Math.max(0,Math.min(n*we,1)),height:1,borderRadius:9,overflow:"clip",bgcolor:"background.paper",transition:C},children:e.jsx(t,{className:"bar-content",sx:{position:"absolute",inset:0,bgcolor:"primary.main",opacity:i===0?.9:.65,transition:"all 0.2s ease-in-out"}})})]})}),e.jsx(t,{children:a?e.jsx(I,{variant:"rounded",animation:"wave",children:e.jsx(m,{variant:"body1",sx:{...b,maxWidth:"10rem"},children:"載入中"})}):e.jsx(m,{variant:"body1",sx:{...b,maxWidth:"10rem"},children:x?"---":pe(d)})})]})},ke=r=>{const d=r.toLowerCase();return["id","create","update","delete","timestamp","modif"].some(a=>d.includes(a))},Se=()=>{const[r,d]=g.useState(!1),{data:n,isFetching:a}=N({types:["table","view"]}),x=g.useMemo(()=>{if(!n||a)return[...Array(5)].map(()=>({field:"",count:0,percentage:0,loading:!0,noData:!1}));const i={};n.forEach(({columns:h})=>{h.forEach(({name:u})=>{i[u]=(i[u]||0)+1})});const o=Object.entries(i).filter(([h])=>r||!ke(h)).toSorted((h,u)=>u[1]-h[1]).slice(0,5),s=o.reduce((h,[u,l])=>h+l,0),p=o.map(([h,u])=>({field:h,count:u,percentage:u/s,loading:!1,noData:!1}));if(p.length<5){const h=[...Array(5-p.length)].map(()=>({field:"",count:0,percentage:0,loading:!1,noData:!0}));return[...p,...h]}return p},[n,a,r]);return e.jsxs(y,{sx:{aspectRatio:{xs:"2/1",ml:"2/1.2"},borderTop:"1px solid",borderColor:"divider",position:"relative"},children:[e.jsxs(t,{sx:{display:"flex",gap:j,justifyContent:"space-between",alignItems:"flex-start",p:j},children:[e.jsx(m,{variant:"h5",component:"h3",children:"使用的欄位名稱"}),e.jsxs(y,{sx:{alignItems:"flex-end"},children:[e.jsx(xe,{checked:r,onChange:({target:i})=>d(i.checked),control:e.jsx(he,{}),labelPlacement:"start",label:e.jsx(m,{variant:"body1",sx:{opacity:.9},children:"包含系統欄位"})}),e.jsx(X,{children:"(id, createdAt, updatedAt, ...)"})]})]}),e.jsxs(t,{sx:{position:"relative",maxWidth:1,flex:1,overflowX:"auto",overflowY:"hidden"},children:[e.jsxs(t,{sx:{display:"grid",gridTemplateColumns:"auto 1fr auto",gap:j,placeItems:"center","& > :nth-of-type(3n + 1)":{justifySelf:"flex-start"},p:j,pt:M,width:1,height:1},children:[e.jsx(t,{children:e.jsx(m,{variant:"body1",sx:{color:"text.secondary"},children:"最常使用"})}),e.jsx(t,{}),e.jsx(t,{children:e.jsx(m,{variant:"body1",sx:{color:"text.secondary"},children:"出現次數"})}),x.map((i,o)=>e.jsx(Ie,{...i,index:o},o))]}),a&&e.jsx(t,{sx:{position:"absolute",inset:0,display:"grid",placeItems:"center",pointerEvents:"none"},children:e.jsx(k,{})})]})]})},et=()=>e.jsxs(t,{sx:{position:"relative",mt:O,display:"grid",gap:O,gridTemplateColumns:{xs:"1fr",ml:"repeat(2, 1fr)"},width:1},children:[e.jsx(je,{}),e.jsx(fe,{}),e.jsx(Ce,{}),e.jsx(Se,{})]});export{et as LargeTiles};
