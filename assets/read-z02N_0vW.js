import{ab as E,r as b}from"./routes-CadzfG2E.js";import{u as g}from"./useQuery-ItHSqdRD.js";import{o as I}from"./forum-J-R9UQLq.js";import{b as S}from"./datahub_home-DIQveoM4.js";import{d as C}from"./dayjs.min-CsIQ6MD_.js";function j(e,r=.9){if(!Array.isArray(e)||e.length===0)return null;if(r<0||r>1)throw new Error("Ratio must be between 0 and 1");const n=e.reduce((t,s)=>(t[s]=(t[s]||0)+1,t),{});let o=e[0],a=0;for(const[t,s]of E(n))s>a&&(o=t,a=s);return a/e.length>=r?o:null}const f=()=>{const{client:e}=S.getState();if(!e)throw new Error("SQLite client is not initialized.");return e},A=async()=>await f().getDatabaseSize(),x=async e=>{const r=f(),n=[];return await Promise.all(e.map(async o=>{(await r.exec("SELECT name FROM sqlite_master WHERE type = $type AND name NOT LIKE 'sqlite_%';",{$type:o})).forEach(t=>{typeof t.name=="string"&&n.push({type:o,name:t.name})})})),n},K=async e=>{const r=f(),n={},o=await x(e);return await Promise.all(o.map(async({name:a})=>{const i=`SELECT COUNT(*) as count FROM ${a};`,t=await r.exec(i);t.length>0?n[a]=Number(t[0].count??0):n[a]=0})),n},R=e=>{if(e==null)return"empty";if(typeof e=="number"&&Number.isInteger(e))return"integer";if(typeof e=="number")return"real";if(typeof e!="string")return"unknown";if(e.trim()==="")return"empty";if(/^[0-9a-f]{8}-[0-9a-f]{4}/.test(e))return"uuid";if(["true","false","0","1"].includes(e.toLowerCase()))return"boolean";if(C(e).isValid())return"date";const n=I(()=>JSON.parse(e));if(n.error)return"text";const o=n.data;return Array.isArray(o)?"json_array":typeof o=="object"&&o!==null?"json_object":"text"},$=async(e,r,n)=>{const o=f(),a=`SELECT "${r}" FROM "${e}" LIMIT 20;`,i=await o.exec(a);if(i.length===0)return n;const t=i.map(c=>R(c[r])).filter(c=>c!=="empty"),s=j(t,.9);return!s||s==="unknown"?n:s},M=async e=>{const r=f(),n=`PRAGMA table_info(${e});`,o=await r.exec(n);if(o.length===0)return null;const i=(await Promise.all(o.map(t=>$(e,t.name,t.type)))).map(t=>t.toLowerCase());return o.map((t,s)=>({...t,type:i[s]}))},L=async e=>{const r=f(),n=`PRAGMA foreign_key_list(${e});`;return await r.exec(n)},O=async e=>{const r=f(),n=`PRAGMA index_list(${e});`,o=await r.exec(n);return await Promise.all(o.map(async i=>{const t=`PRAGMA index_info(${i.name});`,s=await r.exec(t);return{...i,columns:s}}))},d=0,z=()=>g({queryKey:["dbBytes"],queryFn:()=>A(),staleTime:d}),w=({types:e})=>g({queryKey:["objects",e],queryFn:()=>x(e),staleTime:d}),H=({types:e})=>g({queryKey:["rowCounts",e],queryFn:()=>K(e),staleTime:d}),q=({types:e})=>{const{data:r=[],isFetching:n}=w({types:e}),{data:o,isFetching:a}=g({queryKey:["tableInfos",r],queryFn:async()=>(await Promise.all(r.map(async({name:t,type:s})=>({table:t,type:s,columns:await M(t)})))).filter(t=>t.columns!==null),enabled:r.length>0,staleTime:d});return{data:o,isFetching:n||a}},P=({types:e})=>{const{data:r=[],isFetching:n}=w({types:e}),{data:o,isFetching:a}=g({queryKey:["foreignKeys",r],queryFn:async()=>(await Promise.all(r.map(async({name:t,type:s})=>({table:t,type:s,keys:await L(t)})))).filter(t=>t.keys.length>0),enabled:r.length>0,staleTime:d});return{data:o,isFetching:n||a}},_=({types:e})=>{const{data:r=[],isFetching:n}=w({types:e}),{data:o,isFetching:a}=g({queryKey:["indexes",r],queryFn:async()=>(await Promise.all(r.map(async({name:t,type:s})=>({table:t,type:s,indexes:await O(t)})))).filter(t=>t.indexes.length>0),enabled:r.length>0,staleTime:d});return{data:o,isFetching:n||a}},Q=()=>{const{data:e=[],isFetching:r}=q({types:["table","view"]}),{data:n=[],isFetching:o}=P({types:["table","view"]}),a=b.useMemo(()=>{if(e.length===0||n.length===0)return[];const t={};return n.forEach(({keys:s})=>{s.forEach(({table:c,to:l})=>{t[c]||(t[c]=new Set),t[c].add(l)})}),e.toSorted((s,c)=>s.type.localeCompare(c.type)).map(({table:s,type:c,columns:l},m)=>{const y=n.find(({table:u})=>u===s)||null,h=l.map(u=>{var F;return{fieldName:u.name,fieldType:u.type,nullable:u.pk===1?"pk":u.notnull===0?"yes":"no",isSource:((F=t[s])==null?void 0:F.has(u.name))||!1,isTarget:(y==null?void 0:y.keys.some(T=>T.from===u.name))||!1}}),p=m%7;return{tableName:s,tableType:c,hueIndex:p,fields:h}})},[e,n]),i=b.useMemo(()=>{if(e.length===0||n.length===0)return[];const t=[];return n.forEach(({table:s,keys:c})=>{c.forEach(({from:l,to:m,table:y})=>{const h=m,p=y===s?`${l}_self`:l;t.push({id:`${y}.${p}->${s}.${h}`,source:y,target:s,sourceHandle:h,targetHandle:p})})}),t},[e,n]);return{nodes:a,edges:i,isFetching:r||o}},V=()=>{const{data:e=[],isFetching:r}=q({types:["table","view"]}),{data:n=[],isFetching:o}=_({types:["table","view"]});return{data:b.useMemo(()=>{if(e.length===0||n.length===0)return{};const i={};return e.toSorted((t,s)=>t.type.localeCompare(s.type)).forEach(({table:t,columns:s,type:c},l)=>{i[t]={columns:s,indexes:[],type:c,hueIndex:l%7}}),n.forEach(({table:t,indexes:s})=>{i[t]&&i[t].indexes.push(...s)}),i},[e,n]),isFetching:r||o}};export{q as a,Q as b,z as c,w as d,V as e,H as u};
