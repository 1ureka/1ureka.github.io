import{r as m,ae as Wt,j as f,n as lt,af as vt,ag as yt,ah as Vt,ai as Ut,aj as _t,p as At,l as jt,ak as Jt,al as Et,D as kt,N as Gt,S as Lt,am as Kt,x as Qt,y as Z,a5 as Tt,an as Zt,k as te,m as Ct,z as ee,ao as Pt,F as it,s as nt,o as tt,a6 as re,q as Rt,i as ne,a8 as $t,w as Nt,E as xt,ap as bt,G as ft,g as Ft,u as Ht,a as oe,T as se,M as It,P as ae}from"./Toast-CaubaWG6.js";import{s as ie,u as ce,T as le,I as Ot,D as ue,M as et}from"./DarkModeRounded-DhOzHgDY.js";import{g as rt,h as gt,L as pe}from"./ScrollArea-zAV9zyXX.js";const de=Jt(),fe=ie("div",{name:"MuiStack",slot:"Root",overridesResolver:(t,e)=>e.root});function he(t){return ce({props:t,name:"MuiStack",defaultTheme:de})}function me(t,e){const o=m.Children.toArray(t).filter(Boolean);return o.reduce((r,n,c)=>(r.push(n),c<o.length-1&&r.push(m.cloneElement(e,{key:`separator-${c}`})),r),[])}const ge=t=>({row:"Left","row-reverse":"Right",column:"Top","column-reverse":"Bottom"})[t],ye=({ownerState:t,theme:e})=>{let o={display:"flex",flexDirection:"column",...vt({theme:e},yt({values:t.direction,breakpoints:e.breakpoints.values}),r=>({flexDirection:r}))};if(t.spacing){const r=Vt(e),n=Object.keys(e.breakpoints.values).reduce((l,u)=>((typeof t.spacing=="object"&&t.spacing[u]!=null||typeof t.direction=="object"&&t.direction[u]!=null)&&(l[u]=!0),l),{}),c=yt({values:t.direction,base:n}),a=yt({values:t.spacing,base:n});typeof c=="object"&&Object.keys(c).forEach((l,u,d)=>{if(!c[l]){const y=u>0?c[d[u-1]]:"column";c[l]=y}}),o=Ut(o,vt({theme:e},a,(l,u)=>t.useFlexGap?{gap:Et(r,l)}:{"& > :not(style):not(style)":{margin:0},"& > :not(style) ~ :not(style)":{[`margin${ge(u?c[u]:t.direction)}`]:Et(r,l)}}))}return o=_t(e.breakpoints,o),o};function xe(t={}){const{createStyledComponent:e=fe,useThemeProps:o=he,componentName:r="MuiStack"}=t,n=()=>At({root:["root"]},l=>jt(r,l),{}),c=e(ye);return m.forwardRef(function(l,u){const d=o(l),k=Wt(d),{component:y="div",direction:C="column",spacing:M=0,divider:A,children:b,className:O,useFlexGap:g=!1,...j}=k,B={direction:C,spacing:M,useFlexGap:g},L=n();return f.jsx(c,{as:y,ownerState:B,ref:u,className:lt(L.root,O),...j,children:A?me(b,A):b})})}function we(t,e,o){const r=e.getBoundingClientRect(),n=o&&o.getBoundingClientRect(),c=Z(e);let a;if(e.fakeTransform)a=e.fakeTransform;else{const u=c.getComputedStyle(e);a=u.getPropertyValue("-webkit-transform")||u.getPropertyValue("transform")}let h=0,l=0;if(a&&a!=="none"&&typeof a=="string"){const u=a.split("(")[1].split(")")[0].split(",");h=parseInt(u[4],10),l=parseInt(u[5],10)}return t==="left"?n?`translateX(${n.right+h-r.left}px)`:`translateX(${c.innerWidth+h-r.left}px)`:t==="right"?n?`translateX(-${r.right-n.left-h}px)`:`translateX(-${r.left+r.width-h}px)`:t==="up"?n?`translateY(${n.bottom+l-r.top}px)`:`translateY(${c.innerHeight+l-r.top}px)`:n?`translateY(-${r.top-n.top+r.height-l}px)`:`translateY(-${r.top+r.height-l}px)`}function Se(t){return typeof t=="function"?t():t}function ht(t,e,o){const r=Se(o),n=we(t,e,r);n&&(e.style.webkitTransform=n,e.style.transform=n)}const Te=m.forwardRef(function(e,o){const r=kt(),n={enter:r.transitions.easing.easeOut,exit:r.transitions.easing.sharp},c={enter:r.transitions.duration.enteringScreen,exit:r.transitions.duration.leavingScreen},{addEndListener:a,appear:h=!0,children:l,container:u,direction:d="down",easing:k=n,in:y,onEnter:C,onEntered:M,onEntering:A,onExit:b,onExited:O,onExiting:g,style:j,timeout:B=c,TransitionComponent:L=Gt,...V}=e,x=m.useRef(null),X=Lt(Kt(l),x,o),R=p=>w=>{p&&(w===void 0?p(x.current):p(x.current,w))},ot=R((p,w)=>{ht(d,p,u),Zt(p),C&&C(p,w)}),st=R((p,w)=>{const N=Tt({timeout:B,style:j,easing:k},{mode:"enter"});p.style.webkitTransition=r.transitions.create("-webkit-transform",{...N}),p.style.transition=r.transitions.create("transform",{...N}),p.style.webkitTransform="none",p.style.transform="none",A&&A(p,w)}),H=R(M),s=R(g),$=R(p=>{const w=Tt({timeout:B,style:j,easing:k},{mode:"exit"});p.style.webkitTransition=r.transitions.create("-webkit-transform",w),p.style.transition=r.transitions.create("transform",w),ht(d,p,u),b&&b(p)}),W=R(p=>{p.style.webkitTransition="",p.style.transition="",O&&O(p)}),S=p=>{a&&a(x.current,p)},_=m.useCallback(()=>{x.current&&ht(d,x.current,u)},[d,u]);return m.useEffect(()=>{if(y||d==="down"||d==="right")return;const p=Qt(()=>{x.current&&ht(d,x.current,u)}),w=Z(x.current);return w.addEventListener("resize",p),()=>{p.clear(),w.removeEventListener("resize",p)}},[d,y,u]),m.useEffect(()=>{y||_()},[y,_]),f.jsx(L,{nodeRef:x,onEnter:ot,onEntered:H,onEntering:st,onExit:$,onExited:W,onExiting:s,addEndListener:S,appear:h,in:y,timeout:B,...V,children:(p,{ownerState:w,...N})=>m.cloneElement(l,{ref:X,style:{visibility:p==="exited"&&!y?"hidden":void 0,...j,...l.props.style},...N})})});function Pe(t){return jt("MuiDrawer",t)}te("MuiDrawer",["root","docked","paper","anchorLeft","anchorRight","anchorTop","anchorBottom","paperAnchorLeft","paperAnchorRight","paperAnchorTop","paperAnchorBottom","paperAnchorDockedLeft","paperAnchorDockedRight","paperAnchorDockedTop","paperAnchorDockedBottom","modal"]);const Bt=(t,e)=>{const{ownerState:o}=t;return[e.root,(o.variant==="permanent"||o.variant==="persistent")&&e.docked,e.modal]},ke=t=>{const{classes:e,anchor:o,variant:r}=t,n={root:["root",`anchor${tt(o)}`],docked:[(r==="permanent"||r==="persistent")&&"docked"],modal:["modal"],paper:["paper",`paperAnchor${tt(o)}`,r!=="temporary"&&`paperAnchorDocked${tt(o)}`]};return At(n,Pe,e)},Ce=nt(re,{name:"MuiDrawer",slot:"Root",overridesResolver:Bt})(Rt(({theme:t})=>({zIndex:(t.vars||t).zIndex.drawer}))),Re=nt("div",{shouldForwardProp:$t,name:"MuiDrawer",slot:"Docked",skipVariantsResolver:!1,overridesResolver:Bt})({flex:"0 0 auto"}),ve=nt(ne,{name:"MuiDrawer",slot:"Paper",overridesResolver:(t,e)=>{const{ownerState:o}=t;return[e.paper,e[`paperAnchor${tt(o.anchor)}`],o.variant!=="temporary"&&e[`paperAnchorDocked${tt(o.anchor)}`]]}})(Rt(({theme:t})=>({overflowY:"auto",display:"flex",flexDirection:"column",height:"100%",flex:"1 0 auto",zIndex:(t.vars||t).zIndex.drawer,WebkitOverflowScrolling:"touch",position:"fixed",top:0,outline:0,variants:[{props:{anchor:"left"},style:{left:0}},{props:{anchor:"top"},style:{top:0,left:0,right:0,height:"auto",maxHeight:"100%"}},{props:{anchor:"right"},style:{right:0}},{props:{anchor:"bottom"},style:{top:"auto",left:0,bottom:0,right:0,height:"auto",maxHeight:"100%"}},{props:({ownerState:e})=>e.anchor==="left"&&e.variant!=="temporary",style:{borderRight:`1px solid ${(t.vars||t).palette.divider}`}},{props:({ownerState:e})=>e.anchor==="top"&&e.variant!=="temporary",style:{borderBottom:`1px solid ${(t.vars||t).palette.divider}`}},{props:({ownerState:e})=>e.anchor==="right"&&e.variant!=="temporary",style:{borderLeft:`1px solid ${(t.vars||t).palette.divider}`}},{props:({ownerState:e})=>e.anchor==="bottom"&&e.variant!=="temporary",style:{borderTop:`1px solid ${(t.vars||t).palette.divider}`}}]}))),zt={left:"right",right:"left",top:"down",bottom:"up"};function U(t){return["left","right"].includes(t)}function ct({direction:t},e){return t==="rtl"&&U(e)?zt[e]:e}const Ee=m.forwardRef(function(e,o){const r=Ct({props:e,name:"MuiDrawer"}),n=kt(),c=ee(),a={enter:n.transitions.duration.enteringScreen,exit:n.transitions.duration.leavingScreen},{anchor:h="left",BackdropProps:l,children:u,className:d,elevation:k=16,hideBackdrop:y=!1,ModalProps:{BackdropProps:C,...M}={},onClose:A,open:b=!1,PaperProps:O={},SlideProps:g,TransitionComponent:j,transitionDuration:B=a,variant:L="temporary",slots:V={},slotProps:x={},...X}=r,R=m.useRef(!1);m.useEffect(()=>{R.current=!0},[]);const ot=ct({direction:c?"rtl":"ltr"},h),H={...r,anchor:h,elevation:k,open:b,variant:L,...X},s=ke(H),$={slots:{transition:j,...V},slotProps:{paper:O,transition:g,...x,backdrop:Pt(x.backdrop||{...l,...C},{transitionDuration:B})}},[W,S]=it("root",{ref:o,elementType:Ce,className:lt(s.root,s.modal,d),shouldForwardComponentProp:!0,ownerState:H,externalForwardedProps:{...$,...X,...M},additionalProps:{open:b,onClose:A,hideBackdrop:y,slots:{backdrop:$.slots.backdrop},slotProps:{backdrop:$.slotProps.backdrop}}}),[_,p]=it("paper",{elementType:ve,shouldForwardComponentProp:!0,className:lt(s.paper,O.className),ownerState:H,externalForwardedProps:$,additionalProps:{elevation:L==="temporary"?k:0,square:!0}}),[w,N]=it("docked",{elementType:Re,ref:o,className:lt(s.root,s.docked,d),ownerState:H,externalForwardedProps:$,additionalProps:X}),[J,pt]=it("transition",{elementType:Te,ownerState:H,externalForwardedProps:$,additionalProps:{in:b,direction:zt[ot],timeout:B,appear:R.current}}),G=f.jsx(_,{...p,children:u});if(L==="permanent")return f.jsx(w,{...N,children:G});const K=f.jsx(J,{...pt,children:G});return L==="persistent"?f.jsx(w,{...N,children:K}):f.jsx(W,{...S,children:K})});function be(t){const{children:e,defer:o=!1,fallback:r=null}=t,[n,c]=m.useState(!1);return Nt(()=>{o||c(!0)},[o]),m.useEffect(()=>{o&&c(!0)},[o]),n?e:r}const Xe=xe({createStyledComponent:nt("div",{name:"MuiStack",slot:"Root",overridesResolver:(t,e)=>e.root}),useThemeProps:t=>Ct({props:t,name:"MuiStack"})}),De=nt("div",{shouldForwardProp:$t})(Rt(({theme:t})=>({position:"fixed",top:0,left:0,bottom:0,zIndex:t.zIndex.drawer-1,variants:[{props:{anchor:"left"},style:{right:"auto"}},{props:{anchor:"right"},style:{left:"auto",right:0}},{props:{anchor:"top"},style:{bottom:"auto",right:0}},{props:{anchor:"bottom"},style:{top:"auto",bottom:0,right:0}}]}))),Me=m.forwardRef(function(e,o){const{anchor:r,classes:n={},className:c,width:a,style:h,...l}=e,u=e;return f.jsx(De,{className:lt("PrivateSwipeArea-root",n.root,n[`anchor${tt(r)}`],c),ref:o,style:{[U(r)?"width":"height"]:a,...h},ownerState:u,...l})}),mt=3,Dt=20;let Y=null;function wt(t,e,o){return t==="right"?o.body.offsetWidth-e[0].pageX:e[0].pageX}function St(t,e,o){return t==="bottom"?o.innerHeight-e[0].clientY:e[0].clientY}function at(t,e){return t?e.clientWidth:e.clientHeight}function Mt(t,e,o,r){return Math.min(Math.max(o?e-t:r+e-t,0),r)}function Ae(t,e){const o=[];for(;t&&t!==e.parentElement;){const r=Z(e).getComputedStyle(t);r.getPropertyValue("position")==="absolute"||r.getPropertyValue("overflow-x")==="hidden"||(t.clientWidth>0&&t.scrollWidth>t.clientWidth||t.clientHeight>0&&t.scrollHeight>t.clientHeight)&&o.push(t),t=t.parentElement}return o}function je({domTreeShapes:t,start:e,current:o,anchor:r}){const n={scrollPosition:{x:"scrollLeft",y:"scrollTop"},scrollLength:{x:"scrollWidth",y:"scrollHeight"},clientLength:{x:"clientWidth",y:"clientHeight"}};return t.some(c=>{let a=o>=e;(r==="top"||r==="left")&&(a=!a);const h=r==="left"||r==="right"?"x":"y",l=Math.round(c[n.scrollPosition[h]]),u=l>0,d=l+c[n.clientLength[h]]<c[n.scrollLength[h]];return!!(a&&d||!a&&u)})}const Le=typeof navigator<"u"&&/iPad|iPhone|iPod/.test(navigator.userAgent),$e=m.forwardRef(function(e,o){const r=Ct({name:"MuiSwipeableDrawer",props:e}),n=kt(),c={enter:n.transitions.duration.enteringScreen,exit:n.transitions.duration.leavingScreen},{anchor:a="left",disableBackdropTransition:h=!1,disableDiscovery:l=!1,disableSwipeToOpen:u=Le,hideBackdrop:d,hysteresis:k=.52,allowSwipeInChildren:y=!1,minFlingVelocity:C=450,ModalProps:{BackdropProps:M,...A}={},onClose:b,onOpen:O,open:g=!1,PaperProps:j={},SwipeAreaProps:B,swipeAreaWidth:L=20,transitionDuration:V=c,variant:x="temporary",slots:X={},slotProps:R={},...ot}=r,[st,H]=m.useState(!1),s=m.useRef({isSwiping:null}),$=m.useRef(),W=m.useRef(),S=m.useRef(),_=Lt(j.ref,S),p=m.useRef(!1),w=m.useRef();Nt(()=>{w.current=null},[g]);const N=m.useCallback((i,F={})=>{const{mode:T=null,changeTransition:P=!0}=F,v=ct(n,a),E=["right","bottom"].includes(v)?1:-1,z=U(a),I=z?`translate(${E*i}px, 0)`:`translate(0, ${E*i}px)`,Q=S.current.style;Q.webkitTransform=I,Q.transform=I;let D="";if(T&&(D=n.transitions.create("all",Tt({easing:void 0,style:void 0,timeout:V},{mode:T}))),P&&(Q.webkitTransition=D,Q.transition=D),!h&&!d){const q=W.current.style;q.opacity=1-i/at(z,S.current),P&&(q.webkitTransition=D,q.transition=D)}},[a,h,d,n,V]),J=xt(i=>{if(!p.current)return;if(Y=null,p.current=!1,bt.flushSync(()=>{H(!1)}),!s.current.isSwiping){s.current.isSwiping=null;return}s.current.isSwiping=null;const F=ct(n,a),T=U(a);let P;T?P=wt(F,i.changedTouches,ft(i.currentTarget)):P=St(F,i.changedTouches,Z(i.currentTarget));const v=T?s.current.startX:s.current.startY,E=at(T,S.current),z=Mt(P,v,g,E),I=z/E;if(Math.abs(s.current.velocity)>C&&(w.current=Math.abs((E-z)/s.current.velocity)*1e3),g){s.current.velocity>C||I>k?b():N(0,{mode:"exit"});return}s.current.velocity<-C||1-I>k?O():N(at(T,S.current),{mode:"enter"})}),pt=(i=!1)=>{if(!st){(i||!(l&&y))&&bt.flushSync(()=>{H(!0)});const F=U(a);!g&&S.current&&N(at(F,S.current)+(l?15:-20),{changeTransition:!1}),s.current.velocity=0,s.current.lastTime=null,s.current.lastTranslate=null,s.current.paperHit=!1,p.current=!0}},G=xt(i=>{if(!S.current||!p.current||Y!==null&&Y!==s.current)return;pt(!0);const F=ct(n,a),T=U(a),P=wt(F,i.touches,ft(i.currentTarget)),v=St(F,i.touches,Z(i.currentTarget));if(g&&S.current.contains(i.target)&&Y===null){const D=Ae(i.target,S.current);if(je({domTreeShapes:D,start:T?s.current.startX:s.current.startY,current:T?P:v,anchor:a})){Y=!0;return}Y=s.current}if(s.current.isSwiping==null){const D=Math.abs(P-s.current.startX),q=Math.abs(v-s.current.startY),dt=T?D>q&&D>mt:q>D&&q>mt;if(dt&&i.cancelable&&i.preventDefault(),dt===!0||(T?q>mt:D>mt)){if(s.current.isSwiping=dt,!dt){J(i);return}s.current.startX=P,s.current.startY=v,!l&&!g&&(T?s.current.startX-=Dt:s.current.startY-=Dt)}}if(!s.current.isSwiping)return;const E=at(T,S.current);let z=T?s.current.startX:s.current.startY;g&&!s.current.paperHit&&(z=Math.min(z,E));const I=Mt(T?P:v,z,g,E);if(g)if(s.current.paperHit)I===0&&(s.current.startX=P,s.current.startY=v);else if(T?P<E:v<E)s.current.paperHit=!0,s.current.startX=P,s.current.startY=v;else return;s.current.lastTranslate===null&&(s.current.lastTranslate=I,s.current.lastTime=performance.now()+1);const Q=(I-s.current.lastTranslate)/(performance.now()-s.current.lastTime)*1e3;s.current.velocity=s.current.velocity*.4+Q*.6,s.current.lastTranslate=I,s.current.lastTime=performance.now(),i.cancelable&&i.preventDefault(),N(I)}),K=xt(i=>{var E;if(i.defaultPrevented||i.defaultMuiPrevented||g&&(d||!W.current.contains(i.target))&&!S.current.contains(i.target))return;const F=ct(n,a),T=U(a),P=wt(F,i.touches,ft(i.currentTarget)),v=St(F,i.touches,Z(i.currentTarget));if(!g){if(u||!(i.target===$.current||(E=S.current)!=null&&E.contains(i.target)&&(typeof y=="function"?y(i,$.current,S.current):y)))return;if(T){if(P>L)return}else if(v>L)return}i.defaultMuiPrevented=!0,Y=null,s.current.startX=P,s.current.startY=v,pt()});m.useEffect(()=>{if(x==="temporary"){const i=ft(S.current);return i.addEventListener("touchstart",K),i.addEventListener("touchmove",G,{passive:!g}),i.addEventListener("touchend",J),()=>{i.removeEventListener("touchstart",K),i.removeEventListener("touchmove",G,{passive:!g}),i.removeEventListener("touchend",J)}}},[x,g,K,G,J]),m.useEffect(()=>()=>{Y===s.current&&(Y=null)},[]),m.useEffect(()=>{g||H(!1)},[g]);const[Yt,Xt]=it("swipeArea",{ref:$,elementType:Me,ownerState:r,externalForwardedProps:{slots:X,slotProps:{swipeArea:B,...R}},additionalProps:{width:L,anchor:a}});return f.jsxs(m.Fragment,{children:[f.jsx(Ee,{open:x==="temporary"&&st?!0:g,variant:x,ModalProps:{BackdropProps:{...M,ref:W},...x==="temporary"&&{keepMounted:!0},...A},hideBackdrop:d,anchor:a,transitionDuration:w.current||V,onClose:b,ref:o,slots:X,slotProps:{...R,backdrop:Pt(R.backdrop??M,{ref:W}),paper:Pt(R.paper??j,{style:{pointerEvents:x==="temporary"&&!g&&!y?"none":""},ref:_})},...ot}),!u&&x==="temporary"&&f.jsx(be,{children:f.jsx(Yt,{...Xt})})]})}),Ne=Ft(f.jsx("path",{d:"M18.3 5.71a.996.996 0 0 0-1.41 0L12 10.59 7.11 5.7a.996.996 0 0 0-1.41 0c-.39.39-.39 1.02 0 1.41L10.59 12 5.7 16.89c-.39.39-.39 1.02 0 1.41s1.02.39 1.41 0L12 13.41l4.89 4.89c.39.39 1.02.39 1.41 0s.39-1.02 0-1.41L13.41 12l4.89-4.89c.38-.38.38-1.02 0-1.4"}),"CloseRounded"),We=()=>{const[t,e]=m.useState(null),o=n=>e(n.currentTarget),r=()=>e(null);return f.jsxs(f.Fragment,{children:[f.jsx(le,{title:"切換主題",arrow:!0,children:f.jsx(Ot,{onClick:o,children:f.jsx(ue,{fontSize:"small"})})}),f.jsx(Fe,{open:!!t,anchorEl:t,onClose:r,anchorOrigin:{horizontal:"center",vertical:"bottom"},transformOrigin:{horizontal:"center",vertical:"top"}})]})},Fe=({onClose:t,...e})=>{const{mode:o,setMode:r}=Ht(),n=c=>()=>{r(c),t()};return f.jsx(ae,{anchorOrigin:{horizontal:"right",vertical:"top"},onClose:t,...e,children:f.jsxs(It,{dense:!0,children:[f.jsx(et,{onClick:n("light"),selected:o==="light",children:"淺色"}),f.jsx(et,{onClick:n("dark"),selected:o==="dark",children:"暗色"}),f.jsx(et,{onClick:n("system"),selected:o==="system",children:"跟隨系統"})]})})},He=nt("div")(({theme:t})=>({width:30,height:6,backgroundColor:t.palette.divider,borderRadius:3,position:"relative",left:"calc(50% - 15px)",...t.applyStyles("dark",{backgroundColor:t.palette.divider})})),Ve=({onClose:t,...e})=>{const{mode:o,setMode:r}=Ht(),n=c=>()=>{r(c),t()};return f.jsxs($e,{anchor:"top",onClose:t,...e,children:[f.jsxs(oe,{sx:{p:3,display:"flex",alignItems:"center",justifyContent:"space-between"},children:[f.jsx(se,{variant:"h6",children:"切換主題"}),f.jsx(Ot,{onClick:t,children:f.jsx(Ne,{})})]}),f.jsxs(It,{dense:!0,children:[f.jsx(et,{onClick:n("light"),selected:o==="light",children:"淺色"}),f.jsx(et,{onClick:n("dark"),selected:o==="dark",children:"暗色"}),f.jsx(et,{onClick:n("system"),selected:o==="system",children:"跟隨系統"})]}),f.jsx(He,{sx:{mb:2}})]})},Ue=Ft(f.jsx("path",{d:"M13.35 20.13c-.76.69-1.93.69-2.69-.01l-.11-.1C5.3 15.27 1.87 12.16 2 8.28c.06-1.7.93-3.33 2.34-4.29 2.64-1.8 5.9-.96 7.66 1.1 1.76-2.06 5.02-2.91 7.66-1.1 1.41.96 2.28 2.59 2.34 4.29.14 3.88-3.3 6.99-8.55 11.76z"}),"FavoriteRounded"),Ie=async({topic:t}={})=>{var a;const e=[],o={};t&&(e.push("EXISTS (SELECT 1 FROM json_each(tags) WHERE value = $topic)"),o.$topic=t);const n=`
      SELECT COUNT(*) as totalCount
      FROM posts
      ${e.length>0?`WHERE ${e.join(" AND ")}`:""}
    `;return((a=(await rt.exec(n,o))[0])==null?void 0:a.totalCount)||0},qt=async({page:t=0,limit:e=10,topic:o,userId:r,orderBy:n="createdAt",order:c="desc"}={})=>{var g;const a=[],h={};o&&(a.push("EXISTS (SELECT 1 FROM json_each(tags) WHERE value = $topic)"),h.$topic=o),r&&(a.push("userId = $userId"),h.$userId=r);const l=a.length>0?`WHERE ${a.join(" AND ")}`:"";let u="p.createdAt";n==="likeCount"||n==="commentCount"?u=`pic.${n}`:u=`p.${n}`;const d=`
      SELECT COUNT(*) as totalCount
      FROM posts
      ${l}
    `,y=((g=(await rt.exec(d,h))[0])==null?void 0:g.totalCount)||0,C=Math.ceil(y/e),M=t+1<C?t+1:null;h.$limit=e,h.$offset=t*e;const A=`
        SELECT id
        FROM posts p
        LEFT JOIN post_interaction_counts pic ON p.id = pic.postId
        ${l}
        ORDER BY ${u} ${c.toUpperCase()}, p.createdAt DESC
        LIMIT $limit OFFSET $offset
      `;return{posts:(await rt.exec(A,h)).map(j=>j.id),nextPage:M,totalPages:C}},Oe=async()=>{const e=await rt.exec("SELECT uniqueTags FROM tag_stats");if(e.length===0)return[];const o=e[0].uniqueTags,r=JSON.parse(o);return Array.isArray(r)?r:[]},Be=async({postId:t,incrementViewCount:e=!1})=>{e&&await rt.exec("UPDATE posts SET viewCount = viewCount + 1 WHERE id = $postId",{$postId:t});const r=await rt.exec(`
      SELECT
        p.id,
        p.title,
        p.content,
        p.tags,
        p.photos,
        p.attachments,
        p.viewCount,
        p.createdAt,
        p.updatedAt,
        p.userId,
        u.name as userName,
        COALESCE(pic.likeCount, 0) as likeCount,
        COALESCE(pic.commentCount, 0) as commentCount
      FROM
        posts p
      JOIN
        users u ON p.userId = u.id
      LEFT JOIN
        post_interaction_counts pic ON p.id = pic.postId
      WHERE
        p.id = $postId
    `,{$postId:t});if(r.length===0)return null;const n=r[0];return{...n,tags:JSON.parse(n.tags||"[]"),photos:n.photos?JSON.parse(n.photos):void 0,attachments:n.attachments?JSON.parse(n.attachments):void 0,createdAt:new Date(n.createdAt),updatedAt:new Date(n.updatedAt),likeCount:n.likeCount||0,commentCount:n.commentCount||0}},ut=1*60*1e3,_e=({limit:t,topic:e,userId:o,orderBy:r,order:n}={})=>gt({queryKey:["posts",t,e,o,r,n],queryFn:async()=>(await qt({page:0,limit:t,topic:e,userId:o,orderBy:r,order:n})).posts,staleTime:ut}),Je=({topic:t}={})=>gt({queryKey:["postCounts",t],queryFn:()=>Ie({topic:t}),staleTime:ut}),Ge=({limit:t=6,topic:e,userId:o,orderBy:r,order:n}={})=>{const{data:c,fetchNextPage:a,hasNextPage:h,isFetchingNextPage:l,isLoading:u}=pe({queryKey:["infinitePosts",t,e,o,r,n],queryFn:({pageParam:d})=>qt({page:d,limit:t,topic:e,userId:o,orderBy:r,order:n}),initialPageParam:0,getNextPageParam:d=>d.nextPage,staleTime:ut});return m.useEffect(()=>{const d=document.getElementById("scroll-area");if(!d)return;const k=()=>{const y=d.scrollHeight,C=d.scrollTop,M=d.clientHeight;C+M>=y-350&&h&&!l&&a()};return d.addEventListener("scroll",k),()=>d.removeEventListener("scroll",k)},[a,h,l]),{data:c,isLoading:u,isFetchingNextPage:l,hasNextPage:h,fetchNextPage:a}},Ke=()=>gt({queryKey:["tags"],queryFn:Oe,staleTime:ut}),Qe=({postId:t,incrementViewCount:e})=>gt({queryKey:["post",t],queryFn:()=>t===void 0||Number.isNaN(t)?null:Be({postId:t,incrementViewCount:e}),enabled:t!==void 0&&!Number.isNaN(t)&&t>=0,staleTime:ut});export{Ne as C,Ue as F,Xe as S,We as T,Qe as a,Ke as b,Je as c,Ge as d,$e as e,Ve as f,_e as u};
