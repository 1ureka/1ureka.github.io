import{o as E,j as e,t as p,T as c,B as r,A as ae,r as k,D as ce,v as le,E as de,y as V,P as xe,z as me}from"./routes-HNxAJ3wC.js";import{S as ue,A as pe}from"./SentimentDissatisfiedRounded-CyMqRtbS.js";import{g as he,d as b,a as je,A as ge,S as ye}from"./ScrollArea-DVv7XotC.js";import{u as $,D as fe,B as Ie,f as W,F as be,U,g as ve,b as Ce,c as Se,d as ke,e as we}from"./url-CZ-hGQae.js";import{a as q,i as Ee,z as G,j as J,d as Re,g as Ae,e as $e,u as Le,C as Fe}from"./post-BSkPOABJ.js";import{E as _,a as Be}from"./ExpandedPost-Cy-87aPi.js";import{L as Ne,T as D,V as Y,P as Pe,a as Te,S as qe,b as De}from"./PostHeader-CbNOLaPr.js";import{D as Oe}from"./DownloadRounded-eXoy8fNl.js";import{S as v}from"./Skeleton-ClRS8rvl.js";import{C as P}from"./Chip-ClU5wa3A.js";import{T as w,u as X}from"./useMutation-DHV1DfwY.js";import{I as A,S as ze}from"./DarkModeRounded-BcFV06RJ.js";import{D as g}from"./Divider-Bxx0iyhR.js";import{u as L,a as O}from"./forum-N-Qre-Q_.js";import{E as Me}from"./EmojiMenu-CZIHkncX.js";import{T as K,a as R}from"./Tabs-D08045dp.js";import{B as We}from"./ButtonGroup-C7iE8oMh.js";import"./ForumRounded-aPZzzFd5.js";import"./ExpandMoreRounded-B7e8HWqr.js";import"./OpenInNewRounded-BfnWo5b9.js";import"./NotificationsRounded-CDzRw5gH.js";import"./Collapse-Dd7n2mpE.js";import"./with-selector-ZaZOMS5R.js";import"./CommentRounded-B7KNlNhE.js";const B=E(e.jsx("path",{d:"m11.71 15.29 2.59-2.59c.39-.39.39-1.02 0-1.41L11.71 8.7c-.63-.62-1.71-.18-1.71.71v5.17c0 .9 1.08 1.34 1.71.71"})),N=E(e.jsx("path",{d:"M12.29 8.71 9.7 11.3c-.39.39-.39 1.02 0 1.41l2.59 2.59c.63.63 1.71.18 1.71-.71V9.41c0-.89-1.08-1.33-1.71-.7"})),S={display:"-webkit-box",WebkitLineClamp:1,WebkitBoxOrient:"vertical",overflow:"hidden",textOverflow:"ellipsis",textTransform:"none"},_e=()=>{const{searchParams:t,updateSearchParams:n}=$(),s=t.get("postId"),o=s&&/^\d+$/.test(s)&&Number(s)>0?Number(s):-1,{data:a,isFetching:i}=q({postId:o-1});return i&&!a?e.jsx(p,{startIcon:e.jsx(N,{}),loading:!0,children:e.jsx(c,{variant:"button",sx:S,children:"載入中..."})}):a?e.jsx(p,{startIcon:e.jsx(N,{}),onClick:()=>n({postId:(o-1).toString()}),children:e.jsxs(c,{variant:"button",sx:S,children:["上一篇：",a.title]})}):e.jsx(p,{startIcon:e.jsx(N,{}),disabled:!0,children:e.jsx(c,{variant:"button",sx:S,children:"沒有上一篇了"})})},Ke=()=>{const{searchParams:t,updateSearchParams:n}=$(),s=t.get("postId"),o=s&&/^\d+$/.test(s)&&Number(s)>0?Number(s):-1,{data:a,isFetching:i}=q({postId:o+1});return i&&!a?e.jsx(p,{endIcon:e.jsx(B,{}),loading:!0,children:e.jsx(c,{variant:"button",sx:S,children:"載入中..."})}):a?e.jsx(p,{endIcon:e.jsx(B,{}),onClick:()=>n({postId:(o+1).toString()}),children:e.jsxs(c,{variant:"button",sx:S,children:["下一篇：",a.title]})}):e.jsx(p,{endIcon:e.jsx(B,{}),disabled:!0,children:e.jsx(c,{variant:"button",sx:S,children:"沒有下一篇了"})})},He=E(e.jsx("path",{d:"m21.41 11.41-8.83-8.83c-.37-.37-.88-.58-1.41-.58H4c-1.1 0-2 .9-2 2v7.17c0 .53.21 1.04.59 1.41l8.83 8.83c.78.78 2.05.78 2.83 0l7.17-7.17c.78-.78.78-2.04-.01-2.83M6.5 8C5.67 8 5 7.33 5 6.5S5.67 5 6.5 5 8 5.67 8 6.5 7.33 8 6.5 8"}));function Qe(t){return Ve(t)%4+1}function Ve(t){let n=5381;for(let s=0;s<t.length;s++)n=(n<<5)+n+t.charCodeAt(s);return Math.abs(n)}const Ue=t=>["16/9","4/3","1/1","3/2"][Qe(t)-1],Ge=({open:t,onClose:n,name:s,...o})=>e.jsxs(fe,{open:t,onClose:n,slotProps:{paper:{elevation:1,sx:{overflow:"hidden",position:"relative"}}},maxWidth:"md",fullWidth:!0,...o,children:[e.jsx(v,{variant:"rectangular",animation:"wave",sx:{aspectRatio:Ue(s),width:1,height:"auto",bgcolor:"divider"}}),e.jsx(r,{sx:{position:"absolute",inset:"auto 0 0 0",p:1,display:"grid",placeItems:"center"},children:e.jsxs(r,{sx:{display:"flex",gap:1,alignItems:"center"},children:[e.jsx(r,{sx:{maxWidth:200},children:e.jsx(P,{label:s})}),e.jsx(w,{title:"下載圖片",arrow:!0,children:e.jsx(A,{size:"small",children:e.jsx(Oe,{})})})]})}),e.jsx(r,{sx:{position:"absolute",inset:"0 0 auto auto",p:1},children:e.jsx(A,{onClick:a=>n&&n(a,"escapeKeyDown"),children:e.jsx(Ee,{})})})]}),Je=t=>Array.from({length:t},()=>Math.random()*.7+.3),Ye=()=>e.jsxs(r,{sx:{pt:1.5},children:[e.jsx(g,{}),e.jsxs(r,{sx:{position:"relative",py:1.5,height:"fit-content"},children:[e.jsx(r,{sx:{position:"absolute",inset:0,bgcolor:"divider",opacity:.35,pointerEvents:"none"}}),e.jsx(r,{sx:{px:2.5},children:e.jsx(Ne,{sx:{m:0}})})]}),e.jsx(g,{sx:{mb:2.5}}),e.jsxs(r,{sx:{px:2.5,position:"relative"},children:[e.jsx(v,{variant:"rounded",animation:"wave",sx:{mb:1},children:e.jsx(c,{variant:"h4",component:"h2",sx:{textAlign:"start"},gutterBottom:!0,children:"正在載入標題... 正在載入"})}),Je(4).map((t,n)=>e.jsx(v,{variant:"text",animation:"wave",width:`${t*100}%`},n)),e.jsx(ae,{sx:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)"}})]}),e.jsx(g,{sx:{mt:2.5}}),e.jsxs(r,{sx:{p:1.5,py:1,display:"flex",gap:1.5,alignItems:"center",position:"relative",color:"text.secondary"},children:[e.jsx(r,{sx:{position:"absolute",inset:0,bgcolor:"divider",opacity:.35}}),e.jsx(p,{color:"inherit",startIcon:e.jsx(D,{}),size:"small",loading:!0,children:e.jsx(c,{variant:"caption",component:"span",children:"100 個讚"})}),e.jsx(p,{color:"inherit",startIcon:e.jsx(Ie,{}),size:"small",loading:!0,children:e.jsx(c,{variant:"caption",component:"span",children:"收藏該貼文"})}),e.jsx(r,{sx:{flex:1}}),e.jsx(p,{color:"inherit",startIcon:e.jsx(Y,{}),size:"small",loading:!0,children:e.jsx(c,{variant:"caption",component:"span",children:"1000 次瀏覽"})})]}),e.jsx(g,{})]}),Xe=({post:t})=>{const[n,s]=k.useState({open:!1,name:""}),o=i=>s({open:!0,name:i}),a=()=>s(i=>({open:!1,name:i.name}));return e.jsxs(r,{sx:{pt:1.5},children:[e.jsx("title",{children:`論壇樣板 | ${t.title}`}),e.jsx(g,{}),e.jsxs(r,{sx:{position:"relative",py:1.5,height:"fit-content"},children:[e.jsx(r,{sx:{position:"absolute",inset:0,bgcolor:"divider",opacity:.35,pointerEvents:"none"}}),e.jsx(r,{sx:{px:2.5},children:e.jsx(Pe,{post:t,sx:{m:0}})})]}),e.jsx(g,{sx:{mb:2.5}}),e.jsxs(r,{sx:{px:2.5},children:[e.jsx(c,{variant:"h4",component:"h2",sx:{textAlign:"start"},gutterBottom:!0,children:t.title}),e.jsx(c,{variant:"body2",component:"p",sx:{whiteSpace:"pre-line"},children:t.content}),t.photos&&t.photos.length>0&&e.jsx(r,{sx:{display:"grid",gap:1,mt:2,gridTemplateColumns:"repeat(auto-fill, minmax(150px, 1fr))"},children:t.photos.map(({name:i,url:d},m)=>e.jsx(w,{title:"查看圖片",arrow:!0,placement:"top",children:e.jsx(ce,{onClick:()=>o(i),sx:{position:"relative",aspectRatio:"1 / 1",bgcolor:"divider",borderRadius:1,overflow:"hidden"},children:e.jsx(r,{sx:{position:"absolute",inset:"auto 0 0 0",pb:1,display:"grid",placeItems:"center"},children:e.jsx(r,{sx:{maxWidth:150},children:e.jsx(P,{label:i,size:"small"})})})})},`${d}${m}`))}),e.jsx(Ge,{open:n.open,onClose:a,name:n.name}),e.jsxs(ze,{sx:{gap:1.5,flexDirection:"row",justifyContent:"space-between",alignItems:"center",flexWrap:"wrap-reverse",mt:2},children:[e.jsxs(r,{sx:{display:"flex",gap:1.5,flexWrap:"wrap",alignItems:"center"},children:[e.jsxs(c,{variant:"subtitle2",sx:{color:"text.secondary",display:"flex",alignItems:"center",gap:.5},children:[e.jsx(He,{fontSize:"small"}),"標籤："]}),e.jsx(Te,{post:t,displayCount:99})]}),t.attachments&&t.attachments.length>0&&e.jsxs(r,{sx:{display:"flex",gap:1,flexWrap:"wrap",alignItems:"center"},children:[e.jsxs(c,{variant:"subtitle2",sx:{color:"text.secondary",display:"flex",alignItems:"center",gap:.5},children:[e.jsx(W,{fontSize:"small"}),"附件："]}),t.attachments.map((i,d)=>e.jsx(w,{title:"下載附件",arrow:!0,placement:"top",children:e.jsx(P,{label:`${i.name} (${(i.size/1024).toFixed(1)}KB)`,clickable:!0,icon:e.jsx(W,{fontSize:"small"})})},d))]})]})]}),e.jsx(g,{sx:{mt:2.5}}),e.jsxs(r,{sx:{px:2.5,py:1,display:"flex",gap:1.5,alignItems:"center",position:"relative",color:"text.secondary"},children:[e.jsx(r,{sx:{position:"absolute",inset:0,bgcolor:"divider",opacity:.35}}),t.isSelf?e.jsx(qe,{post:t}):e.jsxs(e.Fragment,{children:[e.jsx(De,{postId:t.id,likeCount:t.likeCount}),e.jsx(be,{postId:t.id})]}),e.jsx(r,{sx:{flex:1}}),e.jsx(p,{startIcon:e.jsx(Y,{}),disabled:!0,size:"small",sx:{"button&.Mui-disabled":{color:"text.secondary",opacity:.8}},children:e.jsxs(c,{variant:"caption",component:"span",children:[t.viewCount," 次瀏覽"]})})]}),e.jsx(g,{flexItem:!0})]})},Z=async t=>{const n=t.postId!==void 0,s=n?"c.postId = $id AND c.parentId IS NULL":"c.parentId = $id",a=(t.orderBy||"latest")==="latest"?"datetime(c.createdAt) DESC":"COALESCE(cic.likeCount, 0) DESC, datetime(c.createdAt) DESC",i=`
      SELECT c.id FROM comments c
      LEFT JOIN comment_interaction_counts cic ON c.id = cic.commentId
      WHERE ${s} ORDER BY ${a}
    `,d={$id:n?t.postId:t.parentId};return(await b.exec(i,d)).map(u=>u.id)},Ze=async({commentId:t})=>{const s=await b.exec(`
      SELECT
        c.id,
        c.postId,
        c.parentId,
        c.content,
        c.userId,
        u.name as userName,
        COALESCE(cic.likeCount, 0) as likeCount,
        c.createdAt,
        c.updatedAt
      FROM
        comments c
      JOIN
        users u ON c.userId = u.id
      LEFT JOIN
        comment_interaction_counts cic ON c.id = cic.commentId
      WHERE
        c.id = $commentId
    `,{$commentId:t});if(s.length===0)return null;const o=s[0];return{...o,id:o.id,postId:o.postId,parentId:o.parentId,content:o.content,userId:o.userId,userName:o.userName,likeCount:o.likeCount,createdAt:new Date(o.createdAt),updatedAt:new Date(o.updatedAt)}},et=async({postId:t,content:n,parentId:s})=>{const o=await he({server:!0});if(!o.authenticated)return{error:"未登入或授權失效，無法創建留言"};const a=o.user.id;if((await b.exec("SELECT id FROM posts WHERE id = $postId",{$postId:t})).length===0)return{error:"貼文不存在"};if(s){const I=await b.exec("SELECT id, postId FROM comments WHERE id = $parentId",{$parentId:s});if(I.length===0)return{error:"回覆的留言不存在"};if(I[0].postId!==t)return{error:"回覆的留言不屬於此貼文"}}const m=new Date().toISOString(),u=`
      INSERT INTO comments (userId, postId, parentId, content, createdAt, updatedAt)
      VALUES ($userId, $postId, $parentId, $content, $createdAt, $updatedAt)
      RETURNING id
    `,h={$userId:a,$postId:t,$parentId:s||null,$content:n,$createdAt:m,$updatedAt:m},x=await b.exec(u,h);return!x||x.length===0||typeof x[0].id!="number"?{error:"創建留言失敗"}:x[0].id},z=1e3*60*1,tt=({postId:t,orderBy:n})=>L({queryKey:["commentsByPost",t,n],queryFn:()=>Z({postId:t,orderBy:n}),staleTime:z}),ee=t=>L({queryKey:["commentsByParent",t],queryFn:()=>Z({parentId:t,orderBy:"latest"}),staleTime:z}),st=t=>L({queryKey:["comment",t],queryFn:()=>Ze({commentId:t}),staleTime:z}),nt=()=>{const t=O();return X({mutationFn:et,onSettled:()=>{t.invalidateQueries({queryKey:["commentsByPost"]}),t.invalidateQueries({queryKey:["commentsByParent"]}),t.invalidateQueries({queryKey:["comment"]}),t.invalidateQueries({queryKey:["post"]})}})},te=E(e.jsx("path",{d:"M10 9V7.41c0-.89-1.08-1.34-1.71-.71L3.7 11.29c-.39.39-.39 1.02 0 1.41l4.59 4.59c.63.63 1.71.19 1.71-.7V14.9c5 0 8.5 1.6 11 5.1-1-5-4-10-11-11"})),se=E(e.jsx("path",{d:"M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2m0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2m0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2"})),H=E(e.jsx("path",{d:"M8.12 9.29 12 13.17l3.88-3.88c.39-.39 1.02-.39 1.41 0s.39 1.02 0 1.41l-4.59 4.59c-.39.39-1.02.39-1.41 0L6.7 10.7a.996.996 0 0 1 0-1.41c.39-.38 1.03-.39 1.42 0"})),ne={content:G.string().min(1,{message:"請輸入留言內容"}).max(250,{message:"留言內容過長"})},rt=G.object(ne),ot={content:""},T=({sx:t,onCancel:n,postId:s,parentId:o,...a})=>{const{mutateAsync:i,isPending:d}=nt(),{user:m,authenticated:u,loading:h}=J(),x=Re({defaultValues:ot,validators:{onSubmit:rt},onSubmit:async({value:l})=>{if(d)return;const j=await i({...l,postId:s,parentId:o});if(typeof j=="number")return x.reset(),console.log("發佈成功，留言 ID：",j);j.error&&console.error(`留言發佈失敗：${j.error}`)}}),y=async()=>{if(!x.state.canSubmit){de(x.getAllErrors().fields).forEach(([l,j])=>{j.errors.forEach(f=>{!f||typeof f!="object"||"message"in f&&console.error(`${l}: ${f.message}`)})}),console.error("請檢查表單是否填寫正確");return}x.handleSubmit()},I=k.useRef(null),C=l=>{x.setFieldValue("content",j=>{const f=I.current;if(f){const F=f.selectionStart||0,oe=f.selectionEnd||0,ie=j.substring(0,F)+l+j.substring(oe);return setTimeout(()=>{f.focus(),f.setSelectionRange(F+l.length,F+l.length)},0),ie}return j+l})};return e.jsx(r,{sx:{position:"relative",py:1,px:2,...t},...a,children:e.jsxs(r,{sx:{display:"flex",alignItems:"flex-start",gap:1.5},children:[u&&m?e.jsx(U,{name:m.name,sx:{mt:1.5}}):e.jsx(ve,{sx:{width:"2rem",height:"2rem",mt:1.5}}),e.jsxs(r,{sx:{flex:1},children:[e.jsx(x.Field,{name:"content",validators:{onSubmit:ne.content},children:l=>e.jsx(le,{inputRef:I,name:l.name,variant:"standard",size:"small",label:u?"發表你的想法":"登入後即可發表留言",fullWidth:!0,type:"text",disabled:!u||h,error:$e(l.state.meta.errors),helperText:Ae(l.state.meta.errors),value:l.state.value,onChange:j=>l.handleChange(j.target.value),onBlur:l.handleBlur})}),e.jsxs(r,{sx:{display:"flex",justifyContent:"space-between",mt:1,alignItems:"center",gap:1},children:[e.jsx(Me,{onEmojiClick:C,disabled:!u||h}),e.jsxs(r,{sx:{display:"flex",gap:1},children:[e.jsx(p,{size:"small",disabled:!u||h,sx:{color:"text.secondary"},loading:d,onClick:()=>{x.reset(),n!==void 0&&n()},children:"取消"}),e.jsx(x.Subscribe,{selector:l=>l.values.content,children:l=>e.jsx(p,{size:"small",disabled:!u||h||l.trim().length===0,variant:"contained",onClick:y,loading:d,children:"留言"})})]})]})]})]})})},it=async({commentId:t,userId:n})=>{const s=`
      SELECT 1 as liked
      FROM comment_interactions
      WHERE commentId = $commentId
        AND userId = $userId
        AND type = 'like'
      LIMIT 1
    `,o=`
      SELECT COALESCE(likeCount, 0) as likeCount
      FROM comment_interaction_counts
      WHERE commentId = $commentId
    `,a=await b.exec(s,{$commentId:t,$userId:n}),i=await b.exec(o,{$commentId:t}),d=a.length>0;return!i[0]||!Number.isInteger(i[0].likeCount)?null:{liked:d,likeCount:i[0].likeCount}},at=async({commentId:t,userId:n,type:s,value:o})=>{o?await b.exec(`
        INSERT OR IGNORE INTO comment_interactions (userId, commentId, type)
        VALUES ($userId, $commentId, $type)
      `,{$userId:n,$commentId:t,$type:s}):await b.exec(`
        DELETE FROM comment_interactions
        WHERE userId = $userId
          AND commentId = $commentId
          AND type = $type
      `,{$userId:n,$commentId:t,$type:s})},ct=0,lt=(t,n,s)=>{const o=O(),a=k.useRef(0);return X({mutationFn:i=>{if(n===void 0)throw new Error("未登入");return at({commentId:t,userId:n,type:s,value:i})},onMutate:()=>(a.current++,a.current),onSettled:(i,d,m,u)=>{if(u===a.current){const h=["commentLikeStatus",t,n];o.invalidateQueries({queryKey:h})}},onError:()=>{console.error("評論按讚操作失敗")}})},dt=t=>{const n=O(),{user:s,authenticated:o,loading:a}=J(),{data:i,isLoading:d}=L({staleTime:ct,queryKey:["commentLikeStatus",t,s==null?void 0:s.id],enabled:!a&&o&&(s==null?void 0:s.id)!==void 0,queryFn:async()=>it({commentId:t,userId:s.id})}),m=a||d,u=!o||m||i===void 0||i===null,h=(i==null?void 0:i.liked)??!1,x=(i==null?void 0:i.likeCount)??null,{mutate:y}=lt(t,s==null?void 0:s.id,"like");return{liked:h,likeCount:x,handleLike:async()=>{u||(await n.cancelQueries({queryKey:["commentLikeStatus",t,s.id]}),n.setQueryData(["commentLikeStatus",t,s.id],C=>{const l=!C.liked;return y(l),{liked:l,likeCount:C.likeCount+(l?1:-1)}}))},disabled:u,loading:m}},xt=({commentId:t,likeCount:n})=>{const{liked:s,likeCount:o,handleLike:a,disabled:i,loading:d}=dt(t);return e.jsx(p,{size:"small",startIcon:e.jsx(D,{}),onClick:a,color:s?"primary":"inherit",sx:{color:s?void 0:"text.secondary"},disabled:i,loading:d,children:e.jsx(c,{variant:"caption",children:o!==null?o>0?o:"讚":n})})},re=({postId:t,commentId:n,nestedLevel:s,sx:o,...a})=>{if(s<0)throw new Error("nestedLevel must be greater than 0");const{data:i,isFetching:d}=st(n),{data:m,isFetching:u}=ee(n),[h,x]=k.useState(!1),y=()=>x(j=>!j),[I,C]=k.useState(!1),l=()=>C(j=>!j);return d||!i||u?e.jsx(M,{nestedLevel:s,sx:o,...a}):e.jsx(r,{sx:{position:"relative",py:1,pb:s>0?0:1,pl:2,borderLeft:s>0?"2px solid":"none",borderColor:"divider",...o},...a,children:e.jsxs(r,{sx:{display:"flex",alignItems:"flex-start",gap:1.5},children:[e.jsx(U,{name:i.userName,sx:{mt:1}}),e.jsxs(r,{sx:{flex:1},children:[e.jsxs(r,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx(c,{variant:"subtitle2",component:"a",sx:{"&:hover":{textDecoration:"underline"},color:"text.primary"},href:`${V.forum_users}?user=${i.userName}`,children:i.userName}),e.jsxs(r,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(c,{variant:"caption",color:"text.secondary",children:i.createdAt.toLocaleString()}),i.createdAt.getTime()!==i.updatedAt.getTime()&&e.jsx(w,{title:`最後編輯於 ${i.updatedAt.toLocaleString()}`,arrow:!0,children:e.jsx(c,{variant:"caption",color:"text.secondary",children:"(已編輯)"})}),e.jsx(w,{title:"更多選項",arrow:!0,children:e.jsx(A,{size:"small",children:e.jsx(se,{fontSize:"small"})})})]})]}),e.jsx(c,{variant:"body2",sx:{mt:.5,whiteSpace:"pre-line"},children:i.content}),e.jsxs(r,{sx:{display:"flex",alignItems:"center",mt:1,gap:1},children:[e.jsx(xt,{commentId:n,likeCount:i.likeCount}),e.jsx(p,{size:"small",startIcon:e.jsx(te,{}),sx:{color:"text.secondary"},onClick:l,children:e.jsx(c,{variant:"caption",children:I?"取消回覆":"回覆"})})]}),I&&e.jsx(T,{onCancel:()=>C(!1),postId:t,parentId:n}),m&&m.length>0&&e.jsx(p,{startIcon:h?e.jsx(H,{sx:{transform:"rotate(180deg)",transition:"transform 0.2s ease",transformOrigin:"center"}}):e.jsx(H,{}),sx:{mt:1},size:"small",onClick:y,children:h?"隱藏回覆":`顯示 ${m.length||0} 則回覆`}),h&&m&&e.jsx(mt,{commentId:n,postId:t})]})]})})},M=({nestedLevel:t,sx:n,...s})=>e.jsx(r,{sx:{position:"relative",py:1,pb:t>0?0:1,pl:2,borderLeft:t>0?"2px solid":"none",borderColor:"divider",...n},...s,children:e.jsxs(r,{sx:{display:"flex",alignItems:"flex-start",gap:1.5},children:[e.jsx(v,{variant:"circular",width:"2rem",height:"2rem",sx:{mt:1},animation:"wave"}),e.jsxs(r,{sx:{flex:1},children:[e.jsxs(r,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx(v,{variant:"rounded",animation:"wave",children:e.jsx(c,{variant:"subtitle2",component:"span",children:"載入名稱中..."})}),e.jsxs(r,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(v,{variant:"rounded",animation:"wave",children:e.jsx(c,{variant:"caption",color:"text.secondary",children:"0000-00-00 00:00:00"})}),e.jsx(w,{title:"更多選項",arrow:!0,children:e.jsx("span",{children:e.jsx(A,{size:"small",disabled:!0,children:e.jsx(se,{fontSize:"small"})})})})]})]}),e.jsx(v,{variant:"rounded",animation:"wave",children:e.jsx(c,{variant:"body2",sx:{mt:.5,whiteSpace:"pre-line"},children:"佔位文字，佔位文字，佔位文字，佔位文字，佔位文字，佔位文字，"})}),e.jsxs(r,{sx:{display:"flex",alignItems:"center",mt:1,gap:1},children:[e.jsx(p,{size:"small",startIcon:e.jsx(D,{}),sx:{color:"text.secondary"},loading:!0,children:e.jsx(c,{variant:"caption",children:"讚"})}),e.jsx(p,{size:"small",startIcon:e.jsx(te,{}),sx:{color:"text.secondary"},loading:!0,children:e.jsx(c,{variant:"caption",children:"回覆"})})]})]})]})}),mt=({commentId:t,postId:n})=>{const{data:s,isFetching:o}=ee(t);return o?e.jsx(r,{children:[...Array(1)].map((a,i)=>e.jsx(M,{nestedLevel:1},i))}):s?e.jsx(r,{children:s.map(a=>e.jsx(re,{commentId:a,postId:n,nestedLevel:1},a))}):null},Q={content:'""',display:"block",position:"absolute",inset:0,bgcolor:"divider",opacity:.2,pointerEvents:"none",mr:-2},ut=({totalComments:t})=>{const{searchParams:n,updateSearchParams:s}=$(),o=n.get("postId"),a=o&&/^\d+$/.test(o)&&Number(o)>0?Number(o):-1,d=(n.get("orderBy")||"latest")==="likes"?"likes":"latest",{data:m,isFetching:u}=tt({postId:a,orderBy:d}),h=(x,y)=>{s({orderBy:y===0?"latest":"likes"})};return u?e.jsxs(e.Fragment,{children:[e.jsxs(r,{sx:{display:"flex",alignItems:"center",gap:1.5},children:[e.jsx(v,{variant:"rounded",animation:"wave",sx:{mx:2},children:e.jsx(c,{variant:"subtitle1",component:"h3",children:"0 則留言"})}),e.jsx(g,{flexItem:!0,orientation:"vertical",variant:"middle"}),e.jsxs(K,{value:d==="latest"?0:1,onChange:h,children:[e.jsx(R,{label:"最新",disabled:!0}),e.jsx(R,{label:"最多人按讚",disabled:!0})]})]}),e.jsx(g,{}),e.jsx(r,{sx:{pr:2,"& > .comment:nth-of-type(odd):before":Q},children:[...Array(3)].map((x,y)=>e.jsx(M,{nestedLevel:0,className:"comment"},y))})]}):!m||m.length===0?e.jsxs(e.Fragment,{children:[e.jsx(r,{sx:{pr:2},children:e.jsx(T,{postId:a})}),e.jsx(r,{sx:{pb:2},children:e.jsx(c,{variant:"body2",sx:{color:"text.secondary",textAlign:"center",mt:2},children:"還沒有留言，快來發表你的看法吧！"})})]}):e.jsxs(e.Fragment,{children:[e.jsxs(r,{sx:{display:"flex",alignItems:"center",gap:1.5},children:[e.jsxs(c,{variant:"subtitle1",component:"h3",sx:{px:2},children:[t," 則留言"]}),e.jsx(g,{flexItem:!0,orientation:"vertical",variant:"middle"}),e.jsxs(K,{value:d==="latest"?0:1,onChange:h,children:[e.jsx(R,{label:"最新"}),e.jsx(R,{label:"最多人按讚"})]})]}),e.jsx(g,{}),e.jsxs(r,{sx:{pr:2,"& > .comment:nth-of-type(odd):before":Q},children:[e.jsx(T,{className:"comment",postId:a}),m.map(x=>e.jsx(re,{commentId:x,postId:a,nestedLevel:0,className:"comment"},x))]})]})},pt=()=>{const{data:t,isFetching:n}=Le({limit:2,orderBy:"likeCount",order:"desc"});return n||!t?e.jsxs(r,{children:[e.jsx(_,{}),e.jsx(_,{})]}):e.jsx(r,{children:t.map(s=>e.jsx(Be,{postId:s},s))})},ht=()=>{const{searchParams:t}=$(),n=t.get("postId"),s=n&&/^\d+$/.test(n)&&Number(n)>0?Number(n):-1,{data:o,isFetching:a}=q({postId:s,incrementViewCount:!0});return a&&!o?e.jsx(Ye,{}):o?e.jsxs(e.Fragment,{children:[e.jsx(Xe,{post:o}),e.jsx(ut,{totalComments:o.commentCount})]}):e.jsxs(r,{sx:{pt:1.5},children:[e.jsx(g,{}),e.jsxs(r,{sx:{py:6,display:"flex",flexDirection:"column",alignItems:"center",gap:2},children:[e.jsx(ue,{sx:{fontSize:"6rem",color:"action.disabled"}}),e.jsx(c,{variant:"body1",component:"p",sx:{color:"text.secondary",textAlign:"center"},children:"貼文不存在或已被刪除"})]}),e.jsx(g,{}),e.jsxs(r,{sx:{position:"relative"},children:[e.jsx(r,{sx:{position:"absolute",inset:0,bgcolor:"divider",opacity:.35}}),e.jsx(c,{variant:"h6",sx:{p:2},children:"我們找不到這篇貼文...但你可能會喜歡這些！"})]}),e.jsx(g,{}),e.jsx(pt,{})]})};function jt(){const{isMd:t}=je();return e.jsxs(ge,{children:[e.jsx(Ce,{}),e.jsxs(ye,{children:[t?e.jsx(Se,{}):e.jsx(ke,{}),e.jsx(Fe,{maxWidth:"lg",sx:{position:"relative",my:10,px:0},children:e.jsxs(xe,{sx:{pb:3,borderRadius:3,border:"1px solid",borderColor:"divider"},elevation:1,children:[e.jsxs(r,{sx:{display:"flex",justifyContent:"center",mt:2,mx:2},children:[e.jsx(p,{href:V.forum_home,startIcon:e.jsx(pe,{}),variant:"outlined",sx:{textWrap:"nowrap"},children:t?"返回首頁":"首頁"}),e.jsx(r,{sx:{flex:1}}),e.jsxs(We,{variant:"text",children:[e.jsx(_e,{}),e.jsx(Ke,{})]})]}),e.jsx(ht,{})]})}),e.jsx(we,{})]})]})}me.createRoot(document.getElementById("root")).render(e.jsx(k.StrictMode,{children:e.jsx(jt,{})}));
