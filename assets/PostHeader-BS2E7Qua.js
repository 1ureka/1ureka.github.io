var D=t=>{throw TypeError(t)};var E=(t,e,s)=>e.has(t)||D("Cannot "+s);var d=(t,e,s)=>(E(t,e,"read from private field"),s?s.call(t):e.get(t)),j=(t,e,s)=>e.has(t)?D("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,s),L=(t,e,s,a)=>(E(t,e,"write to private field"),a?a.call(t,s):e.set(t,s),s),T=(t,e,s)=>(E(t,e,"access private method"),s);import{l as rt,k as ot,r as x,m as ct,j as c,s as lt,n as ut,p as ht,q as dt,v as mt,a7 as J,a8 as Y,g as _,T as C,e as $,a as O}from"./Toast-DTVs7FW6.js";import{Q as ft,n as gt,s as pt,d as yt,a as R,p as M,b as Q}from"./session-xflZUqIh.js";import{i as H,j as vt,k as bt,l as xt,s as kt,m as X,n as Pt,o as Z,p as I,B as wt}from"./ScrollArea-CqSHRPTv.js";import{T as tt}from"./DarkModeRounded-BRETPBpn.js";import{C as z,A as Ct}from"./url-Di9IlQWA.js";function St(t){return String(t).match(/[\d.\-+]*\s*(.*)/)[1]||""}function Mt(t){return parseFloat(t)}function Rt(t){return rt("MuiSkeleton",t)}ot("MuiSkeleton",["root","text","rectangular","rounded","circular","pulse","wave","withChildren","fitContent","heightAuto"]);const jt=t=>{const{classes:e,variant:s,animation:a,hasChildren:n,width:i,height:r}=t;return ht({root:["root",s,a,n&&"withChildren",n&&!i&&"fitContent",n&&!r&&"heightAuto"]},Rt,e)},K=Y`
  0% {
    opacity: 1;
  }

  50% {
    opacity: 0.4;
  }

  100% {
    opacity: 1;
  }
`,A=Y`
  0% {
    transform: translateX(-100%);
  }

  50% {
    /* +0.5s of delay between each loop */
    transform: translateX(100%);
  }

  100% {
    transform: translateX(100%);
  }
`,Lt=typeof K!="string"?J`
        animation: ${K} 2s ease-in-out 0.5s infinite;
      `:null,Tt=typeof A!="string"?J`
        &::after {
          animation: ${A} 2s linear 0.5s infinite;
        }
      `:null,Ft=lt("span",{name:"MuiSkeleton",slot:"Root",overridesResolver:(t,e)=>{const{ownerState:s}=t;return[e.root,e[s.variant],s.animation!==!1&&e[s.animation],s.hasChildren&&e.withChildren,s.hasChildren&&!s.width&&e.fitContent,s.hasChildren&&!s.height&&e.heightAuto]}})(dt(({theme:t})=>{const e=St(t.shape.borderRadius)||"px",s=Mt(t.shape.borderRadius);return{display:"block",backgroundColor:t.vars?t.vars.palette.Skeleton.bg:mt(t.palette.text.primary,t.palette.mode==="light"?.11:.13),height:"1.2em",variants:[{props:{variant:"text"},style:{marginTop:0,marginBottom:0,height:"auto",transformOrigin:"0 55%",transform:"scale(1, 0.60)",borderRadius:`${s}${e}/${Math.round(s/.6*10)/10}${e}`,"&:empty:before":{content:'"\\00a0"'}}},{props:{variant:"circular"},style:{borderRadius:"50%"}},{props:{variant:"rounded"},style:{borderRadius:(t.vars||t).shape.borderRadius}},{props:({ownerState:a})=>a.hasChildren,style:{"& > *":{visibility:"hidden"}}},{props:({ownerState:a})=>a.hasChildren&&!a.width,style:{maxWidth:"fit-content"}},{props:({ownerState:a})=>a.hasChildren&&!a.height,style:{height:"auto"}},{props:{animation:"pulse"},style:Lt||{animation:`${K} 2s ease-in-out 0.5s infinite`}},{props:{animation:"wave"},style:{position:"relative",overflow:"hidden",WebkitMaskImage:"-webkit-radial-gradient(white, black)","&::after":{background:`linear-gradient(
                90deg,
                transparent,
                ${(t.vars||t).palette.action.hover},
                transparent
              )`,content:'""',position:"absolute",transform:"translateX(-100%)",bottom:0,left:0,right:0,top:0}}},{props:{animation:"wave"},style:Tt||{"&::after":{animation:`${A} 2s linear 0.5s infinite`}}}]}})),N=x.forwardRef(function(e,s){const a=ct({props:e,name:"MuiSkeleton"}),{animation:n="pulse",className:i,component:r="span",height:l,style:h,variant:m="text",width:o,...u}=a,f={...a,animation:n,component:r,variant:m,hasChildren:!!u.children},p=jt(f);return c.jsx(Ft,{as:r,ref:s,className:ut(p.root,i),ownerState:f,...u,style:{width:o,height:l,...h}})});var qt=class extends ft{constructor(t,e){super(t,e)}bindMethods(){super.bindMethods(),this.fetchNextPage=this.fetchNextPage.bind(this),this.fetchPreviousPage=this.fetchPreviousPage.bind(this)}setOptions(t,e){super.setOptions({...t,behavior:H()},e)}getOptimisticResult(t){return t.behavior=H(),super.getOptimisticResult(t)}fetchNextPage(t){return this.fetch({...t,meta:{fetchMore:{direction:"forward"}}})}fetchPreviousPage(t){return this.fetch({...t,meta:{fetchMore:{direction:"backward"}}})}createResult(t,e){var y,v;const{state:s}=t,a=super.createResult(t,e),{isFetching:n,isRefetching:i,isError:r,isRefetchError:l}=a,h=(v=(y=s.fetchMeta)==null?void 0:y.fetchMore)==null?void 0:v.direction,m=r&&h==="forward",o=n&&h==="forward",u=r&&h==="backward",f=n&&h==="backward";return{...a,fetchNextPage:this.fetchNextPage,fetchPreviousPage:this.fetchPreviousPage,hasNextPage:bt(e,s.data),hasPreviousPage:vt(e,s.data),isFetchNextPageError:m,isFetchingNextPage:o,isFetchPreviousPageError:u,isFetchingPreviousPage:f,isRefetchError:l&&!m&&!u,isRefetching:i&&!o&&!f}}},P,w,g,b,k,q,U,G,Ot=(G=class extends xt{constructor(e,s){super();j(this,k);j(this,P);j(this,w);j(this,g);j(this,b);L(this,P,e),this.setOptions(s),this.bindMethods(),T(this,k,q).call(this)}bindMethods(){this.mutate=this.mutate.bind(this),this.reset=this.reset.bind(this)}setOptions(e){var a;const s=this.options;this.options=d(this,P).defaultMutationOptions(e),kt(this.options,s)||d(this,P).getMutationCache().notify({type:"observerOptionsUpdated",mutation:d(this,g),observer:this}),s!=null&&s.mutationKey&&this.options.mutationKey&&X(s.mutationKey)!==X(this.options.mutationKey)?this.reset():((a=d(this,g))==null?void 0:a.state.status)==="pending"&&d(this,g).setOptions(this.options)}onUnsubscribe(){var e;this.hasListeners()||(e=d(this,g))==null||e.removeObserver(this)}onMutationUpdate(e){T(this,k,q).call(this),T(this,k,U).call(this,e)}getCurrentResult(){return d(this,w)}reset(){var e;(e=d(this,g))==null||e.removeObserver(this),L(this,g,void 0),T(this,k,q).call(this),T(this,k,U).call(this)}mutate(e,s){var a;return L(this,b,s),(a=d(this,g))==null||a.removeObserver(this),L(this,g,d(this,P).getMutationCache().build(d(this,P),this.options)),d(this,g).addObserver(this),d(this,g).execute(e)}},P=new WeakMap,w=new WeakMap,g=new WeakMap,b=new WeakMap,k=new WeakSet,q=function(){var s;const e=((s=d(this,g))==null?void 0:s.state)??Pt();L(this,w,{...e,isPending:e.status==="pending",isSuccess:e.status==="success",isError:e.status==="error",isIdle:e.status==="idle",mutate:this.mutate,reset:this.reset})},U=function(e){Z.batch(()=>{var s,a,n,i,r,l,h,m;if(d(this,b)&&this.hasListeners()){const o=d(this,w).variables,u=d(this,w).context;(e==null?void 0:e.type)==="success"?((a=(s=d(this,b)).onSuccess)==null||a.call(s,e.data,o,u),(i=(n=d(this,b)).onSettled)==null||i.call(n,e.data,null,o,u)):(e==null?void 0:e.type)==="error"&&((l=(r=d(this,b)).onError)==null||l.call(r,e.error,o,u),(m=(h=d(this,b)).onSettled)==null||m.call(h,void 0,e.error,o,u))}this.listeners.forEach(o=>{o(d(this,w))})})},G);function et(t,e){const s=I(),[a]=x.useState(()=>new Ot(s,t));x.useEffect(()=>{a.setOptions(t)},[a,t]);const n=x.useSyncExternalStore(x.useCallback(r=>a.subscribe(Z.batchCalls(r)),[a]),()=>a.getCurrentResult(),()=>a.getCurrentResult()),i=x.useCallback((r,l)=>{a.mutate(r,l).catch(gt)},[a]);if(n.error&&pt(a.options.throwOnError,[n.error]))throw n.error;return{...n,mutate:i,mutateAsync:n.mutate}}function Et(t,e){return yt(t,qt)}const Gt=_(c.jsx("path",{d:"M16.5 6.75v10.58c0 2.09-1.53 3.95-3.61 4.15-2.39.23-4.39-1.64-4.39-3.98V5.14c0-1.31.94-2.5 2.24-2.63 1.5-.15 2.76 1.02 2.76 2.49v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6.75c0-.41-.34-.75-.75-.75s-.75.34-.75.75v8.61c0 1.31.94 2.5 2.24 2.63 1.5.15 2.76-1.02 2.76-2.49V5.17c0-2.09-1.53-3.95-3.61-4.15C9.01.79 7 2.66 7 5v12.27c0 2.87 2.1 5.44 4.96 5.71 3.29.3 6.04-2.26 6.04-5.48V6.75c0-.41-.34-.75-.75-.75s-.75.34-.75.75"}),"AttachFileRounded"),Nt=(t,e,s="asc")=>[...t].sort((a,n)=>{const i=a[e],r=n[e];if(i===r)return 0;const l=i<r?-1:1;return s==="asc"?l:-l}),V=async({pageParam:t=0,limit:e=10,topic:s,author:a,orderBy:n,order:i="asc"}={})=>{await new Promise(u=>setTimeout(u,Math.random()*1e3));let r=M;s&&(r=M.filter(u=>u.tags.includes(s))),a&&(r=r.filter(u=>u.author===a)),n&&Object.keys(M[0]).includes(n)&&(r=Nt(r,n,i));const l=r.map(({id:u})=>u),h=t*e,m=h+e;return{items:l.slice(h,m),nextPage:m<l.length?t+1:null,totalItems:l.length,totalPages:Math.ceil(l.length/e)}},$t=async({author:t,topic:e}={})=>{await new Promise(i=>setTimeout(i,Math.random()*1e3));let s=M;t&&(s=s.filter(i=>i.author===t)),e&&(s=s.filter(i=>i.tags.includes(e)));const a=s.reduce((i,r)=>i+r.likeCount,0),n=s.reduce((i,r)=>i+r.viewCount,0);return{totalPosts:s.length,totalLikes:a,totalViews:n}},Kt=async t=>(await new Promise(e=>setTimeout(e,Math.random()*1e3)),M.find(e=>e.id===t)??null),At=async()=>(await new Promise(t=>setTimeout(t,Math.random()*1e3)),[...new Set(M.flatMap(t=>t.tags))]),F=1*60*1e3,Jt=({limit:t,topic:e,author:s,orderBy:a,order:n}={})=>R({queryKey:["posts",t,e,s,a,n],queryFn:async()=>(await V({pageParam:0,limit:t,topic:e,author:s,orderBy:a,order:n})).items,staleTime:F}),Yt=({topic:t}={})=>R({queryKey:["postCounts",t],queryFn:async()=>(await V({pageParam:0,topic:t,limit:1})).totalItems,staleTime:F}),Zt=({limit:t=6,topic:e,author:s,orderBy:a,order:n}={})=>{const{data:i,fetchNextPage:r,hasNextPage:l,isFetchingNextPage:h,isLoading:m}=Et({queryKey:["infinitePosts",t,e,s,a,n],queryFn:({pageParam:o})=>V({pageParam:o,limit:t,topic:e,author:s,orderBy:a,order:n}),initialPageParam:0,getNextPageParam:o=>o.nextPage,staleTime:F});return x.useEffect(()=>{const o=document.getElementById("scroll-area");if(!o)return;const u=()=>{const f=o.scrollHeight,p=o.scrollTop,y=o.clientHeight;p+y>=f-100&&l&&!h&&r()};return o.addEventListener("scroll",u),()=>o.removeEventListener("scroll",u)},[r,l,h]),{data:i,isLoading:m,isFetchingNextPage:h}},te=(t={})=>R({queryKey:["postStats",t.author,t.topic],queryFn:()=>$t(t),staleTime:F}),ee=()=>R({queryKey:["tags"],queryFn:At,staleTime:F}),se=t=>R({queryKey:["post",t],queryFn:()=>t===void 0||Number.isNaN(t)?null:Kt(t),enabled:t!==void 0&&!Number.isNaN(t)&&t>=0,staleTime:F}),ae=_(c.jsx("path",{d:"M12 4C7 4 2.73 7.11 1 11.5 2.73 15.89 7 19 12 19s9.27-3.11 11-7.5C21.27 7.11 17 4 12 4m0 12.5c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5m0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"}),"VisibilityRounded"),Ut=_(c.jsx("path",{d:"M13.12 2.06 7.58 7.6c-.37.37-.58.88-.58 1.41V19c0 1.1.9 2 2 2h9c.8 0 1.52-.48 1.84-1.21l3.26-7.61C23.94 10.2 22.49 8 20.34 8h-5.65l.95-4.58c.1-.5-.05-1.01-.41-1.37-.59-.58-1.53-.58-2.11.01M3 21c1.1 0 2-.9 2-2v-8c0-1.1-.9-2-2-2s-2 .9-2 2v8c0 1.1.9 2 2 2"}),"ThumbUpRounded"),S=new Map,W=new Map,B=(t,e,s)=>`${t}:${e}:${s}`,_t=async({postId:t,type:e="like"})=>{var i;await new Promise(r=>setTimeout(r,Math.random()*1e3));const s=B(t,1,e),a=((i=M.find(r=>r.id===t))==null?void 0:i.likeCount)||0;return S.has(s)?a+(S.get(s)?1:0):a},st=async({postId:t,type:e="like"})=>{await new Promise(n=>setTimeout(n,Math.random()*1e3));const s=B(t,1,e),a=S.has(s)?S.get(s):Math.random()<.5;return S.has(s)||S.set(s,a),a},at=async({postId:t,type:e,value:s})=>{await new Promise(i=>setTimeout(i,Math.random()*1e3));const a=B(t,1,e),n=Date.now();W.set(a,n),W.get(a)===n&&S.set(a,s)},nt=0,Qt=t=>{const{user:e,authenticated:s,loading:a}=Q(),n={isLiked:!1,likeCount:0},{data:i,isLoading:r,isError:l}=R({staleTime:nt,queryKey:["likeStatus",t,e==null?void 0:e.id],enabled:!a,queryFn:async()=>{const o=n;return o.likeCount=await _t({postId:t,type:"like"}),s&&(o.isLiked=await st({postId:t,type:"like"})),o}}),{isLiked:h,likeCount:m}=i??n;return{isLiked:h,likeCount:m,isLoading:r||a||l}},It=t=>{const e=I(),{user:s,authenticated:a,loading:n}=Q(),{isLiked:i,likeCount:r,isLoading:l}=Qt(t),h=!a||n||l||(s==null?void 0:s.id)===void 0,m=x.useRef(0),{mutate:o}=et({mutationFn:async f=>at({postId:t,type:"like",value:f}),onMutate:()=>(m.current++,m.current),onSettled:(f,p,y,v)=>{v===m.current&&e.invalidateQueries({queryKey:["likeStatus",t,s==null?void 0:s.id]})}});return{isLiked:i,likeCount:r,handleLike:h?()=>{}:async()=>{await e.cancelQueries({queryKey:["likeStatus",t,s==null?void 0:s.id]}),e.setQueryData(["likeStatus",t,s==null?void 0:s.id],f=>{const p=!f.isLiked;return o(p),{isLiked:p,likeCount:f.likeCount+(p?1:-1)}})},loading:l,disabled:h}},ne=t=>{const e=I(),{user:s,authenticated:a,loading:n}=Q(),{data:i,isLoading:r,isError:l}=R({staleTime:nt,queryKey:["favoriteStatus",t,s==null?void 0:s.id],enabled:!n&&a,queryFn:async()=>st({postId:t,type:"favorite"})}),h=i??!1,m=r||n||l,o=!a||m||(s==null?void 0:s.id)===void 0,u=x.useRef(0),{mutate:f}=et({mutationFn:async y=>at({postId:t,type:"favorite",value:y}),onMutate:()=>(u.current++,u.current),onSettled:(y,v,Vt,it)=>{it===u.current&&e.invalidateQueries({queryKey:["favoriteStatus",t,s==null?void 0:s.id]})}});return{isFavorited:h,handleFavorite:o?()=>{}:async()=>{await e.cancelQueries({queryKey:["favoriteStatus",t,s==null?void 0:s.id]}),e.setQueryData(["favoriteStatus",t,s==null?void 0:s.id],y=>{const v=!y;return f(v),v})},loading:m,disabled:o}},ie=({postId:t})=>{const{isLiked:e,likeCount:s,handleLike:a,loading:n,disabled:i}=It(t);return c.jsx(tt,{title:e?"取消喜歡":"喜歡",arrow:!0,placement:"left",children:c.jsx("span",{children:c.jsx(wt,{startIcon:c.jsx(Ut,{}),size:"small",color:e?"primary":"inherit",onClick:a,disabled:i,loading:n,children:c.jsxs(C,{variant:"caption",component:"span",children:[s," 個讚"]})})})})},re=({post:t,displayCount:e=3})=>{const{tags:s,id:a}=t;return c.jsxs(c.Fragment,{children:[s.map((n,i)=>i<e&&c.jsx(z,{label:n,clickable:!0,size:"small",component:"a",href:`${$.forum_posts}?topic=${n}`},n)),s.length>e&&c.jsx(z,{label:`+${s.length-e}`,clickable:!0,size:"small",variant:"outlined",component:"a",href:`${$.forum_post}?postId=${a}`})]})},oe=({post:t,sx:e,...s})=>{const a=Math.abs(t.updatedAt.getTime()-t.createdAt.getTime())>1e3;return c.jsxs(O,{sx:{display:"flex",gap:1.5,mb:2,alignItems:"center",...e},...s,children:[c.jsx(Ct,{sx:{bgcolor:"primary.main",width:"2rem",height:"2rem"},children:c.jsx(C,{sx:{translate:"0px 5%"},children:t.author.slice(0,1).toUpperCase()})}),c.jsxs(C,{variant:"subtitle1",component:"a",href:`${$.forum_users}?user=${t.author}`,sx:{color:"text.secondary",textDecoration:"none","&:hover":{textDecoration:"underline",color:"text.primary"}},children:["by ",t.author]}),c.jsx(O,{sx:{flex:1}}),a?c.jsx(tt,{title:`上次編輯於 ${t.updatedAt.toLocaleString()}`,arrow:!0,children:c.jsxs(C,{variant:"body2",sx:{color:"text.secondary",opacity:.9,"&:hover":{textDecoration:"underline"}},children:["*",t.createdAt.toLocaleString()]})}):c.jsx(C,{variant:"body2",sx:{color:"text.secondary",opacity:.9},children:t.createdAt.toLocaleString()})]})},ce=({sx:t,...e})=>c.jsxs(O,{sx:{display:"flex",gap:1.5,mb:2,alignItems:"center",...t},...e,children:[c.jsx(N,{variant:"circular",sx:{width:"2rem",height:"2rem"},animation:"wave"}),c.jsx(N,{variant:"rounded",animation:"wave",children:c.jsx(C,{variant:"subtitle1",children:"by loading..."})}),c.jsx(O,{sx:{flex:1}}),c.jsx(N,{variant:"rounded",animation:"wave",children:c.jsx(C,{variant:"body2",children:"0000-00-00 00:00"})})]});export{Gt as A,ce as L,oe as P,N as S,Ut as T,ae as V,se as a,ee as b,re as c,ie as d,Yt as e,Zt as f,te as g,ne as h,Jt as u};
