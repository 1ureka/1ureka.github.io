import{as as pe,at as me,r as E,j as F,c as Xt,b as Et,d as ve,au as ge,g as ye,s as Wt,u as Yt,Y as Zt,an as Me,m as Se,a6 as be,O as Fe,av as we,N as $t,aw as Ut,X as ht,ac as Mt,K as Ee,ax as Bt,I as te,l as ee,B as Ve,T as Te,w as Ae,M as se,y as Ce,h as $e}from"./Toast-DD81e0ZS.js";import{D as Ie}from"./DarkModeRounded-BpbMOGed.js";import{T as ke}from"./Tooltip-D4y8LWrL.js";import{i as X,g as ft,D as Pe,u as K}from"./useMutation-tmXyHxVB.js";import{M as Y}from"./MenuItem-MyiTB2I2.js";import{u as nt}from"./SQLiteClient-DE74qkCZ.js";import{u as U}from"./react-error-boundary.esm-DV-Hw4di.js";import{l as Oe,h as xe,i as _e,j as De,k as Re,r as Ne,g as tt,s as N,d as qe}from"./ScrollArea-Cw1iuxp9.js";import{r as Le}from"./routes-J5yqRWDh.js";import{w as We}from"./with-selector-Deie_L8r.js";const je=ge(),He=pe("div",{name:"MuiContainer",slot:"Root",overridesResolver:(e,i)=>{const{ownerState:s}=e;return[i.root,i[`maxWidth${Et(String(s.maxWidth))}`],s.fixed&&i.fixed,s.disableGutters&&i.disableGutters]}}),Ke=e=>me({props:e,name:"MuiContainer",defaultTheme:je}),Ue=(e,i)=>{const s=h=>ye(i,h),{classes:t,fixed:r,disableGutters:n,maxWidth:a}=e,o={root:["root",a&&`maxWidth${Et(String(a))}`,r&&"fixed",n&&"disableGutters"]};return ve(o,s,t)};function Be(e={}){const{createStyledComponent:i=He,useThemeProps:s=Ke,componentName:t="MuiContainer"}=e,r=i(({theme:a,ownerState:o})=>({width:"100%",marginLeft:"auto",boxSizing:"border-box",marginRight:"auto",...!o.disableGutters&&{paddingLeft:a.spacing(2),paddingRight:a.spacing(2),[a.breakpoints.up("sm")]:{paddingLeft:a.spacing(3),paddingRight:a.spacing(3)}}}),({theme:a,ownerState:o})=>o.fixed&&Object.keys(a.breakpoints.values).reduce((h,u)=>{const d=u,c=a.breakpoints.values[d];return c!==0&&(h[a.breakpoints.up(d)]={maxWidth:`${c}${a.breakpoints.unit}`}),h},{}),({theme:a,ownerState:o})=>({...o.maxWidth==="xs"&&{[a.breakpoints.up("xs")]:{maxWidth:Math.max(a.breakpoints.values.xs,444)}},...o.maxWidth&&o.maxWidth!=="xs"&&{[a.breakpoints.up(o.maxWidth)]:{maxWidth:`${a.breakpoints.values[o.maxWidth]}${a.breakpoints.unit}`}}}));return E.forwardRef(function(o,h){const u=s(o),{className:d,component:c="div",disableGutters:l=!1,fixed:f=!1,maxWidth:p="lg",classes:v,...g}=u,S={...u,component:c,disableGutters:l,fixed:f,maxWidth:p},m=Ue(S,t);return F.jsx(r,{as:c,ownerState:S,className:Xt(m.root,d),ref:h,...g})})}const Rs=Be({createStyledComponent:Wt("div",{name:"MuiContainer",slot:"Root",overridesResolver:(e,i)=>{const{ownerState:s}=e;return[i.root,i[`maxWidth${Et(String(s.maxWidth))}`],s.fixed&&i.fixed,s.disableGutters&&i.disableGutters]}}),useThemeProps:e=>Yt({props:e,name:"MuiContainer"})});function ze(e){const{children:i,defer:s=!1,fallback:t=null}=e,[r,n]=E.useState(!1);return Zt(()=>{s||n(!0)},[s]),E.useEffect(()=>{s&&n(!0)},[s]),r?i:t}const Je=Wt("div",{shouldForwardProp:Me})(Se(({theme:e})=>({position:"fixed",top:0,left:0,bottom:0,zIndex:e.zIndex.drawer-1,variants:[{props:{anchor:"left"},style:{right:"auto"}},{props:{anchor:"right"},style:{left:"auto",right:0}},{props:{anchor:"top"},style:{bottom:"auto",right:0}},{props:{anchor:"bottom"},style:{top:"auto",bottom:0,right:0}}]}))),Qe=E.forwardRef(function(i,s){const{anchor:t,classes:r={},className:n,width:a,style:o,...h}=i,u=i;return F.jsx(Je,{className:Xt("PrivateSwipeArea-root",r.root,r[`anchor${Et(t)}`],n),ref:s,style:{[X(t)?"width":"height"]:a,...o},ownerState:u,...h})}),pt=3,zt=20;let j=null;function It(e,i,s){return e==="right"?s.body.offsetWidth-i[0].pageX:i[0].pageX}function kt(e,i,s){return e==="bottom"?s.innerHeight-i[0].clientY:i[0].clientY}function et(e,i){return e?i.clientWidth:i.clientHeight}function Jt(e,i,s,t){return Math.min(Math.max(s?i-e:t+i-e,0),t)}function Ge(e,i){const s=[];for(;e&&e!==i.parentElement;){const t=Mt(i).getComputedStyle(e);t.getPropertyValue("position")==="absolute"||t.getPropertyValue("overflow-x")==="hidden"||(e.clientWidth>0&&e.scrollWidth>e.clientWidth||e.clientHeight>0&&e.scrollHeight>e.clientHeight)&&s.push(e),e=e.parentElement}return s}function Xe({domTreeShapes:e,start:i,current:s,anchor:t}){const r={scrollPosition:{x:"scrollLeft",y:"scrollTop"},scrollLength:{x:"scrollWidth",y:"scrollHeight"},clientLength:{x:"clientWidth",y:"clientHeight"}};return e.some(n=>{let a=s>=i;(t==="top"||t==="left")&&(a=!a);const o=t==="left"||t==="right"?"x":"y",h=Math.round(n[r.scrollPosition[o]]),u=h>0,d=h+n[r.clientLength[o]]<n[r.scrollLength[o]];return!!(a&&d||!a&&u)})}const Ye=typeof navigator<"u"&&/iPad|iPhone|iPod/.test(navigator.userAgent),Ze=E.forwardRef(function(i,s){const t=Yt({name:"MuiSwipeableDrawer",props:i}),r=be(),n={enter:r.transitions.duration.enteringScreen,exit:r.transitions.duration.leavingScreen},{anchor:a="left",disableBackdropTransition:o=!1,disableDiscovery:h=!1,disableSwipeToOpen:u=Ye,hideBackdrop:d,hysteresis:c=.52,allowSwipeInChildren:l=!1,minFlingVelocity:f=450,ModalProps:{BackdropProps:p,...v}={},onClose:g,onOpen:S,open:m=!1,PaperProps:V={},SwipeAreaProps:I,swipeAreaWidth:O=20,transitionDuration:_=n,variant:T="temporary",slots:$={},slotProps:q={},...Q}=t,[z,J]=E.useState(!1),y=E.useRef({isSwiping:null}),ot=E.useRef(),b=E.useRef(),w=E.useRef(),de=Fe(V.ref,w),lt=E.useRef(!1),Tt=E.useRef();Zt(()=>{Tt.current=null},[m]);const ut=E.useCallback((M,D={})=>{const{mode:A=null,changeTransition:C=!0}=D,k=ft(r,a),P=["right","bottom"].includes(k)?1:-1,L=X(a),R=L?`translate(${P*M}px, 0)`:`translate(0, ${P*M}px)`,G=w.current.style;G.webkitTransform=R,G.transform=R;let x="";if(A&&(x=r.transitions.create("all",we({easing:void 0,style:void 0,timeout:_},{mode:A}))),C&&(G.webkitTransition=x,G.transition=x),!o&&!d){const W=b.current.style;W.opacity=1-M/et(L,w.current),C&&(W.webkitTransition=x,W.transition=x)}},[a,o,d,r,_]),ct=$t(M=>{if(!lt.current)return;if(j=null,lt.current=!1,Ut.flushSync(()=>{J(!1)}),!y.current.isSwiping){y.current.isSwiping=null;return}y.current.isSwiping=null;const D=ft(r,a),A=X(a);let C;A?C=It(D,M.changedTouches,ht(M.currentTarget)):C=kt(D,M.changedTouches,Mt(M.currentTarget));const k=A?y.current.startX:y.current.startY,P=et(A,w.current),L=Jt(C,k,m,P),R=L/P;if(Math.abs(y.current.velocity)>f&&(Tt.current=Math.abs((P-L)/y.current.velocity)*1e3),m){y.current.velocity>f||R>c?g():ut(0,{mode:"exit"});return}y.current.velocity<-f||1-R>c?S():ut(et(A,w.current),{mode:"enter"})}),Kt=(M=!1)=>{if(!z){(M||!(h&&l))&&Ut.flushSync(()=>{J(!0)});const D=X(a);!m&&w.current&&ut(et(D,w.current)+(h?15:-20),{changeTransition:!1}),y.current.velocity=0,y.current.lastTime=null,y.current.lastTranslate=null,y.current.paperHit=!1,lt.current=!0}},At=$t(M=>{if(!w.current||!lt.current||j!==null&&j!==y.current)return;Kt(!0);const D=ft(r,a),A=X(a),C=It(D,M.touches,ht(M.currentTarget)),k=kt(D,M.touches,Mt(M.currentTarget));if(m&&w.current.contains(M.target)&&j===null){const x=Ge(M.target,w.current);if(Xe({domTreeShapes:x,start:A?y.current.startX:y.current.startY,current:A?C:k,anchor:a})){j=!0;return}j=y.current}if(y.current.isSwiping==null){const x=Math.abs(C-y.current.startX),W=Math.abs(k-y.current.startY),dt=A?x>W&&x>pt:W>x&&W>pt;if(dt&&M.cancelable&&M.preventDefault(),dt===!0||(A?W>pt:x>pt)){if(y.current.isSwiping=dt,!dt){ct(M);return}y.current.startX=C,y.current.startY=k,!h&&!m&&(A?y.current.startX-=zt:y.current.startY-=zt)}}if(!y.current.isSwiping)return;const P=et(A,w.current);let L=A?y.current.startX:y.current.startY;m&&!y.current.paperHit&&(L=Math.min(L,P));const R=Jt(A?C:k,L,m,P);if(m)if(y.current.paperHit)R===0&&(y.current.startX=C,y.current.startY=k);else if(A?C<P:k<P)y.current.paperHit=!0,y.current.startX=C,y.current.startY=k;else return;y.current.lastTranslate===null&&(y.current.lastTranslate=R,y.current.lastTime=performance.now()+1);const G=(R-y.current.lastTranslate)/(performance.now()-y.current.lastTime)*1e3;y.current.velocity=y.current.velocity*.4+G*.6,y.current.lastTranslate=R,y.current.lastTime=performance.now(),M.cancelable&&M.preventDefault(),ut(R)}),Ct=$t(M=>{var P;if(M.defaultPrevented||M.defaultMuiPrevented||m&&(d||!b.current.contains(M.target))&&!w.current.contains(M.target))return;const D=ft(r,a),A=X(a),C=It(D,M.touches,ht(M.currentTarget)),k=kt(D,M.touches,Mt(M.currentTarget));if(!m){if(u||!(M.target===ot.current||(P=w.current)!=null&&P.contains(M.target)&&(typeof l=="function"?l(M,ot.current,w.current):l)))return;if(A){if(C>O)return}else if(k>O)return}M.defaultMuiPrevented=!0,j=null,y.current.startX=C,y.current.startY=k,Kt()});E.useEffect(()=>{if(T==="temporary"){const M=ht(w.current);return M.addEventListener("touchstart",Ct),M.addEventListener("touchmove",At,{passive:!m}),M.addEventListener("touchend",ct),()=>{M.removeEventListener("touchstart",Ct),M.removeEventListener("touchmove",At,{passive:!m}),M.removeEventListener("touchend",ct)}}},[T,m,Ct,At,ct]),E.useEffect(()=>()=>{j===y.current&&(j=null)},[]),E.useEffect(()=>{m||J(!1)},[m]);const[he,fe]=Ee("swipeArea",{ref:ot,elementType:Qe,ownerState:t,externalForwardedProps:{slots:$,slotProps:{swipeArea:I,...q}},additionalProps:{width:O,anchor:a}});return F.jsxs(E.Fragment,{children:[F.jsx(Pe,{open:T==="temporary"&&z?!0:m,variant:T,ModalProps:{BackdropProps:{...p,ref:b},...T==="temporary"&&{keepMounted:!0},...v},hideBackdrop:d,anchor:a,transitionDuration:Tt.current||_,onClose:g,ref:s,slots:$,slotProps:{...q,backdrop:Bt(q.backdrop??p,{ref:b}),paper:Bt(q.paper??V,{style:{pointerEvents:T==="temporary"&&!m&&!l?"none":""},ref:de})},...Q}),!u&&T==="temporary"&&F.jsx(ze,{children:F.jsx(he,{...fe})})]})}),Ns=()=>{const[e,i]=E.useState(null),s=r=>i(r.currentTarget),t=()=>i(null);return F.jsxs(F.Fragment,{children:[F.jsx(ke,{title:"切換主題",arrow:!0,children:F.jsx(te,{onClick:s,children:F.jsx(Ie,{fontSize:"small"})})}),F.jsx(ts,{open:!!e,anchorEl:e,onClose:t,anchorOrigin:{horizontal:"center",vertical:"bottom"},transformOrigin:{horizontal:"center",vertical:"top"}})]})},ts=({onClose:e,...i})=>{const{mode:s,setMode:t}=ee(),r=n=>()=>{t(n),e()};return F.jsx(Ce,{anchorOrigin:{horizontal:"right",vertical:"top"},onClose:e,...i,children:F.jsxs(se,{dense:!0,children:[F.jsx(Y,{onClick:r("light"),selected:s==="light",children:"淺色"}),F.jsx(Y,{onClick:r("dark"),selected:s==="dark",children:"暗色"}),F.jsx(Y,{onClick:r("system"),selected:s==="system",children:"跟隨系統"})]})})},es=Wt("div")(({theme:e})=>({width:30,height:6,backgroundColor:e.palette.divider,borderRadius:3,position:"relative",left:"calc(50% - 15px)",...e.applyStyles("dark",{backgroundColor:e.palette.divider})})),qs=({onClose:e,...i})=>{const{mode:s,setMode:t}=ee(),r=n=>()=>{t(n),e()};return F.jsxs(Ze,{anchor:"top",onClose:e,...i,children:[F.jsxs(Ve,{sx:{p:3,display:"flex",alignItems:"center",justifyContent:"space-between"},children:[F.jsx(Te,{variant:"h6",children:"切換主題"}),F.jsx(te,{onClick:e,children:F.jsx(Ae,{})})]}),F.jsxs(se,{dense:!0,children:[F.jsx(Y,{onClick:r("light"),selected:s==="light",children:"淺色"}),F.jsx(Y,{onClick:r("dark"),selected:s==="dark",children:"暗色"}),F.jsx(Y,{onClick:r("system"),selected:s==="system",children:"跟隨系統"})]}),F.jsx(es,{sx:{mb:2}})]})},ss=1e3*60*5,Ls=()=>{const{data:e,isFetching:i,error:s}=nt({queryKey:["session"],queryFn:()=>tt({server:!1}),staleTime:ss});return i?{authenticated:!1,user:null,loading:!0,error:null}:s?{authenticated:!1,user:null,loading:!1,error:s instanceof Error?s.message:"未知錯誤"}:e||{authenticated:!1,user:null,loading:!1,error:null}},Ws=()=>{const e=U();return K({mutationFn:Re,onSettled:()=>{e.invalidateQueries({queryKey:["session"]})}})},js=()=>{const e=U();return K({mutationFn:Oe,onSettled:()=>{e.invalidateQueries({queryKey:[]})}})},Hs=()=>{const e=U();return K({mutationFn:Ne,onSettled:()=>{e.invalidateQueries({queryKey:["session"]})}})},Ks=()=>{const e=U();return K({mutationFn:xe,onSettled:()=>{e.invalidateQueries({queryKey:["session"]})}})},Us=()=>{const e=U();return K({mutationFn:_e,onSettled:()=>{e.invalidateQueries({queryKey:["session"]})}})},Bs=()=>{const e=U();return K({mutationFn:De,onSuccess:()=>{window.location.href=Le.forum_home},onSettled:()=>{e.invalidateQueries({queryKey:["session"]})}})},Z=new WeakMap,St=new WeakMap,bt={current:[]};let Pt=!1,it=0;const rt=new Set,mt=new Map;function re(e){const i=Array.from(e).sort((s,t)=>s instanceof H&&s.options.deps.includes(t)?1:t instanceof H&&t.options.deps.includes(s)?-1:0);for(const s of i){if(bt.current.includes(s))continue;bt.current.push(s),s.recompute();const t=St.get(s);if(t)for(const r of t){const n=Z.get(r);n&&re(n)}}}function rs(e){e.listeners.forEach(i=>i({prevVal:e.prevState,currentVal:e.state}))}function is(e){e.listeners.forEach(i=>i({prevVal:e.prevState,currentVal:e.state}))}function ie(e){if(it>0&&!mt.has(e)&&mt.set(e,e.prevState),rt.add(e),!(it>0)&&!Pt)try{for(Pt=!0;rt.size>0;){const i=Array.from(rt);rt.clear();for(const s of i){const t=mt.get(s)??s.prevState;s.prevState=t,rs(s)}for(const s of i){const t=Z.get(s);t&&(bt.current.push(s),re(t))}for(const s of i){const t=Z.get(s);if(t)for(const r of t)is(r)}}}finally{Pt=!1,bt.current=[],mt.clear()}}function B(e){it++;try{e()}finally{if(it--,it===0){const i=Array.from(rt)[0];i&&ie(i)}}}class Dt{constructor(i,s){this.listeners=new Set,this.subscribe=t=>{var r,n;this.listeners.add(t);const a=(n=(r=this.options)==null?void 0:r.onSubscribe)==null?void 0:n.call(r,t,this);return()=>{this.listeners.delete(t),a==null||a()}},this.setState=t=>{var r,n,a;this.prevState=this.state,this.state=(r=this.options)!=null&&r.updateFn?this.options.updateFn(this.prevState)(t):t(this.prevState),(a=(n=this.options)==null?void 0:n.onUpdate)==null||a.call(n),ie(this)},this.prevState=i,this.state=i,this.options=s}}class H{constructor(i){this.listeners=new Set,this._subscriptions=[],this.lastSeenDepValues=[],this.getDepVals=()=>{const s=[],t=[];for(const r of this.options.deps)s.push(r.prevState),t.push(r.state);return this.lastSeenDepValues=t,{prevDepVals:s,currDepVals:t,prevVal:this.prevState??void 0}},this.recompute=()=>{var s,t;this.prevState=this.state;const{prevDepVals:r,currDepVals:n,prevVal:a}=this.getDepVals();this.state=this.options.fn({prevDepVals:r,currDepVals:n,prevVal:a}),(t=(s=this.options).onUpdate)==null||t.call(s)},this.checkIfRecalculationNeededDeeply=()=>{for(const n of this.options.deps)n instanceof H&&n.checkIfRecalculationNeededDeeply();let s=!1;const t=this.lastSeenDepValues,{currDepVals:r}=this.getDepVals();for(let n=0;n<r.length;n++)if(r[n]!==t[n]){s=!0;break}s&&this.recompute()},this.mount=()=>(this.registerOnGraph(),this.checkIfRecalculationNeededDeeply(),()=>{this.unregisterFromGraph();for(const s of this._subscriptions)s()}),this.subscribe=s=>{var t,r;this.listeners.add(s);const n=(r=(t=this.options).onSubscribe)==null?void 0:r.call(t,s,this);return()=>{this.listeners.delete(s),n==null||n()}},this.options=i,this.state=i.fn({prevDepVals:void 0,prevVal:void 0,currDepVals:this.getDepVals().currDepVals})}registerOnGraph(i=this.options.deps){for(const s of i)if(s instanceof H)s.registerOnGraph(),this.registerOnGraph(s.options.deps);else if(s instanceof Dt){let t=Z.get(s);t||(t=new Set,Z.set(s,t)),t.add(this);let r=St.get(this);r||(r=new Set,St.set(this,r)),r.add(s)}}unregisterFromGraph(i=this.options.deps){for(const s of i)if(s instanceof H)this.unregisterFromGraph(s.options.deps);else if(s instanceof Dt){const t=Z.get(s);t&&t.delete(this);const r=St.get(this);r&&r.delete(s)}}}function Vt(e,i){return typeof e=="function"?e(i):e}function ne(e,i){return jt(i).reduce((t,r)=>{if(t===null)return null;if(typeof t<"u")return t[r]},e)}function Ot(e,i,s){const t=jt(i);function r(n){if(!t.length)return Vt(s,n);const a=t.shift();if(typeof a=="string"||typeof a=="number"&&!Array.isArray(n))return typeof n=="object"?(n===null&&(n={}),{...n,[a]:r(n[a])}):{[a]:r()};if(Array.isArray(n)&&typeof a=="number"){const o=n.slice(0,a);return[...o.length?o:new Array(a),r(n[a]),...n.slice(a+1)]}return[...new Array(a),r()]}return r(e)}function ns(e,i){const s=jt(i);function t(r){if(!r)return;if(s.length===1){const a=s[0];if(Array.isArray(r)&&typeof a=="number")return r.filter((u,d)=>d!==a);const{[a]:o,...h}=r;return h}const n=s.shift();if(typeof n=="string"&&typeof r=="object")return{...r,[n]:t(r[n])};if(typeof n=="number"&&Array.isArray(r)){if(n>=r.length)return r;const a=r.slice(0,n);return[...a.length?a:new Array(n),t(r[n]),...r.slice(n+1)]}throw new Error("It seems we have created an infinite loop in deleteBy. ")}return t(e)}const as=/^(\d*)$/gm,os=/\.(\d*)\./gm,ls=/^(\d*)\./gm,us=/\.(\d*$)/gm,cs=/\.{2,}/gm,Rt="__int__",vt=`${Rt}$1`;function jt(e){if(Array.isArray(e))return[...e];if(typeof e!="string")throw new Error("Path must be a string.");return e.replace(/\[/g,".").replace(/\]/g,"").replace(as,vt).replace(os,`.${vt}.`).replace(ls,`${vt}.`).replace(us,`.${vt}`).replace(cs,".").split(".").map(i=>i.indexOf(Rt)===0?parseInt(i.substring(Rt.length),10):i)}function ds(e){return!(Array.isArray(e)&&e.length===0)}function Nt(e,i){const{asyncDebounceMs:s}=i,{onChangeAsync:t,onBlurAsync:r,onSubmitAsync:n,onBlurAsyncDebounceMs:a,onChangeAsyncDebounceMs:o}=i.validators||{},h=s??0,u={cause:"change",validate:t,debounceMs:o??h},d={cause:"blur",validate:r,debounceMs:a??h},c={cause:"submit",validate:n,debounceMs:0},l=f=>({...f,debounceMs:0});switch(e){case"submit":return[l(u),l(d),c];case"blur":return[d];case"change":return[u];case"server":default:return[]}}function qt(e,i){const{onChange:s,onBlur:t,onSubmit:r,onMount:n}=i.validators||{},a={cause:"change",validate:s},o={cause:"blur",validate:t},h={cause:"submit",validate:r},u={cause:"mount",validate:n},d={cause:"server",validate:()=>{}};switch(e){case"mount":return[u];case"submit":return[a,o,h,d];case"server":return[d];case"blur":return[o,d];case"change":default:return[a,d]}}const ae=e=>!!e&&typeof e=="object"&&"fields"in e;function xt(e,i){if(Object.is(e,i))return!0;if(typeof e!="object"||e===null||typeof i!="object"||i===null)return!1;if(e instanceof Map&&i instanceof Map){if(e.size!==i.size)return!1;for(const[t,r]of e)if(!i.has(t)||!Object.is(r,i.get(t)))return!1;return!0}if(e instanceof Set&&i instanceof Set){if(e.size!==i.size)return!1;for(const t of e)if(!i.has(t))return!1;return!0}const s=Object.keys(e);if(s.length!==Object.keys(i).length)return!1;for(let t=0;t<s.length;t++)if(!Object.prototype.hasOwnProperty.call(i,s[t])||!Object.is(e[s[t]],i[s[t]]))return!1;return!0}function hs(e){const i=new Map;for(const s of e){const t=[...s.path??[]].map(r=>{const n=typeof r=="object"?r.key:r;return typeof n=="number"?`[${n}]`:n}).join(".").replace(/\.\[/g,"[");i.set(t,(i.get(t)??[]).concat(s))}return Object.fromEntries(i)}const fs=e=>e,ps=e=>{const i=hs(e);return{form:i,fields:i}},Qt=(e,i)=>e==="form"?ps(i):fs(i),oe={validate({value:e,validationSource:i},s){const t=s["~standard"].validate(e);if(t instanceof Promise)throw new Error("async function passed to sync validator");if(t.issues)return Qt(i,t.issues)},async validateAsync({value:e,validationSource:i},s){const t=await s["~standard"].validate(e);if(t.issues)return Qt(i,t.issues)}},le=e=>!!e&&"~standard"in e,Ft={isValidating:!1,isTouched:!1,isBlurred:!1,isDirty:!1,isPristine:!0,errors:[],errorMap:{}};function gt(e){function i(c,l,f,p){const v=t(c,l,f,p);({insert:()=>o(v,c,l),remove:()=>h(v),swap:()=>p!==void 0&&d(v,c,l,p),move:()=>p!==void 0&&u(v,c,l,p)})[f]()}function s(c,l){return`${c}[${l}]`}function t(c,l,f,p){const v=[s(c,l)];if(f==="swap")v.push(s(c,p));else if(f==="move"){const[g,S]=[Math.min(l,p),Math.max(l,p)];for(let m=g;m<=S;m++)v.push(s(c,m))}else{const g=e.getFieldValue(c),S=Array.isArray(g)?g.length:0;for(let m=l+1;m<S;m++)v.push(s(c,m))}return Object.keys(e.fieldInfo).filter(g=>v.some(S=>g.startsWith(S)))}function r(c,l){return c.replace(/\[(\d+)\]/,(f,p)=>{const v=parseInt(p,10);return`[${l==="up"?v+1:Math.max(0,v-1)}]`})}function n(c,l){(l==="up"?c:[...c].reverse()).forEach(p=>{const v=r(p.toString(),l),g=e.getFieldMeta(v);g?e.setFieldMeta(p,g):e.setFieldMeta(p,a())})}const a=()=>Ft,o=(c,l,f)=>{n(c,"down"),c.forEach(p=>{p.toString().startsWith(s(l,f))&&e.setFieldMeta(p,a())})},h=c=>{n(c,"up")},u=(c,l,f,p)=>{const v=new Map(Object.keys(e.fieldInfo).filter(g=>g.startsWith(s(l,f))).map(g=>[g,e.getFieldMeta(g)]));n(c,f<p?"up":"down"),Object.keys(e.fieldInfo).filter(g=>g.startsWith(s(l,p))).forEach(g=>{const S=g.replace(s(l,p),s(l,f)),m=v.get(S);m&&e.setFieldMeta(g,m)})},d=(c,l,f,p)=>{c.forEach(v=>{if(!v.toString().startsWith(s(l,f)))return;const g=v.toString().replace(s(l,f),s(l,p)),[S,m]=[e.getFieldMeta(v),e.getFieldMeta(g)];S&&e.setFieldMeta(g,S),m&&e.setFieldMeta(v,m)})};return{handleArrayFieldMetaShift:i}}function _t(e){return{values:e.values??{},errorMap:e.errorMap??{},fieldMetaBase:e.fieldMetaBase??{},isSubmitted:e.isSubmitted??!1,isSubmitting:e.isSubmitting??!1,isValidating:e.isValidating??!1,submissionAttempts:e.submissionAttempts??0,isSubmitSuccessful:e.isSubmitSuccessful??!1,validationMetaMap:e.validationMetaMap??{onChange:void 0,onBlur:void 0,onSubmit:void 0,onMount:void 0,onServer:void 0}}}class ms{constructor(i){var s;this.options={},this.fieldInfo={},this.prevTransformArray=[],this.cumulativeFieldsErrorMap={},this.mount=()=>{const t=this.fieldMetaDerived.mount(),r=this.store.mount(),n=()=>{t(),r()},{onMount:a}=this.options.validators||{};return a&&this.validateSync("mount"),n},this.update=t=>{var r,n;if(!t)return;const a=this.options;this.options=t;const o=!!((n=(r=t.transform)==null?void 0:r.deps)!=null&&n.some((d,c)=>d!==this.prevTransformArray[c])),h=t.defaultValues&&!xt(t.defaultValues,a.defaultValues)&&!this.state.isTouched,u=!xt(t.defaultState,a.defaultState)&&!this.state.isTouched;!h&&!u&&!o||B(()=>{this.baseStore.setState(()=>_t(Object.assign({},this.state,u?t.defaultState:{},h?{values:t.defaultValues}:{},o?{_force_re_eval:!this.state._force_re_eval}:{})))})},this.reset=(t,r)=>{const{fieldMeta:n}=this.state,a=this.resetFieldMeta(n);t&&!(r!=null&&r.keepDefaultValues)&&(this.options={...this.options,defaultValues:t}),this.baseStore.setState(()=>{var o;return _t({...this.options.defaultState,values:t??this.options.defaultValues??((o=this.options.defaultState)==null?void 0:o.values),fieldMetaBase:a})})},this.validateAllFields=async t=>{const r=[];return B(()=>{Object.values(this.fieldInfo).forEach(a=>{if(!a.instance)return;const o=a.instance;r.push(Promise.resolve().then(()=>o.validate(t,{skipFormValidation:!0}))),a.instance.state.meta.isTouched||a.instance.setMeta(h=>({...h,isTouched:!0}))})}),(await Promise.all(r)).flat()},this.validateArrayFieldsStartingFrom=async(t,r,n)=>{const a=this.getFieldValue(t),o=Array.isArray(a)?Math.max(a.length-1,0):null,h=[`${t}[${r}]`];for(let l=r+1;l<=(o??0);l++)h.push(`${t}[${l}]`);const u=Object.keys(this.fieldInfo).filter(l=>h.some(f=>l.startsWith(f))),d=[];return B(()=>{u.forEach(l=>{d.push(Promise.resolve().then(()=>this.validateField(l,n)))})}),(await Promise.all(d)).flat()},this.validateField=(t,r)=>{var n;const a=(n=this.fieldInfo[t])==null?void 0:n.instance;return a?(a.state.meta.isTouched||a.setMeta(o=>({...o,isTouched:!0})),a.validate(r)):[]},this.validateSync=t=>{const r=qt(t,this.options);let n=!1;const a={};return B(()=>{var o;for(const u of r){if(!u.validate)continue;const d=this.runValidator({validate:u.validate,value:{value:this.state.values,formApi:this,validationSource:"form"},type:"validate"}),{formError:c,fieldErrors:l}=Lt(d),f=yt(u.cause);if(l)for(const[p,v]of Object.entries(l)){const S={...this.cumulativeFieldsErrorMap[p]||{},[f]:v};a[p]=S,this.cumulativeFieldsErrorMap[p]=S;const m=this.getFieldMeta(p);m&&m.errorMap[f]!==v&&this.setFieldMeta(p,V=>({...V,errorMap:{...V.errorMap,[f]:v}}))}for(const p of Object.keys(this.cumulativeFieldsErrorMap)){const v=this.getFieldMeta(p);v!=null&&v.errorMap[f]&&!((o=a[p])!=null&&o[f])&&(this.cumulativeFieldsErrorMap[p]={...this.cumulativeFieldsErrorMap[p],[f]:void 0},this.setFieldMeta(p,g=>({...g,errorMap:{...g.errorMap,[f]:void 0}})))}this.state.errorMap[f]!==c&&this.baseStore.setState(p=>({...p,errorMap:{...p.errorMap,[f]:c}})),(c||l)&&(n=!0)}const h=yt("submit");this.state.errorMap[h]&&t!=="submit"&&!n&&this.baseStore.setState(u=>({...u,errorMap:{...u.errorMap,[h]:void 0}}))}),{hasErrored:n,fieldsErrorMap:a}},this.validateAsync=async t=>{const r=Nt(t,this.options);this.state.isFormValidating||this.baseStore.setState(u=>({...u,isFormValidating:!0}));const n=[];let a;for(const u of r){if(!u.validate)continue;const d=yt(u.cause),c=this.state.validationMetaMap[d];c==null||c.lastAbortController.abort();const l=new AbortController;this.state.validationMetaMap[d]={lastAbortController:l},n.push(new Promise(async f=>{let p;try{p=await new Promise((m,V)=>{setTimeout(async()=>{if(l.signal.aborted)return m(void 0);try{m(await this.runValidator({validate:u.validate,value:{value:this.state.values,formApi:this,validationSource:"form",signal:l.signal},type:"validateAsync"}))}catch(I){V(I)}},u.debounceMs)})}catch(m){p=m}const{formError:v,fieldErrors:g}=Lt(p);g&&(a=a?{...a,...g}:g);const S=yt(u.cause);if(a)for(const[m,V]of Object.entries(a)){const I=this.getFieldMeta(m);I&&I.errorMap[S]!==V&&this.setFieldMeta(m,O=>({...O,errorMap:{...O.errorMap,[S]:V}}))}this.baseStore.setState(m=>({...m,errorMap:{...m.errorMap,[S]:v}})),f(a?{fieldErrors:a,errorMapKey:S}:void 0)}))}let o=[];const h={};if(n.length){o=await Promise.all(n);for(const u of o)if(u!=null&&u.fieldErrors){const{errorMapKey:d}=u;for(const[c,l]of Object.entries(u.fieldErrors)){const p={...h[c]||{},[d]:l};h[c]=p}}}return this.baseStore.setState(u=>({...u,isFormValidating:!1})),h},this.validate=t=>{const{hasErrored:r,fieldsErrorMap:n}=this.validateSync(t);return r&&!this.options.asyncAlways?n:this.validateAsync(t)},this.getFieldValue=t=>ne(this.state.values,t),this.getFieldMeta=t=>this.state.fieldMeta[t],this.getFieldInfo=t=>{var r;return(r=this.fieldInfo)[t]||(r[t]={instance:null,validationMetaMap:{onChange:void 0,onBlur:void 0,onSubmit:void 0,onMount:void 0,onServer:void 0}})},this.setFieldMeta=(t,r)=>{this.baseStore.setState(n=>({...n,fieldMetaBase:{...n.fieldMetaBase,[t]:Vt(r,n.fieldMetaBase[t])}}))},this.resetFieldMeta=t=>Object.keys(t).reduce((r,n)=>{const a=n;return r[a]=Ft,r},{}),this.setFieldValue=(t,r,n)=>{const a=(n==null?void 0:n.dontUpdateMeta)??!1;B(()=>{a||this.setFieldMeta(t,o=>({...o,isTouched:!0,isDirty:!0,errorMap:{...o==null?void 0:o.errorMap,onMount:void 0}})),this.baseStore.setState(o=>({...o,values:Ot(o.values,t,r)}))})},this.deleteField=t=>{const n=[...Object.keys(this.fieldInfo).filter(a=>{const o=t.toString();return a!==o&&a.startsWith(o)}),t];this.baseStore.setState(a=>{const o={...a};return n.forEach(h=>{o.values=ns(o.values,h),delete this.fieldInfo[h],delete o.fieldMetaBase[h]}),o})},this.pushFieldValue=(t,r,n)=>{this.setFieldValue(t,a=>[...Array.isArray(a)?a:[],r],n),this.validateField(t,"change")},this.insertFieldValue=async(t,r,n,a)=>{this.setFieldValue(t,o=>[...o.slice(0,r),n,...o.slice(r)],a),await this.validateField(t,"change"),gt(this).handleArrayFieldMetaShift(t,r,"insert"),await this.validateArrayFieldsStartingFrom(t,r,"change")},this.replaceFieldValue=async(t,r,n,a)=>{this.setFieldValue(t,o=>o.map((h,u)=>u===r?n:h),a),await this.validateField(t,"change"),await this.validateArrayFieldsStartingFrom(t,r,"change")},this.removeFieldValue=async(t,r,n)=>{const a=this.getFieldValue(t),o=Array.isArray(a)?Math.max(a.length-1,0):null;if(this.setFieldValue(t,h=>h.filter((u,d)=>d!==r),n),gt(this).handleArrayFieldMetaShift(t,r,"remove"),o!==null){const h=`${t}[${o}]`;this.deleteField(h)}await this.validateField(t,"change"),await this.validateArrayFieldsStartingFrom(t,r,"change")},this.swapFieldValues=(t,r,n,a)=>{this.setFieldValue(t,o=>{const h=o[r],u=o[n];return Ot(Ot(o,`${r}`,u),`${n}`,h)},a),gt(this).handleArrayFieldMetaShift(t,r,"swap",n),this.validateField(t,"change"),this.validateField(`${t}[${r}]`,"change"),this.validateField(`${t}[${n}]`,"change")},this.moveFieldValues=(t,r,n,a)=>{this.setFieldValue(t,o=>(o.splice(n,0,o.splice(r,1)[0]),o),a),gt(this).handleArrayFieldMetaShift(t,r,"move",n),this.validateField(t,"change"),this.validateField(`${t}[${r}]`,"change"),this.validateField(`${t}[${n}]`,"change")},this.resetField=t=>{this.baseStore.setState(r=>({...r,fieldMetaBase:{...r.fieldMetaBase,[t]:Ft},values:{...r.values,[t]:this.options.defaultValues&&this.options.defaultValues[t]}}))},this.getAllErrors=()=>({form:{errors:this.state.errors,errorMap:this.state.errorMap},fields:Object.entries(this.state.fieldMeta).reduce((t,[r,n])=>(Object.keys(n).length&&n.errors.length&&(t[r]={errors:n.errors,errorMap:n.errorMap}),t),{})}),this.baseStore=new Dt(_t({...i==null?void 0:i.defaultState,values:(i==null?void 0:i.defaultValues)??((s=i==null?void 0:i.defaultState)==null?void 0:s.values)})),this.fieldMetaDerived=new H({deps:[this.baseStore],fn:({prevDepVals:t,currDepVals:r,prevVal:n})=>{var a;const o=n,h=t==null?void 0:t[0],u=r[0];let d=0;const c={};for(const l of Object.keys(u.fieldMetaBase)){const f=u.fieldMetaBase[l],p=h==null?void 0:h.fieldMetaBase[l],v=o==null?void 0:o[l];let g=v==null?void 0:v.errors;if(!p||f.errorMap!==p.errorMap){g=Object.values(f.errorMap??{}).filter(V=>V!==void 0);const m=(a=this.getFieldInfo(l))==null?void 0:a.instance;m&&!m.options.disableErrorFlat&&(g=g==null?void 0:g.flat(1))}const S=!f.isDirty;if(v&&v.isPristine===S&&v.errors===g&&f===p){c[l]=v,d++;continue}c[l]={...f,errors:g,isPristine:S}}return Object.keys(u.fieldMetaBase).length&&o&&d===Object.keys(u.fieldMetaBase).length?o:c}}),this.store=new H({deps:[this.baseStore,this.fieldMetaDerived],fn:({prevDepVals:t,currDepVals:r,prevVal:n})=>{var a,o,h,u;const d=n,c=t==null?void 0:t[0],l=r[0],f=Object.values(l.fieldMetaBase),p=f.some(b=>b==null?void 0:b.isValidating),v=!f.some(b=>(b==null?void 0:b.errorMap)&&ds(Object.values(b.errorMap).filter(Boolean))),g=f.some(b=>b==null?void 0:b.isTouched),S=f.some(b=>b==null?void 0:b.isBlurred),m=g&&((a=l==null?void 0:l.errorMap)==null?void 0:a.onMount),V=f.some(b=>b==null?void 0:b.isDirty),I=!V,O=!!((o=l.errorMap)!=null&&o.onMount||f.some(b=>{var w;return(w=b==null?void 0:b.errorMap)==null?void 0:w.onMount})),_=!!p;let T=(d==null?void 0:d.errors)??[];(!c||l.errorMap!==c.errorMap)&&(T=Object.values(l.errorMap).reduce((b,w)=>w===void 0?b:w&&ae(w)?(b.push(w.form),b):(b.push(w),b),[]));const $=T.length===0,q=v&&$,Q=l.submissionAttempts===0&&!g&&!O||!_&&!l.isSubmitting&&q;let z=l.errorMap;if(m&&(T=T.filter(b=>b!==l.errorMap.onMount),z=Object.assign(z,{onMount:void 0})),d&&c&&d.errorMap===z&&d.fieldMeta===this.fieldMetaDerived.state&&d.errors===T&&d.isFieldsValidating===p&&d.isFieldsValid===v&&d.isFormValid===$&&d.isValid===q&&d.canSubmit===Q&&d.isTouched===g&&d.isBlurred===S&&d.isPristine===I&&d.isDirty===V&&xt(c,l))return d;let J={...l,errorMap:z,fieldMeta:this.fieldMetaDerived.state,errors:T,isFieldsValidating:p,isFieldsValid:v,isFormValid:$,isValid:q,canSubmit:Q,isTouched:g,isBlurred:S,isPristine:I,isDirty:V};const y=((h=this.options.transform)==null?void 0:h.deps)??[];if(y.length!==this.prevTransformArray.length||y.some((b,w)=>b!==this.prevTransformArray[w])){const b=Object.assign({},this,{state:J});(u=this.options.transform)==null||u.fn(b),J=b.state,this.prevTransformArray=y}return J}}),this.handleSubmit=this.handleSubmit.bind(this),this.update(i||{})}get state(){return this.store.state}runValidator(i){return le(i.validate)?oe[i.type](i.value,i.validate):i.validate(i.value)}async handleSubmit(i){var s,t,r,n,a,o;if(this.baseStore.setState(u=>({...u,isSubmitted:!1,submissionAttempts:u.submissionAttempts+1,isSubmitSuccessful:!1})),!this.state.canSubmit)return;this.baseStore.setState(u=>({...u,isSubmitting:!0}));const h=()=>{this.baseStore.setState(u=>({...u,isSubmitting:!1}))};if(await this.validateAllFields("submit"),!this.state.isFieldsValid){h(),(t=(s=this.options).onSubmitInvalid)==null||t.call(s,{value:this.state.values,formApi:this});return}if(await this.validate("submit"),!this.state.isValid){h(),(n=(r=this.options).onSubmitInvalid)==null||n.call(r,{value:this.state.values,formApi:this});return}B(()=>{Object.values(this.fieldInfo).forEach(u=>{var d,c,l;(l=(c=(d=u.instance)==null?void 0:d.options.listeners)==null?void 0:c.onSubmit)==null||l.call(c,{value:u.instance.state.value,fieldApi:u.instance})})});try{await((o=(a=this.options).onSubmit)==null?void 0:o.call(a,{value:this.state.values,formApi:this,meta:i??this.options.onSubmitMeta})),B(()=>{this.baseStore.setState(u=>({...u,isSubmitted:!0,isSubmitSuccessful:!0})),h()})}catch(u){throw this.baseStore.setState(d=>({...d,isSubmitSuccessful:!1})),h(),u}}setErrorMap(i){this.baseStore.setState(s=>({...s,errorMap:{...s.errorMap,...i}}))}}function Lt(e){if(e){if(ae(e)){const i=Lt(e.form).formError,s=e.fields;return{formError:i,fieldErrors:s}}return{formError:e}}return{formError:void 0}}function yt(e){switch(e){case"submit":return"onSubmit";case"blur":return"onBlur";case"mount":return"onMount";case"server":return"onServer";case"change":default:return"onChange"}}class vs{constructor(i){this.options={},this.mount=()=>{var s,t;const r=this.store.mount();this.options.defaultValue!==void 0&&this.form.setFieldValue(this.name,this.options.defaultValue,{dontUpdateMeta:!0});const n=this.getInfo();n.instance=this,this.update(this.options);const{onMount:a}=this.options.validators||{};if(a){const o=this.runValidator({validate:a,value:{value:this.state.value,fieldApi:this,validationSource:"field"},type:"validate"});o&&this.setMeta(h=>({...h,errorMap:{...h==null?void 0:h.errorMap,onMount:o}}))}return(t=(s=this.options.listeners)==null?void 0:s.onMount)==null||t.call(s,{value:this.state.value,fieldApi:this}),r},this.update=s=>{if(this.state.value===void 0){const t=ne(s.form.options.defaultValues,s.name);s.defaultValue!==void 0?this.setValue(s.defaultValue,{dontUpdateMeta:!0}):t!==void 0&&this.setValue(t,{dontUpdateMeta:!0})}this.form.getFieldMeta(this.name)===void 0&&this.setMeta(this.state.meta),this.options=s,this.name=s.name},this.getValue=()=>this.form.getFieldValue(this.name),this.setValue=(s,t)=>{var r,n;this.form.setFieldValue(this.name,s,t),(n=(r=this.options.listeners)==null?void 0:r.onChange)==null||n.call(r,{value:this.state.value,fieldApi:this}),this.validate("change")},this.getMeta=()=>this.store.state.meta,this.setMeta=s=>this.form.setFieldMeta(this.name,s),this.getInfo=()=>this.form.getFieldInfo(this.name),this.pushValue=(s,t)=>{var r,n;this.form.pushFieldValue(this.name,s,t),(n=(r=this.options.listeners)==null?void 0:r.onChange)==null||n.call(r,{value:this.state.value,fieldApi:this})},this.insertValue=(s,t,r)=>{var n,a;this.form.insertFieldValue(this.name,s,t,r),(a=(n=this.options.listeners)==null?void 0:n.onChange)==null||a.call(n,{value:this.state.value,fieldApi:this})},this.replaceValue=(s,t,r)=>{var n,a;this.form.replaceFieldValue(this.name,s,t,r),(a=(n=this.options.listeners)==null?void 0:n.onChange)==null||a.call(n,{value:this.state.value,fieldApi:this})},this.removeValue=(s,t)=>{var r,n;this.form.removeFieldValue(this.name,s,t),(n=(r=this.options.listeners)==null?void 0:r.onChange)==null||n.call(r,{value:this.state.value,fieldApi:this})},this.swapValues=(s,t,r)=>{var n,a;this.form.swapFieldValues(this.name,s,t,r),(a=(n=this.options.listeners)==null?void 0:n.onChange)==null||a.call(n,{value:this.state.value,fieldApi:this})},this.moveValue=(s,t,r)=>{var n,a;this.form.moveFieldValues(this.name,s,t,r),(a=(n=this.options.listeners)==null?void 0:n.onChange)==null||a.call(n,{value:this.state.value,fieldApi:this})},this.getLinkedFields=s=>{const t=Object.values(this.form.fieldInfo),r=[];for(const n of t){if(!n.instance)continue;const{onChangeListenTo:a,onBlurListenTo:o}=n.instance.options.validators||{};s==="change"&&(a!=null&&a.includes(this.name))&&r.push(n.instance),s==="blur"&&(o!=null&&o.includes(this.name))&&r.push(n.instance)}return r},this.validateSync=(s,t)=>{const r=qt(s,this.options),a=this.getLinkedFields(s).reduce((u,d)=>{const c=qt(s,d.options);return c.forEach(l=>{l.field=d}),u.concat(c)},[]);let o=!1;B(()=>{const u=(d,c)=>{const l=st(c.cause),f=c.validate?Gt(d.runValidator({validate:c.validate,value:{value:d.store.state.value,validationSource:"field",fieldApi:d},type:"validate"})):t[l];d.state.meta.errorMap[l]!==f&&d.setMeta(p=>({...p,errorMap:{...p.errorMap,[st(c.cause)]:f||t[l]}})),(f||t[l])&&(o=!0)};for(const d of r)u(this,d);for(const d of a)d.validate&&u(d.field,d)});const h=st("submit");return this.state.meta.errorMap[h]&&s!=="submit"&&!o&&this.setMeta(u=>({...u,errorMap:{...u.errorMap,[h]:void 0}})),{hasErrored:o}},this.validateAsync=async(s,t)=>{const r=Nt(s,this.options),n=await t,a=this.getLinkedFields(s),o=a.reduce((l,f)=>{const p=Nt(s,f.options);return p.forEach(v=>{v.field=f}),l.concat(p)},[]);this.state.meta.isValidating||this.setMeta(l=>({...l,isValidating:!0}));for(const l of a)l.setMeta(f=>({...f,isValidating:!0}));const h=[],u=[],d=(l,f,p)=>{const v=st(f.cause),g=l.getInfo().validationMetaMap[v];g==null||g.lastAbortController.abort();const S=new AbortController;this.getInfo().validationMetaMap[v]={lastAbortController:S},p.push(new Promise(async m=>{var V;let I;try{I=await new Promise(($,q)=>{this.timeoutIds[f.cause]&&clearTimeout(this.timeoutIds[f.cause]),this.timeoutIds[f.cause]=setTimeout(async()=>{if(S.signal.aborted)return $(void 0);try{$(await this.runValidator({validate:f.validate,value:{value:l.store.state.value,fieldApi:l,signal:S.signal,validationSource:"field"},type:"validateAsync"}))}catch(Q){q(Q)}},f.debounceMs)})}catch($){I=$}if(S.signal.aborted)return m(void 0);const O=Gt(I),_=(V=n[this.name])==null?void 0:V[v],T=O||_;l.setMeta($=>({...$,errorMap:{...$==null?void 0:$.errorMap,[v]:T}})),m(T)}))};for(const l of r)l.validate&&d(this,l,h);for(const l of o)l.validate&&d(l.field,l,u);let c=[];(h.length||u.length)&&(c=await Promise.all(h),await Promise.all(u)),this.setMeta(l=>({...l,isValidating:!1}));for(const l of a)l.setMeta(f=>({...f,isValidating:!1}));return c.filter(Boolean)},this.validate=(s,t)=>{var r;if(!this.state.meta.isTouched)return[];const{fieldsErrorMap:n}=t!=null&&t.skipFormValidation?{fieldsErrorMap:{}}:this.form.validateSync(s),{hasErrored:a}=this.validateSync(s,n[this.name]??{});if(a&&!this.options.asyncAlways)return(r=this.getInfo().validationMetaMap[st(s)])==null||r.lastAbortController.abort(),this.state.meta.errors;const o=t!=null&&t.skipFormValidation?Promise.resolve({}):this.form.validateAsync(s);return this.validateAsync(s,o)},this.handleChange=s=>{this.setValue(s)},this.handleBlur=()=>{var s,t;this.state.meta.isTouched||(this.setMeta(n=>({...n,isTouched:!0})),this.validate("change")),this.state.meta.isBlurred||this.setMeta(n=>({...n,isBlurred:!0})),this.validate("blur"),(t=(s=this.options.listeners)==null?void 0:s.onBlur)==null||t.call(s,{value:this.state.value,fieldApi:this})},this.form=i.form,this.name=i.name,this.timeoutIds={},this.store=new H({deps:[this.form.store],fn:()=>{const s=this.form.getFieldValue(this.name),t=this.form.getFieldMeta(this.name)??{...Ft,...i.defaultMeta};return{value:s,meta:t}}}),this.options=i}get state(){return this.store.state}runValidator(i){return le(i.validate)?oe[i.type](i.value,i.validate):i.validate(i.value)}setErrorMap(i){this.setMeta(s=>({...s,errorMap:{...s.errorMap,...i}}))}}function Gt(e){if(e)return e}function st(e){switch(e){case"submit":return"onSubmit";case"blur":return"onBlur";case"mount":return"onMount";case"server":return"onServer";case"change":default:return"onChange"}}function Ht(e,i=s=>s){return We.useSyncExternalStoreWithSelector(e.subscribe,()=>e.state,()=>e.state,i,gs)}function gs(e,i){if(Object.is(e,i))return!0;if(typeof e!="object"||e===null||typeof i!="object"||i===null)return!1;if(e instanceof Map&&i instanceof Map){if(e.size!==i.size)return!1;for(const[t,r]of e)if(!i.has(t)||!Object.is(r,i.get(t)))return!1;return!0}if(e instanceof Set&&i instanceof Set){if(e.size!==i.size)return!1;for(const t of e)if(!i.has(t))return!1;return!0}const s=Object.keys(e);if(s.length!==Object.keys(i).length)return!1;for(let t=0;t<s.length;t++)if(!Object.prototype.hasOwnProperty.call(i,s[t])||!Object.is(e[s[t]],i[s[t]]))return!1;return!0}const wt=typeof window<"u"?E.useLayoutEffect:E.useEffect;function ys(e){const[i]=E.useState(()=>{const t=new vs({...e,form:e.form,name:e.name});return t.Field=ue,t});return wt(i.mount,[i]),wt(()=>{i.update(e)}),Ht(i.store,e.mode==="array"?s=>[s.meta,Object.keys(s.value??[]).length]:void 0),i}const ue=({children:e,...i})=>{const s=ys(i),t=E.useMemo(()=>Vt(e,s),[e,s,s.state.value,s.state.meta]);return F.jsx(F.Fragment,{children:t})};function Ms({form:e,selector:i,children:s}){const t=Ht(e.store,i);return Vt(s,t)}function zs(e){const[i]=E.useState(()=>{const s=new ms(e),t=s;return t.Field=function(n){return F.jsx(ue,{...n,form:s})},t.Subscribe=r=>F.jsx(Ms,{form:s,selector:r.selector,children:r.children}),t});return wt(i.mount,[]),Ht(i.store,s=>s.isSubmitting),wt(()=>{i.update(e)}),i}const Ss=e=>e.length>0&&e[0]!==null&&e[0]!==void 0,Js=e=>Ss(e)?e.filter(i=>i!==void 0).map(({message:i})=>i).join(", "):null,Qs=$e(F.jsx("path",{d:"M13.35 20.13c-.76.69-1.93.69-2.69-.01l-.11-.1C5.3 15.27 1.87 12.16 2 8.28c.06-1.7.93-3.33 2.34-4.29 2.64-1.8 5.9-.96 7.66 1.1 1.76-2.06 5.02-2.91 7.66-1.1 1.41.96 2.28 2.59 2.34 4.29.14 3.88-3.3 6.99-8.55 11.76z"})),bs=async({topic:e}={})=>{var a;const i=[],s={};e&&(i.push("EXISTS (SELECT 1 FROM json_each(tags) WHERE value = $topic)"),s.$topic=e);const r=`
      SELECT COUNT(*) as totalCount
      FROM posts
      ${i.length>0?`WHERE ${i.join(" AND ")}`:""}
    `;return((a=(await N.exec(r,s))[0])==null?void 0:a.totalCount)||0},ce=async({page:e=0,limit:i=10,topic:s,userId:t,orderBy:r="createdAt",order:n="desc",prioritizeFollowers:a}={})=>{var O;const o=[],h={};s&&(o.push("EXISTS (SELECT 1 FROM json_each(tags) WHERE value = $topic)"),h.$topic=s),t&&(o.push("userId = $userId"),h.$userId=t);const u=o.length>0?`WHERE ${o.join(" AND ")}`:"";let d="p.createdAt";r==="likeCount"||r==="commentCount"?d=`pic.${r}`:r==="createdAt"||r==="updatedAt"?d=`datetime(p.${r})`:d=`p.${r}`;let c="",l="";if(a){const _=await tt({server:!0}),T=_.authenticated?_.user.id:null;T&&(h.$currentUserId=T,c=`
        LEFT JOIN (
          SELECT followeeId, 1 AS isFollowed
          FROM user_interactions
          WHERE followerId = $currentUserId AND type = 'follow'
        ) AS following ON p.userId = following.followeeId
      `,l="CASE WHEN following.isFollowed = 1 THEN 1 ELSE 0 END DESC, ")}const f=`
      SELECT COUNT(*) as totalCount
      FROM posts
      ${u}
    `,v=((O=(await N.exec(f,h))[0])==null?void 0:O.totalCount)||0,g=Math.ceil(v/i),S=e+1<g?e+1:null;h.$limit=i,h.$offset=e*i;const m=`
        SELECT id
        FROM posts p
        LEFT JOIN post_interaction_counts pic ON p.id = pic.postId
        ${c}
        ${u}
        ORDER BY ${l}${d} ${n.toUpperCase()}, p.createdAt DESC
        LIMIT $limit OFFSET $offset
      `;return{posts:(await N.exec(m,h)).map(_=>_.id),nextPage:S,totalPages:g}},Fs=async()=>{const i=await N.exec("SELECT uniqueTags FROM tag_stats");if(i.length===0)return[];const s=i[0].uniqueTags,t=JSON.parse(s);return Array.isArray(t)?t:[]},ws=async({postId:e,incrementViewCount:i=!1})=>{let s=null;const t=await tt({server:!0});s=t.authenticated?t.user.id:null,i&&N.exec("UPDATE posts SET viewCount = viewCount + 1 WHERE id = $postId",{$postId:e});let r=`
      SELECT
        p.id,
        p.title,
        p.content,
        p.tags,
        p.photos,
        p.attachments,
        p.viewCount,
        p.createdAt,
        p.updatedAt,
        p.userId,
        u.name as userName,
        COALESCE(pic.likeCount, 0) as likeCount,
        COALESCE(pic.commentCount, 0) as commentCount
  `;s?r+=`,
      EXISTS (
        SELECT 1
        FROM user_interactions
        WHERE followerId = $currentUserId
        AND followeeId = p.userId
        AND type = 'follow'
      ) as isFromFollowing
    `:r+=", 0 as isFromFollowing",r+=`
      FROM posts p
      JOIN users u ON p.userId = u.id
      LEFT JOIN post_interaction_counts pic ON p.id = pic.postId
      WHERE p.id = $postId
  `;const n={$postId:e};s&&(n.$currentUserId=s);const a=await N.exec(r,n);if(a.length===0)return null;const o=a[0];return{...o,tags:JSON.parse(o.tags||"[]"),photos:o.photos?JSON.parse(o.photos):void 0,attachments:o.attachments?JSON.parse(o.attachments):void 0,createdAt:new Date(o.createdAt),updatedAt:new Date(o.updatedAt),likeCount:o.likeCount||0,commentCount:o.commentCount||0,isFromFollowing:!!o.isFromFollowing,isSelf:s?o.userId===s:!1}},Es=async({title:e,content:i,tags:s,photos:t,attachments:r})=>{const n=await tt({server:!0});if(!n.authenticated)return{error:"未登入或授權失效，無法創建貼文"};const a=n.user.id,o=JSON.stringify(s),h=t?JSON.stringify(t):null,u=r?JSON.stringify(r):null,d=`
      INSERT INTO posts ( userId, title, content, tags, photos, attachments, createdAt, updatedAt )
      VALUES ( $userId, $title, $content, $tags, $photos, $attachments, $createdAt, $updatedAt )
      RETURNING id
    `,c=new Date().toISOString(),l={$userId:a,$title:e,$content:i,$tags:o,$photos:h,$attachments:u,$createdAt:c,$updatedAt:c},f=await N.exec(d,l);return!f||f.length===0||typeof f[0].id!="number"?{error:"創建貼文失敗"}:f[0].id},Vs=async({id:e,title:i,content:s,tags:t,photos:r,attachments:n})=>{const a=await tt({server:!0});if(!a.authenticated)return{error:"未登入或授權失效，無法更新貼文"};const o=a.user.id,u=await N.exec("SELECT userId FROM posts WHERE id = $postId",{$postId:e});if(u.length===0)return{error:"貼文不存在"};if(u[0].userId!==o)return{error:"您沒有權限更新此貼文"};const d=JSON.stringify(t),c=r?JSON.stringify(r):null,l=n?JSON.stringify(n):null,f=new Date().toISOString(),p=`
      UPDATE posts
      SET title = $title,
          content = $content,
          tags = $tags,
          photos = $photos,
          attachments = $attachments,
          updatedAt = $updatedAt
      WHERE id = $postId AND userId = $userId
    `,v={$postId:e,$userId:o,$title:i,$content:s,$tags:d,$photos:c,$attachments:l,$updatedAt:f};return await N.exec(p,v),null},Ts=async e=>{const i=await tt({server:!0});if(!i.authenticated)return{error:"未登入或授權失效，無法刪除貼文"};const s=i.user.id,r=await N.exec("SELECT userId FROM posts WHERE id = $postId",{$postId:e});return r.length===0?{error:"貼文不存在"}:r[0].userId!==s?{error:"您沒有權限刪除此貼文"}:(await N.exec("DELETE FROM posts WHERE id = $postId AND userId = $userId",{$postId:e,$userId:s}),null)},at=1*60*1e3,Gs=({limit:e,topic:i,userId:s,orderBy:t,order:r,prioritizeFollowers:n}={})=>nt({queryKey:["posts",e,i,s,t,r,n],queryFn:async()=>(await ce({page:0,limit:e,topic:i,userId:s,orderBy:t,order:r,prioritizeFollowers:n})).posts,staleTime:at}),Xs=({topic:e}={})=>nt({queryKey:["postCounts",e],queryFn:()=>bs({topic:e}),staleTime:at}),Ys=({limit:e=6,topic:i,userId:s,orderBy:t,order:r,prioritizeFollowers:n}={})=>{const{data:a,fetchNextPage:o,hasNextPage:h,isFetchingNextPage:u,isLoading:d}=qe({queryKey:["infinitePosts",e,i,s,t,r,n],queryFn:({pageParam:c})=>ce({page:c,limit:e,topic:i,userId:s,orderBy:t,order:r,prioritizeFollowers:n}),initialPageParam:0,getNextPageParam:c=>c.nextPage,staleTime:at});return E.useEffect(()=>{const c=document.getElementById("scroll-area");if(!c)return;const l=()=>{const f=c.scrollHeight,p=c.scrollTop,v=c.clientHeight;p+v>=f-350&&h&&!u&&o()};return c.addEventListener("scroll",l),()=>c.removeEventListener("scroll",l)},[o,h,u]),{data:a,isLoading:d,isFetchingNextPage:u,hasNextPage:h,fetchNextPage:o}},Zs=()=>nt({queryKey:["tags"],queryFn:Fs,staleTime:at}),tr=({postId:e,incrementViewCount:i})=>nt({queryKey:["post",e],queryFn:()=>e===void 0||Number.isNaN(e)?null:ws({postId:e,incrementViewCount:i}),enabled:e!==void 0&&!Number.isNaN(e)&&e>=0,staleTime:at}),er=()=>{const e=U();return K({mutationFn:Es,onSettled:()=>{e.invalidateQueries({queryKey:["posts"]}),e.invalidateQueries({queryKey:["infinitePosts"]}),e.invalidateQueries({queryKey:["postCounts"]}),e.invalidateQueries({queryKey:["tags"]})}})},sr=()=>{const e=U();return K({mutationFn:Vs,onSettled:()=>{e.invalidateQueries({queryKey:["posts"]}),e.invalidateQueries({queryKey:["infinitePosts"]}),e.invalidateQueries({queryKey:["postCounts"]}),e.invalidateQueries({queryKey:["tags"]})}})},rr=()=>{const e=U();return K({mutationFn:Ts,onSettled:()=>{e.invalidateQueries({queryKey:["posts"]}),e.invalidateQueries({queryKey:["infinitePosts"]}),e.invalidateQueries({queryKey:["postCounts"]}),e.invalidateQueries({queryKey:["tags"]})}})};export{Rs as C,Qs as F,Ze as S,Ns as T,tr as a,Zs as b,Ws as c,zs as d,Ss as e,Hs as f,Js as g,Xs as h,Ls as i,Ys as j,rr as k,er as l,sr as m,Ks as n,Us as o,Bs as p,js as q,qs as r,Gs as u};
