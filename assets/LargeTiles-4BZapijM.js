import{j as e,B as t,n as h,as as b,am as A,q as P,r as f,S as y,x as I,z as _,D as q,M as K,k as Q,h as U,i as X,ad as Y}from"./routes-C-BkZgtt.js";import{a as G}from"./ArrowDropDownRounded-_f5Pg-S1.js";import{c as C,u as J,n as M,s as j,a as W,t as Z,m as ee,b as te,l as O}from"./main-CMr7R_O3.js";import{T as w,a as se,b as S}from"./TileText-Cjclz5ce.js";import{u as E}from"./url-QUAxP1Wn.js";import{S as k}from"./Skeleton-GnPJ5GGB.js";import{M as T}from"./MenuItem-DhQOCWG4.js";import{C as re}from"./Chip-B_B3n0JL.js";import{A as oe}from"./ArrowOutwardRounded-BFqHlfLA.js";import{a as ne,b as ae,i as ie,M as le,T as ce,B as de,g as pe}from"./style-CH36U_6d.js";import{b as xe}from"./formatters-C9bWSe0O.js";import{F as he,S as ue}from"./Switch-GKi725FL.js";import"./RefreshRounded-84LV6aIo.js";import"./SQLiteClient-NtSnAHyF.js";import"./DataExplorationRounded-BwPftMe4.js";import"./NotificationsRounded-bpE9RUC-.js";import"./fuse-D0PIhOkW.js";import"./useMutation-DItdicL4.js";import"./dayjs.min-DmibwfIS.js";import"./SearchRounded-DZA1yzSm.js";import"./DarkModeRounded-Ck9mItf0.js";import"./Tooltip-Bnxvlrw1.js";import"./DownloadRounded-BKvMQwDC.js";import"./DatasetRounded-BfKRSmty.js";import"./with-selector-CAkLlU_z.js";import"./SwitchBase-CwzMzgKA.js";function D(s){if(!s)return;const i=s.match(/^([a-z]+)(?:\.(\w+))?$/);if(i){const[,r,o]=i,c=["--mui-palette",r];return o&&c.push(o),`var(${c.join("-")})`}return s}const F=({color1:s="white",color2:i="transparent",angle:r=45,stripeWidth:o=10,backgroundSize:c,zIndex:l=0,className:a="",style:n={}})=>{const d=D(s),u=D(i),m=c??o*2,p=`repeating-linear-gradient(
    ${r}deg,
    ${d},
    ${d} ${o}px,
    ${u} ${o}px,
    ${u} ${m}px
  )`;return e.jsx("div",{className:a,style:{position:"absolute",inset:0,zIndex:l,background:p,pointerEvents:"none",...n}})},L=s=>{const{update:i}=E();return()=>i(P.datahub_tables,o=>({db:o.db??null,table:s}))},me=({label:s,records:i,percentage:r,loading:o,noData:c,index:l})=>{const a=L(s);return e.jsx(w,{title:o||c?null:e.jsxs(t,{children:[e.jsx(h,{variant:"subtitle2",children:s}),e.jsxs(h,{children:[i," 筆紀錄"]})]}),children:e.jsxs(t,{onClick:a,sx:{position:"relative",flex:1,borderRadius:2,overflow:"clip",transition:"all 0.2s ease-in-out","&:hover":{bgcolor:"action.hover","& .bar-content":{opacity:1}}},children:[e.jsx(F,{color1:"divider",color2:"#fff0",angle:-20,stripeWidth:5}),e.jsx(t,{sx:{position:"absolute",inset:`${o||c?100:Math.max(0,100-r)}% 0 0 0`,borderRadius:2,overflow:"hidden",bgcolor:"background.paper",transition:C},children:e.jsx(t,{className:"bar-content",sx:{position:"absolute",inset:0,bgcolor:"primary.main",opacity:l===0?.9:.65,transition:"all 0.2s ease-in-out"}})})]})})},je=({label:s,loading:i,noData:r})=>{const o=L(s);return i?e.jsx(k,{variant:"rounded",animation:"wave",children:e.jsx(h,{variant:"body1",component:"p",sx:{flex:1,textAlign:"center"},children:"載入中"})}):r?e.jsx(h,{variant:"body1",component:"p",sx:{flex:1,color:"text.secondary",...b,textAlign:"center"},children:"---"}):e.jsx(w,{title:e.jsx(h,{children:s}),children:e.jsx(h,{onClick:o,variant:"body1",component:"p",sx:{flex:1,color:"text.secondary",...A,...b,textAlign:"center"},children:s})})},fe=({value:s,onClick:i})=>{const[r,o]=f.useState(null),c=n=>o(d=>d?null:n.currentTarget),l=()=>o(null),a=n=>()=>{i(n),l()};return e.jsxs(t,{sx:{display:"flex",gap:j,justifyContent:"space-between",alignItems:"center",p:j},children:[e.jsx(h,{variant:"h5",component:"h3",children:"紀錄數"}),e.jsxs(_,{sx:{"&:hover":{bgcolor:"action.hover"},p:1,pr:0,borderRadius:1},onClick:c,children:[e.jsxs(h,{sx:{color:"text.secondary"},children:["前 ",s," 筆"]}),e.jsx(G,{sx:{color:"text.secondary"}})]}),e.jsx(q,{anchorEl:r,anchorOrigin:{horizontal:"center",vertical:"bottom"},transformOrigin:{horizontal:"center",vertical:"top"},open:!!r,onClose:l,children:e.jsxs(K,{dense:!0,children:[e.jsx(T,{onClick:a(3),selected:s===3,children:"前 3 筆"}),e.jsx(T,{onClick:a(5),selected:s===5,children:"前 5 筆"}),e.jsx(T,{onClick:a(7),selected:s===7,children:"前 7 筆"})]})})]})},ge=(s,i)=>{if(s===null)return{dataArray:[...Array(i)].map((p,x)=>({label:"載入中"+x,records:0,percentage:0,loading:!0,noData:!1})),averageAmount:0,averagePercentages:0};const r=Object.entries(s).sort(([,p],[,x])=>x-p).slice(0,i),o=r.map(([p])=>p),c=r.map(([,p])=>p),l=1.75,a=Object.values(c).reduce((p,x)=>p+x,0),n=Math.round(a/i),d=Math.round(n/a*100*l),u=c.map(p=>Math.round(p/a*100*l)),m=o.map((p,x)=>({label:p,records:c[x],percentage:u[x],loading:!1,noData:!1}));if(m.length<i){const p=[...Array(i-m.length)].map(()=>({label:"",records:0,percentage:0,loading:!1,noData:!0}));return{dataArray:[...m,...p],averageAmount:n,averagePercentages:d}}return{dataArray:m,averageAmount:n,averagePercentages:d}},be=()=>{const[s,i]=f.useState(5),{data:r,isFetching:o}=J({types:["table","view"]}),{dataArray:c,averageAmount:l,averagePercentages:a}=ge(o?null:r??null,s);return e.jsxs(y,{sx:{aspectRatio:{xs:"2/1",ml:"2/1.2"},borderTop:"1px solid",borderColor:"divider"},children:[e.jsx(fe,{value:s,onClick:i}),e.jsxs(t,{sx:{position:"relative",flex:1,display:"flex",gap:j,p:j,py:M,justifyContent:"space-around",alignItems:"stretch"},children:[c.map((n,d)=>e.jsx(me,{index:d,...n},d)),e.jsx(t,{sx:{position:"absolute",inset:`0 0 ${o?0:a}% 0`,borderBottom:"4px dashed",borderColor:"divider",pointerEvents:"none",mx:j,scale:"1.02 1",transition:C,"&:before":{content:`"平均 ${o?0:l} 筆"`,position:"absolute",right:0,bottom:0,fontSize:"1rem",color:"text.secondary",opacity:.75}}}),o&&e.jsx(t,{sx:{position:"absolute",inset:0,display:"grid",placeItems:"center",pointerEvents:"none"},children:e.jsx(I,{})})]}),e.jsx(t,{sx:{display:"flex",gap:j,p:j,justifyContent:"space-around",alignItems:"center"},children:c.map((n,d)=>e.jsx(je,{index:d,...n},d))})]})},ye=Q([e.jsx("path",{d:"M3 6c-.55 0-1 .45-1 1v13c0 1.1.9 2 2 2h13c.55 0 1-.45 1-1s-.45-1-1-1H4V7c0-.55-.45-1-1-1"},"0"),e.jsx("path",{d:"M20 2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2m-3.54 12.01-.63-1.82H12.2l-.65 1.82c-.1.29-.38.48-.68.48-.51 0-.86-.51-.68-.98l2.73-7.27c.16-.44.6-.74 1.08-.74s.92.3 1.09.75l2.73 7.27c.18.47-.17.98-.68.98-.31 0-.58-.19-.68-.49"},"1"),e.jsx("path",{d:"m13.96 7.17-1.31 3.72h2.69l-1.3-3.72z"},"2")]),N=({children:s,loading:i,...r})=>i?e.jsx(k,{variant:"rounded",animation:"wave",...r,children:s}):s,ve=()=>{const{data:s,isFetching:i}=W({types:["table","view"]}),r=f.useMemo(()=>{if(!s||i)return null;const a={};let n=0;s.forEach(({columns:p})=>{p.forEach(({type:x})=>{a[x]=(a[x]||0)+1,n+=1})});const d=[],u=new Set;let m=0;for(const[p,x]of Object.entries(a).sort((g,v)=>v[1]-g[1])){const g=x/n;d.length<3||g>=.1?d.push([p,x]):(m+=x,u.add(p))}if(m>0){const p=Array.from(u).slice(0,5),x=p.join(", ")+(p.length>5?", ...":"");d.push([`其他 (${x})`,m])}return d.map(([p,x])=>({type:p,count:x,percentage:x/n}))},[s,i]),o=r===null,c=!o&&r.length<3,l=!o&&!c;return e.jsxs(y,{sx:{aspectRatio:{xs:"2/1",ml:"2/1.2"},borderTop:"1px solid",borderColor:"divider",position:"relative"},children:[e.jsxs(t,{sx:{display:"flex",gap:j,justifyContent:"space-between",alignItems:"flex-start",p:j},children:[e.jsxs(y,{sx:{gap:1},children:[e.jsx(se,{children:"最常使用的型別"}),e.jsx(N,{loading:o,children:e.jsx(S,{variant:"h4",sx:{textTransform:"uppercase"},children:o?"載入中":c?"N/A":r[0].type})})]}),e.jsx(ye,{sx:{...Z,mt:.5}})]}),e.jsxs(t,{sx:{flex:1,position:"relative"},children:[e.jsxs(t,{sx:{position:"absolute",inset:"auto 0 0 0",p:1.5,borderRadius:9,overflow:"clip"},children:[e.jsx(F,{color1:"divider",color2:"#fff0",angle:-35,stripeWidth:4}),l&&e.jsx(t,{sx:{position:"absolute",inset:0,display:"flex",alignItems:"stretch",zIndex:1},children:r.map(({type:a,count:n,percentage:d},u)=>e.jsx(w,{title:e.jsxs(S,{variant:"body1",sx:{textTransform:"uppercase"},children:[a," 型別使用了 ",n," 次"]}),children:e.jsx(t,{sx:{width:d,"&:hover":{bgcolor:"divider"},opacity:.9,transition:"all 0.2s ease-in-out"}})},u))})]}),e.jsx(t,{sx:{position:"absolute",inset:"auto 0 0 0",my:1.5,display:"grid",placeItems:"center"},children:e.jsx(t,{sx:{position:"absolute",width:1,display:"flex",alignItems:"center",scale:l?"1 1":"0 1",opacity:l?1:0,transition:C},children:l&&r.map(({percentage:a},n)=>e.jsx(t,{sx:{width:a,px:.5,pl:n===0?1:.5,pr:n===r.length-1?1:.5},children:e.jsx(t,{sx:{py:.5,borderRadius:9,bgcolor:"primary.main",filter:`hue-rotate(-${n*30+10}deg)`}})},n))})}),e.jsx(t,{sx:{position:"absolute",inset:0,display:"flex",transformOrigin:"left",scale:l?"1 1":"1 0",transition:C},children:l&&r.map(({type:a,percentage:n},d)=>e.jsx(t,{sx:{width:n,height:1,position:"relative"},children:e.jsx(t,{sx:{position:"absolute",inset:0,ml:d===0?1:0,mb:3,borderLeft:4,borderColor:"divider"},children:e.jsxs(t,{sx:{position:"absolute",inset:"0 auto auto 0"},children:[e.jsx(h,{variant:"body2",sx:{textTransform:"uppercase",color:"text.secondary",ml:1,...b},children:a}),e.jsxs(S,{sx:{textTransform:"uppercase",opacity:.8,ml:1},children:[Math.round(n*100),"%"]})]})})},d))}),o&&e.jsx(t,{sx:{position:"absolute",inset:0,display:"grid",placeItems:"center",pointerEvents:"none"},children:e.jsx(I,{})}),c&&e.jsx(t,{sx:{position:"absolute",inset:0,display:"grid",placeItems:"center",pointerEvents:"none"},children:e.jsx(re,{sx:{p:3,borderRadius:99},label:e.jsx(h,{variant:"h6",component:"p",sx:{color:"text.secondary"},children:"資料不足"})})})]}),e.jsx(t,{sx:{display:"flex",gap:ee,p:j,alignItems:"center",justifyContent:"space-around",width:"fit-content",minWidth:.5},children:l?r.map(({type:a},n)=>e.jsxs(t,{sx:{display:"flex",gap:1,alignItems:"center"},children:[e.jsx(t,{sx:{borderRadius:99,width:"1rem",height:"1rem",bgcolor:"primary.main",filter:`hue-rotate(-${n*30+10}deg)`}}),e.jsx(h,{variant:"body1",component:"p",sx:{color:"text.secondary",textTransform:"uppercase",...b},children:a})]},n)):[...Array(3)].map((a,n)=>e.jsxs(t,{sx:{display:"flex",gap:1,alignItems:"center"},children:[e.jsx(t,{sx:{borderRadius:99,width:"1rem",height:"1rem",bgcolor:"primary.main",filter:`hue-rotate(-${n*30+10}deg)`}}),e.jsx(N,{loading:!0,children:e.jsx(h,{variant:"body1",component:"p",children:"載入中"})})]},n))})]})},Ce={tableNode:ce};function we({nodes:s,edges:i,isFetching:r}){const{mode:o}=U(),[c,l]=f.useState(s),[a,n]=f.useState(i),[d,u]=f.useState(!1);f.useEffect(()=>{if(d)return;let x,g=0;const v=R=>{if(R-g<200){x=requestAnimationFrame(v);return}if(g=R,!c.every($=>{var z,B;return((z=$.measured)==null?void 0:z.width)&&((B=$.measured)==null?void 0:B.height)})){x=requestAnimationFrame(v);return}const{nodes:H,edges:V}=pe(c,a,"horizontal");l(H),n(V),u(!0)};return x=requestAnimationFrame(v),()=>cancelAnimationFrame(x)},[c,a,d]),f.useEffect(()=>{r||(l(s),n(i),u(!1))},[s,i,r]);const m=f.useCallback(x=>l(g=>ne(x,g)),[l]),p=f.useCallback(x=>n(g=>ae(x,g)),[n]);return e.jsxs(e.Fragment,{children:[e.jsx(t,{sx:{position:"absolute",inset:0,display:"grid",placeItems:"center",bgcolor:"action.hover"},children:e.jsx(I,{})}),e.jsx(ie,{nodes:c,nodeTypes:Ce,edges:a,onNodesChange:m,onEdgesChange:p,deleteKeyCode:null,colorMode:o,defaultViewport:{x:10,y:10,zoom:.7},defaultEdgeOptions:{type:"smoothstep",animated:!0,selectable:!1,style:{strokeWidth:2,stroke:"#b1b1b7"},markerEnd:{type:le.Arrow,width:20,height:20}},style:{position:"relative",opacity:!d||r?0:1,transition:!d||r?void 0:"opacity 0.5s ease",background:"var(--mui-palette-background-paper)"},nodesDraggable:!1,nodesConnectable:!1,nodesFocusable:!1,panOnDrag:!1,panOnScroll:!1,zoomOnPinch:!1,zoomOnDoubleClick:!1,zoomOnScroll:!1,children:e.jsx(de,{bgColor:"var(--mui-palette-action-hover)"})})]})}const ke=f.memo(we),Ie=()=>{const{updatePath:s}=E(),i=()=>s(P.datahub_schema),{nodes:r,edges:o,isFetching:c}=te(),l=f.useMemo(()=>r.map(a=>({id:a.tableName,type:"tableNode",data:a,position:{x:0,y:0}})),[r]);return e.jsxs(y,{sx:{aspectRatio:{xs:"2/1",ml:"2/1.2"},borderTop:"1px solid",borderColor:"divider"},children:[e.jsxs(t,{sx:{display:"flex",gap:j,alignItems:"flex-end",p:j},children:[e.jsx(h,{variant:"h5",component:"h3",sx:{textWrap:"noWrap"},children:"資料表關聯圖"}),e.jsx(h,{variant:"body1",sx:{opacity:.8,...b},children:"透過視覺化的節點與連線，探索資料表彼此的結構與關聯。"})]}),e.jsx(t,{sx:{flex:1,width:1,position:"relative"},children:e.jsx(t,{sx:{position:"absolute",inset:0,p:j,pt:M},children:e.jsxs(t,{sx:{position:"relative",width:1,height:1,borderRadius:3,border:3,borderColor:"divider",borderStyle:"dashed"},children:[e.jsxs(t,{sx:{position:"absolute",inset:0,display:"grid",placeItems:"center"},children:[e.jsx(t,{sx:{position:"absolute",inset:0,zIndex:1}}),e.jsx(ke,{nodes:l,edges:o,isFetching:c})]}),e.jsx(t,{sx:{position:"absolute",inset:"auto 0 0 auto",color:"secondary.dark",translate:"1rem 50%",zIndex:2},children:e.jsx(X,{color:"inherit",size:"large",variant:"outlined",onClick:i,endIcon:e.jsx(oe,{}),sx:{"&:hover":{scale:"1.02"},scale:"1.001",transition:"all 0.2s ease-in-out",bgcolor:"background.paper"},children:"查看完整關聯圖"})})]})})})]})},Se=1.375,Te=({field:s,count:i,percentage:r,loading:o,noData:c,index:l})=>{const{updateSearchParams:a}=E(),n=()=>a({search:"true",searchQuery:s,searchTopic:"column"},{skipTransition:!0});return e.jsxs(e.Fragment,{children:[e.jsx(t,{children:o?e.jsx(k,{variant:"rounded",animation:"wave",children:e.jsx(h,{variant:"body1",sx:{...b,...A,width:"6rem"},children:"載入中"})}):c?e.jsx(h,{variant:"body1",sx:{...b,width:"6rem"},children:"---"}):e.jsx(w,{title:e.jsx(h,{children:s}),children:e.jsx(h,{variant:"body1",sx:{...b,...A,width:"6rem"},onClick:n,children:s})})}),e.jsx(w,{title:o||c?null:e.jsxs(t,{children:[e.jsx(h,{variant:"subtitle2",children:s}),e.jsxs(h,{children:["所有欄位名稱中的 ",`${Math.round(r*100)}%`]})]}),children:e.jsxs(t,{onClick:n,sx:{width:1,height:"1rem",borderRadius:99,position:"relative",overflow:"clip",display:"flex",alignItems:"center","&:hover":{bgcolor:"action.hover","& .bar-content":{opacity:1}},transition:"all 0.2s ease-in-out"},children:[e.jsx(F,{color1:"divider",color2:"#fff0",angle:-35,stripeWidth:5}),e.jsx(t,{sx:{position:"absolute",width:Math.max(0,Math.min(r*Se,1)),height:1,borderRadius:9,overflow:"clip",bgcolor:"background.paper",transition:C},children:e.jsx(t,{className:"bar-content",sx:{position:"absolute",inset:0,bgcolor:"primary.main",opacity:l===0?.9:.65,transition:"all 0.2s ease-in-out"}})})]})}),e.jsx(t,{children:o?e.jsx(k,{variant:"rounded",animation:"wave",children:e.jsx(h,{variant:"body1",sx:{...b,maxWidth:"10rem"},children:"載入中"})}):e.jsx(h,{variant:"body1",sx:{...b,maxWidth:"10rem"},children:c?"---":xe(i)})})]})},Ae=s=>{const i=s.toLowerCase();return["id","create","update","delete","timestamp","modif"].some(o=>i.includes(o))},Me=()=>{const[s,i]=f.useState(!1),{data:r,isFetching:o}=W({types:["table","view"]}),c=f.useMemo(()=>{if(!r||o)return[...Array(5)].map(()=>({field:"",count:0,percentage:0,loading:!0,noData:!1}));const l={};r.forEach(({columns:u})=>{u.forEach(({name:m})=>{l[m]=(l[m]||0)+1})});const a=Object.entries(l).filter(([u])=>s||!Ae(u)).toSorted((u,m)=>m[1]-u[1]).slice(0,5),n=a.reduce((u,[m,p])=>u+p,0),d=a.map(([u,m])=>({field:u,count:m,percentage:m/n,loading:!1,noData:!1}));if(d.length<5){const u=[...Array(5-d.length)].map(()=>({field:"",count:0,percentage:0,loading:!1,noData:!0}));return[...d,...u]}return d},[r,o,s]);return e.jsxs(y,{sx:{aspectRatio:{xs:"2/1",ml:"2/1.2"},borderTop:"1px solid",borderColor:"divider",position:"relative"},children:[e.jsxs(t,{sx:{display:"flex",gap:j,justifyContent:"space-between",alignItems:"flex-start",p:j},children:[e.jsx(h,{variant:"h5",component:"h3",children:"使用的欄位名稱"}),e.jsxs(y,{sx:{alignItems:"flex-end"},children:[e.jsx(he,{checked:s,onChange:({target:l})=>i(l.checked),control:e.jsx(ue,{}),labelPlacement:"start",label:e.jsx(h,{variant:"body1",sx:{opacity:.9},children:"包含系統欄位"})}),e.jsx(Y,{children:"(id, createdAt, updatedAt, ...)"})]})]}),e.jsxs(t,{sx:{position:"relative",maxWidth:1,flex:1,overflowX:"auto",overflowY:"hidden"},children:[e.jsxs(t,{sx:{display:"grid",gridTemplateColumns:"auto 1fr auto",gap:j,placeItems:"center","& > :nth-of-type(3n + 1)":{justifySelf:"flex-start"},p:j,pt:M,width:1,height:1},children:[e.jsx(t,{children:e.jsx(h,{variant:"body1",sx:{color:"text.secondary"},children:"最常使用"})}),e.jsx(t,{}),e.jsx(t,{children:e.jsx(h,{variant:"body1",sx:{color:"text.secondary"},children:"出現次數"})}),c.map((l,a)=>e.jsx(Te,{...l,index:a},a))]}),o&&e.jsx(t,{sx:{position:"absolute",inset:0,display:"grid",placeItems:"center",pointerEvents:"none"},children:e.jsx(I,{})})]})]})},rt=()=>e.jsxs(t,{sx:{position:"relative",mt:O,display:"grid",gap:O,gridTemplateColumns:{xs:"1fr",ml:"repeat(2, 1fr)"},width:1},children:[e.jsx(be,{}),e.jsx(ve,{}),e.jsx(Ie,{}),e.jsx(Me,{})]});export{rt as LargeTiles};
