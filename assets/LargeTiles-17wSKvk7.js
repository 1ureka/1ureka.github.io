import{j as e,o as t,l as h,t as g,x as A,w as N,r as f,S as y,A as I,G as V,J as q,M as H,p as K,B as G,af as J}from"./routes-cr_ZCX-8.js";import{a as Q}from"./ArrowDropDownRounded-l5C3B3y8.js";import{c as C,u as U,n as M,s as j,a as P,t as X,m as Y,b as Z,l as z}from"./main-Da6qTfYc.js";import{T as w,a as ee,b as S}from"./TileText-Z95d7Yeg.js";import{S as E,T as te}from"./StripedBackground-BjjAyzLR.js";import{u as F}from"./url-DkSgsy-i.js";import{S as k}from"./Skeleton-Bbc7q_aw.js";import{M as T}from"./MenuItem-B1sC-TLL.js";import{C as se}from"./Badge-CVBwiQYj.js";import{A as re}from"./ArrowOutwardRounded--EfyIIfm.js";import{a as oe,b as ne,i as ae,M as ie,T as le,B as ce,g as de}from"./style-nuDJcWm1.js";import{b as pe}from"./formatters-C9bWSe0O.js";import{F as xe,S as he}from"./Switch-doGGjdFr.js";import"./RefreshRounded-t4J3u6Hj.js";import"./SQLiteClient-DbsuRTG5.js";import"./DataExplorationRounded-DgK2y69Z.js";import"./NotificationsRounded-CgappPQM.js";import"./fuse-BxKT_-xx.js";import"./useMutation-DNy1f8c8.js";import"./dayjs.min-CuSq9ET4.js";import"./ExpandMoreRounded-D_er-ssT.js";import"./DarkModeRounded-1iHanKAf.js";import"./DownloadRounded-CpyN_2XC.js";import"./DatasetRounded-DA0wm4SE.js";import"./with-selector-DMVMw_Wq.js";import"./SwitchBase-CYVbkOv1.js";const L=s=>{const{update:l}=F();return()=>l(N.datahub_tables,a=>({db:a.db??null,table:s}))},ue=({label:s,records:l,percentage:o,loading:a,noData:p,index:i})=>{const n=L(s);return e.jsx(w,{title:a||p?null:e.jsxs(t,{children:[e.jsx(h,{variant:"subtitle2",children:s}),e.jsxs(h,{children:[l," 筆紀錄"]})]}),children:e.jsxs(t,{onClick:n,sx:{position:"relative",flex:1,borderRadius:2,overflow:"clip",transition:"all 0.2s ease-in-out","&:hover":{bgcolor:"action.hover","& .bar-content":{opacity:1}}},children:[e.jsx(E,{color1:"divider",color2:"#fff0",angle:-20,stripeWidth:5}),e.jsx(t,{sx:{position:"absolute",inset:`${a||p?100:Math.max(0,100-o)}% 0 0 0`,borderRadius:2,overflow:"hidden",bgcolor:"background.paper",transition:C},children:e.jsx(t,{className:"bar-content",sx:{position:"absolute",inset:0,bgcolor:"primary.main",opacity:i===0?.9:.65,transition:"all 0.2s ease-in-out"}})})]})})},me=({label:s,loading:l,noData:o})=>{const a=L(s);return l?e.jsx(k,{variant:"rounded",animation:"wave",children:e.jsx(h,{variant:"body1",component:"p",sx:{flex:1,textAlign:"center"},children:"載入中"})}):o?e.jsx(h,{variant:"body1",component:"p",sx:{flex:1,color:"text.secondary",...g,textAlign:"center"},children:"---"}):e.jsx(w,{title:e.jsx(h,{children:s}),children:e.jsx(h,{onClick:a,variant:"body1",component:"p",sx:{flex:1,color:"text.secondary",...A,...g,textAlign:"center"},children:s})})},je=({value:s,onClick:l})=>{const[o,a]=f.useState(null),p=r=>a(c=>c?null:r.currentTarget),i=()=>a(null),n=r=>()=>{l(r),i()};return e.jsxs(t,{sx:{display:"flex",gap:j,justifyContent:"space-between",alignItems:"center",p:j},children:[e.jsx(h,{variant:"h5",component:"h3",children:"紀錄數"}),e.jsxs(V,{sx:{"&:hover":{bgcolor:"action.hover"},p:1,pr:0,borderRadius:1},onClick:p,children:[e.jsxs(h,{sx:{color:"text.secondary"},children:["前 ",s," 筆"]}),e.jsx(Q,{sx:{color:"text.secondary"}})]}),e.jsx(q,{anchorEl:o,anchorOrigin:{horizontal:"center",vertical:"bottom"},transformOrigin:{horizontal:"center",vertical:"top"},open:!!o,onClose:i,children:e.jsxs(H,{dense:!0,children:[e.jsx(T,{onClick:n(3),selected:s===3,children:"前 3 筆"}),e.jsx(T,{onClick:n(5),selected:s===5,children:"前 5 筆"}),e.jsx(T,{onClick:n(7),selected:s===7,children:"前 7 筆"})]})})]})},fe=(s,l)=>{if(s===null)return{dataArray:[...Array(l)].map((x,d)=>({label:"載入中"+d,records:0,percentage:0,loading:!0,noData:!1})),averageAmount:0,averagePercentages:0};const o=Object.entries(s).sort(([,x],[,d])=>d-x).slice(0,l),a=o.map(([x])=>x),p=o.map(([,x])=>x),i=1.75,n=Object.values(p).reduce((x,d)=>x+d,0),r=Math.round(n/l),c=Math.round(r/n*100*i),u=p.map(x=>Math.round(x/n*100*i)),m=a.map((x,d)=>({label:x,records:p[d],percentage:u[d],loading:!1,noData:!1}));if(m.length<l){const x=[...Array(l-m.length)].map(()=>({label:"",records:0,percentage:0,loading:!1,noData:!0}));return{dataArray:[...m,...x],averageAmount:r,averagePercentages:c}}return{dataArray:m,averageAmount:r,averagePercentages:c}},be=()=>{const[s,l]=f.useState(5),{data:o,isFetching:a}=U({types:["table","view"]}),{dataArray:p,averageAmount:i,averagePercentages:n}=fe(a?null:o??null,s);return e.jsxs(y,{sx:{aspectRatio:{xs:"2/1",ml:"2/1.2"},borderTop:"1px solid",borderColor:"divider"},children:[e.jsx(je,{value:s,onClick:l}),e.jsxs(t,{sx:{position:"relative",flex:1,display:"flex",gap:j,p:j,py:M,justifyContent:"space-around",alignItems:"stretch"},children:[p.map((r,c)=>e.jsx(ue,{index:c,...r},c)),e.jsx(t,{sx:{position:"absolute",inset:`0 0 ${a?0:n}% 0`,borderBottom:"4px dashed",borderColor:"divider",pointerEvents:"none",mx:j,scale:"1.02 1",transition:C,"&:before":{content:`"平均 ${a?0:i} 筆"`,position:"absolute",right:0,bottom:0,fontSize:"1rem",color:"text.secondary",opacity:.75}}}),a&&e.jsx(t,{sx:{position:"absolute",inset:0,display:"grid",placeItems:"center",pointerEvents:"none"},children:e.jsx(I,{})})]}),e.jsx(t,{sx:{display:"flex",gap:j,p:j,justifyContent:"space-around",alignItems:"center"},children:p.map((r,c)=>e.jsx(me,{index:c,...r},c))})]})},W=({children:s,loading:l,...o})=>l?e.jsx(k,{variant:"rounded",animation:"wave",...o,children:s}):s,ge=()=>{const{data:s,isFetching:l}=P({types:["table","view"]}),o=f.useMemo(()=>{if(!s||l)return null;const n={};let r=0;s.forEach(({columns:x})=>{x.forEach(({type:d})=>{n[d]=(n[d]||0)+1,r+=1})});const c=[],u=new Set;let m=0;for(const[x,d]of Object.entries(n).sort((b,v)=>v[1]-b[1])){const b=d/r;c.length<3||b>=.1?c.push([x,d]):(m+=d,u.add(x))}if(m>0){const x=Array.from(u).slice(0,5),d=x.join(", ")+(x.length>5?", ...":"");c.push([`其他 (${d})`,m])}return c.map(([x,d])=>({type:x,count:d,percentage:d/r}))},[s,l]),a=o===null,p=!a&&o.length<3,i=!a&&!p;return e.jsxs(y,{sx:{aspectRatio:{xs:"2/1",ml:"2/1.2"},borderTop:"1px solid",borderColor:"divider",position:"relative"},children:[e.jsxs(t,{sx:{display:"flex",gap:j,justifyContent:"space-between",alignItems:"flex-start",p:j},children:[e.jsxs(y,{sx:{gap:1},children:[e.jsx(ee,{children:"最常使用的型別"}),e.jsx(W,{loading:a,children:e.jsx(S,{variant:"h4",sx:{textTransform:"uppercase"},children:a?"載入中":p?"N/A":o[0].type})})]}),e.jsx(te,{sx:{...X,mt:.5}})]}),e.jsxs(t,{sx:{flex:1,position:"relative"},children:[e.jsxs(t,{sx:{position:"absolute",inset:"auto 0 0 0",p:1.5,borderRadius:9,overflow:"clip"},children:[e.jsx(E,{color1:"divider",color2:"#fff0",angle:-35,stripeWidth:4}),i&&e.jsx(t,{sx:{position:"absolute",inset:0,display:"flex",alignItems:"stretch",zIndex:1},children:o.map(({type:n,count:r,percentage:c},u)=>e.jsx(w,{title:e.jsxs(S,{variant:"body1",sx:{textTransform:"uppercase"},children:[n," 型別使用了 ",r," 次"]}),children:e.jsx(t,{sx:{width:c,"&:hover":{bgcolor:"divider"},opacity:.9,transition:"all 0.2s ease-in-out"}})},u))})]}),e.jsx(t,{sx:{position:"absolute",inset:"auto 0 0 0",my:1.5,display:"grid",placeItems:"center"},children:e.jsx(t,{sx:{position:"absolute",width:1,display:"flex",alignItems:"center",scale:i?"1 1":"0 1",opacity:i?1:0,transition:C},children:i&&o.map(({percentage:n},r)=>e.jsx(t,{sx:{width:n,px:.5,pl:r===0?1:.5,pr:r===o.length-1?1:.5},children:e.jsx(t,{sx:{py:.5,borderRadius:9,bgcolor:"primary.main",filter:`hue-rotate(-${r*30+10}deg)`}})},r))})}),e.jsx(t,{sx:{position:"absolute",inset:0,display:"flex",transformOrigin:"left",scale:i?"1 1":"1 0",transition:C},children:i&&o.map(({type:n,percentage:r},c)=>e.jsx(t,{sx:{width:r,height:1,position:"relative"},children:e.jsx(t,{sx:{position:"absolute",inset:0,ml:c===0?1:0,mb:3,borderLeft:4,borderColor:"divider"},children:e.jsxs(t,{sx:{position:"absolute",inset:"0 auto auto 0"},children:[e.jsx(h,{variant:"body2",sx:{textTransform:"uppercase",color:"text.secondary",ml:1,...g},children:n}),e.jsxs(S,{sx:{textTransform:"uppercase",opacity:.8,ml:1},children:[Math.round(r*100),"%"]})]})})},c))}),a&&e.jsx(t,{sx:{position:"absolute",inset:0,display:"grid",placeItems:"center",pointerEvents:"none"},children:e.jsx(I,{})}),p&&e.jsx(t,{sx:{position:"absolute",inset:0,display:"grid",placeItems:"center",pointerEvents:"none"},children:e.jsx(se,{sx:{p:3,borderRadius:99},label:e.jsx(h,{variant:"h6",component:"p",sx:{color:"text.secondary"},children:"資料不足"})})})]}),e.jsx(t,{sx:{display:"flex",gap:Y,p:j,alignItems:"center",justifyContent:"space-around",width:"fit-content",minWidth:.5},children:i?o.map(({type:n},r)=>e.jsxs(t,{sx:{display:"flex",gap:1,alignItems:"center"},children:[e.jsx(t,{sx:{borderRadius:99,width:"1rem",height:"1rem",bgcolor:"primary.main",filter:`hue-rotate(-${r*30+10}deg)`}}),e.jsx(h,{variant:"body1",component:"p",sx:{color:"text.secondary",textTransform:"uppercase",...g},children:n})]},r)):[...Array(3)].map((n,r)=>e.jsxs(t,{sx:{display:"flex",gap:1,alignItems:"center"},children:[e.jsx(t,{sx:{borderRadius:99,width:"1rem",height:"1rem",bgcolor:"primary.main",filter:`hue-rotate(-${r*30+10}deg)`}}),e.jsx(W,{loading:!0,children:e.jsx(h,{variant:"body1",component:"p",children:"載入中"})})]},r))})]})},ye={tableNode:le};function ve({nodes:s,edges:l,isFetching:o}){const{mode:a}=K(),[p,i]=f.useState(s),[n,r]=f.useState(l),[c,u]=f.useState(!1);f.useEffect(()=>{if(c)return;let d,b=0;const v=R=>{if(R-b<200){d=requestAnimationFrame(v);return}if(b=R,!p.every(B=>{var O,D;return((O=B.measured)==null?void 0:O.width)&&((D=B.measured)==null?void 0:D.height)})){d=requestAnimationFrame(v);return}const{nodes:$,edges:_}=de(p,n,"horizontal");i($),r(_),u(!0)};return d=requestAnimationFrame(v),()=>cancelAnimationFrame(d)},[p,n,c]),f.useEffect(()=>{o||(i(s),r(l),u(!1))},[s,l,o]);const m=f.useCallback(d=>i(b=>oe(d,b)),[i]),x=f.useCallback(d=>r(b=>ne(d,b)),[r]);return e.jsxs(e.Fragment,{children:[e.jsx(t,{sx:{position:"absolute",inset:0,display:"grid",placeItems:"center",bgcolor:"action.hover"},children:e.jsx(I,{})}),e.jsx(ae,{nodes:p,nodeTypes:ye,edges:n,onNodesChange:m,onEdgesChange:x,deleteKeyCode:null,colorMode:a,defaultViewport:{x:10,y:10,zoom:.7},defaultEdgeOptions:{type:"smoothstep",animated:!0,selectable:!1,style:{strokeWidth:2,stroke:"#b1b1b7"},markerEnd:{type:ie.Arrow,width:20,height:20}},style:{position:"relative",opacity:!c||o?0:1,transition:!c||o?void 0:"opacity 0.5s ease",background:"var(--mui-palette-background-paper)"},nodesDraggable:!1,nodesConnectable:!1,nodesFocusable:!1,panOnDrag:!1,panOnScroll:!1,zoomOnPinch:!1,zoomOnDoubleClick:!1,zoomOnScroll:!1,children:e.jsx(ce,{bgColor:"var(--mui-palette-action-hover)"})})]})}const Ce=f.memo(ve),we=()=>{const{updatePath:s}=F(),l=()=>s(N.datahub_schema),{nodes:o,edges:a,isFetching:p}=Z(),i=f.useMemo(()=>o.map(n=>({id:n.tableName,type:"tableNode",data:n,position:{x:0,y:0}})),[o]);return e.jsxs(y,{sx:{aspectRatio:{xs:"2/1",ml:"2/1.2"},borderTop:"1px solid",borderColor:"divider"},children:[e.jsxs(t,{sx:{display:"flex",gap:j,alignItems:"flex-end",p:j},children:[e.jsx(h,{variant:"h5",component:"h3",sx:{textWrap:"noWrap"},children:"資料表關聯圖"}),e.jsx(h,{variant:"body1",sx:{opacity:.8,...g},children:"透過視覺化的節點與連線，探索資料表彼此的結構與關聯。"})]}),e.jsx(t,{sx:{flex:1,width:1,position:"relative"},children:e.jsx(t,{sx:{position:"absolute",inset:0,p:j,pt:M},children:e.jsxs(t,{sx:{position:"relative",width:1,height:1,borderRadius:3,border:3,borderColor:"divider",borderStyle:"dashed"},children:[e.jsxs(t,{sx:{position:"absolute",inset:0,display:"grid",placeItems:"center"},children:[e.jsx(t,{sx:{position:"absolute",inset:0,zIndex:1}}),e.jsx(Ce,{nodes:i,edges:a,isFetching:p})]}),e.jsx(t,{sx:{position:"absolute",inset:"auto 0 0 auto",color:"secondary.dark",translate:"1rem 50%",zIndex:2},children:e.jsx(G,{color:"inherit",size:"large",variant:"outlined",onClick:l,endIcon:e.jsx(re,{}),sx:{"&:hover":{scale:"1.02"},scale:"1.001",transition:"all 0.2s ease-in-out",bgcolor:"background.paper"},children:"查看完整關聯圖"})})]})})})]})},ke=1.375,Ie=({field:s,count:l,percentage:o,loading:a,noData:p,index:i})=>{const{updateSearchParams:n}=F(),r=()=>n({search:"true",searchQuery:s,searchTopic:"column"},{skipTransition:!0});return e.jsxs(e.Fragment,{children:[e.jsx(t,{children:a?e.jsx(k,{variant:"rounded",animation:"wave",children:e.jsx(h,{variant:"body1",sx:{...g,...A,width:"6rem"},children:"載入中"})}):p?e.jsx(h,{variant:"body1",sx:{...g,width:"6rem"},children:"---"}):e.jsx(w,{title:e.jsx(h,{children:s}),children:e.jsx(h,{variant:"body1",sx:{...g,...A,width:"6rem"},onClick:r,children:s})})}),e.jsx(w,{title:a||p?null:e.jsxs(t,{children:[e.jsx(h,{variant:"subtitle2",children:s}),e.jsxs(h,{children:["所有欄位名稱中的 ",`${Math.round(o*100)}%`]})]}),children:e.jsxs(t,{onClick:r,sx:{width:1,height:"1rem",borderRadius:99,position:"relative",overflow:"clip",display:"flex",alignItems:"center","&:hover":{bgcolor:"action.hover","& .bar-content":{opacity:1}},transition:"all 0.2s ease-in-out"},children:[e.jsx(E,{color1:"divider",color2:"#fff0",angle:-35,stripeWidth:5}),e.jsx(t,{sx:{position:"absolute",width:Math.max(0,Math.min(o*ke,1)),height:1,borderRadius:9,overflow:"clip",bgcolor:"background.paper",transition:C},children:e.jsx(t,{className:"bar-content",sx:{position:"absolute",inset:0,bgcolor:"primary.main",opacity:i===0?.9:.65,transition:"all 0.2s ease-in-out"}})})]})}),e.jsx(t,{children:a?e.jsx(k,{variant:"rounded",animation:"wave",children:e.jsx(h,{variant:"body1",sx:{...g,maxWidth:"10rem"},children:"載入中"})}):e.jsx(h,{variant:"body1",sx:{...g,maxWidth:"10rem"},children:p?"---":pe(l)})})]})},Se=s=>{const l=s.toLowerCase();return["id","create","update","delete","timestamp","modif"].some(a=>l.includes(a))},Te=()=>{const[s,l]=f.useState(!1),{data:o,isFetching:a}=P({types:["table","view"]}),p=f.useMemo(()=>{if(!o||a)return[...Array(5)].map(()=>({field:"",count:0,percentage:0,loading:!0,noData:!1}));const i={};o.forEach(({columns:u})=>{u.forEach(({name:m})=>{i[m]=(i[m]||0)+1})});const n=Object.entries(i).filter(([u])=>s||!Se(u)).toSorted((u,m)=>m[1]-u[1]).slice(0,5),r=n.reduce((u,[m,x])=>u+x,0),c=n.map(([u,m])=>({field:u,count:m,percentage:m/r,loading:!1,noData:!1}));if(c.length<5){const u=[...Array(5-c.length)].map(()=>({field:"",count:0,percentage:0,loading:!1,noData:!0}));return[...c,...u]}return c},[o,a,s]);return e.jsxs(y,{sx:{aspectRatio:{xs:"2/1",ml:"2/1.2"},borderTop:"1px solid",borderColor:"divider",position:"relative"},children:[e.jsxs(t,{sx:{display:"flex",gap:j,justifyContent:"space-between",alignItems:"flex-start",p:j},children:[e.jsx(h,{variant:"h5",component:"h3",children:"使用的欄位名稱"}),e.jsxs(y,{sx:{alignItems:"flex-end"},children:[e.jsx(xe,{checked:s,onChange:({target:i})=>l(i.checked),control:e.jsx(he,{}),labelPlacement:"start",label:e.jsx(h,{variant:"body1",sx:{opacity:.9},children:"包含系統欄位"})}),e.jsx(J,{children:"(id, createdAt, updatedAt, ...)"})]})]}),e.jsxs(t,{sx:{position:"relative",maxWidth:1,flex:1,overflowX:"auto",overflowY:"hidden"},children:[e.jsxs(t,{sx:{display:"grid",gridTemplateColumns:"auto 1fr auto",gap:j,placeItems:"center","& > :nth-of-type(3n + 1)":{justifySelf:"flex-start"},p:j,pt:M,width:1,height:1},children:[e.jsx(t,{children:e.jsx(h,{variant:"body1",sx:{color:"text.secondary"},children:"最常使用"})}),e.jsx(t,{}),e.jsx(t,{children:e.jsx(h,{variant:"body1",sx:{color:"text.secondary"},children:"出現次數"})}),p.map((i,n)=>e.jsx(Ie,{...i,index:n},n))]}),a&&e.jsx(t,{sx:{position:"absolute",inset:0,display:"grid",placeItems:"center",pointerEvents:"none"},children:e.jsx(I,{})})]})]})},tt=()=>e.jsxs(t,{sx:{position:"relative",mt:z,display:"grid",gap:z,gridTemplateColumns:{xs:"1fr",ml:"repeat(2, 1fr)"},width:1},children:[e.jsx(be,{}),e.jsx(ge,{}),e.jsx(we,{}),e.jsx(Te,{})]});export{tt as LargeTiles};
