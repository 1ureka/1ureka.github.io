var _=Object.defineProperty;var Q=(e,t,s)=>t in e?_(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s;var D=(e,t,s)=>Q(e,typeof t!="symbol"?t+"":t,s);import{n as z,v as R,r as J,o as C,j as a,T as h,B as g,P as U,q as j,y as L,w as K,C as V,x as G}from"./routes-6viKbL0G.js";import{i as O,h as Y,a as X,t as w,d as Z,b as ee,g as te,f as se,s as q,R as re,Q as ae,c as ne,E as oe}from"./forum-CQ6vMwqh.js";import{F as k}from"./ForumRounded-Pin0pi4o.js";import{Q as ie,a as ce,u as T}from"./useQuery-B2a_c7zo.js";import{S as le}from"./Skeleton-BDqUCout.js";var ue=class extends ie{constructor(e,t){super(e,t)}bindMethods(){super.bindMethods(),this.fetchNextPage=this.fetchNextPage.bind(this),this.fetchPreviousPage=this.fetchPreviousPage.bind(this)}setOptions(e,t){super.setOptions({...e,behavior:O()},t)}getOptimisticResult(e){return e.behavior=O(),super.getOptimisticResult(e)}fetchNextPage(e){return this.fetch({...e,meta:{fetchMore:{direction:"forward"}}})}fetchPreviousPage(e){return this.fetch({...e,meta:{fetchMore:{direction:"backward"}}})}createResult(e,t){var y,E;const{state:s}=e,n=super.createResult(e,t),{isFetching:r,isRefetching:i,isError:o,isRefetchError:l}=n,c=(E=(y=s.fetchMeta)==null?void 0:y.fetchMore)==null?void 0:E.direction,d=o&&c==="forward",f=r&&c==="forward",m=o&&c==="backward",x=r&&c==="backward";return{...n,fetchNextPage:this.fetchNextPage,fetchPreviousPage:this.fetchPreviousPage,hasNextPage:X(t,s.data),hasPreviousPage:Y(t,s.data),isFetchNextPageError:d,isFetchingNextPage:f,isFetchPreviousPageError:m,isFetchingPreviousPage:x,isRefetchError:l&&!d&&!m,isRefetching:i&&!f&&!x}}};function de(e,t){return ce(e,ue)}const S=z({cssVariables:{colorSchemeSelector:".mode-%s"},typography:{fontFamily:'Comfortaa, "jf openhuninn", "Noto Sans TC"'},colorSchemes:{light:{palette:{text:{primary:"#000"},primary:{main:"#FF772E",contrastText:"#fff"},secondary:{main:"#2f5d6f"}}},dark:{palette:{primary:{main:"#FF772E",contrastText:"#fff"},secondary:{main:"#2f5d6f"},background:{default:"#222",paper:"#222"}}}},components:{MuiInputBase:{defaultProps:{sx:{"&.Mui-disabled::before":{borderBottomStyle:"solid"}}}}},spacing:"0.5rem"}),Fe=()=>{const e=R(S.breakpoints.up("lg")),t=R(S.breakpoints.up("md")),s=R(S.breakpoints.up("sm"));return J.useEffect(()=>{e?document.documentElement.style.fontSize="16px":s?document.documentElement.style.fontSize="15px":document.documentElement.style.fontSize="13px"},[e,t,s]),{isLg:e,isMd:t,isSm:s}},he=C(a.jsx("path",{d:"M20 3H4c-1.1 0-2 .9-2 2v11c0 1.1.9 2 2 2h3c-.55.55-1 .87-1 1.59 0 .78.63 1.41 1.41 1.41h9.17c.78 0 1.41-.63 1.41-1.41 0-.72-.44-1.03-1-1.59h3c1.1 0 2-.9 2-2V5C22 3.9 21.1 3 20 3m0 13H4V5h16z"})),H=C(a.jsx("path",{d:"M16.88 2.88c-.49-.49-1.28-.49-1.77 0L6.7 11.29c-.39.39-.39 1.02 0 1.41l8.41 8.41c.49.49 1.28.49 1.77 0s.49-1.28 0-1.77L9.54 12l7.35-7.35c.48-.49.48-1.28-.01-1.77"})),fe=C(a.jsx("path",{d:"M12 7c.55 0 1 .45 1 1v4c0 .55-.45 1-1 1s-1-.45-1-1V8c0-.55.45-1 1-1m-.01-5C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2M12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8m1-3h-2v-2h2z"})),M=500,P="sqlite-db-forum";class u{static async exec(t,s){const n=Date.now();this.dbPromise=this.dbPromise===null?this.loadDatabase():this.dbPromise;const r=await this.dbPromise;r.run("PRAGMA foreign_keys = ON;");const[{values:i}]=r.exec("PRAGMA foreign_keys;");if(i[0][0]!==1)return console.error("Failed to enable foreign keys"),this.parse([]);const o=await w((async()=>{const c=r.exec(t,s);return await this.saveDatabase(r),c})());if(o.error!==null)return console.error("Failed to execute SQL query",o.error),this.parse([]);const l=Date.now()-n;return l<M&&await new Promise(c=>setTimeout(c,M-l)),this.parse(o.data)}static async reset(){await Z(P),this.dbPromise=this.loadDatabase()}static parse(t){if(t.length===0||!t[0])return[];const{columns:s,values:n}=t[0];return n.map(r=>Object.fromEntries(s.map((i,o)=>[i,r[o]])))}static async loadDatabase(){const t=await ee({locateFile:c=>`https://sql.js.org/dist/${c}`}),{data:s,error:n}=await w(te(P));if(n&&console.error("Failed to get cached database",n),s)return new t.Database(s);const{data:r,error:i}=await w((async()=>{const d=await(await fetch(se)).arrayBuffer();return new t.Database(new Uint8Array(d))})());if(i)return console.error("Failed to fetch database file",i),new t.Database;const o=r.export(),{error:l}=await w(q(P,o));return l&&console.error("Failed to save database to IndexedDB",l),r}static async saveDatabase(t){const s=t.export(),{error:n}=await w(q(P,s));n&&console.error("Failed to save database to IndexedDB",n)}}D(u,"dbPromise",null);async function v(e){const s=new TextEncoder().encode(e),n=await crypto.subtle.digest("SHA-256",s);return Array.from(new Uint8Array(n)).map(i=>i.toString(16).padStart(2,"0")).join("")}const p="forum_session",me=1e3*60*60*1,Ae=async({username:e,password:t})=>{const s=await b({name:e});if(!s)return{authenticated:!1,user:null,loading:!1,error:"使用者不存在"};const n=`
    SELECT id
    FROM users
    WHERE name = $username AND hashedPassword = $hashedPassword
  `,r=await v(t);if((await u.exec(n,{$username:e,$hashedPassword:r})).length===0)return{authenticated:!1,user:null,loading:!1,error:"密碼錯誤"};const o={authenticated:!0,user:s,loading:!1,error:null},l={...o,timestamp:Date.now()};return localStorage.setItem(p,JSON.stringify(l)),o},I=async()=>{const e=localStorage.getItem(p);if(!e)return{authenticated:!1,user:null,loading:!1,error:null};const t=JSON.parse(e);if(!t.authenticated)return localStorage.removeItem(p),{authenticated:!1,user:null,loading:!1,error:null};const s=Date.now();if(s-t.timestamp>me)return localStorage.removeItem(p),{authenticated:!1,user:null,loading:!1,error:"會話已過期，請重新登入"};const r=await u.exec(`
    SELECT id, name, description, email
    FROM users
    WHERE id = $userId
    LIMIT 1
  `,{$userId:t.user.id});if(r.length===0)return localStorage.removeItem(p),{authenticated:!1,user:null,loading:!1,error:"使用者不存在"};const i=r[0],o={...t,user:i},l={...o,timestamp:s};return localStorage.setItem(p,JSON.stringify(l)),o},pe=async()=>{localStorage.removeItem(p)},De=async({username:e,password:t,email:s,description:n=""})=>{if(await b({name:e}))return{authenticated:!1,user:null,loading:!1,error:"使用者名稱已存在"};if(await B({email:s}))return{authenticated:!1,user:null,loading:!1,error:"電子郵件已被使用"};const o=await v(t),l=new Date().toISOString(),d=await u.exec(`
      INSERT INTO users (name, email, hashedPassword, description, createdAt, updatedAt)
      VALUES ($name, $email, $hashedPassword, $description, $createdAt, $updatedAt)
      RETURNING id, name, description
    `,{$name:e,$email:s,$hashedPassword:o,$description:n,$createdAt:l,$updatedAt:l});if(!d||d.length===0)return{authenticated:!1,user:null,loading:!1,error:"註冊失敗"};const m={authenticated:!0,user:d[0],loading:!1,error:null},x={...m,timestamp:Date.now()};return localStorage.setItem(p,JSON.stringify(x)),m},Oe=async({userId:e,username:t,email:s,description:n})=>{const r=await I();if(!r.authenticated||r.user.id!==e)return{authenticated:!1,user:null,loading:!1,error:"未登入或無權限"};if(!t&&!s&&n===void 0)return{...r,error:"沒有要更新的欄位"};if(t===r.user.name&&s===r.user.email&&n===r.user.description)return{...r,error:"個人資料沒有任何變更需要更新"};if(t&&t!==r.user.name&&await b({name:t}))return{...r,error:"使用者名稱已存在"};if(s&&s!==r.user.email&&await B({email:s}))return{...r,error:"電子郵件已被使用"};const i=[],o={$userId:e};t&&(i.push("name = $username"),o.$username=t),s&&(i.push("email = $email"),o.$email=s),n!==void 0&&(i.push("description = $description"),o.$description=n),i.push("updatedAt = $updatedAt"),o.$updatedAt=new Date().toISOString();const l=`
      UPDATE users
      SET ${i.join(", ")}
      WHERE id = $userId
      RETURNING id, name, email, description
    `,c=await u.exec(l,o);if(!c||c.length===0)return{...r,error:"更新失敗"};const f={authenticated:!0,user:c[0],loading:!1,error:null},m={...f,timestamp:Date.now()};return localStorage.setItem(p,JSON.stringify(m)),f},qe=async({userId:e,currentPassword:t,newPassword:s})=>{const n=await I();if(!n.authenticated||n.user.id!==e)return{authenticated:!1,user:null,loading:!1,error:"未登入或無權限"};const r=await v(t);if((await u.exec(`
      SELECT id
      FROM users
      WHERE id = $userId AND hashedPassword = $hashedPassword
    `,{$userId:e,$hashedPassword:r})).length===0)return{...n,error:"當前密碼錯誤"};const l=await v(s),c=new Date().toISOString();return await u.exec(`
      UPDATE users
      SET hashedPassword = $hashedPassword,
          updatedAt = $updatedAt
      WHERE id = $userId
    `,{$userId:e,$hashedPassword:l,$updatedAt:c}),{...n,error:null}},Me=async({userId:e})=>{const t=await I();return!t.authenticated||t.user.id!==e?{success:!1,error:"未登入或無權限"}:(await u.exec(`
      DELETE FROM users
      WHERE id = $userId
    `,{$userId:e}),await pe(),{success:!0,error:null})},xe=async()=>{var s;return((s=(await u.exec(`
      SELECT COUNT(*) as count
      FROM users
    `))[0])==null?void 0:s.count)||0},ge=async({page:e=0,limit:t=10,isAuthor:s=!1,isUnfollowed:n=!1,orderBy:r="createdAt",order:i="desc"}={})=>{var F;let o=null;if(n){const A=await I();o=A.authenticated?A.user.id:null}const l=[],c={};s&&l.push("EXISTS (SELECT 1 FROM posts WHERE posts.userId = u.id)"),n&&o&&(l.push(`
      u.id <> $currentUserId AND
      NOT EXISTS (
        SELECT 1 FROM user_interactions
        WHERE followerId = $currentUserId AND followeeId = u.id AND type = 'follow'
      )
    `),c.$currentUserId=o);const d=l.length>0?`WHERE ${l.join(" AND ")}`:"";let f="u.createdAt";r==="postCount"||r==="followerCount"?f=`uic.${r}`:f=`u.${r}`;const m=`
      SELECT COUNT(*) as totalCount
      FROM users u
      ${d}
    `,N=((F=(await u.exec(m,c))[0])==null?void 0:F.totalCount)||0,y=Math.ceil(N/t),E=e+1<y?e+1:null;c.$limit=t,c.$offset=e*t;const W=`
      SELECT u.id, u.name, u.description
      FROM users u
      LEFT JOIN user_interaction_counts uic ON u.id = uic.userId
      ${d}
      ORDER BY ${f} ${i.toUpperCase()}, datetime(u.createdAt) DESC
      LIMIT $limit OFFSET $offset
    `;return{users:await u.exec(W,c),nextPage:E,totalPages:y}},b=async({name:e})=>{const s=await u.exec(`
      SELECT id, name, description, email
      FROM users
      WHERE name = $name
      LIMIT 1
    `,{$name:e});return s.length===0?null:s[0]},B=async({email:e})=>{const s=await u.exec(`
        SELECT id, name, description, email
        FROM users
        WHERE email = $email
        LIMIT 1
      `,{$email:e});return s.length===0?null:s[0]},ye=async({userId:e})=>(await u.exec(`
      SELECT
        followerCount,
        followingCount,
        postCount,
        totalLikeCount as likeCount,
        totalViewCount as viewCount
      FROM user_interaction_counts
      WHERE userId = $userId
    `,{$userId:e}))[0],$=1*60*1e3,we=()=>T({queryKey:["userCounts"],queryFn:xe,staleTime:$}),Ue=({page:e=0,limit:t,isAuthor:s=!0,orderBy:n,order:r}={})=>de({queryKey:["users",e,t,s,n,r],queryFn:async({pageParam:i})=>ge({page:i,limit:t,isAuthor:s,orderBy:n,order:r}),initialPageParam:0,getNextPageParam:i=>i.nextPage,staleTime:$}),Le=e=>T({queryKey:["user",e],queryFn:()=>e==null?null:b({name:e}),staleTime:$}),ke=e=>T({queryKey:["userStats",e],queryFn:()=>ye({userId:e}),staleTime:$}),Se=()=>a.jsx(le,{variant:"rounded",animation:"wave",component:"span",sx:{display:"inline",mx:.5},children:a.jsx(h,{variant:"body2",component:"span",sx:{color:"primary.light"},children:"100"})}),Ee=()=>{const{data:e,isFetching:t}=we();return a.jsxs(h,{className:"mode-dark",variant:"body2",sx:{mt:4,color:"text.secondary"},children:["與其他",t||e===void 0?a.jsx(Se,{}):a.jsx(h,{component:"span",variant:"body2",sx:{color:"primary.light"},children:` ${e} `}),"位使用者一同加入我們"]})},He=()=>a.jsxs(g,{sx:{minHeight:"100vh",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",p:3,bgcolor:"secondary.main",color:"text.primary",textAlign:"center"},children:[a.jsxs(g,{className:"mode-dark",sx:{display:"flex",justifyContent:"center",alignItems:"center",gap:1,mb:4},children:[a.jsx(k,{color:"primary",sx:{fontSize:"2.5rem"}}),a.jsx(h,{variant:"h4",component:"h1",sx:{color:"text.primary",fontFamily:'"timemachine-wa"'},children:"論壇樣板"})]}),a.jsxs(U,{elevation:4,sx:{p:4,borderRadius:3,maxWidth:"100%",display:"flex",flexDirection:"column",alignItems:"center",gap:2},children:[a.jsx(he,{fontSize:"large",sx:{color:"text.secondary"}}),a.jsxs(h,{variant:"h5",component:"p",gutterBottom:!0,children:["該頁面僅支援桌面瀏覽器 (寬度大於 ",S.breakpoints.values.sm,"px)"]}),a.jsx(h,{variant:"body1",color:"text.secondary",children:"請使用電腦訪問以獲得最佳體驗"}),a.jsx(j,{variant:"contained",href:L.forum_home,startIcon:a.jsx(H,{}),sx:{mt:2},children:"返回首頁"})]}),a.jsx(Ee,{})]}),Pe=({error:e,resetErrorBoundary:t})=>a.jsxs(g,{sx:{minHeight:"100vh",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",p:3,bgcolor:"secondary.main",color:"text.primary",textAlign:"center"},children:[a.jsxs(g,{className:"mode-dark",sx:{display:"flex",justifyContent:"center",alignItems:"center",gap:1,mb:4},children:[a.jsx(k,{color:"primary",sx:{fontSize:"2.5rem"}}),a.jsx(h,{variant:"h4",component:"h1",sx:{color:"text.primary",fontFamily:'"timemachine-wa"'},children:"論壇樣板"})]}),a.jsxs(U,{elevation:4,sx:{p:4,borderRadius:3,maxWidth:"100%",display:"flex",flexDirection:"column",alignItems:"center",gap:2},children:[a.jsx(fe,{fontSize:"large",sx:{color:"error.main"}}),a.jsx(h,{variant:"h5",component:"p",gutterBottom:!0,children:"發生錯誤"}),a.jsx(h,{variant:"body1",color:"text.secondary",children:e==null?void 0:e.message}),a.jsx(h,{variant:"body1",color:"text.secondary",children:"很抱歉，頁面載入時發生問題，請稍後再試"}),a.jsxs(g,{sx:{display:"flex",gap:2,mt:2},children:[a.jsx(j,{variant:"contained",href:L.forum_home,startIcon:a.jsx(H,{}),children:"返回首頁"}),a.jsx(j,{variant:"outlined",onClick:()=>t(),startIcon:a.jsx(re,{}),children:"重新載入"})]})]}),a.jsxs(h,{className:"mode-dark",variant:"body2",sx:{mt:4,color:"text.secondary"},children:["如需協助，請聯繫",a.jsx(h,{component:"span",variant:"body2",sx:{cursor:"pointer",color:"primary.light","&:hover":{textDecoration:"underline"}},children:" 論壇樣板客服 "})]})]}),ve=new ae;function Be({children:e}){return a.jsxs(K,{theme:S,children:[a.jsx(V,{}),a.jsx(G,{}),a.jsx(ne,{client:ve,children:a.jsx(oe,{fallbackRender:t=>a.jsx(Pe,{...t}),children:e})})]})}const Ie={position:"relative",height:"100dvh",overflow:"auto",scrollbarWidth:"thin",scrollbarColor:"gray transparent",display:"flex",flexDirection:"column"},We=({children:e,...t})=>a.jsx(g,{sx:Ie,id:"scroll-area",className:"top",onScroll:s=>{const n=s.target;n.scrollTop<25?n.classList.add("top"):n.classList.remove("top")},...t,children:e});export{Be as A,He as N,We as S,Ee as U,Fe as a,H as b,we as c,u as d,de as e,Le as f,ke as g,Oe as h,qe as i,Me as j,I as k,Ae as l,pe as m,De as r,S as t,Ue as u};
