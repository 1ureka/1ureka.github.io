import{h as F,j as e,T as l,B as o,I as q,v as fe,t as Ie,r as w,w as ve,S as be,n as Ce,x as G,M as Se,i as ne,P as Ee,q as we}from"./Toast-Cx2S6ON-.js";import{S as ke,A as $e}from"./SentimentDissatisfiedRounded-CC0G1nem.js";import{g as T,s as I,a as Ae,A as Re,S as Fe}from"./ScrollArea-DOOd6zWm.js";import{u as N,D as Be,B as Pe,f as J,F as qe,U as re,g as Le,b as Te,c as Ne,d as Oe,e as De}from"./url-Dju1iMfB.js";import{B as p,t as Me,r as oe}from"./routes-Cj_lxZkv.js";import{a as _,i as ie,d as ze,g as We,e as Ke,u as _e,C as Qe}from"./post-YgoBmBOH.js";import{E as Y,a as He}from"./ExpandedPost-DwOPp_W8.js";import{L as Ve,T as Q,V as ae,P as Ue,a as Ge,S as Je,b as Ye}from"./PostHeader-Di2Du-k7.js";import{D as Xe}from"./DownloadRounded-Bf_HQ45J.js";import{S as $}from"./Skeleton-BNy5r-MV.js";import{C as K}from"./Chip-DjHfKfea.js";import{T as R}from"./Tooltip-uDq6W6yA.js";import{D as y}from"./Divider-B7hzBXuk.js";import{u as O}from"./SQLiteClient-BdEGQxAz.js";import{u as B}from"./react-error-boundary.esm-DwWODNLY.js";import{u as D}from"./useMutation-DYZnN_IX.js";import{E as Ze}from"./EmojiMenu-CjMThHC5.js";import{z as le}from"./index-mSkvzYyn.js";import{M as X}from"./MenuItem-BWJlJzHY.js";import{f as et}from"./formatters-C9bWSe0O.js";import{T as Z,a as P}from"./Tabs-Bu0PiCpD.js";import{B as tt}from"./ButtonGroup-CcmN2Pt_.js";import"./ForumRounded-DMf_LQX6.js";import"./ExpandMoreRounded-Dezdu6WF.js";import"./DarkModeRounded-DqjvIZVv.js";import"./OpenInNewRounded-BdOebzh7.js";import"./NotificationsRounded-D2Q9WMHU.js";import"./ListItemText-9RpWCaym.js";import"./Collapse-eR10p4fG.js";import"./with-selector-BPjM_fby.js";import"./CommentRounded-BsHzm7Gi.js";const z=F(e.jsx("path",{d:"m11.71 15.29 2.59-2.59c.39-.39.39-1.02 0-1.41L11.71 8.7c-.63-.62-1.71-.18-1.71.71v5.17c0 .9 1.08 1.34 1.71.71"})),W=F(e.jsx("path",{d:"M12.29 8.71 9.7 11.3c-.39.39-.39 1.02 0 1.41l2.59 2.59c.63.63 1.71.18 1.71-.71V9.41c0-.89-1.08-1.33-1.71-.7"})),A={display:"-webkit-box",WebkitLineClamp:1,WebkitBoxOrient:"vertical",overflow:"hidden",textOverflow:"ellipsis",textTransform:"none"},st=()=>{const{searchParams:t,updateSearchParams:n}=N(),s=t.get("postId"),a=s&&/^\d+$/.test(s)&&Number(s)>0?Number(s):-1,{data:i,isFetching:r}=_({postId:a-1});return r&&!i?e.jsx(p,{startIcon:e.jsx(W,{}),loading:!0,children:e.jsx(l,{variant:"button",sx:A,children:"載入中..."})}):i?e.jsx(p,{startIcon:e.jsx(W,{}),onClick:()=>n({postId:(a-1).toString()}),children:e.jsxs(l,{variant:"button",sx:A,children:["上一篇：",i.title]})}):e.jsx(p,{startIcon:e.jsx(W,{}),disabled:!0,children:e.jsx(l,{variant:"button",sx:A,children:"沒有上一篇了"})})},nt=()=>{const{searchParams:t,updateSearchParams:n}=N(),s=t.get("postId"),a=s&&/^\d+$/.test(s)&&Number(s)>0?Number(s):-1,{data:i,isFetching:r}=_({postId:a+1});return r&&!i?e.jsx(p,{endIcon:e.jsx(z,{}),loading:!0,children:e.jsx(l,{variant:"button",sx:A,children:"載入中..."})}):i?e.jsx(p,{endIcon:e.jsx(z,{}),onClick:()=>n({postId:(a+1).toString()}),children:e.jsxs(l,{variant:"button",sx:A,children:["下一篇：",i.title]})}):e.jsx(p,{endIcon:e.jsx(z,{}),disabled:!0,children:e.jsx(l,{variant:"button",sx:A,children:"沒有下一篇了"})})},rt=F(e.jsx("path",{d:"m21.41 11.41-8.83-8.83c-.37-.37-.88-.58-1.41-.58H4c-1.1 0-2 .9-2 2v7.17c0 .53.21 1.04.59 1.41l8.83 8.83c.78.78 2.05.78 2.83 0l7.17-7.17c.78-.78.78-2.04-.01-2.83M6.5 8C5.67 8 5 7.33 5 6.5S5.67 5 6.5 5 8 5.67 8 6.5 7.33 8 6.5 8"}));function ot(t){return it(t)%4+1}function it(t){let n=5381;for(let s=0;s<t.length;s++)n=(n<<5)+n+t.charCodeAt(s);return Math.abs(n)}const at=t=>["16/9","4/3","1/1","3/2"][ot(t)-1],lt=({open:t,onClose:n,name:s,...a})=>e.jsxs(Be,{open:t,onClose:n,slotProps:{paper:{elevation:1,sx:{overflow:"hidden",position:"relative"}}},maxWidth:"md",fullWidth:!0,...a,children:[e.jsx($,{variant:"rectangular",animation:"wave",sx:{aspectRatio:at(s),width:1,height:"auto",bgcolor:"divider"}}),e.jsx(o,{sx:{position:"absolute",inset:"auto 0 0 0",p:1,display:"grid",placeItems:"center"},children:e.jsxs(o,{sx:{display:"flex",gap:1,alignItems:"center"},children:[e.jsx(o,{sx:{maxWidth:200},children:e.jsx(K,{label:s})}),e.jsx(R,{title:"下載圖片",arrow:!0,children:e.jsx(q,{size:"small",children:e.jsx(Xe,{})})})]})}),e.jsx(o,{sx:{position:"absolute",inset:"0 0 auto auto",p:1},children:e.jsx(q,{onClick:i=>n&&n(i,"escapeKeyDown"),children:e.jsx(fe,{})})})]}),ct=t=>Array.from({length:t},()=>Math.random()*.7+.3),dt=()=>e.jsxs(o,{sx:{pt:1.5},children:[e.jsx(y,{}),e.jsxs(o,{sx:{position:"relative",py:1.5,height:"fit-content"},children:[e.jsx(o,{sx:{position:"absolute",inset:0,bgcolor:"divider",opacity:.35,pointerEvents:"none"}}),e.jsx(o,{sx:{px:2.5},children:e.jsx(Ve,{sx:{m:0}})})]}),e.jsx(y,{sx:{mb:2.5}}),e.jsxs(o,{sx:{px:2.5,position:"relative"},children:[e.jsx($,{variant:"rounded",animation:"wave",sx:{mb:1},children:e.jsx(l,{variant:"h4",component:"h2",sx:{textAlign:"start"},gutterBottom:!0,children:"正在載入標題... 正在載入"})}),ct(4).map((t,n)=>e.jsx($,{variant:"text",animation:"wave",width:`${t*100}%`},n)),e.jsx(Ie,{sx:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)"}})]}),e.jsx(y,{sx:{mt:2.5}}),e.jsxs(o,{sx:{p:1.5,py:1,display:"flex",gap:1.5,alignItems:"center",position:"relative",color:"text.secondary"},children:[e.jsx(o,{sx:{position:"absolute",inset:0,bgcolor:"divider",opacity:.35}}),e.jsx(p,{color:"inherit",startIcon:e.jsx(Q,{}),size:"small",loading:!0,children:e.jsx(l,{variant:"caption",component:"span",children:"100 個讚"})}),e.jsx(p,{color:"inherit",startIcon:e.jsx(Pe,{}),size:"small",loading:!0,children:e.jsx(l,{variant:"caption",component:"span",children:"收藏該貼文"})}),e.jsx(o,{sx:{flex:1}}),e.jsx(p,{color:"inherit",startIcon:e.jsx(ae,{}),size:"small",loading:!0,children:e.jsx(l,{variant:"caption",component:"span",children:"1000 次瀏覽"})})]}),e.jsx(y,{})]}),xt=({post:t})=>{const[n,s]=w.useState({open:!1,name:""}),a=r=>s({open:!0,name:r}),i=()=>s(r=>({open:!1,name:r.name}));return e.jsxs(o,{sx:{pt:1.5},children:[e.jsx("title",{children:`論壇樣板 | ${t.title}`}),e.jsx(y,{}),e.jsxs(o,{sx:{position:"relative",py:1.5,height:"fit-content"},children:[e.jsx(o,{sx:{position:"absolute",inset:0,bgcolor:"divider",opacity:.35,pointerEvents:"none"}}),e.jsx(o,{sx:{px:2.5},children:e.jsx(Ue,{post:t,sx:{m:0}})})]}),e.jsx(y,{sx:{mb:2.5}}),e.jsxs(o,{sx:{px:2.5},children:[e.jsx(l,{variant:"h4",component:"h2",sx:{textAlign:"start"},gutterBottom:!0,children:t.title}),e.jsx(l,{variant:"body2",component:"p",sx:{whiteSpace:"pre-line"},children:t.content}),t.photos&&t.photos.length>0&&e.jsx(o,{sx:{display:"grid",gap:1,mt:2,gridTemplateColumns:"repeat(auto-fill, minmax(150px, 1fr))"},children:t.photos.map(({name:r,url:c},d)=>e.jsx(R,{title:"查看圖片",arrow:!0,placement:"top",children:e.jsx(ve,{onClick:()=>a(r),sx:{position:"relative",aspectRatio:"1 / 1",bgcolor:"divider",borderRadius:1,overflow:"hidden"},children:e.jsx(o,{sx:{position:"absolute",inset:"auto 0 0 0",pb:1,display:"grid",placeItems:"center"},children:e.jsx(o,{sx:{maxWidth:150},children:e.jsx(K,{label:r,size:"small"})})})})},`${c}${d}`))}),e.jsx(lt,{open:n.open,onClose:i,name:n.name}),e.jsxs(be,{sx:{gap:1.5,flexDirection:"row",justifyContent:"space-between",alignItems:"center",flexWrap:"wrap-reverse",mt:2},children:[e.jsxs(o,{sx:{display:"flex",gap:1.5,flexWrap:"wrap",alignItems:"center"},children:[e.jsxs(l,{variant:"subtitle2",sx:{color:"text.secondary",display:"flex",alignItems:"center",gap:.5},children:[e.jsx(rt,{fontSize:"small"}),"標籤："]}),e.jsx(Ge,{post:t,displayCount:99})]}),t.attachments&&t.attachments.length>0&&e.jsxs(o,{sx:{display:"flex",gap:1,flexWrap:"wrap",alignItems:"center"},children:[e.jsxs(l,{variant:"subtitle2",sx:{color:"text.secondary",display:"flex",alignItems:"center",gap:.5},children:[e.jsx(J,{fontSize:"small"}),"附件："]}),t.attachments.map((r,c)=>e.jsx(R,{title:"下載附件",arrow:!0,placement:"top",children:e.jsx(K,{label:`${r.name} (${(r.size/1024).toFixed(1)}KB)`,clickable:!0,icon:e.jsx(J,{fontSize:"small"})})},c))]})]})]}),e.jsx(y,{sx:{mt:2.5}}),e.jsxs(o,{sx:{px:2.5,py:1,display:"flex",gap:1.5,alignItems:"center",position:"relative",color:"text.secondary"},children:[e.jsx(o,{sx:{position:"absolute",inset:0,bgcolor:"divider",opacity:.35}}),t.isSelf?e.jsx(Je,{post:t}):e.jsxs(e.Fragment,{children:[e.jsx(Ye,{postId:t.id,likeCount:t.likeCount}),e.jsx(qe,{postId:t.id})]}),e.jsx(o,{sx:{flex:1}}),e.jsx(p,{startIcon:e.jsx(ae,{}),disabled:!0,size:"small",sx:{"button&.Mui-disabled":{color:"text.secondary",opacity:.8}},children:e.jsxs(l,{variant:"caption",component:"span",children:[t.viewCount," 次瀏覽"]})})]}),e.jsx(y,{flexItem:!0})]})},ce=async t=>{const n=t.postId!==void 0,s=n?"c.postId = $id AND c.parentId IS NULL":"c.parentId = $id",i=(t.orderBy||"latest")==="latest"?"datetime(c.createdAt) DESC":"COALESCE(cic.likeCount, 0) DESC, datetime(c.createdAt) DESC",r=`
      SELECT c.id FROM comments c
      LEFT JOIN comment_interaction_counts cic ON c.id = cic.commentId
      WHERE ${s} ORDER BY ${i}
    `,c={$id:n?t.postId:t.parentId};return(await I.exec(r,c)).map(x=>x.id)},ut=async({commentId:t})=>{let n=null;const s=await T({server:!0});n=s.authenticated?s.user.id:null;const i=await I.exec(`
      SELECT
        c.id,
        c.postId,
        c.parentId,
        c.content,
        c.userId,
        u.name as userName,
        COALESCE(cic.likeCount, 0) as likeCount,
        c.createdAt,
        c.updatedAt
      FROM
        comments c
      JOIN
        users u ON c.userId = u.id
      LEFT JOIN
        comment_interaction_counts cic ON c.id = cic.commentId
      WHERE
        c.id = $commentId
    `,{$commentId:t});if(i.length===0)return null;const r=i[0];return{...r,id:r.id,postId:r.postId,parentId:r.parentId,content:r.content,userId:r.userId,userName:r.userName,likeCount:r.likeCount,createdAt:new Date(r.createdAt),updatedAt:new Date(r.updatedAt),isSelf:n!==null?r.userId===n:!1}},mt=async({postId:t,content:n,parentId:s})=>{const a=await T({server:!0});if(!a.authenticated)return{error:"未登入或授權失效，無法創建留言"};const i=a.user.id;if((await I.exec("SELECT id FROM posts WHERE id = $postId",{$postId:t})).length===0)return{error:"貼文不存在"};if(s){const S=await I.exec("SELECT id, postId FROM comments WHERE id = $parentId",{$parentId:s});if(S.length===0)return{error:"回覆的留言不存在"};if(S[0].postId!==t)return{error:"回覆的留言不屬於此貼文"}}const d=new Date().toISOString(),x=`
      INSERT INTO comments (userId, postId, parentId, content, createdAt, updatedAt)
      VALUES ($userId, $postId, $parentId, $content, $createdAt, $updatedAt)
      RETURNING id
    `,j={$userId:i,$postId:t,$parentId:s||null,$content:n,$createdAt:d,$updatedAt:d},u=await I.exec(x,j);return!u||u.length===0||typeof u[0].id!="number"?{error:"創建留言失敗"}:u[0].id},pt=async({commentId:t,content:n})=>{const s=await T({server:!0});if(!s.authenticated)return{error:"未登入或授權失效，無法編輯留言"};const a=s.user.id,r=await I.exec("SELECT userId FROM comments WHERE id = $commentId",{$commentId:t});if(r.length===0)return{error:"留言不存在"};if(r[0].userId!==a)return{error:"您沒有權限編輯此留言"};const c=new Date().toISOString(),d=`
      UPDATE comments
      SET content = $content,
          updatedAt = $updatedAt
      WHERE id = $commentId AND userId = $userId
    `,x={$commentId:t,$userId:a,$content:n,$updatedAt:c};return await I.exec(d,x),null},ht=async t=>{const n=await T({server:!0});if(!n.authenticated)return{error:"未登入或授權失效，無法刪除留言"};const s=n.user.id,i=await I.exec("SELECT userId FROM comments WHERE id = $commentId",{$commentId:t});return i.length===0?{error:"留言不存在"}:i[0].userId!==s?{error:"您沒有權限刪除此留言"}:(await I.exec("DELETE FROM comments WHERE id = $commentId AND userId = $userId",{$commentId:t,$userId:s}),null)},H=1e3*60*1,jt=({postId:t,orderBy:n})=>O({queryKey:["commentsByPost",t,n],queryFn:()=>ce({postId:t,orderBy:n}),staleTime:H}),de=t=>O({queryKey:["commentsByParent",t],queryFn:()=>ce({parentId:t,orderBy:"latest"}),staleTime:H}),yt=t=>O({queryKey:["comment",t],queryFn:()=>ut({commentId:t}),staleTime:H}),gt=()=>{const t=B();return D({mutationFn:mt,onSettled:()=>{t.invalidateQueries({queryKey:["commentsByPost"]}),t.invalidateQueries({queryKey:["commentsByParent"]}),t.invalidateQueries({queryKey:["comment"]}),t.invalidateQueries({queryKey:["post"]})}})},ft=()=>{const t=B();return D({mutationFn:pt,onSettled:()=>{t.invalidateQueries({queryKey:["commentsByPost"]}),t.invalidateQueries({queryKey:["commentsByParent"]}),t.invalidateQueries({queryKey:["comment"]}),t.invalidateQueries({queryKey:["post"]})}})},It=()=>{const t=B();return D({mutationFn:ht,onSettled:()=>{t.invalidateQueries({queryKey:["commentsByPost"]}),t.invalidateQueries({queryKey:["commentsByParent"]}),t.invalidateQueries({queryKey:["comment"]}),t.invalidateQueries({queryKey:["post"]})}})},xe=F(e.jsx("path",{d:"M10 9V7.41c0-.89-1.08-1.34-1.71-.71L3.7 11.29c-.39.39-.39 1.02 0 1.41l4.59 4.59c.63.63 1.71.19 1.71-.7V14.9c5 0 8.5 1.6 11 5.1-1-5-4-10-11-11"})),ue=F(e.jsx("path",{d:"M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2m0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2m0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2"})),ee=F(e.jsx("path",{d:"M8.12 9.29 12 13.17l3.88-3.88c.39-.39 1.02-.39 1.41 0s.39 1.02 0 1.41l-4.59 4.59c-.39.39-1.02.39-1.41 0L6.7 10.7a.996.996 0 0 1 0-1.41c.39-.38 1.03-.39 1.42 0"})),me={content:le.string().min(1,{message:"請輸入留言內容"}).max(250,{message:"留言內容過長"})},vt=le.object(me),bt={content:""},L=({type:t,hideAvator:n,sx:s,onCancel:a,postId:i,parentId:r,commentId:c,initialValues:d,...x})=>{const{mutateAsync:j,isPending:u}=gt(),{mutateAsync:g,isPending:S}=ft(),v=u||S,{user:f,authenticated:k,loading:b}=ie(),E=ze({defaultValues:{...bt,...d},validators:{onSubmit:vt},onSubmit:async({value:m})=>{if(!v){if(t==="create"){const h=await j({...m,postId:i,parentId:r});if(typeof h=="number")return E.reset(),console.log("發佈成功，留言 ID："+h);h.error&&console.error(`留言發佈失敗：${h.error}`)}if(t==="edit"){const h=await g({...m,commentId:c});if(h===null)return E.reset(),console.log("更新留言成功");h.error&&console.error(`留言更新失敗：${h.error}`)}}}}),he=async()=>{if(!E.state.canSubmit){Me(E.getAllErrors().fields).forEach(([m,h])=>{h.errors.forEach(C=>{!C||typeof C!="object"||"message"in C&&console.error(`${m}: ${C.message}`)})}),console.error("請檢查表單是否填寫正確");return}E.handleSubmit()},U=w.useRef(null),je=m=>{E.setFieldValue("content",h=>{const C=U.current;if(C){const M=C.selectionStart||0,ye=C.selectionEnd||0,ge=h.substring(0,M)+m+h.substring(ye);return setTimeout(()=>{C.focus(),C.setSelectionRange(M+m.length,M+m.length)},0),ge}return h+m})};return e.jsx(o,{sx:{position:"relative",py:1,px:2,...s},...x,children:e.jsxs(o,{sx:{display:"flex",alignItems:"flex-start",gap:1.5},children:[n?null:k&&f?e.jsx(re,{name:f.name,sx:{mt:1.5}}):e.jsx(Le,{sx:{width:"2rem",height:"2rem",mt:1.5}}),e.jsxs(o,{sx:{flex:1},children:[e.jsx(E.Field,{name:"content",validators:{onSubmit:me.content},children:m=>e.jsx(Ce,{inputRef:U,name:m.name,variant:"standard",size:"small",label:k?"發表你的想法":"登入後即可發表留言",fullWidth:!0,type:"text",disabled:!k||b,error:Ke(m.state.meta.errors),helperText:We(m.state.meta.errors),value:m.state.value,onChange:h=>m.handleChange(h.target.value),onBlur:m.handleBlur})}),e.jsxs(o,{sx:{display:"flex",justifyContent:"space-between",mt:1,alignItems:"center",gap:1},children:[e.jsx(Ze,{onEmojiClick:je,disabled:!k||b}),e.jsxs(o,{sx:{display:"flex",gap:1},children:[e.jsx(p,{size:"small",disabled:!k||b,sx:{color:"text.secondary"},loading:v,onClick:()=>{E.reset(),a!==void 0&&a()},children:"取消"}),e.jsx(E.Subscribe,{selector:m=>m.values.content,children:m=>e.jsx(p,{size:"small",disabled:!k||b||m.trim().length===0,variant:"contained",onClick:he,loading:v,children:"留言"})})]})]})]})]})})},Ct=async({commentId:t,userId:n})=>{const s=`
      SELECT 1 as liked
      FROM comment_interactions
      WHERE commentId = $commentId
        AND userId = $userId
        AND type = 'like'
      LIMIT 1
    `,a=`
      SELECT COALESCE(likeCount, 0) as likeCount
      FROM comment_interaction_counts
      WHERE commentId = $commentId
    `,i=await I.exec(s,{$commentId:t,$userId:n}),r=await I.exec(a,{$commentId:t}),c=i.length>0;return!r[0]||!Number.isInteger(r[0].likeCount)?null:{liked:c,likeCount:r[0].likeCount}},St=async({commentId:t,userId:n,type:s,value:a})=>{a?await I.exec(`
        INSERT OR IGNORE INTO comment_interactions (userId, commentId, type)
        VALUES ($userId, $commentId, $type)
      `,{$userId:n,$commentId:t,$type:s}):await I.exec(`
        DELETE FROM comment_interactions
        WHERE userId = $userId
          AND commentId = $commentId
          AND type = $type
      `,{$userId:n,$commentId:t,$type:s})},Et=0,wt=(t,n,s)=>{const a=B(),i=w.useRef(0);return D({mutationFn:r=>{if(n===void 0)throw new Error("未登入");return St({commentId:t,userId:n,type:s,value:r})},onMutate:()=>(i.current++,i.current),onSettled:(r,c,d,x)=>{if(x===i.current){const j=["commentLikeStatus",t,n];a.invalidateQueries({queryKey:j})}},onError:()=>{console.error("評論按讚操作失敗")}})},kt=t=>{const n=B(),{user:s,authenticated:a,loading:i}=ie(),{data:r,isLoading:c}=O({staleTime:Et,queryKey:["commentLikeStatus",t,s==null?void 0:s.id],enabled:!i&&a&&(s==null?void 0:s.id)!==void 0,queryFn:async()=>Ct({commentId:t,userId:s.id})}),d=i||c,x=!a||d||r===void 0||r===null,j=(r==null?void 0:r.liked)??!1,u=(r==null?void 0:r.likeCount)??null,{mutate:g}=wt(t,s==null?void 0:s.id,"like");return{liked:j,likeCount:u,handleLike:async()=>{x||(await n.cancelQueries({queryKey:["commentLikeStatus",t,s.id]}),n.setQueryData(["commentLikeStatus",t,s.id],v=>{const f=!v.liked;return g(f),{liked:f,likeCount:v.likeCount+(f?1:-1)}}))},disabled:x,loading:d}},$t=({commentId:t,likeCount:n})=>{const{liked:s,likeCount:a,handleLike:i,disabled:r,loading:c}=kt(t);return e.jsx(p,{size:"small",startIcon:e.jsx(Q,{}),onClick:i,color:s?"primary":"inherit",sx:{color:s?void 0:"text.secondary"},disabled:r,loading:c,children:e.jsx(l,{variant:"caption",children:a!==null?a>0?a:"讚":n})})},At=({onEdit:t,onDelete:n,isPending:s,isSelf:a})=>{const[i,r]=w.useState(null),c=f=>r(f.currentTarget),d=()=>r(null),[x,j]=w.useState(null),u=f=>j(f.currentTarget),g=()=>j(null),S=()=>{t(),d()},v=async()=>{await n(),d(),g()};return e.jsxs(e.Fragment,{children:[e.jsx(R,{title:a?"更多選項":"只有自己的留言才能編輯或刪除",arrow:!0,children:e.jsx("span",{children:e.jsx(q,{size:"small",onClick:c,disabled:!a,children:e.jsx(ue,{fontSize:"small"})})})}),e.jsx(G,{anchorEl:i,open:!!i,onClose:d,anchorOrigin:{vertical:"bottom",horizontal:"center"},transformOrigin:{vertical:"top",horizontal:"center"},elevation:6,children:e.jsxs(Se,{dense:!0,children:[e.jsx(X,{onClick:S,children:"編輯"}),e.jsx(X,{onClick:u,sx:{color:"error.main"},children:"刪除"})]})}),e.jsx(G,{anchorEl:x,open:!!x,onClose:g,anchorOrigin:{vertical:"bottom",horizontal:"center"},transformOrigin:{vertical:"top",horizontal:"center"},elevation:6,children:e.jsxs(o,{sx:{p:2,maxWidth:300},children:[e.jsx(l,{variant:"subtitle1",sx:{mb:1},children:"確認刪除留言"}),e.jsx(l,{variant:"body2",sx:{mb:2,color:"text.secondary"},children:"確認刪除留言後，將無法復原，請謹慎操作。"}),e.jsxs(o,{sx:{display:"flex",justifyContent:"flex-end",gap:1},children:[e.jsx(p,{variant:"outlined",size:"small",onClick:g,color:"inherit",loading:s,children:"取消"}),e.jsx(p,{variant:"contained",color:"error",size:"small",onClick:v,loading:s,disableElevation:!0,children:"確認刪除"})]})]})})]})},Rt=({comment:t})=>{const n=ne(d=>d.breakpoints.up("md")),{mutateAsync:s,isPending:a}=It(),i=async()=>{const d=await s(t.id);if(d===null)return console.log("留言刪除成功");d.error&&console.error(`留言刪除失敗：${d.error}`)},[r,c]=w.useState(!1);return r?e.jsx(L,{type:"edit",commentId:t.id,postId:t.postId,parentId:t.parentId??void 0,initialValues:{content:t.content},onCancel:()=>c(!1),hideAvator:!0}):e.jsxs(e.Fragment,{children:[e.jsxs(o,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx(l,{variant:"subtitle2",component:"a",sx:{"&:hover":{textDecoration:"underline"},color:"text.primary"},href:`${oe.forum_users}?user=${t.userName}`,children:t.userName}),e.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(l,{variant:"caption",color:"text.secondary",children:n?t.createdAt.toLocaleString():et(t.createdAt)}),t.createdAt.getTime()!==t.updatedAt.getTime()&&e.jsx(R,{title:`最後編輯於 ${t.updatedAt.toLocaleString()}`,arrow:!0,children:e.jsx(l,{variant:"caption",color:"text.secondary",children:"(已編輯)"})}),e.jsx(At,{onDelete:i,onEdit:()=>c(!0),isPending:a,isSelf:t.isSelf})]})]}),e.jsx(l,{variant:"body2",sx:{mt:.5,whiteSpace:"pre-line"},children:t.content})]})},pe=({postId:t,commentId:n,nestedLevel:s,sx:a,...i})=>{if(s<0)throw new Error("nestedLevel must be greater than 0");const r=ne(b=>b.breakpoints.up("sm")),{data:c,isFetching:d}=yt(n),{data:x,isFetching:j}=de(n),[u,g]=w.useState(!1),S=()=>g(b=>!b),[v,f]=w.useState(!1),k=()=>f(b=>!b);return d||!c||j?e.jsx(V,{nestedLevel:s,sx:a,...i}):e.jsxs(o,{sx:{position:"relative",py:1,pb:s>0?0:1,pl:{xs:1,sm:2},borderLeft:s>0?"2px solid":"none",borderColor:"divider",...a},...i,children:[e.jsxs(o,{sx:{display:"flex",alignItems:"flex-start",gap:1.5},children:[e.jsx(re,{name:c.userName,sx:{mt:1}}),e.jsxs(o,{sx:{flex:1},children:[e.jsx(Rt,{comment:c}),e.jsxs(o,{sx:{display:"flex",alignItems:"center",mt:1,gap:1},children:[e.jsx($t,{commentId:n,likeCount:c.likeCount}),e.jsx(p,{size:"small",startIcon:e.jsx(xe,{}),sx:{color:"text.secondary"},onClick:k,children:e.jsx(l,{variant:"caption",children:v?"取消回覆":"回覆"})})]}),v&&e.jsx(L,{onCancel:()=>f(!1),postId:t,parentId:n,type:"create"}),x&&x.length>0&&e.jsx(p,{startIcon:u?e.jsx(ee,{sx:{transform:"rotate(180deg)",transition:"transform 0.2s ease",transformOrigin:"center"}}):e.jsx(ee,{}),sx:{mt:1},size:"small",onClick:S,children:u?"隱藏回覆":`顯示 ${x.length||0} 則回覆`}),r&&u&&x&&e.jsx(te,{commentId:n,postId:t})]})]}),!r&&u&&x&&e.jsx(te,{commentId:n,postId:t})]})},V=({nestedLevel:t,sx:n,...s})=>e.jsx(o,{sx:{position:"relative",py:1,pb:t>0?0:1,pl:{xs:1,sm:2},borderLeft:t>0?"2px solid":"none",borderColor:"divider",...n},...s,children:e.jsxs(o,{sx:{display:"flex",alignItems:"flex-start",gap:1.5},children:[e.jsx($,{variant:"circular",width:"2rem",height:"2rem",sx:{mt:1},animation:"wave"}),e.jsxs(o,{sx:{flex:1},children:[e.jsxs(o,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx($,{variant:"rounded",animation:"wave",children:e.jsx(l,{variant:"subtitle2",component:"span",children:"載入名稱中..."})}),e.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx($,{variant:"rounded",animation:"wave",children:e.jsx(l,{variant:"caption",color:"text.secondary",children:"0000-00-00 00:00:00"})}),e.jsx(R,{title:"更多選項",arrow:!0,children:e.jsx("span",{children:e.jsx(q,{size:"small",disabled:!0,children:e.jsx(ue,{fontSize:"small"})})})})]})]}),e.jsx($,{variant:"rounded",animation:"wave",children:e.jsx(l,{variant:"body2",sx:{mt:.5,whiteSpace:"pre-line"},children:"佔位文字，佔位文字，佔位文字，佔位文字，佔位文字，佔位文字，"})}),e.jsxs(o,{sx:{display:"flex",alignItems:"center",mt:1,gap:1},children:[e.jsx(p,{size:"small",startIcon:e.jsx(Q,{}),sx:{color:"text.secondary"},loading:!0,children:e.jsx(l,{variant:"caption",children:"讚"})}),e.jsx(p,{size:"small",startIcon:e.jsx(xe,{}),sx:{color:"text.secondary"},loading:!0,children:e.jsx(l,{variant:"caption",children:"回覆"})})]})]})]})}),te=({commentId:t,postId:n})=>{const{data:s,isFetching:a}=de(t);return a?e.jsx(o,{children:[...Array(1)].map((i,r)=>e.jsx(V,{nestedLevel:1},r))}):s?e.jsx(o,{children:s.map(i=>e.jsx(pe,{commentId:i,postId:n,nestedLevel:1},i))}):null},se={content:'""',display:"block",position:"absolute",inset:0,bgcolor:"divider",opacity:.2,pointerEvents:"none",mr:-2},Ft=({totalComments:t})=>{const{searchParams:n,updateSearchParams:s}=N(),a=n.get("postId"),i=a&&/^\d+$/.test(a)&&Number(a)>0?Number(a):-1,c=(n.get("orderBy")||"latest")==="likes"?"likes":"latest",{data:d,isFetching:x}=jt({postId:i,orderBy:c}),j=(u,g)=>{s({orderBy:g===0?"latest":"likes"})};return x?e.jsxs(e.Fragment,{children:[e.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:1.5},children:[e.jsx($,{variant:"rounded",animation:"wave",sx:{mx:2},children:e.jsx(l,{variant:"subtitle1",component:"h3",children:"0 則留言"})}),e.jsx(y,{flexItem:!0,orientation:"vertical",variant:"middle"}),e.jsxs(Z,{value:c==="latest"?0:1,onChange:j,children:[e.jsx(P,{label:"最新",disabled:!0}),e.jsx(P,{label:"最多人按讚",disabled:!0})]})]}),e.jsx(y,{}),e.jsx(o,{sx:{pr:2,"& > .comment:nth-of-type(odd):before":se},children:[...Array(3)].map((u,g)=>e.jsx(V,{nestedLevel:0,className:"comment"},g))})]}):!d||d.length===0?e.jsxs(e.Fragment,{children:[e.jsx(o,{sx:{pr:2},children:e.jsx(L,{type:"create",postId:i})}),e.jsx(o,{sx:{pb:2},children:e.jsx(l,{variant:"body2",sx:{color:"text.secondary",textAlign:"center",mt:2},children:"還沒有留言，快來發表你的看法吧！"})})]}):e.jsxs(e.Fragment,{children:[e.jsxs(o,{sx:{display:"flex",alignItems:"center",gap:1.5},children:[e.jsxs(l,{variant:"subtitle1",component:"h3",sx:{px:2},children:[t," 則留言"]}),e.jsx(y,{flexItem:!0,orientation:"vertical",variant:"middle"}),e.jsxs(Z,{value:c==="latest"?0:1,onChange:j,children:[e.jsx(P,{label:"最新"}),e.jsx(P,{label:"最多人按讚"})]})]}),e.jsx(y,{}),e.jsxs(o,{sx:{pr:2,"& > .comment:nth-of-type(odd):before":se},children:[e.jsx(L,{type:"create",className:"comment",postId:i}),d.map(u=>e.jsx(pe,{commentId:u,postId:i,nestedLevel:0,className:"comment"},u))]})]})},Bt=()=>{const{data:t,isFetching:n}=_e({limit:2,orderBy:"likeCount",order:"desc"});return n||!t?e.jsxs(o,{children:[e.jsx(Y,{}),e.jsx(Y,{})]}):e.jsx(o,{children:t.map(s=>e.jsx(He,{postId:s},s))})},Pt=()=>{const{searchParams:t}=N(),n=t.get("postId"),s=n&&/^\d+$/.test(n)&&Number(n)>0?Number(n):-1,{data:a,isFetching:i}=_({postId:s,incrementViewCount:!0});return i&&!a?e.jsx(dt,{}):a?e.jsxs(e.Fragment,{children:[e.jsx(xt,{post:a}),e.jsx(Ft,{totalComments:a.commentCount})]}):e.jsxs(o,{sx:{pt:1.5},children:[e.jsx(y,{}),e.jsxs(o,{sx:{py:6,display:"flex",flexDirection:"column",alignItems:"center",gap:2},children:[e.jsx(ke,{sx:{fontSize:"6rem",color:"action.disabled"}}),e.jsx(l,{variant:"body1",component:"p",sx:{color:"text.secondary",textAlign:"center"},children:"貼文不存在或已被刪除"})]}),e.jsx(y,{}),e.jsxs(o,{sx:{position:"relative"},children:[e.jsx(o,{sx:{position:"absolute",inset:0,bgcolor:"divider",opacity:.35}}),e.jsx(l,{variant:"h6",sx:{p:2},children:"我們找不到這篇貼文...但你可能會喜歡這些！"})]}),e.jsx(y,{}),e.jsx(Bt,{})]})};function qt(){const{isMd:t,isSm:n}=Ae();return e.jsxs(Re,{children:[e.jsx(Te,{}),e.jsxs(Fe,{children:[t?e.jsx(Ne,{}):e.jsx(Oe,{}),e.jsx(Qe,{maxWidth:"lg",sx:{position:"relative",my:10,px:0},children:e.jsxs(Ee,{sx:{pb:3,borderRadius:3,border:"1px solid",borderColor:"divider"},elevation:1,children:[e.jsxs(o,{sx:{display:"flex",justifyContent:"center",mt:2,mx:2},children:[n&&e.jsx(p,{href:oe.forum_home,startIcon:e.jsx($e,{}),variant:"outlined",sx:{textWrap:"nowrap"},children:t?"返回首頁":"首頁"}),e.jsx(o,{sx:{flex:1}}),e.jsxs(tt,{variant:"text",children:[e.jsx(st,{}),e.jsx(nt,{})]})]}),e.jsx(Pt,{})]})}),e.jsx(De,{})]})]})}we.createRoot(document.getElementById("root")).render(e.jsx(w.StrictMode,{children:e.jsx(qt,{})}));
