import{at as pe,au as me,r as E,j as F,c as Xt,b as Et,d as ve,av as ge,g as ye,s as jt,u as Yt,a9 as Zt,ap as Me,m as Se,ah as be,a3 as Fe,aw as we,X as It,ax as Kt,a8 as ht,an as Mt,V as Ee,ay as Bt,I as te,p as ee,o as Ve,l as Te,q as Ce,M as se,P as Ae,w as Ie,n as $e}from"./routes-BRvtlvXq.js";import{T as Oe,D as Pe}from"./DarkModeRounded-C3T8P242.js";import{i as Y,g as ft,D as ke,u as U}from"./useMutation--o3WIbJj.js";import{M as Z}from"./MenuItem-MMlOtQiM.js";import{u as et}from"./SQLiteClient-ClFa2ebI.js";import{u as K}from"./RefreshRounded-BM5m51hi.js";import{l as _e,h as xe,i as De,j as Re,k as Ne,r as qe,g as Q,s as R,d as Le}from"./ScrollArea-DVFo4K2p.js";import{w as je}from"./with-selector-DQKFazF0.js";const We=ge(),He=pe("div",{name:"MuiContainer",slot:"Root",overridesResolver:(e,i)=>{const{ownerState:s}=e;return[i.root,i[`maxWidth${Et(String(s.maxWidth))}`],s.fixed&&i.fixed,s.disableGutters&&i.disableGutters]}}),Ue=e=>me({props:e,name:"MuiContainer",defaultTheme:We}),Ke=(e,i)=>{const s=h=>ye(i,h),{classes:t,fixed:r,disableGutters:a,maxWidth:n}=e,o={root:["root",n&&`maxWidth${Et(String(n))}`,r&&"fixed",a&&"disableGutters"]};return ve(o,s,t)};function Be(e={}){const{createStyledComponent:i=He,useThemeProps:s=Ue,componentName:t="MuiContainer"}=e,r=i(({theme:n,ownerState:o})=>({width:"100%",marginLeft:"auto",boxSizing:"border-box",marginRight:"auto",...!o.disableGutters&&{paddingLeft:n.spacing(2),paddingRight:n.spacing(2),[n.breakpoints.up("sm")]:{paddingLeft:n.spacing(3),paddingRight:n.spacing(3)}}}),({theme:n,ownerState:o})=>o.fixed&&Object.keys(n.breakpoints.values).reduce((h,u)=>{const d=u,c=n.breakpoints.values[d];return c!==0&&(h[n.breakpoints.up(d)]={maxWidth:`${c}${n.breakpoints.unit}`}),h},{}),({theme:n,ownerState:o})=>({...o.maxWidth==="xs"&&{[n.breakpoints.up("xs")]:{maxWidth:Math.max(n.breakpoints.values.xs,444)}},...o.maxWidth&&o.maxWidth!=="xs"&&{[n.breakpoints.up(o.maxWidth)]:{maxWidth:`${n.breakpoints.values[o.maxWidth]}${n.breakpoints.unit}`}}}));return E.forwardRef(function(o,h){const u=s(o),{className:d,component:c="div",disableGutters:l=!1,fixed:f=!1,maxWidth:p="lg",classes:v,...g}=u,S={...u,component:c,disableGutters:l,fixed:f,maxWidth:p},m=Ke(S,t);return F.jsx(r,{as:c,ownerState:S,className:Xt(m.root,d),ref:h,...g})})}const Ds=Be({createStyledComponent:jt("div",{name:"MuiContainer",slot:"Root",overridesResolver:(e,i)=>{const{ownerState:s}=e;return[i.root,i[`maxWidth${Et(String(s.maxWidth))}`],s.fixed&&i.fixed,s.disableGutters&&i.disableGutters]}}),useThemeProps:e=>Yt({props:e,name:"MuiContainer"})});function ze(e){const{children:i,defer:s=!1,fallback:t=null}=e,[r,a]=E.useState(!1);return Zt(()=>{s||a(!0)},[s]),E.useEffect(()=>{s&&a(!0)},[s]),r?i:t}const Je=jt("div",{shouldForwardProp:Me})(Se(({theme:e})=>({position:"fixed",top:0,left:0,bottom:0,zIndex:e.zIndex.drawer-1,variants:[{props:{anchor:"left"},style:{right:"auto"}},{props:{anchor:"right"},style:{left:"auto",right:0}},{props:{anchor:"top"},style:{bottom:"auto",right:0}},{props:{anchor:"bottom"},style:{top:"auto",bottom:0,right:0}}]}))),Qe=E.forwardRef(function(i,s){const{anchor:t,classes:r={},className:a,width:n,style:o,...h}=i,u=i;return F.jsx(Je,{className:Xt("PrivateSwipeArea-root",r.root,r[`anchor${Et(t)}`],a),ref:s,style:{[Y(t)?"width":"height"]:n,...o},ownerState:u,...h})}),pt=3,zt=20;let W=null;function $t(e,i,s){return e==="right"?s.body.offsetWidth-i[0].pageX:i[0].pageX}function Ot(e,i,s){return e==="bottom"?s.innerHeight-i[0].clientY:i[0].clientY}function rt(e,i){return e?i.clientWidth:i.clientHeight}function Jt(e,i,s,t){return Math.min(Math.max(s?i-e:t+i-e,0),t)}function Ge(e,i){const s=[];for(;e&&e!==i.parentElement;){const t=Mt(i).getComputedStyle(e);t.getPropertyValue("position")==="absolute"||t.getPropertyValue("overflow-x")==="hidden"||(e.clientWidth>0&&e.scrollWidth>e.clientWidth||e.clientHeight>0&&e.scrollHeight>e.clientHeight)&&s.push(e),e=e.parentElement}return s}function Xe({domTreeShapes:e,start:i,current:s,anchor:t}){const r={scrollPosition:{x:"scrollLeft",y:"scrollTop"},scrollLength:{x:"scrollWidth",y:"scrollHeight"},clientLength:{x:"clientWidth",y:"clientHeight"}};return e.some(a=>{let n=s>=i;(t==="top"||t==="left")&&(n=!n);const o=t==="left"||t==="right"?"x":"y",h=Math.round(a[r.scrollPosition[o]]),u=h>0,d=h+a[r.clientLength[o]]<a[r.scrollLength[o]];return!!(n&&d||!n&&u)})}const Ye=typeof navigator<"u"&&/iPad|iPhone|iPod/.test(navigator.userAgent),Ze=E.forwardRef(function(i,s){const t=Yt({name:"MuiSwipeableDrawer",props:i}),r=be(),a={enter:r.transitions.duration.enteringScreen,exit:r.transitions.duration.leavingScreen},{anchor:n="left",disableBackdropTransition:o=!1,disableDiscovery:h=!1,disableSwipeToOpen:u=Ye,hideBackdrop:d,hysteresis:c=.52,allowSwipeInChildren:l=!1,minFlingVelocity:f=450,ModalProps:{BackdropProps:p,...v}={},onClose:g,onOpen:S,open:m=!1,PaperProps:V={},SwipeAreaProps:$,swipeAreaWidth:k=20,transitionDuration:x=a,variant:T="temporary",slots:I={},slotProps:q={},...G}=t,[z,J]=E.useState(!1),y=E.useRef({isSwiping:null}),ot=E.useRef(),b=E.useRef(),w=E.useRef(),de=Fe(V.ref,w),lt=E.useRef(!1),Tt=E.useRef();Zt(()=>{Tt.current=null},[m]);const ut=E.useCallback((M,D={})=>{const{mode:C=null,changeTransition:A=!0}=D,O=ft(r,n),P=["right","bottom"].includes(O)?1:-1,L=Y(n),N=L?`translate(${P*M}px, 0)`:`translate(0, ${P*M}px)`,X=w.current.style;X.webkitTransform=N,X.transform=N;let _="";if(C&&(_=r.transitions.create("all",we({easing:void 0,style:void 0,timeout:x},{mode:C}))),A&&(X.webkitTransition=_,X.transition=_),!o&&!d){const j=b.current.style;j.opacity=1-M/rt(L,w.current),A&&(j.webkitTransition=_,j.transition=_)}},[n,o,d,r,x]),ct=It(M=>{if(!lt.current)return;if(W=null,lt.current=!1,Kt.flushSync(()=>{J(!1)}),!y.current.isSwiping){y.current.isSwiping=null;return}y.current.isSwiping=null;const D=ft(r,n),C=Y(n);let A;C?A=$t(D,M.changedTouches,ht(M.currentTarget)):A=Ot(D,M.changedTouches,Mt(M.currentTarget));const O=C?y.current.startX:y.current.startY,P=rt(C,w.current),L=Jt(A,O,m,P),N=L/P;if(Math.abs(y.current.velocity)>f&&(Tt.current=Math.abs((P-L)/y.current.velocity)*1e3),m){y.current.velocity>f||N>c?g():ut(0,{mode:"exit"});return}y.current.velocity<-f||1-N>c?S():ut(rt(C,w.current),{mode:"enter"})}),Ut=(M=!1)=>{if(!z){(M||!(h&&l))&&Kt.flushSync(()=>{J(!0)});const D=Y(n);!m&&w.current&&ut(rt(D,w.current)+(h?15:-20),{changeTransition:!1}),y.current.velocity=0,y.current.lastTime=null,y.current.lastTranslate=null,y.current.paperHit=!1,lt.current=!0}},Ct=It(M=>{if(!w.current||!lt.current||W!==null&&W!==y.current)return;Ut(!0);const D=ft(r,n),C=Y(n),A=$t(D,M.touches,ht(M.currentTarget)),O=Ot(D,M.touches,Mt(M.currentTarget));if(m&&w.current.contains(M.target)&&W===null){const _=Ge(M.target,w.current);if(Xe({domTreeShapes:_,start:C?y.current.startX:y.current.startY,current:C?A:O,anchor:n})){W=!0;return}W=y.current}if(y.current.isSwiping==null){const _=Math.abs(A-y.current.startX),j=Math.abs(O-y.current.startY),dt=C?_>j&&_>pt:j>_&&j>pt;if(dt&&M.cancelable&&M.preventDefault(),dt===!0||(C?j>pt:_>pt)){if(y.current.isSwiping=dt,!dt){ct(M);return}y.current.startX=A,y.current.startY=O,!h&&!m&&(C?y.current.startX-=zt:y.current.startY-=zt)}}if(!y.current.isSwiping)return;const P=rt(C,w.current);let L=C?y.current.startX:y.current.startY;m&&!y.current.paperHit&&(L=Math.min(L,P));const N=Jt(C?A:O,L,m,P);if(m)if(y.current.paperHit)N===0&&(y.current.startX=A,y.current.startY=O);else if(C?A<P:O<P)y.current.paperHit=!0,y.current.startX=A,y.current.startY=O;else return;y.current.lastTranslate===null&&(y.current.lastTranslate=N,y.current.lastTime=performance.now()+1);const X=(N-y.current.lastTranslate)/(performance.now()-y.current.lastTime)*1e3;y.current.velocity=y.current.velocity*.4+X*.6,y.current.lastTranslate=N,y.current.lastTime=performance.now(),M.cancelable&&M.preventDefault(),ut(N)}),At=It(M=>{var P;if(M.defaultPrevented||M.defaultMuiPrevented||m&&(d||!b.current.contains(M.target))&&!w.current.contains(M.target))return;const D=ft(r,n),C=Y(n),A=$t(D,M.touches,ht(M.currentTarget)),O=Ot(D,M.touches,Mt(M.currentTarget));if(!m){if(u||!(M.target===ot.current||(P=w.current)!=null&&P.contains(M.target)&&(typeof l=="function"?l(M,ot.current,w.current):l)))return;if(C){if(A>k)return}else if(O>k)return}M.defaultMuiPrevented=!0,W=null,y.current.startX=A,y.current.startY=O,Ut()});E.useEffect(()=>{if(T==="temporary"){const M=ht(w.current);return M.addEventListener("touchstart",At),M.addEventListener("touchmove",Ct,{passive:!m}),M.addEventListener("touchend",ct),()=>{M.removeEventListener("touchstart",At),M.removeEventListener("touchmove",Ct,{passive:!m}),M.removeEventListener("touchend",ct)}}},[T,m,At,Ct,ct]),E.useEffect(()=>()=>{W===y.current&&(W=null)},[]),E.useEffect(()=>{m||J(!1)},[m]);const[he,fe]=Ee("swipeArea",{ref:ot,elementType:Qe,ownerState:t,externalForwardedProps:{slots:I,slotProps:{swipeArea:$,...q}},additionalProps:{width:k,anchor:n}});return F.jsxs(E.Fragment,{children:[F.jsx(ke,{open:T==="temporary"&&z?!0:m,variant:T,ModalProps:{BackdropProps:{...p,ref:b},...T==="temporary"&&{keepMounted:!0},...v},hideBackdrop:d,anchor:n,transitionDuration:Tt.current||x,onClose:g,ref:s,slots:I,slotProps:{...q,backdrop:Bt(q.backdrop??p,{ref:b}),paper:Bt(q.paper??V,{style:{pointerEvents:T==="temporary"&&!m&&!l?"none":""},ref:de})},...G}),!u&&T==="temporary"&&F.jsx(ze,{children:F.jsx(he,{...fe})})]})}),Rs=()=>{const[e,i]=E.useState(null),s=r=>i(r.currentTarget),t=()=>i(null);return F.jsxs(F.Fragment,{children:[F.jsx(Oe,{title:"切換主題",arrow:!0,children:F.jsx(te,{onClick:s,children:F.jsx(Pe,{fontSize:"small"})})}),F.jsx(ts,{open:!!e,anchorEl:e,onClose:t,anchorOrigin:{horizontal:"center",vertical:"bottom"},transformOrigin:{horizontal:"center",vertical:"top"}})]})},ts=({onClose:e,...i})=>{const{mode:s,setMode:t}=ee(),r=a=>()=>{t(a),e()};return F.jsx(Ae,{anchorOrigin:{horizontal:"right",vertical:"top"},onClose:e,...i,children:F.jsxs(se,{dense:!0,children:[F.jsx(Z,{onClick:r("light"),selected:s==="light",children:"淺色"}),F.jsx(Z,{onClick:r("dark"),selected:s==="dark",children:"暗色"}),F.jsx(Z,{onClick:r("system"),selected:s==="system",children:"跟隨系統"})]})})},es=jt("div")(({theme:e})=>({width:30,height:6,backgroundColor:e.palette.divider,borderRadius:3,position:"relative",left:"calc(50% - 15px)",...e.applyStyles("dark",{backgroundColor:e.palette.divider})})),Ns=({onClose:e,...i})=>{const{mode:s,setMode:t}=ee(),r=a=>()=>{t(a),e()};return F.jsxs(Ze,{anchor:"top",onClose:e,...i,children:[F.jsxs(Ve,{sx:{p:3,display:"flex",alignItems:"center",justifyContent:"space-between"},children:[F.jsx(Te,{variant:"h6",children:"切換主題"}),F.jsx(te,{onClick:e,children:F.jsx(Ce,{})})]}),F.jsxs(se,{dense:!0,children:[F.jsx(Z,{onClick:r("light"),selected:s==="light",children:"淺色"}),F.jsx(Z,{onClick:r("dark"),selected:s==="dark",children:"暗色"}),F.jsx(Z,{onClick:r("system"),selected:s==="system",children:"跟隨系統"})]}),F.jsx(es,{sx:{mb:2}})]})},ss=1e3*60*5,qs=()=>{const{data:e,isFetching:i,error:s}=et({queryKey:["session"],queryFn:()=>Q({server:!1}),staleTime:ss});return i?{authenticated:!1,user:null,loading:!0,error:null}:s?{authenticated:!1,user:null,loading:!1,error:s instanceof Error?s.message:"未知錯誤"}:e||{authenticated:!1,user:null,loading:!1,error:null}},Ls=()=>{const e=K();return U({mutationFn:Ne,onSettled:()=>{e.invalidateQueries({queryKey:["session"]})}})},js=()=>{const e=K();return U({mutationFn:_e,onSettled:()=>{e.invalidateQueries({queryKey:[]})}})},Ws=()=>{const e=K();return U({mutationFn:qe,onSettled:()=>{e.invalidateQueries({queryKey:["session"]})}})},Hs=()=>{const e=K();return U({mutationFn:xe,onSettled:()=>{e.invalidateQueries({queryKey:["session"]})}})},Us=()=>{const e=K();return U({mutationFn:De,onSettled:()=>{e.invalidateQueries({queryKey:["session"]})}})},Ks=()=>{const e=K();return U({mutationFn:Re,onSuccess:()=>{window.location.href=Ie.forum_home},onSettled:()=>{e.invalidateQueries({queryKey:["session"]})}})},tt=new WeakMap,St=new WeakMap,bt={current:[]};let Pt=!1,nt=0;const at=new Set,mt=new Map;function re(e){const i=Array.from(e).sort((s,t)=>s instanceof H&&s.options.deps.includes(t)?1:t instanceof H&&t.options.deps.includes(s)?-1:0);for(const s of i){if(bt.current.includes(s))continue;bt.current.push(s),s.recompute();const t=St.get(s);if(t)for(const r of t){const a=tt.get(r);a&&re(a)}}}function rs(e){e.listeners.forEach(i=>i({prevVal:e.prevState,currentVal:e.state}))}function is(e){e.listeners.forEach(i=>i({prevVal:e.prevState,currentVal:e.state}))}function ie(e){if(nt>0&&!mt.has(e)&&mt.set(e,e.prevState),at.add(e),!(nt>0)&&!Pt)try{for(Pt=!0;at.size>0;){const i=Array.from(at);at.clear();for(const s of i){const t=mt.get(s)??s.prevState;s.prevState=t,rs(s)}for(const s of i){const t=tt.get(s);t&&(bt.current.push(s),re(t))}for(const s of i){const t=tt.get(s);if(t)for(const r of t)is(r)}}}finally{Pt=!1,bt.current=[],mt.clear()}}function B(e){nt++;try{e()}finally{if(nt--,nt===0){const i=Array.from(at)[0];i&&ie(i)}}}class Dt{constructor(i,s){this.listeners=new Set,this.subscribe=t=>{var r,a;this.listeners.add(t);const n=(a=(r=this.options)==null?void 0:r.onSubscribe)==null?void 0:a.call(r,t,this);return()=>{this.listeners.delete(t),n==null||n()}},this.setState=t=>{var r,a,n;this.prevState=this.state,this.state=(r=this.options)!=null&&r.updateFn?this.options.updateFn(this.prevState)(t):t(this.prevState),(n=(a=this.options)==null?void 0:a.onUpdate)==null||n.call(a),ie(this)},this.prevState=i,this.state=i,this.options=s}}class H{constructor(i){this.listeners=new Set,this._subscriptions=[],this.lastSeenDepValues=[],this.getDepVals=()=>{const s=[],t=[];for(const r of this.options.deps)s.push(r.prevState),t.push(r.state);return this.lastSeenDepValues=t,{prevDepVals:s,currDepVals:t,prevVal:this.prevState??void 0}},this.recompute=()=>{var s,t;this.prevState=this.state;const{prevDepVals:r,currDepVals:a,prevVal:n}=this.getDepVals();this.state=this.options.fn({prevDepVals:r,currDepVals:a,prevVal:n}),(t=(s=this.options).onUpdate)==null||t.call(s)},this.checkIfRecalculationNeededDeeply=()=>{for(const a of this.options.deps)a instanceof H&&a.checkIfRecalculationNeededDeeply();let s=!1;const t=this.lastSeenDepValues,{currDepVals:r}=this.getDepVals();for(let a=0;a<r.length;a++)if(r[a]!==t[a]){s=!0;break}s&&this.recompute()},this.mount=()=>(this.registerOnGraph(),this.checkIfRecalculationNeededDeeply(),()=>{this.unregisterFromGraph();for(const s of this._subscriptions)s()}),this.subscribe=s=>{var t,r;this.listeners.add(s);const a=(r=(t=this.options).onSubscribe)==null?void 0:r.call(t,s,this);return()=>{this.listeners.delete(s),a==null||a()}},this.options=i,this.state=i.fn({prevDepVals:void 0,prevVal:void 0,currDepVals:this.getDepVals().currDepVals})}registerOnGraph(i=this.options.deps){for(const s of i)if(s instanceof H)s.registerOnGraph(),this.registerOnGraph(s.options.deps);else if(s instanceof Dt){let t=tt.get(s);t||(t=new Set,tt.set(s,t)),t.add(this);let r=St.get(this);r||(r=new Set,St.set(this,r)),r.add(s)}}unregisterFromGraph(i=this.options.deps){for(const s of i)if(s instanceof H)this.unregisterFromGraph(s.options.deps);else if(s instanceof Dt){const t=tt.get(s);t&&t.delete(this);const r=St.get(this);r&&r.delete(s)}}}function Vt(e,i){return typeof e=="function"?e(i):e}function ae(e,i){return Wt(i).reduce((t,r)=>{if(t===null)return null;if(typeof t<"u")return t[r]},e)}function kt(e,i,s){const t=Wt(i);function r(a){if(!t.length)return Vt(s,a);const n=t.shift();if(typeof n=="string"||typeof n=="number"&&!Array.isArray(a))return typeof a=="object"?(a===null&&(a={}),{...a,[n]:r(a[n])}):{[n]:r()};if(Array.isArray(a)&&typeof n=="number"){const o=a.slice(0,n);return[...o.length?o:new Array(n),r(a[n]),...a.slice(n+1)]}return[...new Array(n),r()]}return r(e)}function as(e,i){const s=Wt(i);function t(r){if(!r)return;if(s.length===1){const n=s[0];if(Array.isArray(r)&&typeof n=="number")return r.filter((u,d)=>d!==n);const{[n]:o,...h}=r;return h}const a=s.shift();if(typeof a=="string"&&typeof r=="object")return{...r,[a]:t(r[a])};if(typeof a=="number"&&Array.isArray(r)){if(a>=r.length)return r;const n=r.slice(0,a);return[...n.length?n:new Array(a),t(r[a]),...r.slice(a+1)]}throw new Error("It seems we have created an infinite loop in deleteBy. ")}return t(e)}const ns=/^(\d*)$/gm,os=/\.(\d*)\./gm,ls=/^(\d*)\./gm,us=/\.(\d*$)/gm,cs=/\.{2,}/gm,Rt="__int__",vt=`${Rt}$1`;function Wt(e){if(Array.isArray(e))return[...e];if(typeof e!="string")throw new Error("Path must be a string.");return e.replace(/\[/g,".").replace(/\]/g,"").replace(ns,vt).replace(os,`.${vt}.`).replace(ls,`${vt}.`).replace(us,`.${vt}`).replace(cs,".").split(".").map(i=>i.indexOf(Rt)===0?parseInt(i.substring(Rt.length),10):i)}function ds(e){return!(Array.isArray(e)&&e.length===0)}function Nt(e,i){const{asyncDebounceMs:s}=i,{onChangeAsync:t,onBlurAsync:r,onSubmitAsync:a,onBlurAsyncDebounceMs:n,onChangeAsyncDebounceMs:o}=i.validators||{},h=s??0,u={cause:"change",validate:t,debounceMs:o??h},d={cause:"blur",validate:r,debounceMs:n??h},c={cause:"submit",validate:a,debounceMs:0},l=f=>({...f,debounceMs:0});switch(e){case"submit":return[l(u),l(d),c];case"blur":return[d];case"change":return[u];case"server":default:return[]}}function qt(e,i){const{onChange:s,onBlur:t,onSubmit:r,onMount:a}=i.validators||{},n={cause:"change",validate:s},o={cause:"blur",validate:t},h={cause:"submit",validate:r},u={cause:"mount",validate:a},d={cause:"server",validate:()=>{}};switch(e){case"mount":return[u];case"submit":return[n,o,h,d];case"server":return[d];case"blur":return[o,d];case"change":default:return[n,d]}}const ne=e=>!!e&&typeof e=="object"&&"fields"in e;function _t(e,i){if(Object.is(e,i))return!0;if(typeof e!="object"||e===null||typeof i!="object"||i===null)return!1;if(e instanceof Map&&i instanceof Map){if(e.size!==i.size)return!1;for(const[t,r]of e)if(!i.has(t)||!Object.is(r,i.get(t)))return!1;return!0}if(e instanceof Set&&i instanceof Set){if(e.size!==i.size)return!1;for(const t of e)if(!i.has(t))return!1;return!0}const s=Object.keys(e);if(s.length!==Object.keys(i).length)return!1;for(let t=0;t<s.length;t++)if(!Object.prototype.hasOwnProperty.call(i,s[t])||!Object.is(e[s[t]],i[s[t]]))return!1;return!0}function hs(e){const i=new Map;for(const s of e){const t=[...s.path??[]].map(r=>{const a=typeof r=="object"?r.key:r;return typeof a=="number"?`[${a}]`:a}).join(".").replace(/\.\[/g,"[");i.set(t,(i.get(t)??[]).concat(s))}return Object.fromEntries(i)}const fs=e=>e,ps=e=>{const i=hs(e);return{form:i,fields:i}},Qt=(e,i)=>e==="form"?ps(i):fs(i),oe={validate({value:e,validationSource:i},s){const t=s["~standard"].validate(e);if(t instanceof Promise)throw new Error("async function passed to sync validator");if(t.issues)return Qt(i,t.issues)},async validateAsync({value:e,validationSource:i},s){const t=await s["~standard"].validate(e);if(t.issues)return Qt(i,t.issues)}},le=e=>!!e&&"~standard"in e,Ft={isValidating:!1,isTouched:!1,isBlurred:!1,isDirty:!1,isPristine:!0,errors:[],errorMap:{}};function gt(e){function i(c,l,f,p){const v=t(c,l,f,p);({insert:()=>o(v,c,l),remove:()=>h(v),swap:()=>p!==void 0&&d(v,c,l,p),move:()=>p!==void 0&&u(v,c,l,p)})[f]()}function s(c,l){return`${c}[${l}]`}function t(c,l,f,p){const v=[s(c,l)];if(f==="swap")v.push(s(c,p));else if(f==="move"){const[g,S]=[Math.min(l,p),Math.max(l,p)];for(let m=g;m<=S;m++)v.push(s(c,m))}else{const g=e.getFieldValue(c),S=Array.isArray(g)?g.length:0;for(let m=l+1;m<S;m++)v.push(s(c,m))}return Object.keys(e.fieldInfo).filter(g=>v.some(S=>g.startsWith(S)))}function r(c,l){return c.replace(/\[(\d+)\]/,(f,p)=>{const v=parseInt(p,10);return`[${l==="up"?v+1:Math.max(0,v-1)}]`})}function a(c,l){(l==="up"?c:[...c].reverse()).forEach(p=>{const v=r(p.toString(),l),g=e.getFieldMeta(v);g?e.setFieldMeta(p,g):e.setFieldMeta(p,n())})}const n=()=>Ft,o=(c,l,f)=>{a(c,"down"),c.forEach(p=>{p.toString().startsWith(s(l,f))&&e.setFieldMeta(p,n())})},h=c=>{a(c,"up")},u=(c,l,f,p)=>{const v=new Map(Object.keys(e.fieldInfo).filter(g=>g.startsWith(s(l,f))).map(g=>[g,e.getFieldMeta(g)]));a(c,f<p?"up":"down"),Object.keys(e.fieldInfo).filter(g=>g.startsWith(s(l,p))).forEach(g=>{const S=g.replace(s(l,p),s(l,f)),m=v.get(S);m&&e.setFieldMeta(g,m)})},d=(c,l,f,p)=>{c.forEach(v=>{if(!v.toString().startsWith(s(l,f)))return;const g=v.toString().replace(s(l,f),s(l,p)),[S,m]=[e.getFieldMeta(v),e.getFieldMeta(g)];S&&e.setFieldMeta(g,S),m&&e.setFieldMeta(v,m)})};return{handleArrayFieldMetaShift:i}}function xt(e){return{values:e.values??{},errorMap:e.errorMap??{},fieldMetaBase:e.fieldMetaBase??{},isSubmitted:e.isSubmitted??!1,isSubmitting:e.isSubmitting??!1,isValidating:e.isValidating??!1,submissionAttempts:e.submissionAttempts??0,isSubmitSuccessful:e.isSubmitSuccessful??!1,validationMetaMap:e.validationMetaMap??{onChange:void 0,onBlur:void 0,onSubmit:void 0,onMount:void 0,onServer:void 0}}}class ms{constructor(i){var s;this.options={},this.fieldInfo={},this.prevTransformArray=[],this.cumulativeFieldsErrorMap={},this.mount=()=>{const t=this.fieldMetaDerived.mount(),r=this.store.mount(),a=()=>{t(),r()},{onMount:n}=this.options.validators||{};return n&&this.validateSync("mount"),a},this.update=t=>{var r,a;if(!t)return;const n=this.options;this.options=t;const o=!!((a=(r=t.transform)==null?void 0:r.deps)!=null&&a.some((d,c)=>d!==this.prevTransformArray[c])),h=t.defaultValues&&!_t(t.defaultValues,n.defaultValues)&&!this.state.isTouched,u=!_t(t.defaultState,n.defaultState)&&!this.state.isTouched;!h&&!u&&!o||B(()=>{this.baseStore.setState(()=>xt(Object.assign({},this.state,u?t.defaultState:{},h?{values:t.defaultValues}:{},o?{_force_re_eval:!this.state._force_re_eval}:{})))})},this.reset=(t,r)=>{const{fieldMeta:a}=this.state,n=this.resetFieldMeta(a);t&&!(r!=null&&r.keepDefaultValues)&&(this.options={...this.options,defaultValues:t}),this.baseStore.setState(()=>{var o;return xt({...this.options.defaultState,values:t??this.options.defaultValues??((o=this.options.defaultState)==null?void 0:o.values),fieldMetaBase:n})})},this.validateAllFields=async t=>{const r=[];return B(()=>{Object.values(this.fieldInfo).forEach(n=>{if(!n.instance)return;const o=n.instance;r.push(Promise.resolve().then(()=>o.validate(t,{skipFormValidation:!0}))),n.instance.state.meta.isTouched||n.instance.setMeta(h=>({...h,isTouched:!0}))})}),(await Promise.all(r)).flat()},this.validateArrayFieldsStartingFrom=async(t,r,a)=>{const n=this.getFieldValue(t),o=Array.isArray(n)?Math.max(n.length-1,0):null,h=[`${t}[${r}]`];for(let l=r+1;l<=(o??0);l++)h.push(`${t}[${l}]`);const u=Object.keys(this.fieldInfo).filter(l=>h.some(f=>l.startsWith(f))),d=[];return B(()=>{u.forEach(l=>{d.push(Promise.resolve().then(()=>this.validateField(l,a)))})}),(await Promise.all(d)).flat()},this.validateField=(t,r)=>{var a;const n=(a=this.fieldInfo[t])==null?void 0:a.instance;return n?(n.state.meta.isTouched||n.setMeta(o=>({...o,isTouched:!0})),n.validate(r)):[]},this.validateSync=t=>{const r=qt(t,this.options);let a=!1;const n={};return B(()=>{var o;for(const u of r){if(!u.validate)continue;const d=this.runValidator({validate:u.validate,value:{value:this.state.values,formApi:this,validationSource:"form"},type:"validate"}),{formError:c,fieldErrors:l}=Lt(d),f=yt(u.cause);if(l)for(const[p,v]of Object.entries(l)){const S={...this.cumulativeFieldsErrorMap[p]||{},[f]:v};n[p]=S,this.cumulativeFieldsErrorMap[p]=S;const m=this.getFieldMeta(p);m&&m.errorMap[f]!==v&&this.setFieldMeta(p,V=>({...V,errorMap:{...V.errorMap,[f]:v}}))}for(const p of Object.keys(this.cumulativeFieldsErrorMap)){const v=this.getFieldMeta(p);v!=null&&v.errorMap[f]&&!((o=n[p])!=null&&o[f])&&(this.cumulativeFieldsErrorMap[p]={...this.cumulativeFieldsErrorMap[p],[f]:void 0},this.setFieldMeta(p,g=>({...g,errorMap:{...g.errorMap,[f]:void 0}})))}this.state.errorMap[f]!==c&&this.baseStore.setState(p=>({...p,errorMap:{...p.errorMap,[f]:c}})),(c||l)&&(a=!0)}const h=yt("submit");this.state.errorMap[h]&&t!=="submit"&&!a&&this.baseStore.setState(u=>({...u,errorMap:{...u.errorMap,[h]:void 0}}))}),{hasErrored:a,fieldsErrorMap:n}},this.validateAsync=async t=>{const r=Nt(t,this.options);this.state.isFormValidating||this.baseStore.setState(u=>({...u,isFormValidating:!0}));const a=[];let n;for(const u of r){if(!u.validate)continue;const d=yt(u.cause),c=this.state.validationMetaMap[d];c==null||c.lastAbortController.abort();const l=new AbortController;this.state.validationMetaMap[d]={lastAbortController:l},a.push(new Promise(async f=>{let p;try{p=await new Promise((m,V)=>{setTimeout(async()=>{if(l.signal.aborted)return m(void 0);try{m(await this.runValidator({validate:u.validate,value:{value:this.state.values,formApi:this,validationSource:"form",signal:l.signal},type:"validateAsync"}))}catch($){V($)}},u.debounceMs)})}catch(m){p=m}const{formError:v,fieldErrors:g}=Lt(p);g&&(n=n?{...n,...g}:g);const S=yt(u.cause);if(n)for(const[m,V]of Object.entries(n)){const $=this.getFieldMeta(m);$&&$.errorMap[S]!==V&&this.setFieldMeta(m,k=>({...k,errorMap:{...k.errorMap,[S]:V}}))}this.baseStore.setState(m=>({...m,errorMap:{...m.errorMap,[S]:v}})),f(n?{fieldErrors:n,errorMapKey:S}:void 0)}))}let o=[];const h={};if(a.length){o=await Promise.all(a);for(const u of o)if(u!=null&&u.fieldErrors){const{errorMapKey:d}=u;for(const[c,l]of Object.entries(u.fieldErrors)){const p={...h[c]||{},[d]:l};h[c]=p}}}return this.baseStore.setState(u=>({...u,isFormValidating:!1})),h},this.validate=t=>{const{hasErrored:r,fieldsErrorMap:a}=this.validateSync(t);return r&&!this.options.asyncAlways?a:this.validateAsync(t)},this.getFieldValue=t=>ae(this.state.values,t),this.getFieldMeta=t=>this.state.fieldMeta[t],this.getFieldInfo=t=>{var r;return(r=this.fieldInfo)[t]||(r[t]={instance:null,validationMetaMap:{onChange:void 0,onBlur:void 0,onSubmit:void 0,onMount:void 0,onServer:void 0}})},this.setFieldMeta=(t,r)=>{this.baseStore.setState(a=>({...a,fieldMetaBase:{...a.fieldMetaBase,[t]:Vt(r,a.fieldMetaBase[t])}}))},this.resetFieldMeta=t=>Object.keys(t).reduce((r,a)=>{const n=a;return r[n]=Ft,r},{}),this.setFieldValue=(t,r,a)=>{const n=(a==null?void 0:a.dontUpdateMeta)??!1;B(()=>{n||this.setFieldMeta(t,o=>({...o,isTouched:!0,isDirty:!0,errorMap:{...o==null?void 0:o.errorMap,onMount:void 0}})),this.baseStore.setState(o=>({...o,values:kt(o.values,t,r)}))})},this.deleteField=t=>{const a=[...Object.keys(this.fieldInfo).filter(n=>{const o=t.toString();return n!==o&&n.startsWith(o)}),t];this.baseStore.setState(n=>{const o={...n};return a.forEach(h=>{o.values=as(o.values,h),delete this.fieldInfo[h],delete o.fieldMetaBase[h]}),o})},this.pushFieldValue=(t,r,a)=>{this.setFieldValue(t,n=>[...Array.isArray(n)?n:[],r],a),this.validateField(t,"change")},this.insertFieldValue=async(t,r,a,n)=>{this.setFieldValue(t,o=>[...o.slice(0,r),a,...o.slice(r)],n),await this.validateField(t,"change"),gt(this).handleArrayFieldMetaShift(t,r,"insert"),await this.validateArrayFieldsStartingFrom(t,r,"change")},this.replaceFieldValue=async(t,r,a,n)=>{this.setFieldValue(t,o=>o.map((h,u)=>u===r?a:h),n),await this.validateField(t,"change"),await this.validateArrayFieldsStartingFrom(t,r,"change")},this.removeFieldValue=async(t,r,a)=>{const n=this.getFieldValue(t),o=Array.isArray(n)?Math.max(n.length-1,0):null;if(this.setFieldValue(t,h=>h.filter((u,d)=>d!==r),a),gt(this).handleArrayFieldMetaShift(t,r,"remove"),o!==null){const h=`${t}[${o}]`;this.deleteField(h)}await this.validateField(t,"change"),await this.validateArrayFieldsStartingFrom(t,r,"change")},this.swapFieldValues=(t,r,a,n)=>{this.setFieldValue(t,o=>{const h=o[r],u=o[a];return kt(kt(o,`${r}`,u),`${a}`,h)},n),gt(this).handleArrayFieldMetaShift(t,r,"swap",a),this.validateField(t,"change"),this.validateField(`${t}[${r}]`,"change"),this.validateField(`${t}[${a}]`,"change")},this.moveFieldValues=(t,r,a,n)=>{this.setFieldValue(t,o=>(o.splice(a,0,o.splice(r,1)[0]),o),n),gt(this).handleArrayFieldMetaShift(t,r,"move",a),this.validateField(t,"change"),this.validateField(`${t}[${r}]`,"change"),this.validateField(`${t}[${a}]`,"change")},this.resetField=t=>{this.baseStore.setState(r=>({...r,fieldMetaBase:{...r.fieldMetaBase,[t]:Ft},values:{...r.values,[t]:this.options.defaultValues&&this.options.defaultValues[t]}}))},this.getAllErrors=()=>({form:{errors:this.state.errors,errorMap:this.state.errorMap},fields:Object.entries(this.state.fieldMeta).reduce((t,[r,a])=>(Object.keys(a).length&&a.errors.length&&(t[r]={errors:a.errors,errorMap:a.errorMap}),t),{})}),this.baseStore=new Dt(xt({...i==null?void 0:i.defaultState,values:(i==null?void 0:i.defaultValues)??((s=i==null?void 0:i.defaultState)==null?void 0:s.values)})),this.fieldMetaDerived=new H({deps:[this.baseStore],fn:({prevDepVals:t,currDepVals:r,prevVal:a})=>{var n;const o=a,h=t==null?void 0:t[0],u=r[0];let d=0;const c={};for(const l of Object.keys(u.fieldMetaBase)){const f=u.fieldMetaBase[l],p=h==null?void 0:h.fieldMetaBase[l],v=o==null?void 0:o[l];let g=v==null?void 0:v.errors;if(!p||f.errorMap!==p.errorMap){g=Object.values(f.errorMap??{}).filter(V=>V!==void 0);const m=(n=this.getFieldInfo(l))==null?void 0:n.instance;m&&!m.options.disableErrorFlat&&(g=g==null?void 0:g.flat(1))}const S=!f.isDirty;if(v&&v.isPristine===S&&v.errors===g&&f===p){c[l]=v,d++;continue}c[l]={...f,errors:g,isPristine:S}}return Object.keys(u.fieldMetaBase).length&&o&&d===Object.keys(u.fieldMetaBase).length?o:c}}),this.store=new H({deps:[this.baseStore,this.fieldMetaDerived],fn:({prevDepVals:t,currDepVals:r,prevVal:a})=>{var n,o,h,u;const d=a,c=t==null?void 0:t[0],l=r[0],f=Object.values(l.fieldMetaBase),p=f.some(b=>b==null?void 0:b.isValidating),v=!f.some(b=>(b==null?void 0:b.errorMap)&&ds(Object.values(b.errorMap).filter(Boolean))),g=f.some(b=>b==null?void 0:b.isTouched),S=f.some(b=>b==null?void 0:b.isBlurred),m=g&&((n=l==null?void 0:l.errorMap)==null?void 0:n.onMount),V=f.some(b=>b==null?void 0:b.isDirty),$=!V,k=!!((o=l.errorMap)!=null&&o.onMount||f.some(b=>{var w;return(w=b==null?void 0:b.errorMap)==null?void 0:w.onMount})),x=!!p;let T=(d==null?void 0:d.errors)??[];(!c||l.errorMap!==c.errorMap)&&(T=Object.values(l.errorMap).reduce((b,w)=>w===void 0?b:w&&ne(w)?(b.push(w.form),b):(b.push(w),b),[]));const I=T.length===0,q=v&&I,G=l.submissionAttempts===0&&!g&&!k||!x&&!l.isSubmitting&&q;let z=l.errorMap;if(m&&(T=T.filter(b=>b!==l.errorMap.onMount),z=Object.assign(z,{onMount:void 0})),d&&c&&d.errorMap===z&&d.fieldMeta===this.fieldMetaDerived.state&&d.errors===T&&d.isFieldsValidating===p&&d.isFieldsValid===v&&d.isFormValid===I&&d.isValid===q&&d.canSubmit===G&&d.isTouched===g&&d.isBlurred===S&&d.isPristine===$&&d.isDirty===V&&_t(c,l))return d;let J={...l,errorMap:z,fieldMeta:this.fieldMetaDerived.state,errors:T,isFieldsValidating:p,isFieldsValid:v,isFormValid:I,isValid:q,canSubmit:G,isTouched:g,isBlurred:S,isPristine:$,isDirty:V};const y=((h=this.options.transform)==null?void 0:h.deps)??[];if(y.length!==this.prevTransformArray.length||y.some((b,w)=>b!==this.prevTransformArray[w])){const b=Object.assign({},this,{state:J});(u=this.options.transform)==null||u.fn(b),J=b.state,this.prevTransformArray=y}return J}}),this.handleSubmit=this.handleSubmit.bind(this),this.update(i||{})}get state(){return this.store.state}runValidator(i){return le(i.validate)?oe[i.type](i.value,i.validate):i.validate(i.value)}async handleSubmit(i){var s,t,r,a,n,o;if(this.baseStore.setState(u=>({...u,isSubmitted:!1,submissionAttempts:u.submissionAttempts+1,isSubmitSuccessful:!1})),!this.state.canSubmit)return;this.baseStore.setState(u=>({...u,isSubmitting:!0}));const h=()=>{this.baseStore.setState(u=>({...u,isSubmitting:!1}))};if(await this.validateAllFields("submit"),!this.state.isFieldsValid){h(),(t=(s=this.options).onSubmitInvalid)==null||t.call(s,{value:this.state.values,formApi:this});return}if(await this.validate("submit"),!this.state.isValid){h(),(a=(r=this.options).onSubmitInvalid)==null||a.call(r,{value:this.state.values,formApi:this});return}B(()=>{Object.values(this.fieldInfo).forEach(u=>{var d,c,l;(l=(c=(d=u.instance)==null?void 0:d.options.listeners)==null?void 0:c.onSubmit)==null||l.call(c,{value:u.instance.state.value,fieldApi:u.instance})})});try{await((o=(n=this.options).onSubmit)==null?void 0:o.call(n,{value:this.state.values,formApi:this,meta:i??this.options.onSubmitMeta})),B(()=>{this.baseStore.setState(u=>({...u,isSubmitted:!0,isSubmitSuccessful:!0})),h()})}catch(u){throw this.baseStore.setState(d=>({...d,isSubmitSuccessful:!1})),h(),u}}setErrorMap(i){this.baseStore.setState(s=>({...s,errorMap:{...s.errorMap,...i}}))}}function Lt(e){if(e){if(ne(e)){const i=Lt(e.form).formError,s=e.fields;return{formError:i,fieldErrors:s}}return{formError:e}}return{formError:void 0}}function yt(e){switch(e){case"submit":return"onSubmit";case"blur":return"onBlur";case"mount":return"onMount";case"server":return"onServer";case"change":default:return"onChange"}}class vs{constructor(i){this.options={},this.mount=()=>{var s,t;const r=this.store.mount();this.options.defaultValue!==void 0&&this.form.setFieldValue(this.name,this.options.defaultValue,{dontUpdateMeta:!0});const a=this.getInfo();a.instance=this,this.update(this.options);const{onMount:n}=this.options.validators||{};if(n){const o=this.runValidator({validate:n,value:{value:this.state.value,fieldApi:this,validationSource:"field"},type:"validate"});o&&this.setMeta(h=>({...h,errorMap:{...h==null?void 0:h.errorMap,onMount:o}}))}return(t=(s=this.options.listeners)==null?void 0:s.onMount)==null||t.call(s,{value:this.state.value,fieldApi:this}),r},this.update=s=>{if(this.state.value===void 0){const t=ae(s.form.options.defaultValues,s.name);s.defaultValue!==void 0?this.setValue(s.defaultValue,{dontUpdateMeta:!0}):t!==void 0&&this.setValue(t,{dontUpdateMeta:!0})}this.form.getFieldMeta(this.name)===void 0&&this.setMeta(this.state.meta),this.options=s,this.name=s.name},this.getValue=()=>this.form.getFieldValue(this.name),this.setValue=(s,t)=>{var r,a;this.form.setFieldValue(this.name,s,t),(a=(r=this.options.listeners)==null?void 0:r.onChange)==null||a.call(r,{value:this.state.value,fieldApi:this}),this.validate("change")},this.getMeta=()=>this.store.state.meta,this.setMeta=s=>this.form.setFieldMeta(this.name,s),this.getInfo=()=>this.form.getFieldInfo(this.name),this.pushValue=(s,t)=>{var r,a;this.form.pushFieldValue(this.name,s,t),(a=(r=this.options.listeners)==null?void 0:r.onChange)==null||a.call(r,{value:this.state.value,fieldApi:this})},this.insertValue=(s,t,r)=>{var a,n;this.form.insertFieldValue(this.name,s,t,r),(n=(a=this.options.listeners)==null?void 0:a.onChange)==null||n.call(a,{value:this.state.value,fieldApi:this})},this.replaceValue=(s,t,r)=>{var a,n;this.form.replaceFieldValue(this.name,s,t,r),(n=(a=this.options.listeners)==null?void 0:a.onChange)==null||n.call(a,{value:this.state.value,fieldApi:this})},this.removeValue=(s,t)=>{var r,a;this.form.removeFieldValue(this.name,s,t),(a=(r=this.options.listeners)==null?void 0:r.onChange)==null||a.call(r,{value:this.state.value,fieldApi:this})},this.swapValues=(s,t,r)=>{var a,n;this.form.swapFieldValues(this.name,s,t,r),(n=(a=this.options.listeners)==null?void 0:a.onChange)==null||n.call(a,{value:this.state.value,fieldApi:this})},this.moveValue=(s,t,r)=>{var a,n;this.form.moveFieldValues(this.name,s,t,r),(n=(a=this.options.listeners)==null?void 0:a.onChange)==null||n.call(a,{value:this.state.value,fieldApi:this})},this.getLinkedFields=s=>{const t=Object.values(this.form.fieldInfo),r=[];for(const a of t){if(!a.instance)continue;const{onChangeListenTo:n,onBlurListenTo:o}=a.instance.options.validators||{};s==="change"&&(n!=null&&n.includes(this.name))&&r.push(a.instance),s==="blur"&&(o!=null&&o.includes(this.name))&&r.push(a.instance)}return r},this.validateSync=(s,t)=>{const r=qt(s,this.options),n=this.getLinkedFields(s).reduce((u,d)=>{const c=qt(s,d.options);return c.forEach(l=>{l.field=d}),u.concat(c)},[]);let o=!1;B(()=>{const u=(d,c)=>{const l=it(c.cause),f=c.validate?Gt(d.runValidator({validate:c.validate,value:{value:d.store.state.value,validationSource:"field",fieldApi:d},type:"validate"})):t[l];d.state.meta.errorMap[l]!==f&&d.setMeta(p=>({...p,errorMap:{...p.errorMap,[it(c.cause)]:f||t[l]}})),(f||t[l])&&(o=!0)};for(const d of r)u(this,d);for(const d of n)d.validate&&u(d.field,d)});const h=it("submit");return this.state.meta.errorMap[h]&&s!=="submit"&&!o&&this.setMeta(u=>({...u,errorMap:{...u.errorMap,[h]:void 0}})),{hasErrored:o}},this.validateAsync=async(s,t)=>{const r=Nt(s,this.options),a=await t,n=this.getLinkedFields(s),o=n.reduce((l,f)=>{const p=Nt(s,f.options);return p.forEach(v=>{v.field=f}),l.concat(p)},[]);this.state.meta.isValidating||this.setMeta(l=>({...l,isValidating:!0}));for(const l of n)l.setMeta(f=>({...f,isValidating:!0}));const h=[],u=[],d=(l,f,p)=>{const v=it(f.cause),g=l.getInfo().validationMetaMap[v];g==null||g.lastAbortController.abort();const S=new AbortController;this.getInfo().validationMetaMap[v]={lastAbortController:S},p.push(new Promise(async m=>{var V;let $;try{$=await new Promise((I,q)=>{this.timeoutIds[f.cause]&&clearTimeout(this.timeoutIds[f.cause]),this.timeoutIds[f.cause]=setTimeout(async()=>{if(S.signal.aborted)return I(void 0);try{I(await this.runValidator({validate:f.validate,value:{value:l.store.state.value,fieldApi:l,signal:S.signal,validationSource:"field"},type:"validateAsync"}))}catch(G){q(G)}},f.debounceMs)})}catch(I){$=I}if(S.signal.aborted)return m(void 0);const k=Gt($),x=(V=a[this.name])==null?void 0:V[v],T=k||x;l.setMeta(I=>({...I,errorMap:{...I==null?void 0:I.errorMap,[v]:T}})),m(T)}))};for(const l of r)l.validate&&d(this,l,h);for(const l of o)l.validate&&d(l.field,l,u);let c=[];(h.length||u.length)&&(c=await Promise.all(h),await Promise.all(u)),this.setMeta(l=>({...l,isValidating:!1}));for(const l of n)l.setMeta(f=>({...f,isValidating:!1}));return c.filter(Boolean)},this.validate=(s,t)=>{var r;if(!this.state.meta.isTouched)return[];const{fieldsErrorMap:a}=t!=null&&t.skipFormValidation?{fieldsErrorMap:{}}:this.form.validateSync(s),{hasErrored:n}=this.validateSync(s,a[this.name]??{});if(n&&!this.options.asyncAlways)return(r=this.getInfo().validationMetaMap[it(s)])==null||r.lastAbortController.abort(),this.state.meta.errors;const o=t!=null&&t.skipFormValidation?Promise.resolve({}):this.form.validateAsync(s);return this.validateAsync(s,o)},this.handleChange=s=>{this.setValue(s)},this.handleBlur=()=>{var s,t;this.state.meta.isTouched||(this.setMeta(a=>({...a,isTouched:!0})),this.validate("change")),this.state.meta.isBlurred||this.setMeta(a=>({...a,isBlurred:!0})),this.validate("blur"),(t=(s=this.options.listeners)==null?void 0:s.onBlur)==null||t.call(s,{value:this.state.value,fieldApi:this})},this.form=i.form,this.name=i.name,this.timeoutIds={},this.store=new H({deps:[this.form.store],fn:()=>{const s=this.form.getFieldValue(this.name),t=this.form.getFieldMeta(this.name)??{...Ft,...i.defaultMeta};return{value:s,meta:t}}}),this.options=i}get state(){return this.store.state}runValidator(i){return le(i.validate)?oe[i.type](i.value,i.validate):i.validate(i.value)}setErrorMap(i){this.setMeta(s=>({...s,errorMap:{...s.errorMap,...i}}))}}function Gt(e){if(e)return e}function it(e){switch(e){case"submit":return"onSubmit";case"blur":return"onBlur";case"mount":return"onMount";case"server":return"onServer";case"change":default:return"onChange"}}function Ht(e,i=s=>s){return je.useSyncExternalStoreWithSelector(e.subscribe,()=>e.state,()=>e.state,i,gs)}function gs(e,i){if(Object.is(e,i))return!0;if(typeof e!="object"||e===null||typeof i!="object"||i===null)return!1;if(e instanceof Map&&i instanceof Map){if(e.size!==i.size)return!1;for(const[t,r]of e)if(!i.has(t)||!Object.is(r,i.get(t)))return!1;return!0}if(e instanceof Set&&i instanceof Set){if(e.size!==i.size)return!1;for(const t of e)if(!i.has(t))return!1;return!0}const s=Object.keys(e);if(s.length!==Object.keys(i).length)return!1;for(let t=0;t<s.length;t++)if(!Object.prototype.hasOwnProperty.call(i,s[t])||!Object.is(e[s[t]],i[s[t]]))return!1;return!0}const wt=typeof window<"u"?E.useLayoutEffect:E.useEffect;function ys(e){const[i]=E.useState(()=>{const t=new vs({...e,form:e.form,name:e.name});return t.Field=ue,t});return wt(i.mount,[i]),wt(()=>{i.update(e)}),Ht(i.store,e.mode==="array"?s=>[s.meta,Object.keys(s.value??[]).length]:void 0),i}const ue=({children:e,...i})=>{const s=ys(i),t=E.useMemo(()=>Vt(e,s),[e,s,s.state.value,s.state.meta]);return F.jsx(F.Fragment,{children:t})};function Ms({form:e,selector:i,children:s}){const t=Ht(e.store,i);return Vt(s,t)}function Bs(e){const[i]=E.useState(()=>{const s=new ms(e),t=s;return t.Field=function(a){return F.jsx(ue,{...a,form:s})},t.Subscribe=r=>F.jsx(Ms,{form:s,selector:r.selector,children:r.children}),t});return wt(i.mount,[]),Ht(i.store,s=>s.isSubmitting),wt(()=>{i.update(e)}),i}const Ss=e=>e.length>0&&e[0]!==null&&e[0]!==void 0,zs=e=>Ss(e)?e.filter(i=>i!==void 0).map(({message:i})=>i).join(", "):null,Js=$e(F.jsx("path",{d:"M13.35 20.13c-.76.69-1.93.69-2.69-.01l-.11-.1C5.3 15.27 1.87 12.16 2 8.28c.06-1.7.93-3.33 2.34-4.29 2.64-1.8 5.9-.96 7.66 1.1 1.76-2.06 5.02-2.91 7.66-1.1 1.41.96 2.28 2.59 2.34 4.29.14 3.88-3.3 6.99-8.55 11.76z"})),bs=async({topic:e}={})=>{var n;const i=[],s={};e&&(i.push("EXISTS (SELECT 1 FROM json_each(tags) WHERE value = $topic)"),s.$topic=e);const r=`
      SELECT COUNT(*) as totalCount
      FROM posts
      ${i.length>0?`WHERE ${i.join(" AND ")}`:""}
    `;return((n=(await R.exec(r,s))[0])==null?void 0:n.totalCount)||0},ce=async({page:e=0,limit:i=10,topic:s,userId:t,orderBy:r="createdAt",order:a="desc",prioritizeFollowers:n}={})=>{var k;const o=[],h={};s&&(o.push("EXISTS (SELECT 1 FROM json_each(tags) WHERE value = $topic)"),h.$topic=s),t&&(o.push("userId = $userId"),h.$userId=t);const u=o.length>0?`WHERE ${o.join(" AND ")}`:"";let d="p.createdAt";r==="likeCount"||r==="commentCount"?d=`pic.${r}`:r==="createdAt"||r==="updatedAt"?d=`datetime(p.${r})`:d=`p.${r}`;let c="",l="";if(n){const x=await Q({server:!0}),T=x.authenticated?x.user.id:null;T&&(h.$currentUserId=T,c=`
        LEFT JOIN (
          SELECT followeeId, 1 AS isFollowed
          FROM user_interactions
          WHERE followerId = $currentUserId AND type = 'follow'
        ) AS following ON p.userId = following.followeeId
      `,l="CASE WHEN following.isFollowed = 1 THEN 1 ELSE 0 END DESC, ")}const f=`
      SELECT COUNT(*) as totalCount
      FROM posts
      ${u}
    `,v=((k=(await R.exec(f,h))[0])==null?void 0:k.totalCount)||0,g=Math.ceil(v/i),S=e+1<g?e+1:null;h.$limit=i,h.$offset=e*i;const m=`
        SELECT id
        FROM posts p
        LEFT JOIN post_interaction_counts pic ON p.id = pic.postId
        ${c}
        ${u}
        ORDER BY ${l}${d} ${a.toUpperCase()}, p.createdAt DESC
        LIMIT $limit OFFSET $offset
      `;return{posts:(await R.exec(m,h)).map(x=>x.id),nextPage:S,totalPages:g}},Fs=async({postId:e,incrementViewCount:i=!1})=>{let s=null;const t=await Q({server:!0});s=t.authenticated?t.user.id:null,i&&R.exec("UPDATE posts SET viewCount = viewCount + 1 WHERE id = $postId",{$postId:e});let r=`
      SELECT
        p.id,
        p.title,
        p.content,
        p.tags,
        p.photos,
        p.attachments,
        p.viewCount,
        p.createdAt,
        p.updatedAt,
        p.userId,
        u.name as userName,
        COALESCE(pic.likeCount, 0) as likeCount,
        COALESCE(pic.commentCount, 0) as commentCount
  `;s?r+=`,
      EXISTS (
        SELECT 1
        FROM user_interactions
        WHERE followerId = $currentUserId
        AND followeeId = p.userId
        AND type = 'follow'
      ) as isFromFollowing
    `:r+=", 0 as isFromFollowing",r+=`
      FROM posts p
      JOIN users u ON p.userId = u.id
      LEFT JOIN post_interaction_counts pic ON p.id = pic.postId
      WHERE p.id = $postId
  `;const a={$postId:e};s&&(a.$currentUserId=s);const n=await R.exec(r,a);if(n.length===0)return null;const o=n[0];return{...o,tags:JSON.parse(o.tags||"[]"),photos:o.photos?JSON.parse(o.photos):void 0,attachments:o.attachments?JSON.parse(o.attachments):void 0,createdAt:new Date(o.createdAt),updatedAt:new Date(o.updatedAt),likeCount:o.likeCount||0,commentCount:o.commentCount||0,isFromFollowing:!!o.isFromFollowing,isSelf:s?o.userId===s:!1}},ws=async({title:e,content:i,tags:s,photos:t,attachments:r})=>{const a=await Q({server:!0});if(!a.authenticated)return{error:"未登入或授權失效，無法創建貼文"};const n=a.user.id,o=JSON.stringify(s),h=t?JSON.stringify(t):null,u=r?JSON.stringify(r):null,d=`
      INSERT INTO posts ( userId, title, content, tags, photos, attachments, createdAt, updatedAt )
      VALUES ( $userId, $title, $content, $tags, $photos, $attachments, $createdAt, $updatedAt )
      RETURNING id
    `,c=new Date().toISOString(),l={$userId:n,$title:e,$content:i,$tags:o,$photos:h,$attachments:u,$createdAt:c,$updatedAt:c},f=await R.exec(d,l);return!f||f.length===0||typeof f[0].id!="number"?{error:"創建貼文失敗"}:f[0].id},Es=async({id:e,title:i,content:s,tags:t,photos:r,attachments:a})=>{const n=await Q({server:!0});if(!n.authenticated)return{error:"未登入或授權失效，無法更新貼文"};const o=n.user.id,u=await R.exec("SELECT userId FROM posts WHERE id = $postId",{$postId:e});if(u.length===0)return{error:"貼文不存在"};if(u[0].userId!==o)return{error:"您沒有權限更新此貼文"};const d=JSON.stringify(t),c=r?JSON.stringify(r):null,l=a?JSON.stringify(a):null,f=new Date().toISOString(),p=`
      UPDATE posts
      SET title = $title,
          content = $content,
          tags = $tags,
          photos = $photos,
          attachments = $attachments,
          updatedAt = $updatedAt
      WHERE id = $postId AND userId = $userId
    `,v={$postId:e,$userId:o,$title:i,$content:s,$tags:d,$photos:c,$attachments:l,$updatedAt:f};return await R.exec(p,v),null},Vs=async e=>{const i=await Q({server:!0});if(!i.authenticated)return{error:"未登入或授權失效，無法刪除貼文"};const s=i.user.id,r=await R.exec("SELECT userId FROM posts WHERE id = $postId",{$postId:e});return r.length===0?{error:"貼文不存在"}:r[0].userId!==s?{error:"您沒有權限刪除此貼文"}:(await R.exec("DELETE FROM posts WHERE id = $postId AND userId = $userId",{$postId:e,$userId:s}),null)},Ts=async()=>{const i=await R.exec("SELECT tags FROM tag_stats");if(i.length===0)return[];const s=i[0].tags,t=JSON.parse(s);return Array.isArray(t)?t:[]},Cs=async()=>{const e=await Q({server:!0});if(!e.authenticated)return[];const i=e.user.id,t=await R.exec(`
      SELECT json_group_array(json_object('name', tag, 'count', COUNT)) as tags
      FROM (
        SELECT json_each.value AS tag, COUNT(*) AS COUNT
        FROM posts, json_each(posts.tags)
        WHERE posts.userId = $userId
        GROUP BY json_each.value
        ORDER BY COUNT DESC, tag
      )
    `,{$userId:i});if(t.length===0)return[];const r=t[0].tags,a=JSON.parse(r);return Array.isArray(a)?a:[]},st=1*60*1e3,Qs=({limit:e,topic:i,userId:s,orderBy:t,order:r,prioritizeFollowers:a}={})=>et({queryKey:["posts",e,i,s,t,r,a],queryFn:async()=>(await ce({page:0,limit:e,topic:i,userId:s,orderBy:t,order:r,prioritizeFollowers:a})).posts,staleTime:st}),Gs=({topic:e}={})=>et({queryKey:["postCounts",e],queryFn:()=>bs({topic:e}),staleTime:st}),Xs=({limit:e=6,topic:i,userId:s,orderBy:t,order:r,prioritizeFollowers:a}={})=>{const{data:n,fetchNextPage:o,hasNextPage:h,isFetchingNextPage:u,isLoading:d}=Le({queryKey:["infinitePosts",e,i,s,t,r,a],queryFn:({pageParam:c})=>ce({page:c,limit:e,topic:i,userId:s,orderBy:t,order:r,prioritizeFollowers:a}),initialPageParam:0,getNextPageParam:c=>c.nextPage,staleTime:st});return E.useEffect(()=>{const c=document.getElementById("scroll-area");if(!c)return;const l=()=>{const f=c.scrollHeight,p=c.scrollTop,v=c.clientHeight;p+v>=f-350&&h&&!u&&o()};return c.addEventListener("scroll",l),()=>c.removeEventListener("scroll",l)},[o,h,u]),{data:n,isLoading:d,isFetchingNextPage:u,hasNextPage:h,fetchNextPage:o}},Ys=()=>et({queryKey:["tags"],queryFn:Ts,staleTime:st}),Zs=()=>et({queryKey:["userTags"],queryFn:Cs,staleTime:st}),tr=({postId:e,incrementViewCount:i})=>et({queryKey:["post",e],queryFn:()=>e===void 0||Number.isNaN(e)?null:Fs({postId:e,incrementViewCount:i}),enabled:e!==void 0&&!Number.isNaN(e)&&e>=0,staleTime:st}),er=()=>{const e=K();return U({mutationFn:ws,onSettled:()=>{e.invalidateQueries({queryKey:["posts"]}),e.invalidateQueries({queryKey:["infinitePosts"]}),e.invalidateQueries({queryKey:["postCounts"]}),e.invalidateQueries({queryKey:["tags"]}),e.invalidateQueries({queryKey:["userTags"]})}})},sr=()=>{const e=K();return U({mutationFn:Es,onSettled:()=>{e.invalidateQueries({queryKey:["posts"]}),e.invalidateQueries({queryKey:["infinitePosts"]}),e.invalidateQueries({queryKey:["postCounts"]}),e.invalidateQueries({queryKey:["tags"]}),e.invalidateQueries({queryKey:["userTags"]})}})},rr=()=>{const e=K();return U({mutationFn:Vs,onSettled:()=>{e.invalidateQueries({queryKey:["posts"]}),e.invalidateQueries({queryKey:["infinitePosts"]}),e.invalidateQueries({queryKey:["postCounts"]}),e.invalidateQueries({queryKey:["tags"]}),e.invalidateQueries({queryKey:["userTags"]})}})};export{Ds as C,Js as F,Ze as S,Rs as T,tr as a,Ys as b,Ls as c,Bs as d,Ss as e,Ws as f,zs as g,Gs as h,qs as i,Xs as j,rr as k,er as l,sr as m,Zs as n,Hs as o,Us as p,Ks as q,js as r,Ns as s,Qs as u};
