import{aq as vt,ar as gt,r as E,j as w,c as tt,b as Te,d as yt,as as St,g as Mt,s as He,u as st,a6 as rt,am as bt,m as wt,ae as Ft,a0 as Et,at as Vt,U as $e,au as ze,a5 as fe,ak as be,O as Tt,av as Je,I as it,i as nt,p as Ct,n as At,q as It,M as at,P as Ot,o as $t}from"./Toast-DyYNk4-H.js";import{T as Pt,D as kt}from"./DarkModeRounded-Nq1sIAOR.js";import{i as X,g as pe,D as _t,u as B}from"./useMutation-D5ZFqPdF.js";import{M as Z}from"./MenuItem-CaZ61uO_.js";import{u as se}from"./tryCatch-Dx5fmaYy.js";import{u as K}from"./ErrorOutlineRounded-zTQCHSuR.js";import{l as xt,h as Dt,i as Rt,j as Nt,k as Lt,r as qt,g as G,s as R,d as Wt}from"./ScrollArea-D5WG6kkQ.js";import{r as jt}from"./routes-Dr3OAPvi.js";import{w as Ht}from"./with-selector-DPazL_cM.js";const Ut=St(),Bt=vt("div",{name:"MuiContainer",slot:"Root",overridesResolver:(t,i)=>{const{ownerState:s}=t;return[i.root,i[`maxWidth${Te(String(s.maxWidth))}`],s.fixed&&i.fixed,s.disableGutters&&i.disableGutters]}}),Kt=t=>gt({props:t,name:"MuiContainer",defaultTheme:Ut}),zt=(t,i)=>{const s=h=>Mt(i,h),{classes:e,fixed:r,disableGutters:n,maxWidth:a}=t,o={root:["root",a&&`maxWidth${Te(String(a))}`,r&&"fixed",n&&"disableGutters"]};return yt(o,s,e)};function Jt(t={}){const{createStyledComponent:i=Bt,useThemeProps:s=Kt,componentName:e="MuiContainer"}=t,r=i(({theme:a,ownerState:o})=>({width:"100%",marginLeft:"auto",boxSizing:"border-box",marginRight:"auto",...!o.disableGutters&&{paddingLeft:a.spacing(2),paddingRight:a.spacing(2),[a.breakpoints.up("sm")]:{paddingLeft:a.spacing(3),paddingRight:a.spacing(3)}}}),({theme:a,ownerState:o})=>o.fixed&&Object.keys(a.breakpoints.values).reduce((h,c)=>{const d=c,u=a.breakpoints.values[d];return u!==0&&(h[a.breakpoints.up(d)]={maxWidth:`${u}${a.breakpoints.unit}`}),h},{}),({theme:a,ownerState:o})=>({...o.maxWidth==="xs"&&{[a.breakpoints.up("xs")]:{maxWidth:Math.max(a.breakpoints.values.xs,444)}},...o.maxWidth&&o.maxWidth!=="xs"&&{[a.breakpoints.up(o.maxWidth)]:{maxWidth:`${a.breakpoints.values[o.maxWidth]}${a.breakpoints.unit}`}}}));return E.forwardRef(function(o,h){const c=s(o),{className:d,component:u="div",disableGutters:l=!1,fixed:f=!1,maxWidth:p="lg",classes:m,...g}=c,M={...c,component:u,disableGutters:l,fixed:f,maxWidth:p},v=zt(M,e);return w.jsx(r,{as:u,ownerState:M,className:tt(v.root,d),ref:h,...g})})}const Rs=Jt({createStyledComponent:He("div",{name:"MuiContainer",slot:"Root",overridesResolver:(t,i)=>{const{ownerState:s}=t;return[i.root,i[`maxWidth${Te(String(s.maxWidth))}`],s.fixed&&i.fixed,s.disableGutters&&i.disableGutters]}}),useThemeProps:t=>st({props:t,name:"MuiContainer"})});function Qt(t){const{children:i,defer:s=!1,fallback:e=null}=t,[r,n]=E.useState(!1);return rt(()=>{s||n(!0)},[s]),E.useEffect(()=>{s&&n(!0)},[s]),r?i:e}const Gt=He("div",{shouldForwardProp:bt})(wt(({theme:t})=>({position:"fixed",top:0,left:0,bottom:0,zIndex:t.zIndex.drawer-1,variants:[{props:{anchor:"left"},style:{right:"auto"}},{props:{anchor:"right"},style:{left:"auto",right:0}},{props:{anchor:"top"},style:{bottom:"auto",right:0}},{props:{anchor:"bottom"},style:{top:"auto",bottom:0,right:0}}]}))),Yt=E.forwardRef(function(i,s){const{anchor:e,classes:r={},className:n,width:a,style:o,...h}=i,c=i;return w.jsx(Gt,{className:tt("PrivateSwipeArea-root",r.root,r[`anchor${Te(e)}`],n),ref:s,style:{[X(e)?"width":"height"]:a,...o},ownerState:c,...h})}),me=3,Qe=20;let j=null;function Pe(t,i,s){return t==="right"?s.body.offsetWidth-i[0].pageX:i[0].pageX}function ke(t,i,s){return t==="bottom"?s.innerHeight-i[0].clientY:i[0].clientY}function ae(t,i){return t?i.clientWidth:i.clientHeight}function Ge(t,i,s,e){return Math.min(Math.max(s?i-t:e+i-t,0),e)}function Xt(t,i){const s=[];for(;t&&t!==i.parentElement;){const e=be(i).getComputedStyle(t);e.getPropertyValue("position")==="absolute"||e.getPropertyValue("overflow-x")==="hidden"||(t.clientWidth>0&&t.scrollWidth>t.clientWidth||t.clientHeight>0&&t.scrollHeight>t.clientHeight)&&s.push(t),t=t.parentElement}return s}function Zt({domTreeShapes:t,start:i,current:s,anchor:e}){const r={scrollPosition:{x:"scrollLeft",y:"scrollTop"},scrollLength:{x:"scrollWidth",y:"scrollHeight"},clientLength:{x:"clientWidth",y:"clientHeight"}};return t.some(n=>{let a=s>=i;(e==="top"||e==="left")&&(a=!a);const o=e==="left"||e==="right"?"x":"y",h=Math.round(n[r.scrollPosition[o]]),c=h>0,d=h+n[r.clientLength[o]]<n[r.scrollLength[o]];return!!(a&&d||!a&&c)})}const es=typeof navigator<"u"&&/iPad|iPhone|iPod/.test(navigator.userAgent),ts=E.forwardRef(function(i,s){const e=st({name:"MuiSwipeableDrawer",props:i}),r=Ft(),n={enter:r.transitions.duration.enteringScreen,exit:r.transitions.duration.leavingScreen},{anchor:a="left",disableBackdropTransition:o=!1,disableDiscovery:h=!1,disableSwipeToOpen:c=es,hideBackdrop:d,hysteresis:u=.52,allowSwipeInChildren:l=!1,minFlingVelocity:f=450,ModalProps:{BackdropProps:p,...m}={},onClose:g,onOpen:M,open:v=!1,PaperProps:F={},SwipeAreaProps:C,swipeAreaWidth:$=20,transitionDuration:I=n,variant:V="temporary",slots:L={},slotProps:T={},...ie}=e,[J,z]=E.useState(!1),y=E.useRef({isSwiping:null}),Q=E.useRef(),ne=E.useRef(),S=E.useRef(),x=Et(F.ref,S),ue=E.useRef(!1),Ae=E.useRef();rt(()=>{Ae.current=null},[v]);const ce=E.useCallback((b,D={})=>{const{mode:A=null,changeTransition:O=!0}=D,P=pe(r,a),k=["right","bottom"].includes(P)?1:-1,q=X(a),N=q?`translate(${k*b}px, 0)`:`translate(0, ${k*b}px)`,Y=S.current.style;Y.webkitTransform=N,Y.transform=N;let _="";if(A&&(_=r.transitions.create("all",Vt({easing:void 0,style:void 0,timeout:I},{mode:A}))),O&&(Y.webkitTransition=_,Y.transition=_),!o&&!d){const W=ne.current.style;W.opacity=1-b/ae(q,S.current),O&&(W.webkitTransition=_,W.transition=_)}},[a,o,d,r,I]),de=$e(b=>{if(!ue.current)return;if(j=null,ue.current=!1,ze.flushSync(()=>{z(!1)}),!y.current.isSwiping){y.current.isSwiping=null;return}y.current.isSwiping=null;const D=pe(r,a),A=X(a);let O;A?O=Pe(D,b.changedTouches,fe(b.currentTarget)):O=ke(D,b.changedTouches,be(b.currentTarget));const P=A?y.current.startX:y.current.startY,k=ae(A,S.current),q=Ge(O,P,v,k),N=q/k;if(Math.abs(y.current.velocity)>f&&(Ae.current=Math.abs((k-q)/y.current.velocity)*1e3),v){y.current.velocity>f||N>u?g():ce(0,{mode:"exit"});return}y.current.velocity<-f||1-N>u?M():ce(ae(A,S.current),{mode:"enter"})}),Ke=(b=!1)=>{if(!J){(b||!(h&&l))&&ze.flushSync(()=>{z(!0)});const D=X(a);!v&&S.current&&ce(ae(D,S.current)+(h?15:-20),{changeTransition:!1}),y.current.velocity=0,y.current.lastTime=null,y.current.lastTranslate=null,y.current.paperHit=!1,ue.current=!0}},Ie=$e(b=>{if(!S.current||!ue.current||j!==null&&j!==y.current)return;Ke(!0);const D=pe(r,a),A=X(a),O=Pe(D,b.touches,fe(b.currentTarget)),P=ke(D,b.touches,be(b.currentTarget));if(v&&S.current.contains(b.target)&&j===null){const _=Xt(b.target,S.current);if(Zt({domTreeShapes:_,start:A?y.current.startX:y.current.startY,current:A?O:P,anchor:a})){j=!0;return}j=y.current}if(y.current.isSwiping==null){const _=Math.abs(O-y.current.startX),W=Math.abs(P-y.current.startY),he=A?_>W&&_>me:W>_&&W>me;if(he&&b.cancelable&&b.preventDefault(),he===!0||(A?W>me:_>me)){if(y.current.isSwiping=he,!he){de(b);return}y.current.startX=O,y.current.startY=P,!h&&!v&&(A?y.current.startX-=Qe:y.current.startY-=Qe)}}if(!y.current.isSwiping)return;const k=ae(A,S.current);let q=A?y.current.startX:y.current.startY;v&&!y.current.paperHit&&(q=Math.min(q,k));const N=Ge(A?O:P,q,v,k);if(v)if(y.current.paperHit)N===0&&(y.current.startX=O,y.current.startY=P);else if(A?O<k:P<k)y.current.paperHit=!0,y.current.startX=O,y.current.startY=P;else return;y.current.lastTranslate===null&&(y.current.lastTranslate=N,y.current.lastTime=performance.now()+1);const Y=(N-y.current.lastTranslate)/(performance.now()-y.current.lastTime)*1e3;y.current.velocity=y.current.velocity*.4+Y*.6,y.current.lastTranslate=N,y.current.lastTime=performance.now(),b.cancelable&&b.preventDefault(),ce(N)}),Oe=$e(b=>{var k;if(b.defaultPrevented||b.defaultMuiPrevented||v&&(d||!ne.current.contains(b.target))&&!S.current.contains(b.target))return;const D=pe(r,a),A=X(a),O=Pe(D,b.touches,fe(b.currentTarget)),P=ke(D,b.touches,be(b.currentTarget));if(!v){if(c||!(b.target===Q.current||(k=S.current)!=null&&k.contains(b.target)&&(typeof l=="function"?l(b,Q.current,S.current):l)))return;if(A){if(O>$)return}else if(P>$)return}b.defaultMuiPrevented=!0,j=null,y.current.startX=O,y.current.startY=P,Ke()});E.useEffect(()=>{if(V==="temporary"){const b=fe(S.current);return b.addEventListener("touchstart",Oe),b.addEventListener("touchmove",Ie,{passive:!v}),b.addEventListener("touchend",de),()=>{b.removeEventListener("touchstart",Oe),b.removeEventListener("touchmove",Ie,{passive:!v}),b.removeEventListener("touchend",de)}}},[V,v,Oe,Ie,de]),E.useEffect(()=>()=>{j===y.current&&(j=null)},[]),E.useEffect(()=>{v||z(!1)},[v]);const[pt,mt]=Tt("swipeArea",{ref:Q,elementType:Yt,ownerState:e,externalForwardedProps:{slots:L,slotProps:{swipeArea:C,...T}},additionalProps:{width:$,anchor:a}});return w.jsxs(E.Fragment,{children:[w.jsx(_t,{open:V==="temporary"&&J?!0:v,variant:V,ModalProps:{BackdropProps:{...p,ref:ne},...V==="temporary"&&{keepMounted:!0},...m},hideBackdrop:d,anchor:a,transitionDuration:Ae.current||I,onClose:g,ref:s,slots:L,slotProps:{...T,backdrop:Je(T.backdrop??p,{ref:ne}),paper:Je(T.paper??F,{style:{pointerEvents:V==="temporary"&&!v&&!l?"none":""},ref:x})},...ie}),!c&&V==="temporary"&&w.jsx(Qt,{children:w.jsx(pt,{...mt})})]})}),Ns=()=>{const[t,i]=E.useState(null),s=r=>i(r.currentTarget),e=()=>i(null);return w.jsxs(w.Fragment,{children:[w.jsx(Pt,{title:"切換主題",arrow:!0,children:w.jsx(it,{onClick:s,children:w.jsx(kt,{fontSize:"small"})})}),w.jsx(ss,{open:!!t,anchorEl:t,onClose:e,anchorOrigin:{horizontal:"center",vertical:"bottom"},transformOrigin:{horizontal:"center",vertical:"top"}})]})},ss=({onClose:t,...i})=>{const{mode:s,setMode:e}=nt(),r=n=>()=>{e(n),t()};return w.jsx(Ot,{anchorOrigin:{horizontal:"right",vertical:"top"},onClose:t,...i,children:w.jsxs(at,{dense:!0,children:[w.jsx(Z,{onClick:r("light"),selected:s==="light",children:"淺色"}),w.jsx(Z,{onClick:r("dark"),selected:s==="dark",children:"暗色"}),w.jsx(Z,{onClick:r("system"),selected:s==="system",children:"跟隨系統"})]})})},rs=He("div")(({theme:t})=>({width:30,height:6,backgroundColor:t.palette.divider,borderRadius:3,position:"relative",left:"calc(50% - 15px)",...t.applyStyles("dark",{backgroundColor:t.palette.divider})})),Ls=({onClose:t,...i})=>{const{mode:s,setMode:e}=nt(),r=n=>()=>{e(n),t()};return w.jsxs(ts,{anchor:"top",onClose:t,...i,children:[w.jsxs(Ct,{sx:{p:3,display:"flex",alignItems:"center",justifyContent:"space-between"},children:[w.jsx(At,{variant:"h6",children:"切換主題"}),w.jsx(it,{onClick:t,children:w.jsx(It,{})})]}),w.jsxs(at,{dense:!0,children:[w.jsx(Z,{onClick:r("light"),selected:s==="light",children:"淺色"}),w.jsx(Z,{onClick:r("dark"),selected:s==="dark",children:"暗色"}),w.jsx(Z,{onClick:r("system"),selected:s==="system",children:"跟隨系統"})]}),w.jsx(rs,{sx:{mb:2}})]})},is=1e3*60*5,qs=()=>{const{data:t,isFetching:i,error:s}=se({queryKey:["session"],queryFn:()=>G({server:!1}),staleTime:is});return i?{authenticated:!1,user:null,loading:!0,error:null}:s?{authenticated:!1,user:null,loading:!1,error:s instanceof Error?s.message:"未知錯誤"}:t||{authenticated:!1,user:null,loading:!1,error:null}},Ws=()=>{const t=K();return B({mutationFn:Lt,onSettled:()=>{t.invalidateQueries({queryKey:["session"]})}})},js=()=>{const t=K();return B({mutationFn:xt,onSettled:()=>{t.invalidateQueries({queryKey:[]})}})},Hs=()=>{const t=K();return B({mutationFn:qt,onSettled:()=>{t.invalidateQueries({queryKey:["session"]})}})},Us=()=>{const t=K();return B({mutationFn:Dt,onSettled:()=>{t.invalidateQueries({queryKey:["session"]})}})},Bs=()=>{const t=K();return B({mutationFn:Rt,onSettled:()=>{t.invalidateQueries({queryKey:["session"]})}})},Ks=()=>{const t=K();return B({mutationFn:Nt,onSuccess:()=>{window.location.href=jt.forum_home},onSettled:()=>{t.invalidateQueries({queryKey:["session"]})}})},ee=new WeakMap,we=new WeakMap,Fe={current:[]};let _e=!1,le=0;const oe=new Set,ve=new Map;function ot(t){const i=Array.from(t).sort((s,e)=>s instanceof U&&s.options.deps.includes(e)?1:e instanceof U&&e.options.deps.includes(s)?-1:0);for(const s of i){if(Fe.current.includes(s))continue;Fe.current.push(s),s.recompute();const e=we.get(s);if(e)for(const r of e){const n=ee.get(r);n&&ot(n)}}}function ns(t){t.listeners.forEach(i=>i({prevVal:t.prevState,currentVal:t.state}))}function as(t){t.listeners.forEach(i=>i({prevVal:t.prevState,currentVal:t.state}))}function lt(t){if(le>0&&!ve.has(t)&&ve.set(t,t.prevState),oe.add(t),!(le>0)&&!_e)try{for(_e=!0;oe.size>0;){const i=Array.from(oe);oe.clear();for(const s of i){const e=ve.get(s)??s.prevState;s.prevState=e,ns(s)}for(const s of i){const e=ee.get(s);e&&(Fe.current.push(s),ot(e))}for(const s of i){const e=ee.get(s);if(e)for(const r of e)as(r)}}}finally{_e=!1,Fe.current=[],ve.clear()}}function H(t){le++;try{t()}finally{if(le--,le===0){const i=Array.from(oe)[0];i&&lt(i)}}}class Ne{constructor(i,s){this.listeners=new Set,this.subscribe=e=>{var r,n;this.listeners.add(e);const a=(n=(r=this.options)==null?void 0:r.onSubscribe)==null?void 0:n.call(r,e,this);return()=>{this.listeners.delete(e),a==null||a()}},this.setState=e=>{var r,n,a;this.prevState=this.state,this.state=(r=this.options)!=null&&r.updateFn?this.options.updateFn(this.prevState)(e):e(this.prevState),(a=(n=this.options)==null?void 0:n.onUpdate)==null||a.call(n),lt(this)},this.prevState=i,this.state=i,this.options=s}}class U{constructor(i){this.listeners=new Set,this._subscriptions=[],this.lastSeenDepValues=[],this.getDepVals=()=>{const s=[],e=[];for(const r of this.options.deps)s.push(r.prevState),e.push(r.state);return this.lastSeenDepValues=e,{prevDepVals:s,currDepVals:e,prevVal:this.prevState??void 0}},this.recompute=()=>{var s,e;this.prevState=this.state;const{prevDepVals:r,currDepVals:n,prevVal:a}=this.getDepVals();this.state=this.options.fn({prevDepVals:r,currDepVals:n,prevVal:a}),(e=(s=this.options).onUpdate)==null||e.call(s)},this.checkIfRecalculationNeededDeeply=()=>{for(const n of this.options.deps)n instanceof U&&n.checkIfRecalculationNeededDeeply();let s=!1;const e=this.lastSeenDepValues,{currDepVals:r}=this.getDepVals();for(let n=0;n<r.length;n++)if(r[n]!==e[n]){s=!0;break}s&&this.recompute()},this.mount=()=>(this.registerOnGraph(),this.checkIfRecalculationNeededDeeply(),()=>{this.unregisterFromGraph();for(const s of this._subscriptions)s()}),this.subscribe=s=>{var e,r;this.listeners.add(s);const n=(r=(e=this.options).onSubscribe)==null?void 0:r.call(e,s,this);return()=>{this.listeners.delete(s),n==null||n()}},this.options=i,this.state=i.fn({prevDepVals:void 0,prevVal:void 0,currDepVals:this.getDepVals().currDepVals})}registerOnGraph(i=this.options.deps){for(const s of i)if(s instanceof U)s.registerOnGraph(),this.registerOnGraph(s.options.deps);else if(s instanceof Ne){let e=ee.get(s);e||(e=new Set,ee.set(s,e)),e.add(this);let r=we.get(this);r||(r=new Set,we.set(this,r)),r.add(s)}}unregisterFromGraph(i=this.options.deps){for(const s of i)if(s instanceof U)this.unregisterFromGraph(s.options.deps);else if(s instanceof Ne){const e=ee.get(s);e&&e.delete(this);const r=we.get(this);r&&r.delete(s)}}}function Ce(t,i){return typeof t=="function"?t(i):t}function ut(t,i){return Ue(i).reduce((e,r)=>{if(e===null)return null;if(typeof e<"u")return e[r]},t)}function xe(t,i,s){const e=Ue(i);function r(n){if(!e.length)return Ce(s,n);const a=e.shift();if(typeof a=="string"||typeof a=="number"&&!Array.isArray(n))return typeof n=="object"?(n===null&&(n={}),{...n,[a]:r(n[a])}):{[a]:r()};if(Array.isArray(n)&&typeof a=="number"){const o=n.slice(0,a);return[...o.length?o:new Array(a),r(n[a]),...n.slice(a+1)]}return[...new Array(a),r()]}return r(t)}function os(t,i){const s=Ue(i);function e(r){if(!r)return;if(s.length===1){const a=s[0];if(Array.isArray(r)&&typeof a=="number")return r.filter((c,d)=>d!==a);const{[a]:o,...h}=r;return h}const n=s.shift();if(typeof n=="string"&&typeof r=="object")return{...r,[n]:e(r[n])};if(typeof n=="number"&&Array.isArray(r)){if(n>=r.length)return r;const a=r.slice(0,n);return[...a.length?a:new Array(n),e(r[n]),...r.slice(n+1)]}throw new Error("It seems we have created an infinite loop in deleteBy. ")}return e(t)}const ls=/^(\d*)$/gm,us=/\.(\d*)\./gm,cs=/^(\d*)\./gm,ds=/\.(\d*$)/gm,hs=/\.{2,}/gm,Le="__int__",ge=`${Le}$1`;function Ue(t){if(Array.isArray(t))return[...t];if(typeof t!="string")throw new Error("Path must be a string.");return t.replace(/\[/g,".").replace(/\]/g,"").replace(ls,ge).replace(us,`.${ge}.`).replace(cs,`${ge}.`).replace(ds,`.${ge}`).replace(hs,".").split(".").map(i=>i.indexOf(Le)===0?parseInt(i.substring(Le.length),10):i)}function fs(t){return!(Array.isArray(t)&&t.length===0)}function qe(t,i){const{asyncDebounceMs:s}=i,{onChangeAsync:e,onBlurAsync:r,onSubmitAsync:n,onBlurAsyncDebounceMs:a,onChangeAsyncDebounceMs:o}=i.validators||{},h=s??0,c={cause:"change",validate:e,debounceMs:o??h},d={cause:"blur",validate:r,debounceMs:a??h},u={cause:"submit",validate:n,debounceMs:0},l=f=>({...f,debounceMs:0});switch(t){case"submit":return[l(c),l(d),u];case"blur":return[d];case"change":return[c];case"server":default:return[]}}function We(t,i){const{onChange:s,onBlur:e,onSubmit:r,onMount:n}=i.validators||{},a={cause:"change",validate:s},o={cause:"blur",validate:e},h={cause:"submit",validate:r},c={cause:"mount",validate:n},d={cause:"server",validate:()=>{}};switch(t){case"mount":return[c];case"submit":return[a,o,h,d];case"server":return[d];case"blur":return[o,d];case"change":default:return[a,d]}}const ct=t=>!!t&&typeof t=="object"&&"fields"in t;function De(t,i){if(Object.is(t,i))return!0;if(typeof t!="object"||t===null||typeof i!="object"||i===null)return!1;if(t instanceof Map&&i instanceof Map){if(t.size!==i.size)return!1;for(const[e,r]of t)if(!i.has(e)||!Object.is(r,i.get(e)))return!1;return!0}if(t instanceof Set&&i instanceof Set){if(t.size!==i.size)return!1;for(const e of t)if(!i.has(e))return!1;return!0}const s=Object.keys(t);if(s.length!==Object.keys(i).length)return!1;for(let e=0;e<s.length;e++)if(!Object.prototype.hasOwnProperty.call(i,s[e])||!Object.is(t[s[e]],i[s[e]]))return!1;return!0}const Ye=({newFormValidatorError:t,isPreviousErrorFromFormValidator:i,previousErrorValue:s})=>t?{newErrorValue:t,newSource:"form"}:i?{newErrorValue:void 0,newSource:void 0}:s?{newErrorValue:s,newSource:"field"}:{newErrorValue:void 0,newSource:void 0},Xe=({formLevelError:t,fieldLevelError:i})=>i?{newErrorValue:i,newSource:"field"}:t?{newErrorValue:t,newSource:"form"}:{newErrorValue:void 0,newSource:void 0};function ps(t){const i=new Map;for(const s of t){const e=[...s.path??[]].map(r=>{const n=typeof r=="object"?r.key:r;return typeof n=="number"?`[${n}]`:n}).join(".").replace(/\.\[/g,"[");i.set(e,(i.get(e)??[]).concat(s))}return Object.fromEntries(i)}const Ze=t=>{const i=ps(t);return{form:i,fields:i}},te={validate({value:t,validationSource:i},s){const e=s["~standard"].validate(t);if(e instanceof Promise)throw new Error("async function passed to sync validator");if(e.issues)return i==="field"?e.issues:Ze(e.issues)},async validateAsync({value:t,validationSource:i},s){const e=await s["~standard"].validate(t);if(e.issues)return i==="field"?e.issues:Ze(e.issues)}},dt=t=>!!t&&"~standard"in t,Ee={isValidating:!1,isTouched:!1,isBlurred:!1,isDirty:!1,isPristine:!0,errors:[],errorMap:{},errorSourceMap:{}};function ye(t){function i(u,l,f,p){const m=e(u,l,f,p);({insert:()=>o(m,u,l),remove:()=>h(m),swap:()=>p!==void 0&&d(m,u,l,p),move:()=>p!==void 0&&c(m,u,l,p)})[f]()}function s(u,l){return`${u}[${l}]`}function e(u,l,f,p){const m=[s(u,l)];if(f==="swap")m.push(s(u,p));else if(f==="move"){const[g,M]=[Math.min(l,p),Math.max(l,p)];for(let v=g;v<=M;v++)m.push(s(u,v))}else{const g=t.getFieldValue(u),M=Array.isArray(g)?g.length:0;for(let v=l+1;v<M;v++)m.push(s(u,v))}return Object.keys(t.fieldInfo).filter(g=>m.some(M=>g.startsWith(M)))}function r(u,l){return u.replace(/\[(\d+)\]/,(f,p)=>{const m=parseInt(p,10);return`[${l==="up"?m+1:Math.max(0,m-1)}]`})}function n(u,l){(l==="up"?u:[...u].reverse()).forEach(p=>{const m=r(p.toString(),l),g=t.getFieldMeta(m);g?t.setFieldMeta(p,g):t.setFieldMeta(p,a())})}const a=()=>Ee,o=(u,l,f)=>{n(u,"down"),u.forEach(p=>{p.toString().startsWith(s(l,f))&&t.setFieldMeta(p,a())})},h=u=>{n(u,"up")},c=(u,l,f,p)=>{const m=new Map(Object.keys(t.fieldInfo).filter(g=>g.startsWith(s(l,f))).map(g=>[g,t.getFieldMeta(g)]));n(u,f<p?"up":"down"),Object.keys(t.fieldInfo).filter(g=>g.startsWith(s(l,p))).forEach(g=>{const M=g.replace(s(l,p),s(l,f)),v=m.get(M);v&&t.setFieldMeta(g,v)})},d=(u,l,f,p)=>{u.forEach(m=>{if(!m.toString().startsWith(s(l,f)))return;const g=m.toString().replace(s(l,f),s(l,p)),[M,v]=[t.getFieldMeta(m),t.getFieldMeta(g)];M&&t.setFieldMeta(g,M),v&&t.setFieldMeta(m,v)})};return{handleArrayFieldMetaShift:i}}function Re(t){return{values:t.values??{},errorMap:t.errorMap??{},fieldMetaBase:t.fieldMetaBase??{},isSubmitted:t.isSubmitted??!1,isSubmitting:t.isSubmitting??!1,isValidating:t.isValidating??!1,submissionAttempts:t.submissionAttempts??0,isSubmitSuccessful:t.isSubmitSuccessful??!1,validationMetaMap:t.validationMetaMap??{onChange:void 0,onBlur:void 0,onSubmit:void 0,onMount:void 0,onServer:void 0}}}class ms{constructor(i){var s;this.options={},this.fieldInfo={},this.prevTransformArray=[],this.mount=()=>{const e=this.fieldMetaDerived.mount(),r=this.store.mount(),n=()=>{e(),r()},{onMount:a}=this.options.validators||{};return a&&this.validateSync("mount"),n},this.update=e=>{var r,n;if(!e)return;const a=this.options;this.options=e;const o=!!((n=(r=e.transform)==null?void 0:r.deps)!=null&&n.some((d,u)=>d!==this.prevTransformArray[u])),h=e.defaultValues&&!De(e.defaultValues,a.defaultValues)&&!this.state.isTouched,c=!De(e.defaultState,a.defaultState)&&!this.state.isTouched;!h&&!c&&!o||H(()=>{this.baseStore.setState(()=>Re(Object.assign({},this.state,c?e.defaultState:{},h?{values:e.defaultValues}:{},o?{_force_re_eval:!this.state._force_re_eval}:{})))})},this.reset=(e,r)=>{const{fieldMeta:n}=this.state,a=this.resetFieldMeta(n);e&&!(r!=null&&r.keepDefaultValues)&&(this.options={...this.options,defaultValues:e}),this.baseStore.setState(()=>{var o;return Re({...this.options.defaultState,values:e??this.options.defaultValues??((o=this.options.defaultState)==null?void 0:o.values),fieldMetaBase:a})})},this.validateAllFields=async e=>{const r=[];return H(()=>{Object.values(this.fieldInfo).forEach(a=>{if(!a.instance)return;const o=a.instance;r.push(Promise.resolve().then(()=>o.validate(e,{skipFormValidation:!0}))),a.instance.state.meta.isTouched||a.instance.setMeta(h=>({...h,isTouched:!0}))})}),(await Promise.all(r)).flat()},this.validateArrayFieldsStartingFrom=async(e,r,n)=>{const a=this.getFieldValue(e),o=Array.isArray(a)?Math.max(a.length-1,0):null,h=[`${e}[${r}]`];for(let l=r+1;l<=(o??0);l++)h.push(`${e}[${l}]`);const c=Object.keys(this.fieldInfo).filter(l=>h.some(f=>l.startsWith(f))),d=[];return H(()=>{c.forEach(l=>{d.push(Promise.resolve().then(()=>this.validateField(l,n)))})}),(await Promise.all(d)).flat()},this.validateField=(e,r)=>{var n;const a=(n=this.fieldInfo[e])==null?void 0:n.instance;return a?(a.state.meta.isTouched||a.setMeta(o=>({...o,isTouched:!0})),a.validate(r)):[]},this.validateSync=e=>{const r=We(e,this.options);let n=!1;const a={};return H(()=>{var o,h;for(const d of r){if(!d.validate)continue;const u=this.runValidator({validate:d.validate,value:{value:this.state.values,formApi:this,validationSource:"form"},type:"validate"}),{formError:l,fieldErrors:f}=je(u),p=Se(d.cause);for(const m of Object.keys(this.state.fieldMeta)){const g=this.getFieldMeta(m);if(!g)continue;const{errorMap:M,errorSourceMap:v}=g,F=f==null?void 0:f[m],{newErrorValue:C,newSource:$}=Ye({newFormValidatorError:F,isPreviousErrorFromFormValidator:(v==null?void 0:v[p])==="form",previousErrorValue:M==null?void 0:M[p]});$==="form"&&(a[m]={...a[m],[p]:F}),(M==null?void 0:M[p])!==C&&this.setFieldMeta(m,I=>({...I,errorMap:{...I.errorMap,[p]:C},errorSourceMap:{...I.errorSourceMap,[p]:$}}))}((o=this.state.errorMap)==null?void 0:o[p])!==l&&this.baseStore.setState(m=>({...m,errorMap:{...m.errorMap,[p]:l}})),(l||f)&&(n=!0)}const c=Se("submit");(h=this.state.errorMap)!=null&&h[c]&&e!=="submit"&&!n&&this.baseStore.setState(d=>({...d,errorMap:{...d.errorMap,[c]:void 0}}))}),{hasErrored:n,fieldsErrorMap:a}},this.validateAsync=async e=>{const r=qe(e,this.options);this.state.isFormValidating||this.baseStore.setState(c=>({...c,isFormValidating:!0}));const n=[];let a;for(const c of r){if(!c.validate)continue;const d=Se(c.cause),u=this.state.validationMetaMap[d];u==null||u.lastAbortController.abort();const l=new AbortController;this.state.validationMetaMap[d]={lastAbortController:l},n.push(new Promise(async f=>{let p;try{p=await new Promise((v,F)=>{setTimeout(async()=>{if(l.signal.aborted)return v(void 0);try{v(await this.runValidator({validate:c.validate,value:{value:this.state.values,formApi:this,validationSource:"form",signal:l.signal},type:"validateAsync"}))}catch(C){F(C)}},c.debounceMs)})}catch(v){p=v}const{formError:m,fieldErrors:g}=je(p);g&&(a=a?{...a,...g}:g);const M=Se(c.cause);for(const v of Object.keys(this.state.fieldMeta)){const F=this.getFieldMeta(v);if(!F)continue;const{errorMap:C,errorSourceMap:$}=F,I=a==null?void 0:a[v],{newErrorValue:V,newSource:L}=Ye({newFormValidatorError:I,isPreviousErrorFromFormValidator:($==null?void 0:$[M])==="form",previousErrorValue:C==null?void 0:C[M]});(C==null?void 0:C[M])!==V&&this.setFieldMeta(v,T=>({...T,errorMap:{...T.errorMap,[M]:V},errorSourceMap:{...T.errorSourceMap,[M]:L}}))}this.baseStore.setState(v=>({...v,errorMap:{...v.errorMap,[M]:m}})),f(a?{fieldErrors:a,errorMapKey:M}:void 0)}))}let o=[];const h={};if(n.length){o=await Promise.all(n);for(const c of o)if(c!=null&&c.fieldErrors){const{errorMapKey:d}=c;for(const[u,l]of Object.entries(c.fieldErrors)){const p={...h[u]||{},[d]:l};h[u]=p}}}return this.baseStore.setState(c=>({...c,isFormValidating:!1})),h},this.validate=e=>{const{hasErrored:r,fieldsErrorMap:n}=this.validateSync(e);return r&&!this.options.asyncAlways?n:this.validateAsync(e)},this.getFieldValue=e=>ut(this.state.values,e),this.getFieldMeta=e=>this.state.fieldMeta[e],this.getFieldInfo=e=>{var r;return(r=this.fieldInfo)[e]||(r[e]={instance:null,validationMetaMap:{onChange:void 0,onBlur:void 0,onSubmit:void 0,onMount:void 0,onServer:void 0}})},this.setFieldMeta=(e,r)=>{this.baseStore.setState(n=>({...n,fieldMetaBase:{...n.fieldMetaBase,[e]:Ce(r,n.fieldMetaBase[e])}}))},this.resetFieldMeta=e=>Object.keys(e).reduce((r,n)=>{const a=n;return r[a]=Ee,r},{}),this.setFieldValue=(e,r,n)=>{const a=(n==null?void 0:n.dontUpdateMeta)??!1;H(()=>{a||this.setFieldMeta(e,o=>({...o,isTouched:!0,isDirty:!0,errorMap:{...o==null?void 0:o.errorMap,onMount:void 0}})),this.baseStore.setState(o=>({...o,values:xe(o.values,e,r)}))})},this.deleteField=e=>{const n=[...Object.keys(this.fieldInfo).filter(a=>{const o=e.toString();return a!==o&&a.startsWith(o)}),e];this.baseStore.setState(a=>{const o={...a};return n.forEach(h=>{o.values=os(o.values,h),delete this.fieldInfo[h],delete o.fieldMetaBase[h]}),o})},this.pushFieldValue=(e,r,n)=>{this.setFieldValue(e,a=>[...Array.isArray(a)?a:[],r],n),this.validateField(e,"change")},this.insertFieldValue=async(e,r,n,a)=>{this.setFieldValue(e,o=>[...o.slice(0,r),n,...o.slice(r)],a),await this.validateField(e,"change"),ye(this).handleArrayFieldMetaShift(e,r,"insert"),await this.validateArrayFieldsStartingFrom(e,r,"change")},this.replaceFieldValue=async(e,r,n,a)=>{this.setFieldValue(e,o=>o.map((h,c)=>c===r?n:h),a),await this.validateField(e,"change"),await this.validateArrayFieldsStartingFrom(e,r,"change")},this.removeFieldValue=async(e,r,n)=>{const a=this.getFieldValue(e),o=Array.isArray(a)?Math.max(a.length-1,0):null;if(this.setFieldValue(e,h=>h.filter((c,d)=>d!==r),n),ye(this).handleArrayFieldMetaShift(e,r,"remove"),o!==null){const h=`${e}[${o}]`;this.deleteField(h)}await this.validateField(e,"change"),await this.validateArrayFieldsStartingFrom(e,r,"change")},this.swapFieldValues=(e,r,n,a)=>{this.setFieldValue(e,o=>{const h=o[r],c=o[n];return xe(xe(o,`${r}`,c),`${n}`,h)},a),ye(this).handleArrayFieldMetaShift(e,r,"swap",n),this.validateField(e,"change"),this.validateField(`${e}[${r}]`,"change"),this.validateField(`${e}[${n}]`,"change")},this.moveFieldValues=(e,r,n,a)=>{this.setFieldValue(e,o=>(o.splice(n,0,o.splice(r,1)[0]),o),a),ye(this).handleArrayFieldMetaShift(e,r,"move",n),this.validateField(e,"change"),this.validateField(`${e}[${r}]`,"change"),this.validateField(`${e}[${n}]`,"change")},this.resetField=e=>{this.baseStore.setState(r=>({...r,fieldMetaBase:{...r.fieldMetaBase,[e]:Ee},values:{...r.values,[e]:this.options.defaultValues&&this.options.defaultValues[e]}}))},this.getAllErrors=()=>({form:{errors:this.state.errors,errorMap:this.state.errorMap},fields:Object.entries(this.state.fieldMeta).reduce((e,[r,n])=>(Object.keys(n).length&&n.errors.length&&(e[r]={errors:n.errors,errorMap:n.errorMap}),e),{})}),this.parseValuesWithSchema=e=>te.validate({value:this.state.values,validationSource:"form"},e),this.parseValuesWithSchemaAsync=e=>te.validateAsync({value:this.state.values,validationSource:"form"},e),this.baseStore=new Ne(Re({...i==null?void 0:i.defaultState,values:(i==null?void 0:i.defaultValues)??((s=i==null?void 0:i.defaultState)==null?void 0:s.values)})),this.fieldMetaDerived=new U({deps:[this.baseStore],fn:({prevDepVals:e,currDepVals:r,prevVal:n})=>{var a;const o=n,h=e==null?void 0:e[0],c=r[0];let d=0;const u={};for(const l of Object.keys(c.fieldMetaBase)){const f=c.fieldMetaBase[l],p=h==null?void 0:h.fieldMetaBase[l],m=o==null?void 0:o[l];let g=m==null?void 0:m.errors;if(!p||f.errorMap!==p.errorMap){g=Object.values(f.errorMap??{}).filter(F=>F!==void 0);const v=(a=this.getFieldInfo(l))==null?void 0:a.instance;v&&!v.options.disableErrorFlat&&(g=g==null?void 0:g.flat(1))}const M=!f.isDirty;if(m&&m.isPristine===M&&m.errors===g&&f===p){u[l]=m,d++;continue}u[l]={...f,errors:g,isPristine:M}}return Object.keys(c.fieldMetaBase).length&&o&&d===Object.keys(c.fieldMetaBase).length?o:u}}),this.store=new U({deps:[this.baseStore,this.fieldMetaDerived],fn:({prevDepVals:e,currDepVals:r,prevVal:n})=>{var a,o,h,c;const d=n,u=e==null?void 0:e[0],l=r[0],f=Object.values(l.fieldMetaBase),p=f.some(S=>S==null?void 0:S.isValidating),m=!f.some(S=>(S==null?void 0:S.errorMap)&&fs(Object.values(S.errorMap).filter(Boolean))),g=f.some(S=>S==null?void 0:S.isTouched),M=f.some(S=>S==null?void 0:S.isBlurred),v=g&&((a=l==null?void 0:l.errorMap)==null?void 0:a.onMount),F=f.some(S=>S==null?void 0:S.isDirty),C=!F,$=!!((o=l.errorMap)!=null&&o.onMount||f.some(S=>{var x;return(x=S==null?void 0:S.errorMap)==null?void 0:x.onMount})),I=!!p;let V=(d==null?void 0:d.errors)??[];(!u||l.errorMap!==u.errorMap)&&(V=Object.values(l.errorMap).reduce((S,x)=>x===void 0?S:x&&ct(x)?(S.push(x.form),S):(S.push(x),S),[]));const L=V.length===0,T=m&&L,ie=this.options.canSubmitWhenInvalid??!1,J=l.submissionAttempts===0&&!g&&!$||!I&&!l.isSubmitting&&T||ie;let z=l.errorMap;if(v&&(V=V.filter(S=>S!==l.errorMap.onMount),z=Object.assign(z,{onMount:void 0})),d&&u&&d.errorMap===z&&d.fieldMeta===this.fieldMetaDerived.state&&d.errors===V&&d.isFieldsValidating===p&&d.isFieldsValid===m&&d.isFormValid===L&&d.isValid===T&&d.canSubmit===J&&d.isTouched===g&&d.isBlurred===M&&d.isPristine===C&&d.isDirty===F&&De(u,l))return d;let y={...l,errorMap:z,fieldMeta:this.fieldMetaDerived.state,errors:V,isFieldsValidating:p,isFieldsValid:m,isFormValid:L,isValid:T,canSubmit:J,isTouched:g,isBlurred:M,isPristine:C,isDirty:F};const Q=((h=this.options.transform)==null?void 0:h.deps)??[];if(Q.length!==this.prevTransformArray.length||Q.some((S,x)=>S!==this.prevTransformArray[x])){const S=Object.assign({},this,{state:y});(c=this.options.transform)==null||c.fn(S),y=S.state,this.prevTransformArray=Q}return y}}),this.handleSubmit=this.handleSubmit.bind(this),this.update(i||{})}get state(){return this.store.state}runValidator(i){return dt(i.validate)?te[i.type](i.value,i.validate):i.validate(i.value)}async handleSubmit(i){var s,e,r,n,a,o;if(this.baseStore.setState(c=>({...c,isSubmitted:!1,submissionAttempts:c.submissionAttempts+1,isSubmitSuccessful:!1})),H(()=>{Object.values(this.fieldInfo).forEach(c=>{c.instance&&(c.instance.state.meta.isTouched||c.instance.setMeta(d=>({...d,isTouched:!0})))})}),!this.state.canSubmit)return;this.baseStore.setState(c=>({...c,isSubmitting:!0}));const h=()=>{this.baseStore.setState(c=>({...c,isSubmitting:!1}))};if(await this.validateAllFields("submit"),!this.state.isFieldsValid){h(),(e=(s=this.options).onSubmitInvalid)==null||e.call(s,{value:this.state.values,formApi:this});return}if(await this.validate("submit"),!this.state.isValid){h(),(n=(r=this.options).onSubmitInvalid)==null||n.call(r,{value:this.state.values,formApi:this});return}H(()=>{Object.values(this.fieldInfo).forEach(c=>{var d,u,l;(l=(u=(d=c.instance)==null?void 0:d.options.listeners)==null?void 0:u.onSubmit)==null||l.call(u,{value:c.instance.state.value,fieldApi:c.instance})})});try{await((o=(a=this.options).onSubmit)==null?void 0:o.call(a,{value:this.state.values,formApi:this,meta:i??this.options.onSubmitMeta})),H(()=>{this.baseStore.setState(c=>({...c,isSubmitted:!0,isSubmitSuccessful:!0})),h()})}catch(c){throw this.baseStore.setState(d=>({...d,isSubmitSuccessful:!1})),h(),c}}setErrorMap(i){this.baseStore.setState(s=>({...s,errorMap:{...s.errorMap,...i}}))}}function je(t){if(t){if(ct(t)){const i=je(t.form).formError,s=t.fields;return{formError:i,fieldErrors:s}}return{formError:t}}return{formError:void 0}}function Se(t){switch(t){case"submit":return"onSubmit";case"blur":return"onBlur";case"mount":return"onMount";case"server":return"onServer";case"change":default:return"onChange"}}class vs{constructor(i){this.options={},this.mount=()=>{var s,e;const r=this.store.mount();this.options.defaultValue!==void 0&&this.form.setFieldValue(this.name,this.options.defaultValue,{dontUpdateMeta:!0});const n=this.getInfo();n.instance=this,this.update(this.options);const{onMount:a}=this.options.validators||{};if(a){const o=this.runValidator({validate:a,value:{value:this.state.value,fieldApi:this,validationSource:"field"},type:"validate"});o&&this.setMeta(h=>({...h,errorMap:{...h==null?void 0:h.errorMap,onMount:o},errorSourceMap:{...h==null?void 0:h.errorSourceMap,onMount:"field"}}))}return(e=(s=this.options.listeners)==null?void 0:s.onMount)==null||e.call(s,{value:this.state.value,fieldApi:this}),r},this.update=s=>{this.options=s;const e=this.name!==s.name;if(this.name=s.name,this.state.value===void 0){const r=ut(s.form.options.defaultValues,s.name),n=s.defaultValue??r;e?this.setValue(a=>a||n,{dontUpdateMeta:!0}):n!==void 0&&this.setValue(n,{dontUpdateMeta:!0})}this.form.getFieldMeta(this.name)===void 0&&this.setMeta(this.state.meta)},this.getValue=()=>this.form.getFieldValue(this.name),this.setValue=(s,e)=>{this.form.setFieldValue(this.name,s,e),this.triggerOnChangeListener(),this.validate("change")},this.getMeta=()=>this.store.state.meta,this.setMeta=s=>this.form.setFieldMeta(this.name,s),this.getInfo=()=>this.form.getFieldInfo(this.name),this.pushValue=(s,e)=>{this.form.pushFieldValue(this.name,s,e),this.triggerOnChangeListener()},this.insertValue=(s,e,r)=>{this.form.insertFieldValue(this.name,s,e,r),this.triggerOnChangeListener()},this.replaceValue=(s,e,r)=>{this.form.replaceFieldValue(this.name,s,e,r),this.triggerOnChangeListener()},this.removeValue=(s,e)=>{this.form.removeFieldValue(this.name,s,e),this.triggerOnChangeListener()},this.swapValues=(s,e,r)=>{this.form.swapFieldValues(this.name,s,e,r),this.triggerOnChangeListener()},this.moveValue=(s,e,r)=>{this.form.moveFieldValues(this.name,s,e,r),this.triggerOnChangeListener()},this.getLinkedFields=s=>{const e=Object.values(this.form.fieldInfo),r=[];for(const n of e){if(!n.instance)continue;const{onChangeListenTo:a,onBlurListenTo:o}=n.instance.options.validators||{};s==="change"&&(a!=null&&a.includes(this.name))&&r.push(n.instance),s==="blur"&&(o!=null&&o.includes(this.name))&&r.push(n.instance)}return r},this.validateSync=(s,e)=>{var r;const n=We(s,this.options),o=this.getLinkedFields(s).reduce((d,u)=>{const l=We(s,u.options);return l.forEach(f=>{f.field=u}),d.concat(l)},[]);let h=!1;H(()=>{const d=(u,l)=>{var f;const p=Me(l.cause),m=l.validate?et(u.runValidator({validate:l.validate,value:{value:u.store.state.value,validationSource:"field",fieldApi:u},type:"validate"})):void 0,g=e[p],{newErrorValue:M,newSource:v}=Xe({formLevelError:g,fieldLevelError:m});((f=u.state.meta.errorMap)==null?void 0:f[p])!==M&&u.setMeta(F=>({...F,errorMap:{...F.errorMap,[p]:M},errorSourceMap:{...F.errorSourceMap,[p]:v}})),M&&(h=!0)};for(const u of n)d(this,u);for(const u of o)u.validate&&d(u.field,u)});const c=Me("submit");return(r=this.state.meta.errorMap)!=null&&r[c]&&s!=="submit"&&!h&&this.setMeta(d=>({...d,errorMap:{...d.errorMap,[c]:void 0},errorSourceMap:{...d.errorSourceMap,[c]:void 0}})),{hasErrored:h}},this.validateAsync=async(s,e)=>{const r=qe(s,this.options),n=await e,a=this.getLinkedFields(s),o=a.reduce((l,f)=>{const p=qe(s,f.options);return p.forEach(m=>{m.field=f}),l.concat(p)},[]);this.state.meta.isValidating||this.setMeta(l=>({...l,isValidating:!0}));for(const l of a)l.setMeta(f=>({...f,isValidating:!0}));const h=[],c=[],d=(l,f,p)=>{const m=Me(f.cause),g=l.getInfo().validationMetaMap[m];g==null||g.lastAbortController.abort();const M=new AbortController;this.getInfo().validationMetaMap[m]={lastAbortController:M},p.push(new Promise(async v=>{var F;let C;try{C=await new Promise((T,ie)=>{this.timeoutIds.validations[f.cause]&&clearTimeout(this.timeoutIds.validations[f.cause]),this.timeoutIds.validations[f.cause]=setTimeout(async()=>{if(M.signal.aborted)return T(void 0);try{T(await this.runValidator({validate:f.validate,value:{value:l.store.state.value,fieldApi:l,signal:M.signal,validationSource:"field"},type:"validateAsync"}))}catch(J){ie(J)}},f.debounceMs)})}catch(T){C=T}if(M.signal.aborted)return v(void 0);const $=et(C),I=(F=n[this.name])==null?void 0:F[m],{newErrorValue:V,newSource:L}=Xe({formLevelError:I,fieldLevelError:$});l.setMeta(T=>({...T,errorMap:{...T==null?void 0:T.errorMap,[m]:V},errorSourceMap:{...T.errorSourceMap,[m]:L}})),v(V)}))};for(const l of r)l.validate&&d(this,l,h);for(const l of o)l.validate&&d(l.field,l,c);let u=[];(h.length||c.length)&&(u=await Promise.all(h),await Promise.all(c)),this.setMeta(l=>({...l,isValidating:!1}));for(const l of a)l.setMeta(f=>({...f,isValidating:!1}));return u.filter(Boolean)},this.validate=(s,e)=>{var r;if(!this.state.meta.isTouched)return[];const{fieldsErrorMap:n}=e!=null&&e.skipFormValidation?{fieldsErrorMap:{}}:this.form.validateSync(s),{hasErrored:a}=this.validateSync(s,n[this.name]??{});if(a&&!this.options.asyncAlways)return(r=this.getInfo().validationMetaMap[Me(s)])==null||r.lastAbortController.abort(),this.state.meta.errors;const o=e!=null&&e.skipFormValidation?Promise.resolve({}):this.form.validateAsync(s);return this.validateAsync(s,o)},this.handleChange=s=>{this.setValue(s)},this.handleBlur=()=>{this.state.meta.isTouched||(this.setMeta(e=>({...e,isTouched:!0})),this.validate("change")),this.state.meta.isBlurred||this.setMeta(e=>({...e,isBlurred:!0})),this.validate("blur"),this.triggerOnBlurListener()},this.parseValueWithSchema=s=>te.validate({value:this.state.value,validationSource:"field"},s),this.parseValueWithSchemaAsync=s=>te.validateAsync({value:this.state.value,validationSource:"field"},s),this.form=i.form,this.name=i.name,this.timeoutIds={validations:{},listeners:{}},this.store=new U({deps:[this.form.store],fn:()=>{const s=this.form.getFieldValue(this.name),e=this.form.getFieldMeta(this.name)??{...Ee,...i.defaultMeta};return{value:s,meta:e}}}),this.options=i}get state(){return this.store.state}runValidator(i){return dt(i.validate)?te[i.type](i.value,i.validate):i.validate(i.value)}setErrorMap(i){this.setMeta(s=>({...s,errorMap:{...s.errorMap,...i}}))}triggerOnBlurListener(){var i,s,e;const r=(i=this.options.listeners)==null?void 0:i.onBlurDebounceMs;r&&r>0?(this.timeoutIds.listeners.blur&&clearTimeout(this.timeoutIds.listeners.blur),this.timeoutIds.listeners.blur=setTimeout(()=>{var n,a;(a=(n=this.options.listeners)==null?void 0:n.onBlur)==null||a.call(n,{value:this.state.value,fieldApi:this})},r)):(e=(s=this.options.listeners)==null?void 0:s.onBlur)==null||e.call(s,{value:this.state.value,fieldApi:this})}triggerOnChangeListener(){var i,s,e;const r=(i=this.options.listeners)==null?void 0:i.onChangeDebounceMs;r&&r>0?(this.timeoutIds.listeners.change&&clearTimeout(this.timeoutIds.listeners.change),this.timeoutIds.listeners.change=setTimeout(()=>{var n,a;(a=(n=this.options.listeners)==null?void 0:n.onChange)==null||a.call(n,{value:this.state.value,fieldApi:this})},r)):(e=(s=this.options.listeners)==null?void 0:s.onChange)==null||e.call(s,{value:this.state.value,fieldApi:this})}}function et(t){if(t)return t}function Me(t){switch(t){case"submit":return"onSubmit";case"blur":return"onBlur";case"mount":return"onMount";case"server":return"onServer";case"change":default:return"onChange"}}function Be(t,i=s=>s){return Ht.useSyncExternalStoreWithSelector(t.subscribe,()=>t.state,()=>t.state,i,gs)}function gs(t,i){if(Object.is(t,i))return!0;if(typeof t!="object"||t===null||typeof i!="object"||i===null)return!1;if(t instanceof Map&&i instanceof Map){if(t.size!==i.size)return!1;for(const[e,r]of t)if(!i.has(e)||!Object.is(r,i.get(e)))return!1;return!0}if(t instanceof Set&&i instanceof Set){if(t.size!==i.size)return!1;for(const e of t)if(!i.has(e))return!1;return!0}const s=Object.keys(t);if(s.length!==Object.keys(i).length)return!1;for(let e=0;e<s.length;e++)if(!Object.prototype.hasOwnProperty.call(i,s[e])||!Object.is(t[s[e]],i[s[e]]))return!1;return!0}const Ve=typeof window<"u"?E.useLayoutEffect:E.useEffect;function ys(t){const[i]=E.useState(()=>{const e=new vs({...t,form:t.form,name:t.name});return e.Field=ht,e});return Ve(i.mount,[i]),Ve(()=>{i.update(t)}),Be(i.store,t.mode==="array"?s=>[s.meta,Object.keys(s.value??[]).length]:void 0),i}const ht=({children:t,...i})=>{const s=ys(i),e=E.useMemo(()=>Ce(t,s),[t,s,s.state.value,s.state.meta]);return w.jsx(w.Fragment,{children:e})};function Ss({form:t,selector:i,children:s}){const e=Be(t.store,i);return Ce(s,e)}function zs(t){const[i]=E.useState(()=>{const s=new ms(t),e=s;return e.Field=function(n){return w.jsx(ht,{...n,form:s})},e.Subscribe=r=>w.jsx(Ss,{form:s,selector:r.selector,children:r.children}),e});return Ve(i.mount,[]),Be(i.store,s=>s.isSubmitting),Ve(()=>{i.update(t)}),i}const Ms=t=>t.length>0&&t[0]!==null&&t[0]!==void 0,Js=t=>Ms(t)?t.filter(i=>i!==void 0).map(({message:i})=>i).join(", "):null,Qs=$t(w.jsx("path",{d:"M13.35 20.13c-.76.69-1.93.69-2.69-.01l-.11-.1C5.3 15.27 1.87 12.16 2 8.28c.06-1.7.93-3.33 2.34-4.29 2.64-1.8 5.9-.96 7.66 1.1 1.76-2.06 5.02-2.91 7.66-1.1 1.41.96 2.28 2.59 2.34 4.29.14 3.88-3.3 6.99-8.55 11.76z"})),bs=async({topic:t}={})=>{var a;const i=[],s={};t&&(i.push("EXISTS (SELECT 1 FROM json_each(tags) WHERE value = $topic)"),s.$topic=t);const r=`
      SELECT COUNT(*) as totalCount
      FROM posts
      ${i.length>0?`WHERE ${i.join(" AND ")}`:""}
    `;return((a=(await R.exec(r,s))[0])==null?void 0:a.totalCount)||0},ft=async({page:t=0,limit:i=10,topic:s,userId:e,orderBy:r="createdAt",order:n="desc",prioritizeFollowers:a}={})=>{var $;const o=[],h={};s&&(o.push("EXISTS (SELECT 1 FROM json_each(tags) WHERE value = $topic)"),h.$topic=s),e&&(o.push("userId = $userId"),h.$userId=e);const c=o.length>0?`WHERE ${o.join(" AND ")}`:"";let d="p.createdAt";r==="likeCount"||r==="commentCount"?d=`pic.${r}`:r==="createdAt"||r==="updatedAt"?d=`datetime(p.${r})`:d=`p.${r}`;let u="",l="";if(a){const I=await G({server:!0}),V=I.authenticated?I.user.id:null;V&&(h.$currentUserId=V,u=`
        LEFT JOIN (
          SELECT followeeId, 1 AS isFollowed
          FROM user_interactions
          WHERE followerId = $currentUserId AND type = 'follow'
        ) AS following ON p.userId = following.followeeId
      `,l="CASE WHEN following.isFollowed = 1 THEN 1 ELSE 0 END DESC, ")}const f=`
      SELECT COUNT(*) as totalCount
      FROM posts
      ${c}
    `,m=(($=(await R.exec(f,h))[0])==null?void 0:$.totalCount)||0,g=Math.ceil(m/i),M=t+1<g?t+1:null;h.$limit=i,h.$offset=t*i;const v=`
        SELECT id
        FROM posts p
        LEFT JOIN post_interaction_counts pic ON p.id = pic.postId
        ${u}
        ${c}
        ORDER BY ${l}${d} ${n.toUpperCase()}, p.createdAt DESC
        LIMIT $limit OFFSET $offset
      `;return{posts:(await R.exec(v,h)).map(I=>I.id),nextPage:M,totalPages:g}},ws=async({postId:t,incrementViewCount:i=!1})=>{let s=null;const e=await G({server:!0});s=e.authenticated?e.user.id:null,i&&R.exec("UPDATE posts SET viewCount = viewCount + 1 WHERE id = $postId",{$postId:t});let r=`
      SELECT
        p.id,
        p.title,
        p.content,
        p.tags,
        p.photos,
        p.attachments,
        p.viewCount,
        p.createdAt,
        p.updatedAt,
        p.userId,
        u.name as userName,
        COALESCE(pic.likeCount, 0) as likeCount,
        COALESCE(pic.commentCount, 0) as commentCount
  `;s?r+=`,
      EXISTS (
        SELECT 1
        FROM user_interactions
        WHERE followerId = $currentUserId
        AND followeeId = p.userId
        AND type = 'follow'
      ) as isFromFollowing
    `:r+=", 0 as isFromFollowing",r+=`
      FROM posts p
      JOIN users u ON p.userId = u.id
      LEFT JOIN post_interaction_counts pic ON p.id = pic.postId
      WHERE p.id = $postId
  `;const n={$postId:t};s&&(n.$currentUserId=s);const a=await R.exec(r,n);if(a.length===0)return null;const o=a[0];return{...o,tags:JSON.parse(o.tags||"[]"),photos:o.photos?JSON.parse(o.photos):void 0,attachments:o.attachments?JSON.parse(o.attachments):void 0,createdAt:new Date(o.createdAt),updatedAt:new Date(o.updatedAt),likeCount:o.likeCount||0,commentCount:o.commentCount||0,isFromFollowing:!!o.isFromFollowing,isSelf:s?o.userId===s:!1}},Fs=async({title:t,content:i,tags:s,photos:e,attachments:r})=>{const n=await G({server:!0});if(!n.authenticated)return{error:"未登入或授權失效，無法創建貼文"};const a=n.user.id,o=JSON.stringify(s),h=e?JSON.stringify(e):null,c=r?JSON.stringify(r):null,d=`
      INSERT INTO posts ( userId, title, content, tags, photos, attachments, createdAt, updatedAt )
      VALUES ( $userId, $title, $content, $tags, $photos, $attachments, $createdAt, $updatedAt )
      RETURNING id
    `,u=new Date().toISOString(),l={$userId:a,$title:t,$content:i,$tags:o,$photos:h,$attachments:c,$createdAt:u,$updatedAt:u},f=await R.exec(d,l);return!f||f.length===0||typeof f[0].id!="number"?{error:"創建貼文失敗"}:f[0].id},Es=async({id:t,title:i,content:s,tags:e,photos:r,attachments:n})=>{const a=await G({server:!0});if(!a.authenticated)return{error:"未登入或授權失效，無法更新貼文"};const o=a.user.id,c=await R.exec("SELECT userId FROM posts WHERE id = $postId",{$postId:t});if(c.length===0)return{error:"貼文不存在"};if(c[0].userId!==o)return{error:"您沒有權限更新此貼文"};const d=JSON.stringify(e),u=r?JSON.stringify(r):null,l=n?JSON.stringify(n):null,f=new Date().toISOString(),p=`
      UPDATE posts
      SET title = $title,
          content = $content,
          tags = $tags,
          photos = $photos,
          attachments = $attachments,
          updatedAt = $updatedAt
      WHERE id = $postId AND userId = $userId
    `,m={$postId:t,$userId:o,$title:i,$content:s,$tags:d,$photos:u,$attachments:l,$updatedAt:f};return await R.exec(p,m),null},Vs=async t=>{const i=await G({server:!0});if(!i.authenticated)return{error:"未登入或授權失效，無法刪除貼文"};const s=i.user.id,r=await R.exec("SELECT userId FROM posts WHERE id = $postId",{$postId:t});return r.length===0?{error:"貼文不存在"}:r[0].userId!==s?{error:"您沒有權限刪除此貼文"}:(await R.exec("DELETE FROM posts WHERE id = $postId AND userId = $userId",{$postId:t,$userId:s}),null)},Ts=async()=>{const i=await R.exec("SELECT tags FROM tag_stats");if(i.length===0)return[];const s=i[0].tags,e=JSON.parse(s);return Array.isArray(e)?e:[]},Cs=async()=>{const t=await G({server:!0});if(!t.authenticated)return[];const i=t.user.id,e=await R.exec(`
      SELECT json_group_array(json_object('name', tag, 'count', COUNT)) as tags
      FROM (
        SELECT json_each.value AS tag, COUNT(*) AS COUNT
        FROM posts, json_each(posts.tags)
        WHERE posts.userId = $userId
        GROUP BY json_each.value
        ORDER BY COUNT DESC, tag
      )
    `,{$userId:i});if(e.length===0)return[];const r=e[0].tags,n=JSON.parse(r);return Array.isArray(n)?n:[]},re=1*60*1e3,Gs=({limit:t,topic:i,userId:s,orderBy:e,order:r,prioritizeFollowers:n}={})=>se({queryKey:["posts",t,i,s,e,r,n],queryFn:async()=>(await ft({page:0,limit:t,topic:i,userId:s,orderBy:e,order:r,prioritizeFollowers:n})).posts,staleTime:re}),Ys=({topic:t}={})=>se({queryKey:["postCounts",t],queryFn:()=>bs({topic:t}),staleTime:re}),Xs=({limit:t=6,topic:i,userId:s,orderBy:e,order:r,prioritizeFollowers:n}={})=>{const{data:a,fetchNextPage:o,hasNextPage:h,isFetchingNextPage:c,isLoading:d}=Wt({queryKey:["infinitePosts",t,i,s,e,r,n],queryFn:({pageParam:u})=>ft({page:u,limit:t,topic:i,userId:s,orderBy:e,order:r,prioritizeFollowers:n}),initialPageParam:0,getNextPageParam:u=>u.nextPage,staleTime:re});return E.useEffect(()=>{const u=document.getElementById("scroll-area");if(!u)return;const l=()=>{const f=u.scrollHeight,p=u.scrollTop,m=u.clientHeight;p+m>=f-350&&h&&!c&&o()};return u.addEventListener("scroll",l),()=>u.removeEventListener("scroll",l)},[o,h,c]),{data:a,isLoading:d,isFetchingNextPage:c,hasNextPage:h,fetchNextPage:o}},Zs=()=>se({queryKey:["tags"],queryFn:Ts,staleTime:re}),er=()=>se({queryKey:["userTags"],queryFn:Cs,staleTime:re}),tr=({postId:t,incrementViewCount:i})=>se({queryKey:["post",t],queryFn:()=>t===void 0||Number.isNaN(t)?null:ws({postId:t,incrementViewCount:i}),enabled:t!==void 0&&!Number.isNaN(t)&&t>=0,staleTime:re}),sr=()=>{const t=K();return B({mutationFn:Fs,onSettled:()=>{t.invalidateQueries({queryKey:["posts"]}),t.invalidateQueries({queryKey:["infinitePosts"]}),t.invalidateQueries({queryKey:["postCounts"]}),t.invalidateQueries({queryKey:["tags"]}),t.invalidateQueries({queryKey:["userTags"]})}})},rr=()=>{const t=K();return B({mutationFn:Es,onSettled:()=>{t.invalidateQueries({queryKey:["posts"]}),t.invalidateQueries({queryKey:["infinitePosts"]}),t.invalidateQueries({queryKey:["postCounts"]}),t.invalidateQueries({queryKey:["tags"]}),t.invalidateQueries({queryKey:["userTags"]})}})},ir=()=>{const t=K();return B({mutationFn:Vs,onSettled:()=>{t.invalidateQueries({queryKey:["posts"]}),t.invalidateQueries({queryKey:["infinitePosts"]}),t.invalidateQueries({queryKey:["postCounts"]}),t.invalidateQueries({queryKey:["tags"]}),t.invalidateQueries({queryKey:["userTags"]})}})};export{Rs as C,Qs as F,ts as S,Ns as T,tr as a,Zs as b,Ws as c,zs as d,Ms as e,Hs as f,Js as g,Ys as h,qs as i,Xs as j,ir as k,sr as l,rr as m,er as n,Us as o,Bs as p,Ks as q,js as r,Ls as s,Gs as u};
