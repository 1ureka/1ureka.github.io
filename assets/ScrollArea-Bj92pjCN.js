var U=Object.defineProperty;var _=(e,t,r)=>t in e?U(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var T=(e,t,r)=>_(e,typeof t!="symbol"?t+"":t,r);import{n as B,v as w,r as Q,o as I,j as s,T as u,B as f,P as q,q as P,y as k,w as z,C as H,x as W}from"./routes-Bsweq7TM.js";import{Q as K,i as D,h as V,b as J,c as Y,t as p,d as G,e as X,g as Z,f as ee,s as O,u as C,S as te,R as se,j as re,k as ae,E as ne}from"./forum-DwW5JLUY.js";import{F as L}from"./ForumRounded-DOUsWsZj.js";var oe=class extends K{constructor(e,t){super(e,t)}bindMethods(){super.bindMethods(),this.fetchNextPage=this.fetchNextPage.bind(this),this.fetchPreviousPage=this.fetchPreviousPage.bind(this)}setOptions(e,t){super.setOptions({...e,behavior:D()},t)}getOptimisticResult(e){return e.behavior=D(),super.getOptimisticResult(e)}fetchNextPage(e){return this.fetch({...e,meta:{fetchMore:{direction:"forward"}}})}fetchPreviousPage(e){return this.fetch({...e,meta:{fetchMore:{direction:"backward"}}})}createResult(e,t){var x,b;const{state:r}=e,a=super.createResult(e,t),{isFetching:n,isRefetching:c,isError:o,isRefetchError:l}=a,i=(b=(x=r.fetchMeta)==null?void 0:x.fetchMore)==null?void 0:b.direction,d=o&&i==="forward",h=n&&i==="forward",S=o&&i==="backward",j=n&&i==="backward";return{...a,fetchNextPage:this.fetchNextPage,fetchPreviousPage:this.fetchPreviousPage,hasNextPage:J(t,r.data),hasPreviousPage:V(t,r.data),isFetchNextPageError:d,isFetchingNextPage:h,isFetchPreviousPageError:S,isFetchingPreviousPage:j,isRefetchError:l&&!d&&!S,isRefetching:c&&!h&&!j}}};function ie(e,t){return Y(e,oe)}const g=B({cssVariables:{colorSchemeSelector:".mode-%s"},typography:{fontFamily:'Comfortaa, "jf openhuninn", "Noto Sans TC"'},colorSchemes:{light:{palette:{text:{primary:"#000"},primary:{main:"#FF772E",contrastText:"#fff"},secondary:{main:"#2f5d6f"}}},dark:{palette:{primary:{main:"#FF772E",contrastText:"#fff"},secondary:{main:"#2f5d6f"},background:{default:"#222",paper:"#222"}}}},components:{MuiInputBase:{defaultProps:{sx:{"&.Mui-disabled::before":{borderBottomStyle:"solid"}}}}},spacing:"0.5rem"}),Ce=()=>{const e=w(g.breakpoints.up("lg")),t=w(g.breakpoints.up("md")),r=w(g.breakpoints.up("sm"));return Q.useEffect(()=>{e?document.documentElement.style.fontSize="16px":t?document.documentElement.style.fontSize="14px":document.documentElement.style.fontSize="13px"},[e,t,r]),{isLg:e,isMd:t,isSm:r}},ce=I(s.jsx("path",{d:"M20 3H4c-1.1 0-2 .9-2 2v11c0 1.1.9 2 2 2h3c-.55.55-1 .87-1 1.59 0 .78.63 1.41 1.41 1.41h9.17c.78 0 1.41-.63 1.41-1.41 0-.72-.44-1.03-1-1.59h3c1.1 0 2-.9 2-2V5C22 3.9 21.1 3 20 3m0 13H4V5h16z"})),$=I(s.jsx("path",{d:"M16.88 2.88c-.49-.49-1.28-.49-1.77 0L6.7 11.29c-.39.39-.39 1.02 0 1.41l8.41 8.41c.49.49 1.28.49 1.77 0s.49-1.28 0-1.77L9.54 12l7.35-7.35c.48-.49.48-1.28-.01-1.77"})),le=I(s.jsx("path",{d:"M12 7c.55 0 1 .45 1 1v4c0 .55-.45 1-1 1s-1-.45-1-1V8c0-.55.45-1 1-1m-.01-5C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2M12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8m1-3h-2v-2h2z"})),M=500,v="sqlite-db-forum";class m{static async exec(t,r){const a=Date.now();this.dbPromise=this.dbPromise===null?this.loadDatabase():this.dbPromise;const n=await this.dbPromise;n.run("PRAGMA foreign_keys = ON;");const[{values:c}]=n.exec("PRAGMA foreign_keys;");if(c[0][0]!==1)return console.error("Failed to enable foreign keys"),this.parse([]);const o=await p((async()=>{const i=n.exec(t,r);return await this.saveDatabase(n),i})());if(o.error!==null)return console.error("Failed to execute SQL query",o.error),this.parse([]);const l=Date.now()-a;return l<M&&await new Promise(i=>setTimeout(i,M-l)),this.parse(o.data)}static async reset(){await G(v),this.dbPromise=this.loadDatabase()}static parse(t){if(t.length===0||!t[0])return[];const{columns:r,values:a}=t[0];return a.map(n=>Object.fromEntries(r.map((c,o)=>[c,n[o]])))}static async loadDatabase(){const t=await X({locateFile:i=>`https://sql.js.org/dist/${i}`}),{data:r,error:a}=await p(Z(v));if(a&&console.error("Failed to get cached database",a),r)return new t.Database(r);const{data:n,error:c}=await p((async()=>{const d=await(await fetch(ee)).arrayBuffer();return new t.Database(new Uint8Array(d))})());if(c)return console.error("Failed to fetch database file",c),new t.Database;const o=n.export(),{error:l}=await p(O(v,o));return l&&console.error("Failed to save database to IndexedDB",l),n}static async saveDatabase(t){const r=t.export(),{error:a}=await p(O(v,r));a&&console.error("Failed to save database to IndexedDB",a)}}T(m,"dbPromise",null);const y="forum_session",ue=1e3*60*60*1,de=async()=>{const e=localStorage.getItem(y);if(!e)return{authenticated:!1,user:null,loading:!1,error:null};const t=JSON.parse(e);if(!t.authenticated)return localStorage.removeItem(y),{authenticated:!1,user:null,loading:!1,error:null};const r=Date.now();if(r-t.timestamp>ue)return localStorage.removeItem(y),{authenticated:!1,user:null,loading:!1,error:"會話已過期，請重新登入"};const n=await m.exec(`
    SELECT id, name, description
    FROM users
    WHERE id = $userId
    LIMIT 1
  `,{$userId:t.user.id});if(n.length===0)return localStorage.removeItem(y),{authenticated:!1,user:null,loading:!1,error:"使用者不存在"};const c=n[0],o={...t,user:c},l={...o,timestamp:r};return localStorage.setItem(y,JSON.stringify(l)),o},me=async()=>{var r;return((r=(await m.exec(`
      SELECT COUNT(*) as count
      FROM users
    `))[0])==null?void 0:r.count)||0},he=async({page:e=0,limit:t=10,isAuthor:r=!1,isUnfollowed:a=!1,orderBy:n="createdAt",order:c="desc"}={})=>{var F;let o=null;if(a){const N=await de();o=N.authenticated?N.user.id:null}const l=[],i={};r&&l.push("EXISTS (SELECT 1 FROM posts WHERE posts.userId = u.id)"),a&&o&&(l.push(`
      u.id <> $currentUserId AND
      NOT EXISTS (
        SELECT 1 FROM user_interactions
        WHERE followerId = $currentUserId AND followeeId = u.id AND type = 'follow'
      )
    `),i.$currentUserId=o);const d=l.length>0?`WHERE ${l.join(" AND ")}`:"";let h="u.createdAt";n==="postCount"||n==="followerCount"?h=`uic.${n}`:h=`u.${n}`;const S=`
      SELECT COUNT(*) as totalCount
      FROM users u
      ${d}
    `,R=((F=(await m.exec(S,i))[0])==null?void 0:F.totalCount)||0,x=Math.ceil(R/t),b=e+1<x?e+1:null;i.$limit=t,i.$offset=e*t;const A=`
      SELECT u.id, u.name, u.description
      FROM users u
      LEFT JOIN user_interaction_counts uic ON u.id = uic.userId
      ${d}
      ORDER BY ${h} ${c.toUpperCase()}, datetime(u.createdAt) DESC
      LIMIT $limit OFFSET $offset
    `;return{users:await m.exec(A,i),nextPage:b,totalPages:x}},fe=async({name:e})=>{const r=await m.exec(`
      SELECT id, name, description
      FROM users
      WHERE name = $name
      LIMIT 1
    `,{$name:e});return r.length===0?null:r[0]},xe=async({userId:e})=>(await m.exec(`
      SELECT
        followerCount,
        followingCount,
        postCount,
        totalLikeCount as likeCount,
        totalViewCount as viewCount
      FROM user_interaction_counts
      WHERE userId = $userId
    `,{$userId:e}))[0],E=1*60*1e3,pe=()=>C({queryKey:["userCounts"],queryFn:me,staleTime:E}),Re=({page:e=0,limit:t,isAuthor:r=!0,orderBy:a,order:n}={})=>ie({queryKey:["users",e,t,r,a,n],queryFn:async({pageParam:c})=>he({page:c,limit:t,isAuthor:r,orderBy:a,order:n}),initialPageParam:0,getNextPageParam:c=>c.nextPage,staleTime:E}),Fe=e=>C({queryKey:["user",e],queryFn:()=>e==null?null:fe({name:e}),staleTime:E}),Ne=e=>C({queryKey:["userStats",e],queryFn:()=>xe({userId:e}),staleTime:E}),ye=()=>s.jsx(te,{variant:"rounded",animation:"wave",component:"span",sx:{display:"inline",mx:.5},children:s.jsx(u,{variant:"body2",component:"span",sx:{color:"primary.light"},children:"100"})}),ge=()=>{const{data:e,isFetching:t}=pe();return s.jsxs(u,{className:"mode-dark",variant:"body2",sx:{mt:4,color:"text.secondary"},children:["與其他",t||e===void 0?s.jsx(ye,{}):s.jsx(u,{component:"span",variant:"body2",sx:{color:"primary.light"},children:` ${e} `}),"位使用者一同加入我們"]})},Te=()=>s.jsxs(f,{sx:{minHeight:"100vh",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",p:3,bgcolor:"secondary.main",color:"text.primary",textAlign:"center"},children:[s.jsxs(f,{className:"mode-dark",sx:{display:"flex",justifyContent:"center",alignItems:"center",gap:1,mb:4},children:[s.jsx(L,{color:"primary",sx:{fontSize:"2.5rem"}}),s.jsx(u,{variant:"h4",component:"h1",sx:{color:"text.primary",fontFamily:'"timemachine-wa"'},children:"論壇樣板"})]}),s.jsxs(q,{elevation:4,sx:{p:4,borderRadius:3,maxWidth:"100%",display:"flex",flexDirection:"column",alignItems:"center",gap:2},children:[s.jsx(ce,{fontSize:"large",sx:{color:"text.secondary"}}),s.jsxs(u,{variant:"h5",component:"p",gutterBottom:!0,children:["該頁面僅支援桌面瀏覽器 (寬度大於 ",g.breakpoints.values.sm,"px)"]}),s.jsx(u,{variant:"body1",color:"text.secondary",children:"請使用電腦訪問以獲得最佳體驗"}),s.jsx(P,{variant:"contained",href:k.forum_home,startIcon:s.jsx($,{}),sx:{mt:2},children:"返回首頁"})]}),s.jsx(ge,{})]}),Se=({error:e,resetErrorBoundary:t})=>s.jsxs(f,{sx:{minHeight:"100vh",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",p:3,bgcolor:"secondary.main",color:"text.primary",textAlign:"center"},children:[s.jsxs(f,{className:"mode-dark",sx:{display:"flex",justifyContent:"center",alignItems:"center",gap:1,mb:4},children:[s.jsx(L,{color:"primary",sx:{fontSize:"2.5rem"}}),s.jsx(u,{variant:"h4",component:"h1",sx:{color:"text.primary",fontFamily:'"timemachine-wa"'},children:"論壇樣板"})]}),s.jsxs(q,{elevation:4,sx:{p:4,borderRadius:3,maxWidth:"100%",display:"flex",flexDirection:"column",alignItems:"center",gap:2},children:[s.jsx(le,{fontSize:"large",sx:{color:"error.main"}}),s.jsx(u,{variant:"h5",component:"p",gutterBottom:!0,children:"發生錯誤"}),s.jsx(u,{variant:"body1",color:"text.secondary",children:e==null?void 0:e.message}),s.jsx(u,{variant:"body1",color:"text.secondary",children:"很抱歉，頁面載入時發生問題，請稍後再試"}),s.jsxs(f,{sx:{display:"flex",gap:2,mt:2},children:[s.jsx(P,{variant:"contained",href:k.forum_home,startIcon:s.jsx($,{}),children:"返回首頁"}),s.jsx(P,{variant:"outlined",onClick:()=>t(),startIcon:s.jsx(se,{}),children:"重新載入"})]})]}),s.jsxs(u,{className:"mode-dark",variant:"body2",sx:{mt:4,color:"text.secondary"},children:["如需協助，請聯繫",s.jsx(u,{component:"span",variant:"body2",sx:{cursor:"pointer",color:"primary.light","&:hover":{textDecoration:"underline"}},children:" 論壇樣板客服 "})]})]}),be=new re;function De({children:e}){return s.jsxs(z,{theme:g,children:[s.jsx(H,{}),s.jsx(W,{}),s.jsx(ae,{client:be,children:s.jsx(ne,{fallbackRender:t=>s.jsx(Se,{...t}),children:e})})]})}const ve={position:"relative",height:"100dvh",overflow:"auto",scrollbarWidth:"thin",scrollbarColor:"gray transparent",display:"flex",flexDirection:"column"},Oe=({children:e,...t})=>s.jsx(f,{sx:ve,id:"scroll-area",className:"top",onScroll:r=>{const a=r.target;a.scrollTop<25?a.classList.add("top"):a.classList.remove("top")},...t,children:e});export{De as A,Te as N,Oe as S,ge as U,Ce as a,$ as b,pe as c,m as d,ie as e,Fe as f,Ne as g,g as t,Re as u};
