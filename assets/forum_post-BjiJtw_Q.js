import{r as B,a as Ie,g as Ce,u as $e,j as e,s as Se,c as Be,G as Ee,H as we,b as $,d as Re,m as ke,e as ee,J as Ae,n as L,B as h,l as u,o as i,I as M,q as Pe,F as Te,y as Fe,S as Le,v as qe,z as Ne,P as te,M as Oe,i as de,w as ce,A as ze,E as De}from"./routes-BL4F7qe0.js";import{S as Me,A as We}from"./SentimentDissatisfiedRounded-D8u3jCzd.js";import{g as K,s as S,a as Ke,A as He,S as Ve}from"./ScrollArea-CKfI-QIU.js";import{B as _e,f as ne,F as Qe,U as ue,b as Ue,c as Ge,d as Je,e as Ye}from"./AttachFileRounded-DfQXCVvE.js";import{a as J,i as xe,d as Xe,g as Ze,e as et,u as tt,C as nt}from"./post-CzcBpsWZ.js";import{u as H}from"./url-DQDR-2Is.js";import{E as se,a as st}from"./ExpandedPost-BhIydj7q.js";import{T as Y,V as me}from"./PersonPinCircleRounded-BCuK5Ply.js";import{L as rt,P as ot,T as it,S as at,a as lt}from"./PostHeader-CB27SGFI.js";import{D as dt}from"./DownloadRounded-BhbGJTPc.js";import{D as ct}from"./NotificationsRounded-D3H6RF3j.js";import{S as P}from"./Skeleton-ClxZthIi.js";import{C as G}from"./Badge-D5tNnhU_.js";import{T as F}from"./DarkModeRounded-Cxep-z7o.js";import{D as b}from"./ExpandMoreRounded-CTn9USNx.js";import{u as V}from"./SQLiteClient-DK8bI8dR.js";import{u as q}from"./RefreshRounded-izmRgbbI.js";import{u as _}from"./useMutation-CDZIunGl.js";import{E as ut}from"./EmojiMenu-CUcleZOM.js";import{z as pe}from"./index-mSkvzYyn.js";import{A as xt}from"./ErrorRounded-1S1nGTGh.js";import{M as re}from"./MenuItem-D8U_jw-0.js";import{f as mt}from"./formatters-C9bWSe0O.js";import{T as oe,a as D}from"./Tabs-CS-jEvmQ.js";import"./ForumRounded-DkGOXTQX.js";import"./ErrorOutlineRounded-DZbqNvDb.js";import"./OpenInNewRounded-CmBpT7ZC.js";import"./MoreHorizRounded-Bx5iTzBR.js";import"./ArrowOutwardRounded-D4UzN7TR.js";import"./with-selector-CSjwWLM5.js";import"./CommentRounded-DQNCUrkZ.js";function pt(t){return B.Children.toArray(t).filter(n=>B.isValidElement(n))}function ht(t){return Ce("MuiButtonGroup",t)}const l=Ie("MuiButtonGroup",["root","contained","outlined","text","disableElevation","disabled","firstButton","fullWidth","horizontal","vertical","colorPrimary","colorSecondary","grouped","groupedHorizontal","groupedVertical","groupedText","groupedTextHorizontal","groupedTextVertical","groupedTextPrimary","groupedTextSecondary","groupedOutlined","groupedOutlinedHorizontal","groupedOutlinedVertical","groupedOutlinedPrimary","groupedOutlinedSecondary","groupedContained","groupedContainedHorizontal","groupedContainedVertical","groupedContainedPrimary","groupedContainedSecondary","lastButton","middleButton"]),jt=(t,n)=>{const{ownerState:s}=t;return[{[`& .${l.grouped}`]:n.grouped},{[`& .${l.grouped}`]:n[`grouped${$(s.orientation)}`]},{[`& .${l.grouped}`]:n[`grouped${$(s.variant)}`]},{[`& .${l.grouped}`]:n[`grouped${$(s.variant)}${$(s.orientation)}`]},{[`& .${l.grouped}`]:n[`grouped${$(s.variant)}${$(s.color)}`]},{[`& .${l.firstButton}`]:n.firstButton},{[`& .${l.lastButton}`]:n.lastButton},{[`& .${l.middleButton}`]:n.middleButton},n.root,n[s.variant],s.disableElevation===!0&&n.disableElevation,s.fullWidth&&n.fullWidth,s.orientation==="vertical"&&n.vertical]},gt=t=>{const{classes:n,color:s,disabled:a,disableElevation:o,fullWidth:r,orientation:d,variant:c}=t,x={root:["root",c,d,r&&"fullWidth",o&&"disableElevation",`color${$(s)}`],grouped:["grouped",`grouped${$(d)}`,`grouped${$(c)}`,`grouped${$(c)}${$(d)}`,`grouped${$(c)}${$(s)}`,a&&"disabled"],firstButton:["firstButton"],lastButton:["lastButton"],middleButton:["middleButton"]};return Re(x,ht,n)},ft=Se("div",{name:"MuiButtonGroup",slot:"Root",overridesResolver:jt})(ke(({theme:t})=>({display:"inline-flex",borderRadius:(t.vars||t).shape.borderRadius,variants:[{props:{variant:"contained"},style:{boxShadow:(t.vars||t).shadows[2]}},{props:{disableElevation:!0},style:{boxShadow:"none"}},{props:{fullWidth:!0},style:{width:"100%"}},{props:{orientation:"vertical"},style:{flexDirection:"column",[`& .${l.lastButton},& .${l.middleButton}`]:{borderTopRightRadius:0,borderTopLeftRadius:0},[`& .${l.firstButton},& .${l.middleButton}`]:{borderBottomRightRadius:0,borderBottomLeftRadius:0}}},{props:{orientation:"horizontal"},style:{[`& .${l.firstButton},& .${l.middleButton}`]:{borderTopRightRadius:0,borderBottomRightRadius:0},[`& .${l.lastButton},& .${l.middleButton}`]:{borderTopLeftRadius:0,borderBottomLeftRadius:0}}},{props:{variant:"text",orientation:"horizontal"},style:{[`& .${l.firstButton},& .${l.middleButton}`]:{borderRight:t.vars?`1px solid rgba(${t.vars.palette.common.onBackgroundChannel} / 0.23)`:`1px solid ${t.palette.mode==="light"?"rgba(0, 0, 0, 0.23)":"rgba(255, 255, 255, 0.23)"}`,[`&.${l.disabled}`]:{borderRight:`1px solid ${(t.vars||t).palette.action.disabled}`}}}},{props:{variant:"text",orientation:"vertical"},style:{[`& .${l.firstButton},& .${l.middleButton}`]:{borderBottom:t.vars?`1px solid rgba(${t.vars.palette.common.onBackgroundChannel} / 0.23)`:`1px solid ${t.palette.mode==="light"?"rgba(0, 0, 0, 0.23)":"rgba(255, 255, 255, 0.23)"}`,[`&.${l.disabled}`]:{borderBottom:`1px solid ${(t.vars||t).palette.action.disabled}`}}}},...Object.entries(t.palette).filter(ee()).flatMap(([n])=>[{props:{variant:"text",color:n},style:{[`& .${l.firstButton},& .${l.middleButton}`]:{borderColor:t.vars?`rgba(${t.vars.palette[n].mainChannel} / 0.5)`:Ae(t.palette[n].main,.5)}}}]),{props:{variant:"outlined",orientation:"horizontal"},style:{[`& .${l.firstButton},& .${l.middleButton}`]:{borderRightColor:"transparent","&:hover":{borderRightColor:"currentColor"}},[`& .${l.lastButton},& .${l.middleButton}`]:{marginLeft:-1}}},{props:{variant:"outlined",orientation:"vertical"},style:{[`& .${l.firstButton},& .${l.middleButton}`]:{borderBottomColor:"transparent","&:hover":{borderBottomColor:"currentColor"}},[`& .${l.lastButton},& .${l.middleButton}`]:{marginTop:-1}}},{props:{variant:"contained",orientation:"horizontal"},style:{[`& .${l.firstButton},& .${l.middleButton}`]:{borderRight:`1px solid ${(t.vars||t).palette.grey[400]}`,[`&.${l.disabled}`]:{borderRight:`1px solid ${(t.vars||t).palette.action.disabled}`}}}},{props:{variant:"contained",orientation:"vertical"},style:{[`& .${l.firstButton},& .${l.middleButton}`]:{borderBottom:`1px solid ${(t.vars||t).palette.grey[400]}`,[`&.${l.disabled}`]:{borderBottom:`1px solid ${(t.vars||t).palette.action.disabled}`}}}},...Object.entries(t.palette).filter(ee(["dark"])).map(([n])=>({props:{variant:"contained",color:n},style:{[`& .${l.firstButton},& .${l.middleButton}`]:{borderColor:(t.vars||t).palette[n].dark}}}))],[`& .${l.grouped}`]:{minWidth:40,boxShadow:"none",props:{variant:"contained"},style:{"&:hover":{boxShadow:"none"}}}}))),yt=B.forwardRef(function(n,s){const a=$e({props:n,name:"MuiButtonGroup"}),{children:o,className:r,color:d="primary",component:c="div",disabled:x=!1,disableElevation:j=!1,disableFocusRipple:m=!1,disableRipple:g=!1,fullWidth:I=!1,orientation:C="horizontal",size:y="medium",variant:E="outlined",...w}=a,R={...a,color:d,component:c,disabled:x,disableElevation:j,disableFocusRipple:m,disableRipple:g,fullWidth:I,orientation:C,size:y,variant:E},A=gt(R),N=B.useMemo(()=>({className:A.grouped,color:d,disabled:x,disableElevation:j,disableFocusRipple:m,disableRipple:g,fullWidth:I,size:y,variant:E}),[d,x,j,m,g,I,y,E,A.grouped]),O=pt(o),p=O.length,f=v=>{const k=v===0,z=v===p-1;return k&&z?"":k?A.firstButton:z?A.lastButton:A.middleButton};return e.jsx(ft,{as:c,role:"group",className:Be(A.root,r),ref:s,ownerState:R,...w,children:e.jsx(Ee.Provider,{value:N,children:O.map((v,k)=>e.jsx(we.Provider,{value:f(k),children:v},k))})})}),Q=L(e.jsx("path",{d:"m11.71 15.29 2.59-2.59c.39-.39.39-1.02 0-1.41L11.71 8.7c-.63-.62-1.71-.18-1.71.71v5.17c0 .9 1.08 1.34 1.71.71"})),U=L(e.jsx("path",{d:"M12.29 8.71 9.7 11.3c-.39.39-.39 1.02 0 1.41l2.59 2.59c.63.63 1.71.18 1.71-.71V9.41c0-.89-1.08-1.33-1.71-.7"})),T={display:"-webkit-box",WebkitLineClamp:1,WebkitBoxOrient:"vertical",overflow:"hidden",textOverflow:"ellipsis",textTransform:"none"},vt=()=>{const{searchParams:t,updateSearchParams:n}=H(),s=t.get("postId"),a=s&&/^\d+$/.test(s)&&Number(s)>0?Number(s):-1,{data:o,isFetching:r}=J({postId:a-1});return r&&!o?e.jsx(h,{startIcon:e.jsx(U,{}),loading:!0,children:e.jsx(u,{variant:"button",sx:T,children:"載入中..."})}):o?e.jsx(h,{startIcon:e.jsx(U,{}),onClick:()=>n({postId:(a-1).toString()}),children:e.jsxs(u,{variant:"button",sx:T,children:["上一篇：",o.title]})}):e.jsx(h,{startIcon:e.jsx(U,{}),disabled:!0,children:e.jsx(u,{variant:"button",sx:T,children:"沒有上一篇了"})})},bt=()=>{const{searchParams:t,updateSearchParams:n}=H(),s=t.get("postId"),a=s&&/^\d+$/.test(s)&&Number(s)>0?Number(s):-1,{data:o,isFetching:r}=J({postId:a+1});return r&&!o?e.jsx(h,{endIcon:e.jsx(Q,{}),loading:!0,children:e.jsx(u,{variant:"button",sx:T,children:"載入中..."})}):o?e.jsx(h,{endIcon:e.jsx(Q,{}),onClick:()=>n({postId:(a+1).toString()}),children:e.jsxs(u,{variant:"button",sx:T,children:["下一篇：",o.title]})}):e.jsx(h,{endIcon:e.jsx(Q,{}),disabled:!0,children:e.jsx(u,{variant:"button",sx:T,children:"沒有下一篇了"})})},It=L(e.jsx("path",{d:"m21.41 11.41-8.83-8.83c-.37-.37-.88-.58-1.41-.58H4c-1.1 0-2 .9-2 2v7.17c0 .53.21 1.04.59 1.41l8.83 8.83c.78.78 2.05.78 2.83 0l7.17-7.17c.78-.78.78-2.04-.01-2.83M6.5 8C5.67 8 5 7.33 5 6.5S5.67 5 6.5 5 8 5.67 8 6.5 7.33 8 6.5 8"}));function Ct(t){return $t(t)%4+1}function $t(t){let n=5381;for(let s=0;s<t.length;s++)n=(n<<5)+n+t.charCodeAt(s);return Math.abs(n)}const St=t=>["16/9","4/3","1/1","3/2"][Ct(t)-1],Bt=({open:t,onClose:n,name:s,...a})=>e.jsxs(ct,{open:t,onClose:n,slotProps:{paper:{elevation:1,sx:{overflow:"hidden",position:"relative"}}},maxWidth:"md",fullWidth:!0,...a,children:[e.jsx(P,{variant:"rectangular",animation:"wave",sx:{aspectRatio:St(s),width:1,height:"auto",bgcolor:"divider"}}),e.jsx(i,{sx:{position:"absolute",inset:"auto 0 0 0",p:1,display:"grid",placeItems:"center"},children:e.jsxs(i,{sx:{display:"flex",gap:1,alignItems:"center"},children:[e.jsx(i,{sx:{maxWidth:200},children:e.jsx(G,{label:s})}),e.jsx(F,{title:"下載圖片",arrow:!0,children:e.jsx(M,{size:"small",children:e.jsx(dt,{})})})]})}),e.jsx(i,{sx:{position:"absolute",inset:"0 0 auto auto",p:1},children:e.jsx(M,{onClick:o=>n&&n(o,"escapeKeyDown"),children:e.jsx(Pe,{})})})]}),Et=t=>Array.from({length:t},()=>Math.random()*.7+.3),wt=()=>e.jsxs(i,{sx:{pt:1.5},children:[e.jsx(b,{}),e.jsxs(i,{sx:{position:"relative",py:1.5,height:"fit-content"},children:[e.jsx(i,{sx:{position:"absolute",inset:0,bgcolor:"divider",opacity:.35,pointerEvents:"none"}}),e.jsx(i,{sx:{px:2.5},children:e.jsx(rt,{sx:{m:0}})})]}),e.jsx(b,{sx:{mb:2.5}}),e.jsxs(i,{sx:{px:2.5,position:"relative"},children:[e.jsx(P,{variant:"rounded",animation:"wave",sx:{mb:1},children:e.jsx(u,{variant:"h4",component:"h2",sx:{textAlign:"start"},gutterBottom:!0,children:"正在載入標題... 正在載入"})}),Et(4).map((t,n)=>e.jsx(P,{variant:"text",animation:"wave",width:`${t*100}%`},n)),e.jsx(Te,{sx:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)"}})]}),e.jsx(b,{sx:{mt:2.5}}),e.jsxs(i,{sx:{p:1.5,py:1,display:"flex",gap:1.5,alignItems:"center",position:"relative",color:"text.secondary"},children:[e.jsx(i,{sx:{position:"absolute",inset:0,bgcolor:"divider",opacity:.35}}),e.jsx(h,{color:"inherit",startIcon:e.jsx(Y,{}),size:"small",loading:!0,children:e.jsx(u,{variant:"caption",component:"span",children:"100 個讚"})}),e.jsx(h,{color:"inherit",startIcon:e.jsx(_e,{}),size:"small",loading:!0,children:e.jsx(u,{variant:"caption",component:"span",children:"收藏該貼文"})}),e.jsx(i,{sx:{flex:1}}),e.jsx(h,{color:"inherit",startIcon:e.jsx(me,{}),size:"small",loading:!0,children:e.jsx(u,{variant:"caption",component:"span",children:"1000 次瀏覽"})})]}),e.jsx(b,{})]}),Rt=({post:t})=>{const[n,s]=B.useState({open:!1,name:""}),a=r=>s({open:!0,name:r}),o=()=>s(r=>({open:!1,name:r.name}));return e.jsxs(i,{sx:{pt:1.5},children:[e.jsx("title",{children:`論壇樣板 | ${t.title}`}),e.jsx(b,{}),e.jsxs(i,{sx:{position:"relative",py:1.5,height:"fit-content"},children:[e.jsx(i,{sx:{position:"absolute",inset:0,bgcolor:"divider",opacity:.35,pointerEvents:"none"}}),e.jsx(i,{sx:{px:2.5},children:e.jsx(ot,{post:t,sx:{m:0}})})]}),e.jsx(b,{sx:{mb:2.5}}),e.jsxs(i,{sx:{px:2.5},children:[e.jsx(u,{variant:"h4",component:"h2",sx:{textAlign:"start"},gutterBottom:!0,children:t.title}),e.jsx(u,{variant:"body2",component:"p",sx:{whiteSpace:"pre-line"},children:t.content}),t.photos&&t.photos.length>0&&e.jsx(i,{sx:{display:"grid",gap:1,mt:2,gridTemplateColumns:"repeat(auto-fill, minmax(150px, 1fr))"},children:t.photos.map(({name:r,url:d},c)=>e.jsx(F,{title:"查看圖片",arrow:!0,placement:"top",children:e.jsx(Fe,{onClick:()=>a(r),sx:{position:"relative",aspectRatio:"1 / 1",bgcolor:"divider",borderRadius:1,overflow:"hidden"},children:e.jsx(i,{sx:{position:"absolute",inset:"auto 0 0 0",pb:1,display:"grid",placeItems:"center"},children:e.jsx(i,{sx:{maxWidth:150},children:e.jsx(G,{label:r,size:"small"})})})})},`${d}${c}`))}),e.jsx(Bt,{open:n.open,onClose:o,name:n.name}),e.jsxs(Le,{sx:{gap:1.5,flexDirection:"row",justifyContent:"space-between",alignItems:"center",flexWrap:"wrap-reverse",mt:2},children:[e.jsxs(i,{sx:{display:"flex",gap:1.5,flexWrap:"wrap",alignItems:"center"},children:[e.jsxs(u,{variant:"subtitle2",sx:{color:"text.secondary",display:"flex",alignItems:"center",gap:.5},children:[e.jsx(It,{fontSize:"small"}),"標籤："]}),e.jsx(it,{post:t,displayCount:99})]}),t.attachments&&t.attachments.length>0&&e.jsxs(i,{sx:{display:"flex",gap:1,flexWrap:"wrap",alignItems:"center"},children:[e.jsxs(u,{variant:"subtitle2",sx:{color:"text.secondary",display:"flex",alignItems:"center",gap:.5},children:[e.jsx(ne,{fontSize:"small"}),"附件："]}),t.attachments.map((r,d)=>e.jsx(F,{title:"下載附件",arrow:!0,placement:"top",children:e.jsx(G,{label:`${r.name} (${(r.size/1024).toFixed(1)}KB)`,clickable:!0,icon:e.jsx(ne,{fontSize:"small"})})},d))]})]})]}),e.jsx(b,{sx:{mt:2.5}}),e.jsxs(i,{sx:{px:2.5,py:1,display:"flex",gap:1.5,alignItems:"center",position:"relative",color:"text.secondary"},children:[e.jsx(i,{sx:{position:"absolute",inset:0,bgcolor:"divider",opacity:.35}}),t.isSelf?e.jsx(at,{post:t}):e.jsxs(e.Fragment,{children:[e.jsx(lt,{postId:t.id,likeCount:t.likeCount}),e.jsx(Qe,{postId:t.id})]}),e.jsx(i,{sx:{flex:1}}),e.jsx(h,{startIcon:e.jsx(me,{}),disabled:!0,size:"small",sx:{"button&.Mui-disabled":{color:"text.secondary",opacity:.8}},children:e.jsxs(u,{variant:"caption",component:"span",children:[t.viewCount," 次瀏覽"]})})]}),e.jsx(b,{flexItem:!0})]})},he=async t=>{const n=t.postId!==void 0,s=n?"c.postId = $id AND c.parentId IS NULL":"c.parentId = $id",o=(t.orderBy||"latest")==="latest"?"datetime(c.createdAt) DESC":"COALESCE(cic.likeCount, 0) DESC, datetime(c.createdAt) DESC",r=`
      SELECT c.id FROM comments c
      LEFT JOIN comment_interaction_counts cic ON c.id = cic.commentId
      WHERE ${s} ORDER BY ${o}
    `,d={$id:n?t.postId:t.parentId};return(await S.exec(r,d)).map(x=>x.id)},kt=async({commentId:t})=>{let n=null;const s=await K({server:!0});n=s.authenticated?s.user.id:null;const o=await S.exec(`
      SELECT
        c.id,
        c.postId,
        c.parentId,
        c.content,
        c.userId,
        u.name as userName,
        COALESCE(cic.likeCount, 0) as likeCount,
        c.createdAt,
        c.updatedAt
      FROM
        comments c
      JOIN
        users u ON c.userId = u.id
      LEFT JOIN
        comment_interaction_counts cic ON c.id = cic.commentId
      WHERE
        c.id = $commentId
    `,{$commentId:t});if(o.length===0)return null;const r=o[0];return{...r,id:r.id,postId:r.postId,parentId:r.parentId,content:r.content,userId:r.userId,userName:r.userName,likeCount:r.likeCount,createdAt:new Date(r.createdAt),updatedAt:new Date(r.updatedAt),isSelf:n!==null?r.userId===n:!1}},At=async({postId:t,content:n,parentId:s})=>{const a=await K({server:!0});if(!a.authenticated)return{error:"未登入或授權失效，無法創建留言"};const o=a.user.id;if((await S.exec("SELECT id FROM posts WHERE id = $postId",{$postId:t})).length===0)return{error:"貼文不存在"};if(s){const I=await S.exec("SELECT id, postId FROM comments WHERE id = $parentId",{$parentId:s});if(I.length===0)return{error:"回覆的留言不存在"};if(I[0].postId!==t)return{error:"回覆的留言不屬於此貼文"}}const c=new Date().toISOString(),x=`
      INSERT INTO comments (userId, postId, parentId, content, createdAt, updatedAt)
      VALUES ($userId, $postId, $parentId, $content, $createdAt, $updatedAt)
      RETURNING id
    `,j={$userId:o,$postId:t,$parentId:s||null,$content:n,$createdAt:c,$updatedAt:c},m=await S.exec(x,j);return!m||m.length===0||typeof m[0].id!="number"?{error:"創建留言失敗"}:m[0].id},Pt=async({commentId:t,content:n})=>{const s=await K({server:!0});if(!s.authenticated)return{error:"未登入或授權失效，無法編輯留言"};const a=s.user.id,r=await S.exec("SELECT userId FROM comments WHERE id = $commentId",{$commentId:t});if(r.length===0)return{error:"留言不存在"};if(r[0].userId!==a)return{error:"您沒有權限編輯此留言"};const d=new Date().toISOString(),c=`
      UPDATE comments
      SET content = $content,
          updatedAt = $updatedAt
      WHERE id = $commentId AND userId = $userId
    `,x={$commentId:t,$userId:a,$content:n,$updatedAt:d};return await S.exec(c,x),null},Tt=async t=>{const n=await K({server:!0});if(!n.authenticated)return{error:"未登入或授權失效，無法刪除留言"};const s=n.user.id,o=await S.exec("SELECT userId FROM comments WHERE id = $commentId",{$commentId:t});return o.length===0?{error:"留言不存在"}:o[0].userId!==s?{error:"您沒有權限刪除此留言"}:(await S.exec("DELETE FROM comments WHERE id = $commentId AND userId = $userId",{$commentId:t,$userId:s}),null)},X=1e3*60*1,Ft=({postId:t,orderBy:n})=>V({queryKey:["commentsByPost",t,n],queryFn:()=>he({postId:t,orderBy:n}),staleTime:X}),je=t=>V({queryKey:["commentsByParent",t],queryFn:()=>he({parentId:t,orderBy:"latest"}),staleTime:X}),Lt=t=>V({queryKey:["comment",t],queryFn:()=>kt({commentId:t}),staleTime:X}),qt=()=>{const t=q();return _({mutationFn:At,onSettled:()=>{t.invalidateQueries({queryKey:["commentsByPost"]}),t.invalidateQueries({queryKey:["commentsByParent"]}),t.invalidateQueries({queryKey:["comment"]}),t.invalidateQueries({queryKey:["post"]})}})},Nt=()=>{const t=q();return _({mutationFn:Pt,onSettled:()=>{t.invalidateQueries({queryKey:["commentsByPost"]}),t.invalidateQueries({queryKey:["commentsByParent"]}),t.invalidateQueries({queryKey:["comment"]}),t.invalidateQueries({queryKey:["post"]})}})},Ot=()=>{const t=q();return _({mutationFn:Tt,onSettled:()=>{t.invalidateQueries({queryKey:["commentsByPost"]}),t.invalidateQueries({queryKey:["commentsByParent"]}),t.invalidateQueries({queryKey:["comment"]}),t.invalidateQueries({queryKey:["post"]})}})},ge=L(e.jsx("path",{d:"M10 9V7.41c0-.89-1.08-1.34-1.71-.71L3.7 11.29c-.39.39-.39 1.02 0 1.41l4.59 4.59c.63.63 1.71.19 1.71-.7V14.9c5 0 8.5 1.6 11 5.1-1-5-4-10-11-11"})),fe=L(e.jsx("path",{d:"M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2m0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2m0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2"})),ie=L(e.jsx("path",{d:"M8.12 9.29 12 13.17l3.88-3.88c.39-.39 1.02-.39 1.41 0s.39 1.02 0 1.41l-4.59 4.59c-.39.39-1.02.39-1.41 0L6.7 10.7a.996.996 0 0 1 0-1.41c.39-.38 1.03-.39 1.42 0"})),ye={content:pe.string().min(1,{message:"請輸入留言內容"}).max(250,{message:"留言內容過長"})},zt=pe.object(ye),Dt={content:""},W=({type:t,hideAvator:n,sx:s,onCancel:a,postId:o,parentId:r,commentId:d,initialValues:c,...x})=>{const{mutateAsync:j,isPending:m}=qt(),{mutateAsync:g,isPending:I}=Nt(),C=m||I,{user:y,authenticated:E,loading:w}=xe(),R=Xe({defaultValues:{...Dt,...c},validators:{onSubmit:zt},onSubmit:async({value:p})=>{if(!C){if(t==="create"){const f=await j({...p,postId:o,parentId:r});if(typeof f=="number")return R.reset(),console.log("發佈成功，留言 ID："+f);f.error&&console.error(`留言發佈失敗：${f.error}`)}if(t==="edit"){const f=await g({...p,commentId:d});if(f===null)return R.reset(),console.log("更新留言成功");f.error&&console.error(`留言更新失敗：${f.error}`)}}}}),A=async()=>{if(!R.state.canSubmit){Ne(R.getAllErrors().fields).forEach(([p,f])=>{f.errors.forEach(v=>{!v||typeof v!="object"||"message"in v&&console.error(`${p}: ${v.message}`)})}),console.error("請檢查表單是否填寫正確");return}R.handleSubmit()},N=B.useRef(null),O=p=>{R.setFieldValue("content",f=>{const v=N.current;if(v){const k=v.selectionStart||0,z=v.selectionEnd||0,be=f.substring(0,k)+p+f.substring(z);return setTimeout(()=>{v.focus(),v.setSelectionRange(k+p.length,k+p.length)},0),be}return f+p})};return e.jsx(i,{sx:{position:"relative",py:1,px:2,...s},...x,children:e.jsxs(i,{sx:{display:"flex",alignItems:"flex-start",gap:1.5},children:[n?null:E&&y?e.jsx(ue,{name:y.name,sx:{mt:1.5}}):e.jsx(xt,{sx:{width:"2rem",height:"2rem",mt:1.5}}),e.jsxs(i,{sx:{flex:1},children:[e.jsx(R.Field,{name:"content",validators:{onSubmit:ye.content},children:p=>e.jsx(qe,{inputRef:N,name:p.name,variant:"standard",size:"small",label:E?"發表你的想法":"登入後即可發表留言",fullWidth:!0,type:"text",disabled:!E||w,error:et(p.state.meta.errors),helperText:Ze(p.state.meta.errors),value:p.state.value,onChange:f=>p.handleChange(f.target.value),onBlur:p.handleBlur})}),e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between",mt:1,alignItems:"center",gap:1},children:[e.jsx(ut,{onEmojiClick:O,disabled:!E||w}),e.jsxs(i,{sx:{display:"flex",gap:1},children:[e.jsx(h,{size:"small",disabled:!E||w,sx:{color:"text.secondary"},loading:C,onClick:()=>{R.reset(),a!==void 0&&a()},children:"取消"}),e.jsx(R.Subscribe,{selector:p=>p.values.content,children:p=>e.jsx(h,{size:"small",disabled:!E||w||p.trim().length===0,variant:"contained",onClick:A,loading:C,children:"留言"})})]})]})]})]})})},Mt=async({commentId:t,userId:n})=>{const s=`
      SELECT 1 as liked
      FROM comment_interactions
      WHERE commentId = $commentId
        AND userId = $userId
        AND type = 'like'
      LIMIT 1
    `,a=`
      SELECT COALESCE(likeCount, 0) as likeCount
      FROM comment_interaction_counts
      WHERE commentId = $commentId
    `,o=await S.exec(s,{$commentId:t,$userId:n}),r=await S.exec(a,{$commentId:t}),d=o.length>0;return!r[0]||!Number.isInteger(r[0].likeCount)?null:{liked:d,likeCount:r[0].likeCount}},Wt=async({commentId:t,userId:n,type:s,value:a})=>{a?await S.exec(`
        INSERT OR IGNORE INTO comment_interactions (userId, commentId, type)
        VALUES ($userId, $commentId, $type)
      `,{$userId:n,$commentId:t,$type:s}):await S.exec(`
        DELETE FROM comment_interactions
        WHERE userId = $userId
          AND commentId = $commentId
          AND type = $type
      `,{$userId:n,$commentId:t,$type:s})},Kt=0,Ht=(t,n,s)=>{const a=q(),o=B.useRef(0);return _({mutationFn:r=>{if(n===void 0)throw new Error("未登入");return Wt({commentId:t,userId:n,type:s,value:r})},onMutate:()=>(o.current++,o.current),onSettled:(r,d,c,x)=>{if(x===o.current){const j=["commentLikeStatus",t,n];a.invalidateQueries({queryKey:j})}},onError:()=>{console.error("評論按讚操作失敗")}})},Vt=t=>{const n=q(),{user:s,authenticated:a,loading:o}=xe(),{data:r,isLoading:d}=V({staleTime:Kt,queryKey:["commentLikeStatus",t,s==null?void 0:s.id],enabled:!o&&a&&(s==null?void 0:s.id)!==void 0,queryFn:async()=>Mt({commentId:t,userId:s.id})}),c=o||d,x=!a||c||r===void 0||r===null,j=(r==null?void 0:r.liked)??!1,m=(r==null?void 0:r.likeCount)??null,{mutate:g}=Ht(t,s==null?void 0:s.id,"like");return{liked:j,likeCount:m,handleLike:async()=>{x||(await n.cancelQueries({queryKey:["commentLikeStatus",t,s.id]}),n.setQueryData(["commentLikeStatus",t,s.id],C=>{const y=!C.liked;return g(y),{liked:y,likeCount:C.likeCount+(y?1:-1)}}))},disabled:x,loading:c}},_t=({commentId:t,likeCount:n})=>{const{liked:s,likeCount:a,handleLike:o,disabled:r,loading:d}=Vt(t);return e.jsx(h,{size:"small",startIcon:e.jsx(Y,{}),onClick:o,color:s?"primary":"inherit",sx:{color:s?void 0:"text.secondary"},disabled:r,loading:d,children:e.jsx(u,{variant:"caption",children:a!==null?a>0?a:"讚":n})})},Qt=({onEdit:t,onDelete:n,isPending:s,isSelf:a})=>{const[o,r]=B.useState(null),d=y=>r(y.currentTarget),c=()=>r(null),[x,j]=B.useState(null),m=y=>j(y.currentTarget),g=()=>j(null),I=()=>{t(),c()},C=async()=>{await n(),c(),g()};return e.jsxs(e.Fragment,{children:[e.jsx(F,{title:a?"更多選項":"只有自己的留言才能編輯或刪除",arrow:!0,children:e.jsx("span",{children:e.jsx(M,{size:"small",onClick:d,disabled:!a,children:e.jsx(fe,{fontSize:"small"})})})}),e.jsx(te,{anchorEl:o,open:!!o,onClose:c,anchorOrigin:{vertical:"bottom",horizontal:"center"},transformOrigin:{vertical:"top",horizontal:"center"},elevation:6,children:e.jsxs(Oe,{dense:!0,children:[e.jsx(re,{onClick:I,children:"編輯"}),e.jsx(re,{onClick:m,sx:{color:"error.main"},children:"刪除"})]})}),e.jsx(te,{anchorEl:x,open:!!x,onClose:g,anchorOrigin:{vertical:"bottom",horizontal:"center"},transformOrigin:{vertical:"top",horizontal:"center"},elevation:6,children:e.jsxs(i,{sx:{p:2,maxWidth:300},children:[e.jsx(u,{variant:"subtitle1",sx:{mb:1},children:"確認刪除留言"}),e.jsx(u,{variant:"body2",sx:{mb:2,color:"text.secondary"},children:"確認刪除留言後，將無法復原，請謹慎操作。"}),e.jsxs(i,{sx:{display:"flex",justifyContent:"flex-end",gap:1},children:[e.jsx(h,{variant:"outlined",size:"small",onClick:g,color:"inherit",loading:s,children:"取消"}),e.jsx(h,{variant:"contained",color:"error",size:"small",onClick:C,loading:s,disableElevation:!0,children:"確認刪除"})]})]})})]})},Ut=({comment:t})=>{const n=de(c=>c.breakpoints.up("md")),{mutateAsync:s,isPending:a}=Ot(),o=async()=>{const c=await s(t.id);if(c===null)return console.log("留言刪除成功");c.error&&console.error(`留言刪除失敗：${c.error}`)},[r,d]=B.useState(!1);return r?e.jsx(W,{type:"edit",commentId:t.id,postId:t.postId,parentId:t.parentId??void 0,initialValues:{content:t.content},onCancel:()=>d(!1),hideAvator:!0}):e.jsxs(e.Fragment,{children:[e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx(u,{variant:"subtitle2",component:"a",sx:{"&:hover":{textDecoration:"underline"},color:"text.primary"},href:`${ce.forum_users}?user=${t.userName}`,children:t.userName}),e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(u,{variant:"caption",color:"text.secondary",children:n?t.createdAt.toLocaleString():mt(t.createdAt)}),t.createdAt.getTime()!==t.updatedAt.getTime()&&e.jsx(F,{title:`最後編輯於 ${t.updatedAt.toLocaleString()}`,arrow:!0,children:e.jsx(u,{variant:"caption",color:"text.secondary",children:"(已編輯)"})}),e.jsx(Qt,{onDelete:o,onEdit:()=>d(!0),isPending:a,isSelf:t.isSelf})]})]}),e.jsx(u,{variant:"body2",sx:{mt:.5,whiteSpace:"pre-line"},children:t.content})]})},ve=({postId:t,commentId:n,nestedLevel:s,sx:a,...o})=>{if(s<0)throw new Error("nestedLevel must be greater than 0");const r=de(w=>w.breakpoints.up("sm")),{data:d,isFetching:c}=Lt(n),{data:x,isFetching:j}=je(n),[m,g]=B.useState(!1),I=()=>g(w=>!w),[C,y]=B.useState(!1),E=()=>y(w=>!w);return c||!d||j?e.jsx(Z,{nestedLevel:s,sx:a,...o}):e.jsxs(i,{sx:{position:"relative",py:1,pb:s>0?0:1,pl:{xs:1,sm:2},borderLeft:s>0?"2px solid":"none",borderColor:"divider",...a},...o,children:[e.jsxs(i,{sx:{display:"flex",alignItems:"flex-start",gap:1.5},children:[e.jsx(ue,{name:d.userName,sx:{mt:1}}),e.jsxs(i,{sx:{flex:1},children:[e.jsx(Ut,{comment:d}),e.jsxs(i,{sx:{display:"flex",alignItems:"center",mt:1,gap:1},children:[e.jsx(_t,{commentId:n,likeCount:d.likeCount}),e.jsx(h,{size:"small",startIcon:e.jsx(ge,{}),sx:{color:"text.secondary"},onClick:E,children:e.jsx(u,{variant:"caption",children:C?"取消回覆":"回覆"})})]}),C&&e.jsx(W,{onCancel:()=>y(!1),postId:t,parentId:n,type:"create"}),x&&x.length>0&&e.jsx(h,{startIcon:m?e.jsx(ie,{sx:{transform:"rotate(180deg)",transition:"transform 0.2s ease",transformOrigin:"center"}}):e.jsx(ie,{}),sx:{mt:1},size:"small",onClick:I,children:m?"隱藏回覆":`顯示 ${x.length||0} 則回覆`}),r&&m&&x&&e.jsx(ae,{commentId:n,postId:t})]})]}),!r&&m&&x&&e.jsx(ae,{commentId:n,postId:t})]})},Z=({nestedLevel:t,sx:n,...s})=>e.jsx(i,{sx:{position:"relative",py:1,pb:t>0?0:1,pl:{xs:1,sm:2},borderLeft:t>0?"2px solid":"none",borderColor:"divider",...n},...s,children:e.jsxs(i,{sx:{display:"flex",alignItems:"flex-start",gap:1.5},children:[e.jsx(P,{variant:"circular",width:"2rem",height:"2rem",sx:{mt:1},animation:"wave"}),e.jsxs(i,{sx:{flex:1},children:[e.jsxs(i,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx(P,{variant:"rounded",animation:"wave",children:e.jsx(u,{variant:"subtitle2",component:"span",children:"載入名稱中..."})}),e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(P,{variant:"rounded",animation:"wave",children:e.jsx(u,{variant:"caption",color:"text.secondary",children:"0000-00-00 00:00:00"})}),e.jsx(F,{title:"更多選項",arrow:!0,children:e.jsx("span",{children:e.jsx(M,{size:"small",disabled:!0,children:e.jsx(fe,{fontSize:"small"})})})})]})]}),e.jsx(P,{variant:"rounded",animation:"wave",children:e.jsx(u,{variant:"body2",sx:{mt:.5,whiteSpace:"pre-line"},children:"佔位文字，佔位文字，佔位文字，佔位文字，佔位文字，佔位文字，"})}),e.jsxs(i,{sx:{display:"flex",alignItems:"center",mt:1,gap:1},children:[e.jsx(h,{size:"small",startIcon:e.jsx(Y,{}),sx:{color:"text.secondary"},loading:!0,children:e.jsx(u,{variant:"caption",children:"讚"})}),e.jsx(h,{size:"small",startIcon:e.jsx(ge,{}),sx:{color:"text.secondary"},loading:!0,children:e.jsx(u,{variant:"caption",children:"回覆"})})]})]})]})}),ae=({commentId:t,postId:n})=>{const{data:s,isFetching:a}=je(t);return a?e.jsx(i,{children:[...Array(1)].map((o,r)=>e.jsx(Z,{nestedLevel:1},r))}):s?e.jsx(i,{children:s.map(o=>e.jsx(ve,{commentId:o,postId:n,nestedLevel:1},o))}):null},le={content:'""',display:"block",position:"absolute",inset:0,bgcolor:"divider",opacity:.2,pointerEvents:"none",mr:-2},Gt=({totalComments:t})=>{const{searchParams:n,updateSearchParams:s}=H(),a=n.get("postId"),o=a&&/^\d+$/.test(a)&&Number(a)>0?Number(a):-1,d=(n.get("orderBy")||"latest")==="likes"?"likes":"latest",{data:c,isFetching:x}=Ft({postId:o,orderBy:d}),j=(m,g)=>{s({orderBy:g===0?"latest":"likes"})};return x?e.jsxs(e.Fragment,{children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1.5},children:[e.jsx(P,{variant:"rounded",animation:"wave",sx:{mx:2},children:e.jsx(u,{variant:"subtitle1",component:"h3",children:"0 則留言"})}),e.jsx(b,{flexItem:!0,orientation:"vertical",variant:"middle"}),e.jsxs(oe,{value:d==="latest"?0:1,onChange:j,children:[e.jsx(D,{label:"最新",disabled:!0}),e.jsx(D,{label:"最多人按讚",disabled:!0})]})]}),e.jsx(b,{}),e.jsx(i,{sx:{pr:2,"& > .comment:nth-of-type(odd):before":le},children:[...Array(3)].map((m,g)=>e.jsx(Z,{nestedLevel:0,className:"comment"},g))})]}):!c||c.length===0?e.jsxs(e.Fragment,{children:[e.jsx(i,{sx:{pr:2},children:e.jsx(W,{type:"create",postId:o})}),e.jsx(i,{sx:{pb:2},children:e.jsx(u,{variant:"body2",sx:{color:"text.secondary",textAlign:"center",mt:2},children:"還沒有留言，快來發表你的看法吧！"})})]}):e.jsxs(e.Fragment,{children:[e.jsxs(i,{sx:{display:"flex",alignItems:"center",gap:1.5},children:[e.jsxs(u,{variant:"subtitle1",component:"h3",sx:{px:2},children:[t," 則留言"]}),e.jsx(b,{flexItem:!0,orientation:"vertical",variant:"middle"}),e.jsxs(oe,{value:d==="latest"?0:1,onChange:j,children:[e.jsx(D,{label:"最新"}),e.jsx(D,{label:"最多人按讚"})]})]}),e.jsx(b,{}),e.jsxs(i,{sx:{pr:2,"& > .comment:nth-of-type(odd):before":le},children:[e.jsx(W,{type:"create",className:"comment",postId:o}),c.map(m=>e.jsx(ve,{commentId:m,postId:o,nestedLevel:0,className:"comment"},m))]})]})},Jt=()=>{const{data:t,isFetching:n}=tt({limit:2,orderBy:"likeCount",order:"desc"});return n||!t?e.jsxs(i,{children:[e.jsx(se,{}),e.jsx(se,{})]}):e.jsx(i,{children:t.map(s=>e.jsx(st,{postId:s},s))})},Yt=()=>{const{searchParams:t}=H(),n=t.get("postId"),s=n&&/^\d+$/.test(n)&&Number(n)>0?Number(n):-1,{data:a,isFetching:o}=J({postId:s,incrementViewCount:!0});return o&&!a?e.jsx(wt,{}):a?e.jsxs(e.Fragment,{children:[e.jsx(Rt,{post:a}),e.jsx(Gt,{totalComments:a.commentCount})]}):e.jsxs(i,{sx:{pt:1.5},children:[e.jsx(b,{}),e.jsxs(i,{sx:{py:6,display:"flex",flexDirection:"column",alignItems:"center",gap:2},children:[e.jsx(Me,{sx:{fontSize:"6rem",color:"action.disabled"}}),e.jsx(u,{variant:"body1",component:"p",sx:{color:"text.secondary",textAlign:"center"},children:"貼文不存在或已被刪除"})]}),e.jsx(b,{}),e.jsxs(i,{sx:{position:"relative"},children:[e.jsx(i,{sx:{position:"absolute",inset:0,bgcolor:"divider",opacity:.35}}),e.jsx(u,{variant:"h6",sx:{p:2},children:"我們找不到這篇貼文...但你可能會喜歡這些！"})]}),e.jsx(b,{}),e.jsx(Jt,{})]})};function Xt(){const{isMd:t,isSm:n}=Ke();return e.jsxs(He,{children:[e.jsx(Ue,{}),e.jsxs(Ve,{children:[t?e.jsx(Ge,{}):e.jsx(Je,{}),e.jsx(nt,{maxWidth:"lg",sx:{position:"relative",my:10,px:0},children:e.jsxs(ze,{sx:{pb:3,borderRadius:3,border:"1px solid",borderColor:"divider"},elevation:1,children:[e.jsxs(i,{sx:{display:"flex",justifyContent:"center",mt:2,mx:2},children:[n&&e.jsx(h,{href:ce.forum_home,startIcon:e.jsx(We,{}),variant:"outlined",sx:{textWrap:"nowrap"},children:t?"返回首頁":"首頁"}),e.jsx(i,{sx:{flex:1}}),e.jsxs(yt,{variant:"text",children:[e.jsx(vt,{}),e.jsx(bt,{})]})]}),e.jsx(Yt,{})]})}),e.jsx(Ye,{})]})]})}De.createRoot(document.getElementById("root")).render(e.jsx(B.StrictMode,{children:e.jsx(Xt,{})}));
